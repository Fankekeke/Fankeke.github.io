<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="JavaScript 异步、栈、事件循环、任务队列"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>JavaScript 异步、栈、事件循环、任务队列 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/05l1jzfr0ne8/",
				"appid": "1613049289050283", 
				"title": "JavaScript 异步、栈、事件循环、任务队列 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-31T02:30:30"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/066fknl8qjoa/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/2l5z5iq2j1z/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f&text=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f&text=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f&title=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f&is_video=false&description=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f&title=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f&title=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f&title=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f05l1jzfr0ne8%2f&title=JavaScript%20%e5%bc%82%e6%ad%a5%e3%80%81%e6%a0%88%e3%80%81%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e3%80%81%e4%bb%bb%e5%8a%a1%e9%98%9f%e5%88%97"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">JavaScript 异步、栈、事件循环、任务队列</h1><div class="meta"><div class="postdate"><time datetime="2018-12-31" itemprop="datePublished">2018-12-31</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e概览\x3c\/h2\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVU9kG?w=922\x26amp;h=706\x22 src=\x22https:\/\/static.alili.tech\/img\/bVU9kG?w=922\x26amp;h=706\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3cbr\x3e我们经常会听到引擎和runtime，它们的区别是什么呢？\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e引擎：解释并编译代码，让它变成能交给机器运行的代码（runnable commands）。\x3c\/li\x3e\n\x3cli\x3eruntime：就是运行环境，它提供一些对外接口供Js调用，以跟外界打交道，比如，浏览器环境、Node.js环境。不同的runtime，会提供不同的接口，比如，在 Node.js 环境中，我们可以通过 \x3ccode\x3erequire\x3c\/code\x3e 来引入模块；而在浏览器中，我们有 \x3ccode\x3ewindow\x3c\/code\x3e、 DOM。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3eJs引擎是单线程的，如上图中，它负责维护任务队列，并通过 Event Loop 的机制，按顺序把任务放入栈中执行。而图中的异步处理模块，就是 runtime 提供的，拥有和Js引擎互不干扰的线程。接下来，我们会细说图中的：栈和任务队列。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e栈\x3c\/h2\x3e\n\x3cp\x3e现在，我们要运行下面这段代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function bar() {\n    console.log(1);\n}\n\nfunction foo() {\n    console.log(2);\n    far();\n}\n\nsetTimeout(() =\x3e {\n    console.log(3)\n});\n\nfoo();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ebar\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e);\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efoo\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e);\n    far();\n}\n\nsetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e)\n});\n\nfoo();\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e它在栈中的入栈、出栈过程，如下图：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVU9kK?w=1181\x26amp;h=993\x22 src=\x22https:\/\/static.alili.tech\/img\/bVU9kK?w=1181\x26amp;h=993\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e任务队列\x3c\/h2\x3e\n\x3cp\x3eJs 中，有两类任务队列：宏任务队列（macro tasks）和微任务队列（micro tasks）。宏任务队列可以有多个，微任务队列只有一个。那么什么任务，会分到哪个队列呢？\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e宏任务：script（全局任务）, setTimeout, setInterval, setImmediate, I\/O, UI rendering.\x3c\/li\x3e\n\x3cli\x3e微任务：process.nextTick, Promise, Object.observer, MutationObserver.\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e浏览器的 Event Loop\x3c\/h3\x3e\n\x3cp\x3e\x3cstrong\x3e浏览器的 Event Loop 遵循的是 HTML5 标准，而 NodeJs 的 Event Loop 遵循的是 libuv。\x3c\/strong\x3e 区别较大，分开讲。\x3c\/p\x3e\n\x3cp\x3e我们上面讲到，当stack空的时候，就会从任务队列中，取任务来执行。浏览器这边，共分3步：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e取一个宏任务来执行。执行完毕后，下一步。\x3c\/li\x3e\n\x3cli\x3e取一个微任务来执行，执行完毕后，再取一个微任务来执行。直到微任务队列为空，执行下一步。\x3c\/li\x3e\n\x3cli\x3e更新UI渲染。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3eEvent Loop 会无限循环执行上面3步，这就是Event Loop的主要控制逻辑。其中，第3步（更新UI渲染）会根据浏览器的逻辑，决定要不要马上执行更新。毕竟更新UI成本大，所以，一般都会比较长的时间间隔，执行一次更新。\x3c\/p\x3e\n\x3cp\x3e从执行步骤来看，我们发现微任务，受到了特殊待遇！我们代码开始执行都是从script（全局任务）开始，所以，一旦我们的全局任务（属于宏任务）执行完，就马上执行完整个微任务队列。看个例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22console.log(\x27script start\x27);\n\n\/\/ 微任务\nPromise.resolve().then(() =\x3e {\n    console.log(\x27p 1\x27);\n});\n\n\/\/ 宏任务\nsetTimeout(() =\x3e {\n    console.log(\x27setTimeout\x27);\n}, 0);\n\nvar s = new Date();\nwhile(new Date() - s \x3c 50); \/\/ 阻塞50ms\n\n\/\/ 微任务\nPromise.resolve().then(() =\x3e {\n    console.log(\x27p 2\x27);\n});\n\nconsole.log(\x27script ent\x27);\n\n\n\/*** output ***\/\n\n\/\/ one macro task\nscript start\nscript ent\n\n\/\/ all micro tasks\np 1\np 2\n\n\/\/ one macro task again\nsetTimeout\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27script start\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 微任务\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve().then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27p 1\x27\x3c\/span\x3e);\n});\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 宏任务\x3c\/span\x3e\nsetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27setTimeout\x27\x3c\/span\x3e);\n}, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e s = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e();\n\x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e() - s \x26lt; \x3cspan class=\x22hljs-number\x22\x3e50\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 阻塞50ms\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 微任务\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve().then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27p 2\x27\x3c\/span\x3e);\n});\n\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27script ent\x27\x3c\/span\x3e);\n\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/*** output ***\/\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ one macro task\x3c\/span\x3e\nscript start\nscript ent\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ all micro tasks\x3c\/span\x3e\np \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\np \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ one macro task again\x3c\/span\x3e\nsetTimeout\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面之所以加50ms的阻塞，是因为 \x3ccode\x3esetTimeout\x3c\/code\x3e 的 delayTime 最少是 4ms. 为了避免认为 \x3ccode\x3esetTimeout\x3c\/code\x3e 是因为4ms的延迟而后面才被执行的，我们加了50ms阻塞。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3eNodeJs 的 Event Loop\x3c\/h3\x3e\n\x3cp\x3eNodeJs 的运行是这样的：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e初始化 Event Loop\x3c\/li\x3e\n\x3cli\x3e执行您的主代码。这里同样，遇到异步处理，就会分配给对应的队列。直到主代码执行完毕。\x3c\/li\x3e\n\x3cli\x3e执行主代码中出现的所有微任务：\x3cstrong\x3e先执行完所有nextTick()，然后在执行其它所有微任务。\x3c\/strong\x3e\n\x3c\/li\x3e\n\x3cli\x3e开始 Event Loop\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3eNodeJs 的 Event Loop 分6个阶段执行：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22   ┌───────────────────────────┐\n┌─\x3e│           timers          │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │     pending callbacks     │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │       idle, prepare       │\n│  └─────────────┬─────────────┘      ┌───────────────┐\n│  ┌─────────────┴─────────────┐      │   incoming:   │\n│  │           poll            │\x3c─────┤  connections, │\n│  └─────────────┬─────────────┘      │   data, etc.  │\n│  ┌─────────────┴─────────────┐      └───────────────┘\n│  │           check           │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n└──┤      close callbacks      │\n   └───────────────────────────┘\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs smali\x22\x3e\x3ccode\x3e   ┌───────────────────────────┐\n┌─\x26gt;│           timers          │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │     pending callbacks     │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │       idle, prepare       │\n│  └─────────────┬─────────────┘      ┌───────────────┐\n│  ┌─────────────┴─────────────┐      │   incoming:   │\n│  │           poll            │\x26lt;─────┤  connections, │\n│  └─────────────┬─────────────┘      │   data, etc.  │\n│  ┌─────────────┴─────────────┐      └───────────────┘\n│  │          \x3cspan class=\x22hljs-built_in\x22\x3e check \x3c\/span\x3e          │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n└──┤      close callbacks      │\n   └───────────────────────────┘\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e以上的6个阶段，具体处理的任务如下：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3etimers: 这个阶段执行\x3ccode\x3esetTimeout()\x3c\/code\x3e和\x3ccode\x3esetInterval()\x3c\/code\x3e设定的回调。\x3c\/li\x3e\n\x3cli\x3epending callbacks: 上一轮循环中有少数的 I\/O callback 会被延迟到这一轮的这一阶段执行。\x3c\/li\x3e\n\x3cli\x3eidle, prepare: 仅内部使用。\x3c\/li\x3e\n\x3cli\x3epoll: 执行 I\/O callback，在适当的条件下会阻塞在这个阶段\x3c\/li\x3e\n\x3cli\x3echeck: 执行\x3ccode\x3esetImmediate()\x3c\/code\x3e设定的回调。\x3c\/li\x3e\n\x3cli\x3eclose callbacks: 执行比如\x3ccode\x3esocket.on(\x27close\x27, ...)\x3c\/code\x3e的回调。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cstrong\x3e每个阶段执行完毕后，都会执行所有微任务（先 nextTick，后其它），然后再进入下一个阶段。\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3eLinks\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/html.spec.whatwg.org\/multipage\/webappapis.html#event-loop\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eEvent loops\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/nodejs.org\/en\/docs\/guides\/event-loop-timers-and-nexttick\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eNodeJs 的 Event Loop 官方文档\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/developer.mozilla.org\/zh-CN\/docs\/Web\/JavaScript\/EventLoop\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e并发模型与事件循环\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/vimeo.com\/96425312\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ePhilip Roberts: Help, I’m stuck in an event-loop.\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/www.zhihu.com\/question\/36972010\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ePromise的队列与setTimeout的队列有何关联？\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000004322358\x22\x3eJavaScript：彻底理解同步、异步和事件循环(Event Loop)\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/github.com\/aooy\/blog\/issues\/5\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e从event loop规范探究javaScript异步及浏览器更新渲染时机\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.ruanyifeng.com\/blog\/2014\/10\/event-loop.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eJavaScript 运行机制详解：再谈Event Loop - 阮一峰的网络日志\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eTasks, microtasks, queues and schedules\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/WindowOrWorkerGlobalScope\/setTimeout\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWindowOrWorkerGlobalScope.setTimeout()\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/stackoverflow.com\/questions\/29027845\/what-is-the-difference-between-javascript-engine-and-javascript-runtime-environm\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWhat is the difference between JavaScript Engine and JavaScript Runtime Environment\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>JavaScript 异步、栈、事件循环、任务队列</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000011198232">https://segmentfault.com/a/1190000011198232</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/05l1jzfr0ne8/" target="_blank">https://alili.tech/archive/05l1jzfr0ne8/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>