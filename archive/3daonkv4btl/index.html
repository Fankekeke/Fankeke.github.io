<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="web 埋点实现原理了解一下"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>web 埋点实现原理了解一下 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/3daonkv4btl/",
				"appid": "1613049289050283", 
				"title": "web 埋点实现原理了解一下 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-11-30T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/dpw23v06y4/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/ikf8ies6l1/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f&text=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f&text=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f&title=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f&is_video=false&description=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f&title=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f&title=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f&title=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f3daonkv4btl%2f&title=web%20%e5%9f%8b%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%ba%86%e8%a7%a3%e4%b8%80%e4%b8%8b"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">web 埋点实现原理了解一下</h1><div class="meta"><div class="postdate"><time datetime="2018-11-30" itemprop="datePublished">2018-11-30</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch3 id=\x22articleHeader0\x22\x3e前言\x3c\/h3\x3e\n\x3cp\x3e埋点，是网站分析的一种常用的数据采集方法。我们主要用来采集用户行为数据（例如页面访问路径，点击了什么元素）进行数据分析，从而让运营同学更加合理的安排运营计划。现在市面上有很多第三方埋点服务商，百度统计，友盟，growingIO 等大家应该都不太陌生，大多情况下大家都只是使用，最近我研究了下 web 埋点，你要不要了解下。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e现有埋点三大类型\x3c\/h3\x3e\n\x3cblockquote\x3e用户行为分析是一个大系统，一个典型的数据平台。由用户数据采集，用户行为建模分析，可视化报表展示几个模块构成。现有的埋点采集方案可以大致被分为三种，手动埋点，可视化埋点，无埋点\x3c\/blockquote\x3e\n\x3col\x3e\n\x3cli\x3e手动埋点\x3cbr\x3e手动代码埋点比较常见，需要调用埋点的业务方在需要采集数据的地方调用埋点的方法。优点是流量可控，业务方可以根据需要在任意地点任意场景进行数据采集，采集信息也完全由业务方来控制。这样的有点也带来了一些弊端，需要业务方来写死方法，如果采集方案变了，业务方也需要重新修改代码，重新发布。\x3c\/li\x3e\n\x3cli\x3e可视化埋点\x3cbr\x3e可是化埋点是近今年的埋点趋势，很多大厂自己的数据埋点部门也都开始做这块。优点是业务方工作量少，缺点则是技术上推广和实现起来有点难（业务方前端代码规范是个大前提）。阿里的活动页很多都是运营通过可视化的界面拖拽配置实现，这些活动控件元素都带有唯一标识。通过埋点配置后台，将元素与要采集事件关联起来，可以自动生成埋点代码嵌入到页面中。\x3c\/li\x3e\n\x3cli\x3e无埋点\x3cbr\x3e无埋点则是前端自动采集全部事件，上报埋点数据，由后端来过滤和计算出有用的数据，优点是前端只要加载埋点脚本。缺点是流量和采集的数据过于庞大，服务器性能压力山大，主流的 GrowingIO 就是这种实现方案。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e我们暂时放弃可视化埋点的实现，在 \x3ccode\x3e手动埋点\x3c\/code\x3e 和 \x3ccode\x3e无埋点\x3c\/code\x3e 上进行了尝试，为了便于描述，下文我会称采集脚本为 SDK。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e思考几个问题\x3c\/h3\x3e\n\x3cblockquote\x3e埋点开发需要考虑很多内容，贯穿着不轻易动手写代码的原则，我们在开发前先思考下面这几个问题\x3c\/blockquote\x3e\n\x3col\x3e\n\x3cli\x3e我们要采集什么内容，进行哪些采集接口的约定\x3c\/li\x3e\n\x3cli\x3e业务方通过什么方式来调用我们的采集脚本\x3c\/li\x3e\n\x3cli\x3e手动埋点：SDK 需要封装一个方法给业务方进行调用，传参方式业务方可控\x3c\/li\x3e\n\x3cli\x3e无埋点：考虑到数据量对于服务器的压力，我们需要对无埋点进行开关配置，可以配置进行哪些元素进行无埋点采集\x3c\/li\x3e\n\x3cli\x3e用户标识：游客用户和登录用户的采集数据怎么进行区分关联\x3c\/li\x3e\n\x3cli\x3e设备Id：用户通过浏览器来访问 web 页面，设备Id需要存储在浏览器上，同一个用户访问不同的业务方网站，设备Id要保持一样，怎么实现\x3c\/li\x3e\n\x3cli\x3e单页面应用：现在流行的单页面应用和普通 web 页面的数据采集是否有差异\x3c\/li\x3e\n\x3cli\x3e混合应用：app 与 h5 的混合应用我们要怎么进行通讯\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch4\x3e我们要采集什么内容，进行哪些采集接口的约定\x3c\/h4\x3e\n\x3cp\x3e第一期我们先实现对 PV（即页面浏览量或点击量） 、UV（一天内同个访客多次访问） 、点击量、用户的访问路径的基础指标的采集。精细化分析的流量转化需要和业务相关，需要和数据分析方做约定，我们预留扩展。所以我们的采集接口需要进行以下的约定\x3c\/p\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22{\n    \x26quot;header\x26quot;:{ \/\/ HTTP 头部\n        \x26quot;X-Device-Id\x26quot;:\x26quot; 550e8400-e29b-41d4-a716-446655440000\x26quot;, \/\/设备ID，用来区分用户设备\n        \x26quot;X-Source-Url\x26quot;:\x26quot;https:\/\/www.baidu.com\/\x26quot;, \/\/源地址，关联用户的整个操作流程，用于用户行为路径分析，例如登录，到首页，进入商品详情，退出这一整个完整的路径\n        \x26quot;X-Current-Url\x26quot;:\x26quot;\x26quot;, \/\/当前地址，用户行为发生的页面\n        \x26quot;X-User-Id\x26quot;:\x26quot;\x26quot;,\/\/用户ID，统计登录用户行为\n    },\n    \x26quot;body\x26quot;:[{ \/\/ HTTP Body体\n        \x26quot;PageSessionID\x26quot;:\x26quot;\x26quot;, \/\/页面标识ID，用来区分页面事件，例如加载和离开我们会发两个事件，这个标识可以让我们知道这个事件是发生在一个页面上\n        \x26quot;Event\x26quot;:\x26quot;loaded\x26quot;, \/\/事件类型，区分用户行为事件\n        \x26quot;PageTitle\x26quot;:  \x26quot;埋点测试页\x26quot;,  \/\/页面标题，直观看到用户访问页面\n        \x26quot;CurrentTime\x26quot;:  “1517798922201”,  \/\/事件发生的时间\n        \x26quot;ExtraInfo\x26quot;:  {\n         }    \/\/扩展字段，对具体业务分析的传参\n    }]\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs 1c\x22\x3e\x3ccode\x3e{\n    \x3cspan class=\x22hljs-string\x22\x3e\x22header\x22\x3c\/span\x3e:{ \x3cspan class=\x22hljs-comment\x22\x3e\/\/ HTTP 头部\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22X-Device-Id\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22 550e8400-e29b-41d4-a716-446655440000\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/\/设备ID，用来区分用户设备\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22X-Source-Url\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22https:\/\/www.baidu.com\/\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/\/源地址，关联用户的整个操作流程，用于用户行为路径分析，例如登录，到首页，进入商品详情，退出这一整个完整的路径\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22X-Current-Url\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/\/当前地址，用户行为发生的页面\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22X-User-Id\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e,\x3cspan class=\x22hljs-comment\x22\x3e\/\/用户ID，统计登录用户行为\x3c\/span\x3e\n    },\n    \x3cspan class=\x22hljs-string\x22\x3e\x22body\x22\x3c\/span\x3e:[{ \x3cspan class=\x22hljs-comment\x22\x3e\/\/ HTTP Body体\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22PageSessionID\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/\/页面标识ID，用来区分页面事件，例如加载和离开我们会发两个事件，这个标识可以让我们知道这个事件是发生在一个页面上\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22Event\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22loaded\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/\/事件类型，区分用户行为事件\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22PageTitle\x22\x3c\/span\x3e:  \x3cspan class=\x22hljs-string\x22\x3e\x22埋点测试页\x22\x3c\/span\x3e,  \x3cspan class=\x22hljs-comment\x22\x3e\/\/页面标题，直观看到用户访问页面\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22CurrentTime\x22\x3c\/span\x3e:  “\x3cspan class=\x22hljs-number\x22\x3e1517798922201\x3c\/span\x3e”,  \x3cspan class=\x22hljs-comment\x22\x3e\/\/事件发生的时间\x3c\/span\x3e\n        \x3cspan class=\x22hljs-string\x22\x3e\x22ExtraInfo\x22\x3c\/span\x3e:  {\n         }    \x3cspan class=\x22hljs-comment\x22\x3e\/\/扩展字段，对具体业务分析的传参\x3c\/span\x3e\n    }]\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3cp\x3e以上就是我们现在约定好了的通用的事件采集的接口，所传的参数基本上会根据采集事件的不同而发生变化。但是在用户的整一个访问行为中，用户的设备是不会变化的，如果你想采集设备信息可以重新约定一个接口，在整个采集开始之前发送设备信息，这样可以避免在事件采集接口上重复采集固定数据。\x3c\/p\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22{\n    \x26quot;header\x26quot;:{ \/\/ HTTP 头部\n          \x26quot;X-Device-Id\x26quot;  ：\x26quot;550e8400-e29b-41d4-a716-446655440000\x26quot;  ,      \/\/  设备id\n    },\n    \x26quot;body\x26quot;:{ \/\/ HTTP Body体\n              \x26quot;DeviceType\x26quot;:  \x26quot;web\x26quot; ,   \/\/设备类型\n             \x26quot;ScreenWide\x26quot;  :  768 , \/\/  屏幕宽\n             \x26quot;ScreenHigh\x26quot;:  1366 , \/\/  屏幕高\n             \x26quot;Language\x26quot;:    \x26quot;zh-cn\x26quot;  \/\/语言\n    }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs 1c\x22\x3e\x3ccode\x3e{\n    \x3cspan class=\x22hljs-string\x22\x3e\x22header\x22\x3c\/span\x3e:{ \x3cspan class=\x22hljs-comment\x22\x3e\/\/ HTTP 头部\x3c\/span\x3e\n          \x3cspan class=\x22hljs-string\x22\x3e\x22X-Device-Id\x22\x3c\/span\x3e  ：\x3cspan class=\x22hljs-string\x22\x3e\x22550e8400-e29b-41d4-a716-446655440000\x22\x3c\/span\x3e  ,      \x3cspan class=\x22hljs-comment\x22\x3e\/\/  设备id\x3c\/span\x3e\n    },\n    \x3cspan class=\x22hljs-string\x22\x3e\x22body\x22\x3c\/span\x3e:{ \x3cspan class=\x22hljs-comment\x22\x3e\/\/ HTTP Body体\x3c\/span\x3e\n              \x3cspan class=\x22hljs-string\x22\x3e\x22DeviceType\x22\x3c\/span\x3e:  \x3cspan class=\x22hljs-string\x22\x3e\x22web\x22\x3c\/span\x3e ,   \x3cspan class=\x22hljs-comment\x22\x3e\/\/设备类型\x3c\/span\x3e\n             \x3cspan class=\x22hljs-string\x22\x3e\x22ScreenWide\x22\x3c\/span\x3e  :  \x3cspan class=\x22hljs-number\x22\x3e768\x3c\/span\x3e , \x3cspan class=\x22hljs-comment\x22\x3e\/\/  屏幕宽\x3c\/span\x3e\n             \x3cspan class=\x22hljs-string\x22\x3e\x22ScreenHigh\x22\x3c\/span\x3e:  \x3cspan class=\x22hljs-number\x22\x3e1366\x3c\/span\x3e , \x3cspan class=\x22hljs-comment\x22\x3e\/\/  屏幕高\x3c\/span\x3e\n             \x3cspan class=\x22hljs-string\x22\x3e\x22Language\x22\x3c\/span\x3e:    \x3cspan class=\x22hljs-string\x22\x3e\x22zh-cn\x22\x3c\/span\x3e  \x3cspan class=\x22hljs-comment\x22\x3e\/\/语言\x3c\/span\x3e\n    }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3ch4\x3e业务方通过什么方式来调用我们的采集脚本\x3c\/h4\x3e\n\x3cp\x3e埋点应该让调用的业务方，尽可能少有工作量，最好是什么都不用做，😁，但是实现起来有点难额。我们采用的方案是让业务方在代码里通过 script 脚本来引用我们的 SDK ，业务方只要配置一些需要的参数进行埋点定制（👆我们讲到过的无埋点的流量控制），然后什么都不做就可以进行基础数据的采集。\x3c\/p\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22(function() {\n            var collect = document.createElement(\x27script\x27);\n            collect.type = \x27text\/javascript\x27;\n            collect.async = true;\n            collect.src =  \x27http:\/\/collect.trc.com\/index.js\x27;\n            var s = document.getElementsByTagName(\x27script\x27)[0];\n            s.parentNode.insertBefore(collect, s);\n    })();\n\n\n\/\/用户自定义要进行无埋点采集的元素，如果不进行无埋点采集，可以不配置\n var _XT = [];\n  _XT.push([\x27Target\x27,\x27div\x27]);\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e collect = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x27script\x27\x3c\/span\x3e);\n            collect.type = \x3cspan class=\x22hljs-string\x22\x3e\x27text\/javascript\x27\x3c\/span\x3e;\n            collect.async = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n            collect.src =  \x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/collect.trc.com\/index.js\x27\x3c\/span\x3e;\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e s = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementsByTagName(\x3cspan class=\x22hljs-string\x22\x3e\x27script\x27\x3c\/span\x3e)[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e];\n            s.parentNode.insertBefore(collect, s);\n    })();\n\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/用户自定义要进行无埋点采集的元素，如果不进行无埋点采集，可以不配置\x3c\/span\x3e\n \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e _XT = [];\n  _XT.push([\x3cspan class=\x22hljs-string\x22\x3e\x27Target\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x27div\x27\x3c\/span\x3e]);\n\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3ch4\x3e手动埋点：SDK\x3c\/h4\x3e\n\x3cp\x3e如果业务方需要采集更多业务定制的数据，可以调用我们暴露出的方法进行采集\x3cbr\x3e\x3ccode\x3e\x3c\/code\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/自定义事件\n  sdk.dispatch(\x27customEvent\x27,{extraInfo:\x27自定义事件的额外信息\x27})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs groovy\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/自定义事件\x3c\/span\x3e\n  sdk.dispatch(\x3cspan class=\x22hljs-string\x22\x3e\x27customEvent\x27\x3c\/span\x3e,{\x3cspan class=\x22hljs-string\x22\x3eextraInfo:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x27自定义事件的额外信息\x27\x3c\/span\x3e})\n\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3ch4\x3e游客与用户关联\x3c\/h4\x3e\n\x3cp\x3e我们使用 userId 来做用户标识，同一个设备的用户，从游客用户切换到登录用户，如果我们要把他们关联起来，需要有一个设备Id 做关联\x3c\/p\x3e\n\x3ch4\x3eweb 设备Id\x3c\/h4\x3e\n\x3cp\x3e用户通过浏览器来访问 web 页面，设备Id需要存储在浏览器上，同一个用户访问不同的业务方网站，设备Id要保持一样。web 变量存储，我们第一时间想到的就是 cookie，sessionStorage，localStorage，但是这3种存储方式都和访问资源的域名相关。我们总不能每次访问一个网站就新建一个设备指纹吧，所以我们需要通过一个方法来跨域共享设备指纹\x3c\/p\x3e\n\x3cp\x3e我们想到的方案是，通过嵌套 iframe 加载一个静态页面，在 iframe 上加载的域名上存储设备id，通过跨域共享变量获取设备id，共享变量的原理是采用了iframe 的 contentWindow通讯，通过 postMessage 获取事件状态，调用封装好的回调函数进行数据处理具体的实现方式\x3c\/p\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/web 应用，通过嵌入 iframe 进行跨域 cookie 通讯，设置设备id,\n    collect.setIframe = function () {\n        var that = this\n        var iframe = document.createElement(\x27iframe\x27)\n        iframe.id = \x26quot;frame\x26quot;,\n        iframe.src = \x27http:\/\/collectiframe.trc.com\x27 \/\/ 配置域名代理，目的是让开发测试生产环境代码一致\n        iframe.style.display=\x27none\x27 \/\/iframe 设置的目的是用来生成固定的设备id，不展示\n        document.body.appendChild(iframe)\n\n        iframe.onload = function () {\n                iframe.contentWindow.postMessage(\x27loaded\x27,\x27*\x27);\n        }\n\n        \/\/监听message事件，iframe 加载完成，获取设备id ，进行相关的数据采集\n        helper.on(window,\x26quot;message\x26quot;,function(event){\n            that.deviceId = event.data.deviceId\n\n            if(event.data \x26amp;\x26amp; event.data.type == \x27loaded\x27){\n                that.sendDevice(that.getDevice(), that.deviceUrl);\n                setTimeout(function () {\n                    that.send(that.beforeload)\n                    that.send(that.loaded)\n                },1000)\n            }\n        })\n    }\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/web 应用，通过嵌入 iframe 进行跨域 cookie 通讯，设置设备id,\x3c\/span\x3e\n    collect.setIframe = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e that = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e iframe = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x27iframe\x27\x3c\/span\x3e)\n        iframe.id = \x3cspan class=\x22hljs-string\x22\x3e\x22frame\x22\x3c\/span\x3e,\n        iframe.src = \x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/collectiframe.trc.com\x27\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 配置域名代理，目的是让开发测试生产环境代码一致\x3c\/span\x3e\n        iframe.style.display=\x3cspan class=\x22hljs-string\x22\x3e\x27none\x27\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/iframe 设置的目的是用来生成固定的设备id，不展示\x3c\/span\x3e\n        \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.body.appendChild(iframe)\n\n        iframe.onload = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                iframe.contentWindow.postMessage(\x3cspan class=\x22hljs-string\x22\x3e\x27loaded\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x27*\x27\x3c\/span\x3e);\n        }\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/监听message事件，iframe 加载完成，获取设备id ，进行相关的数据采集\x3c\/span\x3e\n        helper.on(\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x22message\x22\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eevent\x3c\/span\x3e)\x3c\/span\x3e{\n            that.deviceId = event.data.deviceId\n\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(event.data \x26amp;\x26amp; event.data.type == \x3cspan class=\x22hljs-string\x22\x3e\x27loaded\x27\x3c\/span\x3e){\n                that.sendDevice(that.getDevice(), that.deviceUrl);\n                setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                    that.send(that.beforeload)\n                    that.send(that.loaded)\n                },\x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e)\n            }\n        })\n    }\n\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3cp\x3eiframe 与 SDK 通讯\x3c\/p\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function receiveMessageFromIndex ( event ) {\n    getDeviceInfo() \/\/ 获取设备信息\n    var data =  {\n            deviceId: _deviceId,\n            type:event.data\n    }\n\n    event.source.postMessage(data, \x27*\x27); \/\/ 将设备信息发送给 SDK\n}\n\n\/\/监听message事件\nif(window.addEventListener){\n        window.addEventListener(\x26quot;message\x26quot;, receiveMessageFromIndex, false);\n}else{\n        window.attachEvent(\x26quot;onmessage\x26quot;, receiveMessageFromIndex, false)\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereceiveMessageFromIndex\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e event \x3c\/span\x3e) \x3c\/span\x3e{\n    getDeviceInfo() \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 获取设备信息\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e data =  {\n            \x3cspan class=\x22hljs-attr\x22\x3edeviceId\x3c\/span\x3e: _deviceId,\n            \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e:event.data\n    }\n\n    event.source.postMessage(data, \x3cspan class=\x22hljs-string\x22\x3e\x27*\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 将设备信息发送给 SDK\x3c\/span\x3e\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/监听message事件\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.addEventListener){\n        \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x22message\x22\x3c\/span\x3e, receiveMessageFromIndex, \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e);\n}\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.attachEvent(\x3cspan class=\x22hljs-string\x22\x3e\x22onmessage\x22\x3c\/span\x3e, receiveMessageFromIndex, \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e)\n\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3cp\x3e如果你想知道可以看我的另一篇博客 \x3ca href=\x22https:\/\/bailinlin.github.io\/2018\/03\/05\/cookie-share\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eweb 浏览器指纹跨域共享\x3c\/a\x3e\x3c\/p\x3e\n\x3ch4\x3e单页面应用：现在流行的单页面应用和普通 web 页面的数据采集是否有差异\x3c\/h4\x3e\n\x3cblockquote\x3e我们知道单页面应用都是无刷新的页面加载，所以我们在页面\x3ccode\x3e跳转\x3c\/code\x3e的处理和我们的普通的页面会有所不同。单页面应用的路由插件运用了 window 自带的无刷新修改用户浏览记录的方法，pushState 和 replaceState。\x3c\/blockquote\x3e\n\x3cp\x3ewindow 的 history 对象 提供了两个方法，能够无刷新的修改用户的浏览记录，pushSate，和 replaceState，区别的 pushState 在用户访问页面后面添加一个访问记录， replaceState 则是直接替换了当前访问记录，所以我们只要改写 history 的方法，在方法执行前执行我们的采集方法就能实现对单页面应用的页面跳转事件的采集了\x3c\/p\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22 \/\/ 改写思路：拷贝 window 默认的 replaceState 函数，重写 history.replaceState 在方法里插入我们的采集行为，在重写的 replaceState 方法最后调用，window 默认的 replaceState 方法\n\n    collect = {}\n    collect.onPushStateCallback : function(){}  \/\/ 自定义的采集方法\n\n    (function(history){\n        var replaceState = history.replaceState;   \/\/ 存储原生 replaceState\n        history.replaceState = function(state, param) {     \/\/ 改写 replaceState\n           var url = arguments[2];\n           if (typeof collect.onPushStateCallback == \x26quot;function\x26quot;) {\n                 collect.onPushStateCallback({state: state, param: param, url: url});   \/\/自定义的采集行为方法\n           }\n           return replaceState.apply(history, arguments);    \/\/ 调用原生的 replaceState\n        };\n     })(window.history);\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs qml\x22\x3e\x3ccode\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 改写思路：拷贝 window 默认的 replaceState 函数，重写 history.replaceState 在方法里插入我们的采集行为，在重写的 replaceState 方法最后调用，window 默认的 replaceState 方法\x3c\/span\x3e\n\n    collect = {}\n    \x3cspan class=\x22hljs-attribute\x22\x3ecollect.onPushStateCallback\x3c\/span\x3e : \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{}  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 自定义的采集方法\x3c\/span\x3e\n\n    (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ehistory\x3c\/span\x3e)\x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3evar\x3c\/span\x3e replaceState = history.replaceState;   \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 存储原生 replaceState\x3c\/span\x3e\n        history.replaceState = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3estate, param\x3c\/span\x3e) \x3c\/span\x3e{     \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 改写 replaceState\x3c\/span\x3e\n           \x3cspan class=\x22hljs-built_in\x22\x3evar\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eurl\x3c\/span\x3e = \x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e];\n           \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e collect.onPushStateCallback == \x3cspan class=\x22hljs-string\x22\x3e\x22function\x22\x3c\/span\x3e) {\n                 collect.onPushStateCallback({\x3cspan class=\x22hljs-attribute\x22\x3estate\x3c\/span\x3e: state, \x3cspan class=\x22hljs-attribute\x22\x3eparam\x3c\/span\x3e: param, \x3cspan class=\x22hljs-attribute\x22\x3eurl\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eurl\x3c\/span\x3e});   \x3cspan class=\x22hljs-comment\x22\x3e\/\/自定义的采集行为方法\x3c\/span\x3e\n           }\n           \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e replaceState.apply(history, \x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e);    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用原生的 replaceState\x3c\/span\x3e\n        };\n     })(\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.history);\n\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3cp\x3e这块介绍起来也比较的复杂，如果你想了解更多，可以看我的另一篇博客\x3ca href=\x22https:\/\/bailinlin.github.io\/2018\/04\/28\/history\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e你需要知道的单页面路由实现原理\x3c\/a\x3e\x3c\/p\x3e\n\x3ch4\x3e混合应用：app 与 h5 的混合应用我们要怎么进行通讯\x3c\/h4\x3e\n\x3cblockquote\x3e现在大部分的应用都不是纯原生的应用， app 与 h5 的混合的应用是现在的一种主流。\x3c\/blockquote\x3e\n\x3cp\x3e纯 web 数据采集我们考虑到前端存储数据容易丢失，我们在每一次事件触发的时候都用采集接口传输采集到的数据。考虑到现在很多用户的手机会有流量管家的软件监控，如果在 App 中 h5 还是采集到数据就传输给服务端，很有可能会让流量管家检测到，给用户报警，从而使得用户不再信任你的 App , 所以我们在用户操作的时候将数据传给 app 端，存储到 app。用户切换应用到后台的时候，通过 app 端的 SDK 打包传输到服务器，我们给 app 提供的方法封装了一个适配器\x3c\/p\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ app 与 h5 混合应用，直接将数信息发给 app\ncollect.saveEvent = function (jsonString) {\n\n    collect.dcpDeviceType \x26amp;\x26amp; setTimeout(function () {\n        if(collect.dcpDeviceType==\x27android\x27){\n            android.saveEvent(jsonString)\n        } else {\n            window.webkit \x26amp;\x26amp; window.webkit.messageHandlers ? window.webkit.messageHandlers.nativeBridge.postMessage(jsonString) : window.postBridgeMessage(jsonString)\n        }\n\n    },1000)\n    }\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ app 与 h5 混合应用，直接将数信息发给 app\x3c\/span\x3e\ncollect.saveEvent = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3ejsonString\x3c\/span\x3e) \x3c\/span\x3e{\n\n    collect.dcpDeviceType \x26amp;\x26amp; setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(collect.dcpDeviceType==\x3cspan class=\x22hljs-string\x22\x3e\x27android\x27\x3c\/span\x3e){\n            android.saveEvent(jsonString)\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.webkit \x26amp;\x26amp; \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.webkit.messageHandlers ? \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.webkit.messageHandlers.nativeBridge.postMessage(jsonString) : \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.postBridgeMessage(jsonString)\n        }\n\n    },\x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e)\n    }\n\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3ch3 id=\x22articleHeader3\x22\x3e实现思路\x3c\/h3\x3e\n\x3cblockquote\x3e通过上面几个问题的思考，我们对埋点的实现大致已经有了一些想法，我们使用思维导图来还原下我们即将要做的事情，图片记得放大看哦，太小了可能看不清。\x3c\/blockquote\x3e\n\x3cp\x3e我们需要暴露给业务方调用的方法\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000014922673?w=822\x26amp;h=397\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000014922673?w=822\x26amp;h=397\x22 alt=\x22暴露方法\x22 title=\x22暴露方法\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3cbr\x3e 我们需要处理的事件类型\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000014922674?w=1292\x26amp;h=580\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000014922674?w=1292\x26amp;h=580\x22 alt=\x22监听事件\x22 title=\x22监听事件\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3cbr\x3eSDK 的基本实现思路\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000014922675?w=1623\x26amp;h=721\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000014922675?w=1623\x26amp;h=721\x22 alt=\x22实现逻辑\x22 title=\x22实现逻辑\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e我们来看下几个核心代码的实现\x3c\/h3\x3e\n\x3ch4\x3e工具方法\x3c\/h4\x3e\n\x3cp\x3e我们定义了几个工具方法，提高开发的幸福指数 😝\x3c\/p\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    var helper = {};\n\n    \/\/ 生成一个唯一的标识，pageSessionId （用这个变量来关联开始加载、加载完成、离开页面的事件，计算出页面加菜时间，停留时间）\n    helper.uuid = function(){}\n\n    \/\/ 元素绑定事件监听，兼容浏览器到IE8\n    helper.on = function(){}\n\n    \/\/元素移除事件监听的适配器函数，兼容浏览器到IE8\n    helper.remove = function(){}\n\n    \/\/将json转为字符串,事件传输的参数类型转化\n    helper.changeJSON2Query = function(){}\n\n    \/\/将相对路径解析成文档全路径\n    helper.normalize = function(){}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3e    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e helper = {};\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 生成一个唯一的标识，pageSessionId （用这个变量来关联开始加载、加载完成、离开页面的事件，计算出页面加菜时间，停留时间）\x3c\/span\x3e\n    helper.uuid = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 元素绑定事件监听，兼容浏览器到IE8\x3c\/span\x3e\n    helper.on = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/元素移除事件监听的适配器函数，兼容浏览器到IE8\x3c\/span\x3e\n    helper.remove = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/将json转为字符串,事件传输的参数类型转化\x3c\/span\x3e\n    helper.changeJSON2Query = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/将相对路径解析成文档全路径\x3c\/span\x3e\n    helper.normalize = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3ch4\x3e采集逻辑\x3c\/h4\x3e\n\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    var collect = {\n        deviceUrl:\x27http:\/\/collect.trc.com\/rest\/collect\/device\/h5\/v1\x27,\n        eventUrl:\x27http:\/\/collect.trc.com\/rest\/collect\/event\/h5\/v1\x27,\n        isuploadUrl:\x27http:\/\/collect.trc.com\/rest\/collect\/isupload\/app\/v1\x27,\n        parmas:{ ExtraInfo:{} },\n        device:{}\n    };\n\n    \/\/获取埋点配置\n    collect.setParames = function(){}\n\n    \/\/更新访问路径及页面信息\n    collect.updatePageInfo = function(){}\n\n    \/\/获取事件参数\n    collect.getParames = function(){}\n\n    \/\/获取设备信息\n    collect.getDevice = function(){}\n\n    \/\/事件采集\n    collect.send = function(){}\n\n    \/\/设备采集\n    collect.sendDevice = function(){}\n\n    \/\/判断才否采集，埋点采集的开关\n    collect.isupload = function(){\n\n        1. 判断是否采集，不采集就注销事件监听（项目中区分游客身份和用户身份的采集情况，这个方法会被判断两次）\n        2. 采集则判断是否已经采集过\n            a.已经采集过不做任何操作\n            b.没有采集过添加事件监听\n        3. 判断是 混合应用还是纯 web 应用\n            a.如果是web 应用，调用 collect.setIframe 设置 iframe\n            b.如果是混合应用 将开始加载和加载完成事件传输给 app\n    }\n\n    \/\/点击事件处理函数\n    collect.clickHandler = function(){}\n\n    \/\/离开页面的事件处理函数\n    collect.beforeUnloadHandler = function(){}\n\n    \/\/页面回退事件处理函数\n    collect.onPopStateHandler = function(){}\n\n    \/\/系统事件初始化，注册离开事件，浏览器后退事件\n    collect.event = function(){}\n\n    \/\/获取记录开始加载数据信息\n    collect.getBeforeload = function(){}\n\n    \/\/存储加载完成，获取设备类型，记录加载完成信息\n    collect.onload = function(){\n\n        1. 判断cookie是否有存设备类型信息，有表示混合应用\n        2. 采集加载完成时间等信息\n        3. 调用 collect.isupload 判断是否进行采集\n    }\n\n    \/\/web 应用，通过嵌入 iframe 进行跨域 cookie 通讯，设置设备id\n    collect.setIframe = function(){}\n\n    \/\/app 与 h5 混合应用，直接将数信息发给 app,判断设备类型做原生方法适配器\n    collect.saveEvent = function(){}\n\n    \/\/采集自定义事件类型\n    collect.dispatch = function(){}\n\n    \/\/将参数 userId 存入sessionStorage\n    collect.storeUserId = function(){}\n\n    \/\/采集H5信息,如果是混合应用，将采集到的信息发送给 app 端\n    collect.saveEventInfo = function(){}\n\n    \/\/页面初始化调用方法\n    collect.init = function(){\n\n        1. 获取开始加载的采集信息\n        2. 获取 SDK 配置信息，设备信息\n        3. 改写 history 两个方法，单页面应用页面跳转前调用我们自己的方法\n        4. 页面加载完成，调用 collect.onload 方法\n\n    }\n\n\n    collect.init(); \/\/ 初始化\n\n    \/\/暴露给业务方调用的方法\n    return {\n        dispatch:collect.dispatch,\n        storeUserId:collect.storeUserId,\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3e    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e collect = {\n        deviceUrl:\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/collect.trc.com\/rest\/collect\/device\/h5\/v1\x27\x3c\/span\x3e,\n        eventUrl:\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/collect.trc.com\/rest\/collect\/event\/h5\/v1\x27\x3c\/span\x3e,\n        isuploadUrl:\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/collect.trc.com\/rest\/collect\/isupload\/app\/v1\x27\x3c\/span\x3e,\n        parmas:{ ExtraInfo:{} },\n        device:{}\n    };\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/获取埋点配置\x3c\/span\x3e\n    collect.setParames = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/更新访问路径及页面信息\x3c\/span\x3e\n    collect.updatePageInfo = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/获取事件参数\x3c\/span\x3e\n    collect.getParames = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/获取设备信息\x3c\/span\x3e\n    collect.getDevice = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/事件采集\x3c\/span\x3e\n    collect.send = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/设备采集\x3c\/span\x3e\n    collect.sendDevice = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/判断才否采集，埋点采集的开关\x3c\/span\x3e\n    collect.isupload = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{\n\n        \x3cspan class=\x22hljs-number\x22\x3e1.\x3c\/span\x3e 判断是否采集，不采集就注销事件监听（项目中区分游客身份和用户身份的采集情况，这个方法会被判断两次）\n        \x3cspan class=\x22hljs-number\x22\x3e2.\x3c\/span\x3e 采集则判断是否已经采集过\n            a.已经采集过不做任何操作\n            b.没有采集过添加事件监听\n        \x3cspan class=\x22hljs-number\x22\x3e3.\x3c\/span\x3e 判断是 混合应用还是纯 web 应用\n            a.如果是web 应用，调用 collect.setIframe 设置 iframe\n            b.如果是混合应用 将开始加载和加载完成事件传输给 app\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/点击事件处理函数\x3c\/span\x3e\n    collect.clickHandler = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/离开页面的事件处理函数\x3c\/span\x3e\n    collect.beforeUnloadHandler = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/页面回退事件处理函数\x3c\/span\x3e\n    collect.onPopStateHandler = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/系统事件初始化，注册离开事件，浏览器后退事件\x3c\/span\x3e\n    collect.event = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/获取记录开始加载数据信息\x3c\/span\x3e\n    collect.getBeforeload = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/存储加载完成，获取设备类型，记录加载完成信息\x3c\/span\x3e\n    collect.onload = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{\n\n        \x3cspan class=\x22hljs-number\x22\x3e1.\x3c\/span\x3e 判断cookie是否有存设备类型信息，有表示混合应用\n        \x3cspan class=\x22hljs-number\x22\x3e2.\x3c\/span\x3e 采集加载完成时间等信息\n        \x3cspan class=\x22hljs-number\x22\x3e3.\x3c\/span\x3e 调用 collect.isupload 判断是否进行采集\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/web 应用，通过嵌入 iframe 进行跨域 cookie 通讯，设置设备id\x3c\/span\x3e\n    collect.setIframe = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/app 与 h5 混合应用，直接将数信息发给 app,判断设备类型做原生方法适配器\x3c\/span\x3e\n    collect.saveEvent = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/采集自定义事件类型\x3c\/span\x3e\n    collect.dispatch = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/将参数 userId 存入sessionStorage\x3c\/span\x3e\n    collect.storeUserId = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/采集H5信息,如果是混合应用，将采集到的信息发送给 app 端\x3c\/span\x3e\n    collect.saveEventInfo = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{}\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/页面初始化调用方法\x3c\/span\x3e\n    collect.init = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{\n\n        \x3cspan class=\x22hljs-number\x22\x3e1.\x3c\/span\x3e 获取开始加载的采集信息\n        \x3cspan class=\x22hljs-number\x22\x3e2.\x3c\/span\x3e 获取 SDK 配置信息，设备信息\n        \x3cspan class=\x22hljs-number\x22\x3e3.\x3c\/span\x3e 改写 history 两个方法，单页面应用页面跳转前调用我们自己的方法\n        \x3cspan class=\x22hljs-number\x22\x3e4.\x3c\/span\x3e 页面加载完成，调用 collect.onload 方法\n\n    }\n\n\n    collect.init(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始化\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/暴露给业务方调用的方法\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n        dispatch:collect.dispatch,\n        storeUserId:collect.storeUserId,\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\n\x3ch3 id=\x22articleHeader5\x22\x3e扩展\x3c\/h3\x3e\n\x3cblockquote\x3e👆就是我这段时间研究的成果了，代码的篇幅比较长，就不放在博客里了，感兴趣的同学可以加我微信进行交流，或则在文章下面留言，也欢迎大家给我提意见，帮忙优化 😝。\x3c\/blockquote\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/bailinlin.github.io\/2018\/03\/05\/cookie-share\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eweb 浏览器指纹跨域共享\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/bailinlin.github.io\/2018\/04\/28\/history\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e你需要知道的单页面路由实现原理\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/www.zhihu.com\/question\/36411025\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e数据埋点是什么？设置埋点的意义是什么？\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/sensorsdata.cn\/blog\/shu-ju-jie-ru-yu-mai-dian\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e数据采集与埋点\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/tech.meituan.com\/mt-mobile-analytics-practice.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e美团点评前端无痕埋点实践\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/www.zhihu.com\/question\/20448467\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e如何清楚易懂的解释“UV和PV＂的定义\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>web 埋点实现原理了解一下</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000014922668">https://segmentfault.com/a/1190000014922668</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/3daonkv4btl/" target="_blank">https://alili.tech/archive/3daonkv4btl/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>