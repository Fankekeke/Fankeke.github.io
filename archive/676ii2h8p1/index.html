<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="through2原理解析"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>through2原理解析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/676ii2h8p1/",
				"appid": "1613049289050283", 
				"title": "through2原理解析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-27T02:30:13"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/g8727rmhvhd/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/rq12kb11p2n/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f&text=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f&text=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f&title=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f&is_video=false&description=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f&title=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f&title=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f&title=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f676ii2h8p1%2f&title=through2%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">through2原理解析</h1><div class="meta"><div class="postdate"><time datetime="2018-12-27" itemprop="datePublished">2018-12-27</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e写在前面\x3c\/h2\x3e\n\x3cp\x3e\x3ccode\x3ethrough2\x3c\/code\x3e经常被用于处理\x3ccode\x3enode\x3c\/code\x3e的\x3ccode\x3estream\x3c\/code\x3e，假如使用过\x3ccode\x3egulp\x3c\/code\x3e的话，对于这个包一定不会陌生，如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22gulp.task(\x27rewrite\x27, () =\x3e {\n  return gulp.src(\x27.\/through\/enter.txt\x27)\n    .pipe(through2.obj(function(chunk, enc, callback) {\n      const { contents } = chunk;\n      for (var i = 0; i \x3c contents.length; i\x2b\x2b) {\n        if (contents[i] === 97) {\n          contents[i] = 122;\n        }\n      }\n\n      chunk.contents = contents;\n      this.push(chunk);\n\n      callback();\n    }))\n    .pipe(gulp.dest(\x27.\/dist\x27));\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3egulp.task(\x3cspan class=\x22hljs-string\x22\x3e\x27rewrite\x27\x3c\/span\x3e, () =\x26gt; {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e gulp.src(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/through\/enter.txt\x27\x3c\/span\x3e)\n    .pipe(through2.obj(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3echunk, enc, callback\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { contents } = chunk;\n      \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; contents.length; i\x2b\x2b) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (contents[i] === \x3cspan class=\x22hljs-number\x22\x3e97\x3c\/span\x3e) {\n          contents[i] = \x3cspan class=\x22hljs-number\x22\x3e122\x3c\/span\x3e;\n        }\n      }\n\n      chunk.contents = contents;\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.push(chunk);\n\n      callback();\n    }))\n    .pipe(gulp.dest(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/dist\x27\x3c\/span\x3e));\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里将文件中所有的字符\x3ccode\x3ea\x3c\/code\x3e转换为字符\x3ccode\x3ez\x3c\/code\x3e，在写\x3ccode\x3egulp\x3c\/code\x3e插件时一定会应用到这个包，下面就来窥探一下这个使用率非常高的包。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eTransform stream\x3c\/h2\x3e\n\x3cp\x3e\x3ccode\x3ethrough2\x3c\/code\x3e的源码仅仅就100多行，本质上就是对于\x3ccode\x3enode\x3c\/code\x3e原生的\x3ccode\x3etransform\x3c\/code\x3e流进行的封装，先来看下\x3ccode\x3eTransform stream\x3c\/code\x3e。\x3ccode\x3eTransform\x3c\/code\x3e是一个双工流，既可读，也可写，但是与\x3ccode\x3eDuplex\x3c\/code\x3e还是有着一些区别，\x3ccode\x3eDuplex\x3c\/code\x3e的写和读可以说是没有任何的关联，是两个缓冲区和管道互补干扰，而\x3ccode\x3eTransform\x3c\/code\x3e将其输入和输出是存在相互关联的，中间做了处理。具体差别可以参考下面图片对比：\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eDuplex stream\x3c\/code\x3e:\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVXikC?w=561\x26amp;h=340\x22 src=\x22https:\/\/static.alili.tech\/img\/bVXikC?w=561\x26amp;h=340\x22 alt=\x22Duplex 图示\x22 title=\x22Duplex 图示\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eTransform stream\x3c\/code\x3e:\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVXih2?w=555\x26amp;h=346\x22 src=\x22https:\/\/static.alili.tech\/img\/bVXih2?w=555\x26amp;h=346\x22 alt=\x22transform 图示\x22 title=\x22transform 图示\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eTransform stream\x3c\/code\x3e的两个缓存区相互关联，对于每个缓冲区来说，\x3ccode\x3ehighWaterMark\x3c\/code\x3e为阈值，超过阈值后，将会停止读或者写操作，如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let i = 0;\nconst readable = Readable({\n  highWaterMark: 2,\n  read: function () {\n    var data = i \x3c 26 ? String.fromCharCode(i\x2b\x2b \x2b 97) : null;\n    console.log(\x27push\x27, data);\n    this.push(data);\n  }\n});\n\nconst transform = Transform({\n  highWaterMark: 2,\n  transform: function (buf, enc, next) {\n    console.log(\x27transform\x27, buf.toString());\n    next(null, buf);\n  }\n})\n\nreadable.pipe(transform);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e readable = Readable({\n  \x3cspan class=\x22hljs-attr\x22\x3ehighWaterMark\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eread\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e data = i \x26lt; \x3cspan class=\x22hljs-number\x22\x3e26\x3c\/span\x3e ? \x3cspan class=\x22hljs-built_in\x22\x3eString\x3c\/span\x3e.fromCharCode(i\x2b\x2b \x2b \x3cspan class=\x22hljs-number\x22\x3e97\x3c\/span\x3e) : \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27push\x27\x3c\/span\x3e, data);\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.push(data);\n  }\n});\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e transform = Transform({\n  \x3cspan class=\x22hljs-attr\x22\x3ehighWaterMark\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3ebuf, enc, next\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27transform\x27\x3c\/span\x3e, buf.toString());\n    next(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, buf);\n  }\n})\n\nreadable.pipe(transform);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3estream\x3c\/code\x3e流向为：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVXiRw?w=451\x26amp;h=205\x22 src=\x22https:\/\/static.alili.tech\/img\/bVXiRw?w=451\x26amp;h=205\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e由于阈值为\x3ccode\x3e2\x3c\/code\x3e，所以只能\x3ccode\x3epush\x3c\/code\x3e到\x3ccode\x3ef\x3c\/code\x3e，这时\x3ccode\x3ereadable\x3c\/code\x3e的缓存区已满，\x3ccode\x3etransform\x3c\/code\x3e的读缓存区和写缓存区已经满了（由于\x3ccode\x3etransform\x3c\/code\x3e的两个缓存区的阈值为\x3ccode\x3e2\x3c\/code\x3e，所以写缓存区在写入\x3ccode\x3eb\x3c\/code\x3e之后就已经满了，后续不能继续写入），全部满之后，自然停止了读取，最终\x3ccode\x3ee,f\x3c\/code\x3e存在\x3ccode\x3eA\x3c\/code\x3e中，\x3ccode\x3ec,d\x3c\/code\x3e存在\x3ccode\x3eB\x3c\/code\x3e中，\x3ccode\x3ea,b\x3c\/code\x3e存在\x3ccode\x3eC\x3c\/code\x3e中，想要解决很简单，在添加一个流向就可以：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22readable.pipe(transform).pipe(process.stdout);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3ereadable.pipe(transform).pipe(process.stdout);\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3ethrough2源码\x3c\/h2\x3e\n\x3cp\x3e在了解\x3ccode\x3eTransform stream\x3c\/code\x3e之后，\x3ccode\x3ethrough2\x3c\/code\x3e的源码非常的简单，就是对于其的一层封装，暴露出三个\x3ccode\x3eapi\x3c\/code\x3e(\x3ccode\x3ethrough2\x3c\/code\x3e，\x3ccode\x3ethrough2.obj\x3c\/code\x3e，\x3ccode\x3ethrough2.ctor\x3c\/code\x3e)而且三者接收的参数一致，因为都是由一个工厂方法创造出的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function through2 (construct) {\n  return function (options, transform, flush) {\n    \/\/ 做了一些参数整理\n    if (typeof options == \x27function\x27) {\n      flush     = transform\n      transform = options\n      options   = {}\n    }\n\n    if (typeof transform != \x27function\x27)\n      transform = noop\n\n    if (typeof flush != \x27function\x27)\n      flush = null\n\n    return construct(options, transform, flush)\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ethrough2\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3econstruct\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eoptions, transform, flush\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 做了一些参数整理\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e options == \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n      flush     = transform\n      transform = options\n      options   = {}\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e transform != \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e)\n      transform = noop\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e flush != \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e)\n      flush = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e construct(options, transform, flush)\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e来看一下\x3ccode\x3ethrough2\x3c\/code\x3e对于\x3ccode\x3eTransform stream\x3c\/code\x3e的再加工，也就是源码中的\x3ccode\x3eDestroyableTransform\x3c\/code\x3e，与其名字一样，就是一个替我们实现好了\x3ccode\x3edestory\x3c\/code\x3e方法的\x3ccode\x3eTransform stream\x3c\/code\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22DestroyableTransform.prototype.destroy = function(err) {\n  if (this._destroyed) return\n  this._destroyed = true\n\n  var self = this\n  \/\/ 触发destory后，close掉流\n  process.nextTick(function() {\n    if (err)\n      self.emit(\x27error\x27, err)\n    self.emit(\x27close\x27)\n  })\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3eDestroyableTransform.prototype.destroy = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(err)\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._destroyed) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._destroyed = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e self = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 触发destory后，close掉流\x3c\/span\x3e\n  process.nextTick(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err)\n      self.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e, err)\n    self.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27close\x27\x3c\/span\x3e)\n  })\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3ethrough2\x3c\/code\x3e与\x3ccode\x3ethrough2.obj\x3c\/code\x3e全部是创造出一个再加工后的\x3ccode\x3eTransform\x3c\/code\x3e，区别如下：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e后者开启了对象模式（\x3ccode\x3eobjectMode\x3c\/code\x3e属性为\x3ccode\x3etrue\x3c\/code\x3e），写入的参数不仅仅限制在\x3ccode\x3estring or uint8Array\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3e后者降低了阈值（\x3ccode\x3ehighWaterMark\x3c\/code\x3e为\x3ccode\x3e16\x3c\/code\x3e，而不是默认的\x3ccode\x3e16kb\x3c\/code\x3e），这样做的原因，是为了和\x3ccode\x3enode\x3c\/code\x3e的默认保持一致，具体可以参见\x3ca href=\x22https:\/\/github.com\/rvagg\/through2\/pull\/18\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e这里\x3c\/a\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3ccode\x3ethrough2.ctor\x3c\/code\x3e可以用来再次定制，其返回的是一个构造函数，用法可以参考下面：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const Tran = through.ctor(function(chunk, enc, callback) {\n  console.log(\x27transform\x27, chunk.toString());\n  callback(null, chunk);\n});\nconst transform = new Tran();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Tran = through.ctor(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3echunk, enc, callback\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27transform\x27\x3c\/span\x3e, chunk.toString());\n  callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, chunk);\n});\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e transform = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Tran();\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e写在最后\x3c\/h2\x3e\n\x3cp\x3e\x3ccode\x3estream\x3c\/code\x3e在\x3ccode\x3enode\x3c\/code\x3e中有着非常广泛的应用，但是它使用起来却不是那么友好，\x3ccode\x3ethrogh2\x3c\/code\x3e的出现可以减少使用上的麻烦，其原理也非常的简单；以上内容均为本人理解，如有错误还请指出，不胜感激~\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>through2原理解析</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000011740894">https://segmentfault.com/a/1190000011740894</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/676ii2h8p1/" target="_blank">https://alili.tech/archive/676ii2h8p1/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>