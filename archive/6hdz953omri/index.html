<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="vue中使用微信公众号js-sdk踩坑记录（2）"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>vue中使用微信公众号js-sdk踩坑记录（2） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/6hdz953omri/",
				"appid": "1613049289050283", 
				"title": "vue中使用微信公众号js-sdk踩坑记录（2） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-23T02:30:07"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/tnlrpuiz56o/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/blz8xvqsgm8/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f&text=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f&text=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f&title=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f&is_video=false&description=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f&title=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f&title=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f&title=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f6hdz953omri%2f&title=vue%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%be%ae%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7js-sdk%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95%ef%bc%882%ef%bc%89"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">vue中使用微信公众号js-sdk踩坑记录（2）</h1><div class="meta"><div class="postdate"><time datetime="2018-12-23" itemprop="datePublished">2018-12-23</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e最近又在vue中捣鼓了下微信公众号api的接入，不得不说这里边水是真的深啊，上次分享了微信授权登录和js-sdk签名的部分，其中很多朋友私信我表示了疑惑，今天我就再次尝试理顺一下这里边的坑吧：\x3c\/p\x3e\n\x3cblockquote\x3e微信JS-SDK是微信公众平台面向网页开发者提供的基于微信内的网页开发工具包。\x3cbr\x3e通过使用微信JS-SDK，网页开发者可借助微信高效地使用拍照、选图、语音、位置等手机系统的能力，同时可以直接使用微信分享、扫一扫、卡券、支付等微信特有的能力，为微信用户提供更优质的网页体验。\x3c\/blockquote\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e分享页面到朋友圈\x3c\/h2\x3e\n\x3cp\x3e上文是从\x3ca href=\x22https:\/\/mp.weixin.qq.com\/wiki?t=resource\/res_main\x26amp;id=mp1421141115\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e官方文档\x3c\/a\x3e中摘出来的，由此可见，我们如果要实现在公众号的内嵌h5中实现微信分享，支付等功能，就得引入js-sdk。\x3cbr\x3e使用js-sdk有一个关键的环节，那就是通过config接口注入权限验证配置，而配置中有个signature参数是需要借助服务端获取的，这里就不过多探讨了，大家通过\x3ca href=\x22https:\/\/mp.weixin.qq.com\/wiki?t=resource\/res_main\x26amp;id=mp1421141115\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e官方文档\x3c\/a\x3e可以深入了解。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3eHash or History?\x3c\/h3\x3e\n\x3cp\x3e上篇文章，我推荐大家在vue中配置vue-router使用hash模式，那么hash模式和history模式到底有什么差别呢？我举个栗子，假设我们都通过\x3ccode\x3ehttp:\/\/domain.com\x3c\/code\x3e进入，然后跳转到路由为\x3ccode\x3e\/jssdk\x3c\/code\x3e的页面需要用到jssdk，那么实际js-sdk进行签名校验时所获取的当前页面url在ios和andrioid是不同的，这里我通过表格展示出来：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012339153?w=1744\x26amp;h=712\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012339153?w=1744\x26amp;h=712\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e真相都在表格里，我表达能力不好恕我偷个懒23333333。\x3c\/p\x3e\n\x3cp\x3e如果阁下没有接入分享指定页面的需求的话，hash模式很方便，但是无奈笔者需要接微信分享，如果使用hash模式，分享出去的地址，微信会自动处理掉#后边的部分，那么我就没法分享指定页面到朋友圈或者给朋友了。\x3cbr\x3e怎么办呢，只能硬着脑子解决history问题咯，其实也好解决，就是\x3cstrong\x3eiOS需要使用第一次进入页面的URL获取签名，安卓每次路由切换都重新配置签名\x3c\/strong\x3e。我这里罗列两个方案：\x3c\/p\x3e\n\x3cp\x3e1.入口文件中记录页面URL，在页面组件创建完成后，ios获取记录的url进行签名，android获取当前路由（\x3ccode\x3ewindow.location.href.split(\x27#\x27)[0]\x3c\/code\x3e），请移步我的\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000010753247?_ea=2944899\x22\x3e上一篇博客\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e2.入口文件中直接进行签名和注入配置，仅针对android在每次切换路由时再重新签名和配置。该方案适合所有页面都需要用到js-sdk的情况\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e问题记录\x3c\/h3\x3e\n\x3cp\x3e现列出我在捣鼓过程中遇到的一个个bug：\x3c\/p\x3e\n\x3cp\x3e1.安卓设备能分享ios设备不能分享；\x3cbr\x3e出现该问题的原因就是因为采用了history模式，且没有考虑到ios校验签名获取的url是第一次访问的url而使用了切换后的url。\x3c\/p\x3e\n\x3cp\x3e2.ios设备进入页面时不能分享，手动刷新页面后才能分享；\x3cbr\x3e多次测试后我发现，测试分享的时候，如果是访问的链接没带\x3ca href=\x22http:\/\/%E7%9A%84%E8%AF%9D\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/的话\x3c\/a\x3e，除了首页其他页面都是失效的，测试时落地页ur必须要加\x3ca\x3ehttp:\/\/\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e3.点击链接能正常分享，点击别人分享的图文消息之后不能分享；\x3cbr\x3e猜想1：点击图文消息时候，微信进行签名校验的url去掉了自己添加的参数，所以我们在进行签名时也要去掉微信添加的参数? 所以我把微信参数即\x3cbr\x3e`?from=singlemessage\x26amp;isappinstalled=0\x27这个部分去掉，结果依旧是分享失败，而我自己随意加一个参数，分享则正常，我随意加两个参数的时候，分享却又不正常了。\x3c\/p\x3e\n\x3cp\x3e猜想2: 微信分享进行签名校验的url仅能允许一个参数？所以我这样写：\x3cbr\x3e\x3ccode\x3eurl = location.href.split(\x27\x26amp;\x27)[0]\x3c\/code\x3e,验证后发现是错误的，再仔细一想我居然有这么可怕的想法，连官方文档都不相信了。\x3c\/p\x3e\n\x3cp\x3e猜想3：url难道需要进行编码？即\x3cbr\x3e\x3ccode\x3eurl = encodeURIComponent(window.location.href.split(\x27#\x27)[0])\x3c\/code\x3e经我多次debug，终于找到问题，就是需要对签名的url进行编码，word哥，不容易啊\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e仅需要对签名的url进行编码，分享配置中的url不需要编码\x3c\/strong\x3e\x3cbr\x3e\x3cstrong\x3e仅需要对签名的url进行编码，分享配置中的url不需要编码\x3c\/strong\x3e\x3cbr\x3e\x3cstrong\x3e仅需要对签名的url进行编码，分享配置中的url不需要编码\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e这里又是一个坑，务必小心。\x3c\/p\x3e\n\x3cp\x3e经常N次的debug和尝试之后我码了几十行代码，解决了以上所有问题，回首一看我真的是年轻啊，也就那么简单的逻辑，也许换个人一步就到位了，我却和各种各样的bug战斗了n多遍（改动一点代码就要上生产环境debug的心酸有谁能懂），唉。。。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3eCoding\x3c\/h3\x3e\n\x3cp\x3e分享一下我怎么按照第二种方案进行微信分享配置的\x3cbr\x3e由于我项目中需求是基本所有页面都需要能分享，所以在每个page组件中去获取签名是不实际的，所以我就想借助vue-router的after钩子去完成分享配置的操作，对于android则还需要重新进行签名。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ main.js\n...\nimport wx from \x27weixin-js-sdk\x27\nimport request from \x27axios\x27\n...\nrouter.afterEach((to, from) =\x3e {\n  let _url = window.location.origin \x2b to.fullPath\n  \/\/ 非ios设备，切换路由时候进行重新签名\n  if (window.__wxjs_is_wkwebview !== true) {\n    request.get(\x27\/api\/jssdk?url=\x27 \x2b encodeURIComponent(_url)).then(function (_lists) {\n      \/\/ 注入配置\n      wx.config({\n      ...\n      })\n    })\n  }\n  \/\/ 微信分享配置\n  wx.ready(function () {\n    wx.onMenuShareTimeline({\n     ...\n    })\n    wx.onMenuShareAppMessage({\n      ...\n    })\n  })\n})\n\n...\n\/\/ ios 设备进入页面则进行js-sdk签名\nif (window.__wxjs_is_wkwebview === true) {\n  let _url = window.location.href.split(\x27#\x27)[0]\n  request.get(\x27\/api\/jssdk?url=\x27 \x2b encodeURIComponent(_url)).then(function (res) {\n    let _lists = res\n    wx.config({\n      debug: false,\n      appId: _lists.appId,\n      timestamp: _lists.timestamp,\n      nonceStr: _lists.nonceStr,\n      signature: _lists.signature,\n      jsApiList: [\x27chooseImage\x27, \x27uploadImage\x27, \x27previewImage\x27, \x27onMenuShareTimeline\x27, \x27onMenuShareAppMessage\x27, \x27onMenuShareTimeline\x27, \x27chooseWXPay\x27]\n    })\n  })\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ main.js\x3c\/span\x3e\n...\nimport wx \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27weixin-js-sdk\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e request \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27axios\x27\x3c\/span\x3e\n...\nrouter.afterEach(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eto, \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e _url = \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.location.origin \x2b to.fullPath\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 非ios设备，切换路由时候进行重新签名\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.__wxjs_is_wkwebview !== \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e) {\n    request.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/api\/jssdk?url=\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-built_in\x22\x3eencodeURIComponent\x3c\/span\x3e(_url)).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e_lists\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 注入配置\x3c\/span\x3e\n      wx.config({\n      ...\n      })\n    })\n  }\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 微信分享配置\x3c\/span\x3e\n  wx.ready(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    wx.onMenuShareTimeline({\n     ...\n    })\n    wx.onMenuShareAppMessage({\n      ...\n    })\n  })\n})\n\n...\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ ios 设备进入页面则进行js-sdk签名\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.__wxjs_is_wkwebview === \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e) {\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e _url = \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.location.href.split(\x3cspan class=\x22hljs-string\x22\x3e\x27#\x27\x3c\/span\x3e)[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e]\n  request.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/api\/jssdk?url=\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-built_in\x22\x3eencodeURIComponent\x3c\/span\x3e(_url)).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e _lists = res\n    wx.config({\n      \x3cspan class=\x22hljs-attr\x22\x3edebug\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3eappId\x3c\/span\x3e: _lists.appId,\n      \x3cspan class=\x22hljs-attr\x22\x3etimestamp\x3c\/span\x3e: _lists.timestamp,\n      \x3cspan class=\x22hljs-attr\x22\x3enonceStr\x3c\/span\x3e: _lists.nonceStr,\n      \x3cspan class=\x22hljs-attr\x22\x3esignature\x3c\/span\x3e: _lists.signature,\n      \x3cspan class=\x22hljs-attr\x22\x3ejsApiList\x3c\/span\x3e: [\x3cspan class=\x22hljs-string\x22\x3e\x27chooseImage\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27uploadImage\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27previewImage\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27onMenuShareTimeline\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27onMenuShareAppMessage\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27onMenuShareTimeline\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27chooseWXPay\x27\x3c\/span\x3e]\n    })\n  })\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e总结： 总之简要概括就是要想分享成功，必须签名是成功的，要想签名成功，必须保证调用签名配置的时候微信校验签名获取的url（ios永远是第一次进入页面的url）和我们请求服务端获取签名时提交的url一致。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e调用微信支付\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e两个方案何去何从\x3c\/h3\x3e\n\x3cp\x3eh5使用微信支付，细心的人会发现，微信是有两个方案的，我大致了解了一个，一个是js-sdk中开放的能力，一个是微信支付开放平台提供的接口\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/mp.weixin.qq.com\/wiki?t=resource\/res_main\x26amp;id=mp1421141115\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ejs-sdk版本:\x3c\/a\x3e\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012339154?w=1838\x26amp;h=1168\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012339154?w=1838\x26amp;h=1168\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3cbr\x3e\x3ca href=\x22https:\/\/pay.weixin.qq.com\/wiki\/doc\/api\/jsapi.php?chapter=7_7\x26amp;index=6\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e微信支付版本：\x3c\/a\x3e\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012339155?w=1478\x26amp;h=1124\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012339155?w=1478\x26amp;h=1124\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e如果你只需要在公众号中调用支付，两个方法都可以，笔者由于已经使用js-sdk接入了其他功能，所以这里就选择了chooseWXPay方式。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e接入步骤\x3c\/h3\x3e\n\x3cp\x3e在其他功能都接入成功的前提下，接支付就很快很方便了，笔者把主要步骤列下：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e微信公众平台中配置好js安全接口域名（例如www.imwty.com），这个是调用js-sdk的前提，公众号支付也是基于js-sdk；\x3c\/li\x3e\n\x3cli\x3e微信支付平台中设置支付目录，参见\x3ca href=\x22https:\/\/mp.weixin.qq.com\/wiki?t=resource\/res_main\x26amp;id=mp1421141115\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e微信支付开发文档\x3c\/a\x3e，这里要说明的是，你需要进行支付的页面路由是什么，就要配置什么，而且需要在后边加上\/（例如www.imwty.com\/pay\/）\x3c\/li\x3e\n\x3cli\x3e调用js-sdk签名配置（wechat.config），上文已有提及。\x3c\/li\x3e\n\x3cli\x3e在点击支付按钮的逻辑中，调用wechat.chooseWXPay()方法，该方法也涉及到支付签名，需要从服务端去获取签名信息\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e注意的点：访问支付页面务必不要遗漏\x3ccode\x3e\/\x3c\/code\x3e，微信那边会严格比较调用第4步骤时你所在的页面路由和支付平台中设置的路由是否一致。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3eCoding\x3c\/h3\x3e\n\x3cp\x3e这里主要展示第4步骤中笔者的写法，仅供参考\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22...\nmethods () {\n handlerPay () {**粗体文本**\n    let self = this\n    \/\/ 进行支付签名\n    apiUtil.get(\x27\/api\/jssdk\/pay\x27, {amount: this.amount}).then(function (wxmsg) {\n      self.$wechat.chooseWXPay({\n     \/\/ 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符\n          appId: wxmsg.appId,\n          timestamp: wxmsg.timeStamp,\n          nonceStr: wxmsg.nonceStr, \/\/ 支付签名随机串，不长于 32 位\n          package: wxmsg.package, \/\/ 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）\n          signType: wxmsg.signType, \/\/ 签名方式，默认为\x27SHA1\x27，使用新版支付需传入\x27MD5\x27\n          paySign: wxmsg.paySign, \/\/ 支付签名\n          success: function (res) {\n            \/\/ 支付成功的回调函数\n          },\n          cancel: function (res) {\n            \/\/ 支付取消的回调函数\n          },\n          error: function (res) {\n            \/\/ 支付失败的回调函数\n          }\n    }).catch(function () {\n      ...\n    })\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e...\nmethods () {\n handlerPay () {**粗体文本**\n    let \x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e = this\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 进行支付签名\x3c\/span\x3e\n    apiUtil.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/api\/jssdk\/pay\x27\x3c\/span\x3e, {amount: this.amount}).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(wxmsg)\x3c\/span\x3e \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e.$wechat.chooseWXPay({\n     \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符\x3c\/span\x3e\n          appId: wxmsg.appId,\n          timestamp: wxmsg.timeStamp,\n          nonceStr: wxmsg.nonceStr, \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 支付签名随机串，不长于 32 位\x3c\/span\x3e\n          package: wxmsg.package, \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）\x3c\/span\x3e\n          signType: wxmsg.signType, \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 签名方式，默认为\x27SHA1\x27，使用新版支付需传入\x27MD5\x27\x3c\/span\x3e\n          paySign: wxmsg.paySign, \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 支付签名\x3c\/span\x3e\n          success: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(res)\x3c\/span\x3e \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 支付成功的回调函数\x3c\/span\x3e\n          },\n          cancel: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(res)\x3c\/span\x3e \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 支付取消的回调函数\x3c\/span\x3e\n          },\n          error: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(res)\x3c\/span\x3e \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 支付失败的回调函数\x3c\/span\x3e\n          }\n    }).\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n      ...\n    })\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e结语\x3c\/h3\x3e\n\x3cp\x3e由于本人文笔一般，思维的表达估计不到位，见解也是浅尝辄止，所以如果看官您有疑惑的地方或者有歧义欢迎来和本人交流。为了方便大家互相沟通，本人也创建了一个vue公众号开发的qq群，欢迎加入和大家一起分享开发心得，qq群号：130903919\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>vue中使用微信公众号js-sdk踩坑记录（2）</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000012339148">https://segmentfault.com/a/1190000012339148</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/6hdz953omri/" target="_blank">https://alili.tech/archive/6hdz953omri/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>