<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="网络推送交互会变得好用"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>网络推送交互会变得好用 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/71780e3d/",
				"appid": "1613049289050283", 
				"title": "网络推送交互会变得好用 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-10-19T00:00:00"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/45c69746/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/2e3f8879/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f&text=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f&text=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f&title=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f&is_video=false&description=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f&title=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f&title=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f&title=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f71780e3d%2f&title=%e7%bd%91%e7%bb%9c%e6%8e%a8%e9%80%81%e4%ba%a4%e4%ba%92%e4%bc%9a%e5%8f%98%e5%be%97%e5%a5%bd%e7%94%a8"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">网络推送交互会变得好用</h1><div class="meta"><div class="postdate"><time datetime="2018-10-19" itemprop="datePublished">2018-10-19</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3cp\x3eChrome浏览器开始支持网络推送api时，它使用的是一项以前被叫做Google云消息的推送服务(GCM)的技术，现在叫Firebase云消息(FCM)。这个使用的是它们自己的私有api，使得开发者在网络推送协议还在草拟的时候或者根本没有网络推送协议的时候就可以使用网络推送API。好消息是，不管怎么说，上面两种情况都是不对的。\x3c\/p\x3e\n\x3cp\x3eFCM\/GCM 和chrome浏览器现在支持标准的网络推送协议，同时推送者可以通过实现VAPID(Voluntary Application Server Identification，自主应用服务器标识，它是一种为站点和网页之间推送协议增加授权的开源标准。)来获得授权，而不再需要\x27gcm_send_id\x27。\x3c\/p\x3e\n\x3cp\x3e本文中，我将先介绍一下怎么将你现有的服务端代码改造以便可以通过FCM来使用网络推送协议，然后，我将给你展示怎么在客户端和服务端实现VAPID。\x3c\/p\x3e\n\x3ch3\x3eFCM支持网络推送协议\x3c\/h3\x3e\n\x3cp\x3e我们先讲讲整个的背景。当你的web应用注册了一个推送任务，它将会把这个得到一个推送服务的URL。你的服务器将会通过web应用给你的用户发送一些数据。在chrome浏览器里，如果没有使用VAPID，那么需要推送服务的URL就是一个FCM的终结点URL(后面回讲到使用VAPID)。在FCM支持网络推送协议之前，你必须从URL中抽取出注册ID放在一个FCM API请求的header里。 比如，一个FCM终结点URL \x3ca href=\x22https:\/\/android.googleapis.com\/gcm\/send\/ABCD1234\x22\x3ehttps:\/\/android.googleapis.com\/gcm\/send\/ABCD1234\x3c\/a\x3e, 包含一个注册ID\x27ABCD1234\x27。\x3c\/p\x3e\n\x3cp\x3e现在由于FCM支持网络推送协议，你可以保持这个终结点URL不变，并且把它作为一个网络推送协议的终结点(这将使得chrome浏览器和火狐浏览器及其它浏览器保持一致)。\x3c\/p\x3e\n\x3cp\x3e在我们着手研究VAPID之前，我们需要确保服务端能正确处理FCM终结点URL。下面是一个在节点里给推送服务发送请求的例子。注意，在FCM里，我们会将API key加入到请求的headers里面。对于其它推送服务，是不用这个操作的。在chrome 52之前的版本，android设备上的opera和三星浏览器上，你还需要将\x22gcm_sender_id\x22写在web应用的manifest.json里。 API key和sender ID是服务端用来检查是否需要给某个请求的用户发送消息。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e headers = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Headers();  \n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 12-hour notification time to live.  \x3c\/span\x3e\nheaders.append(\x3cspan class=\x22hljs-string\x22\x3e\x27TTL\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e12\x3c\/span\x3e * \x3cspan class=\x22hljs-number\x22\x3e60\x3c\/span\x3e * \x3cspan class=\x22hljs-number\x22\x3e60\x3c\/span\x3e);  \n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Assuming no data is going to be sent  \x3c\/span\x3e\nheaders.append(\x3cspan class=\x22hljs-string\x22\x3e\x27Content-Length\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Assuming you\x27re not using VAPID (read on), this\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ proprietary header is needed  \x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(subscription.endpoint\n  .indexOf(\x3cspan class=\x22hljs-string\x22\x3e\x27https:\/\/android.googleapis.com\/gcm\/send\/\x27\x3c\/span\x3e) === \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {  \n  headers.append(\x3cspan class=\x22hljs-string\x22\x3e\x27Authorization\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27GCM_API_KEY\x27\x3c\/span\x3e);  \n}\n\nfetch(subscription.endpoint, {  \n  \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27POST\x27\x3c\/span\x3e,  \n  \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e: headers  \n})  \n.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresponse\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {  \n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (response.status !== \x3cspan class=\x22hljs-number\x22\x3e201\x3c\/span\x3e) {  \n    \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27Unable to send push message\x27\x3c\/span\x3e);  \n  }  \n});\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e记住，你不需要更新推送任务，只需要按照上面展示的一样去定义headers，因为这就是FCM\/GCM API的变化。\x3c\/p\x3e\n\x3ch4\x3e介绍用于服务端身份标识的VAPID\x3c\/h4\x3e\n\x3cp\x3eVAPID是Voluntary Application Server Identification (\x3ca href=\x22https:\/\/tools.ietf.org\/html\/draft-thomson-webpush-vapid\x22\x3ehttps:\/\/tools.ietf.org\/html\/draft-thomson-webpush-vapid\x3c\/a\x3e) 的简称。它是用来定义服务端和推送服务之间的握手协议，从而来判定那个服务端可以发送消息。通过VAPID，当你推送一个消息时，就可以避免使用FCM定义的方法，也不再需要一个Firebase项目，不再需要gcm_sender_id或者用于验证的header。\x3c\/p\x3e\n\x3cp\x3e它的过程很简单：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3eweb应用服务端创建一个公有和私有的密钥对，公钥给web应用。\x3c\/p\x3e\n\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e当用户选择接收推送时，将这个公钥放在订阅的参数里。\x3c\/p\x3e\n\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e当web应用服务端推送一条消息时，将一个用公钥签名的JSON Web Token包含在其中。\x3c\/p\x3e\n\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e具体来看看这些步骤\x3c\/p\x3e\n\x3ch5\x3e创建公钥和私钥对\x3c\/h5\x3e\n\x3cp\x3e看到加密就头痛，所以这里就把相关的不分放在这里，忽略掉VAPID公钥和私钥的格式\x3c\/p\x3e\n\x3cblockquote\x3e\n\x3cp\x3eweb应用服务端应该生成和维护一个用基于P-256曲线的椭圆曲线数字签名算法（ECSDA）签名的公钥和私钥对。\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e你也可以参考怎么实现这个签名过程(\x3ca href=\x22https:\/\/github.com\/web-push-libs\/web-push\/\x22\x3ehttps:\/\/github.com\/web-push-libs\/web-push\/\x3c\/a\x3e)\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs actionscript\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egenerateVAPIDKeys\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{  \n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e curve = crypto.createECDH(\x3cspan class=\x22hljs-string\x22\x3e\x27prime256v1\x27\x3c\/span\x3e);  \n  curve.generateKeys();\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {  \n    publicKey: curve.getPublicKey(),  \n    privateKey: curve.getPrivateKey(),  \n  };  \n}\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3ch5\x3e用公钥订阅推送服务\x3c\/h5\x3e\n\x3cp\x3e你需要通过将公钥以Uint8Array的格式作为参数传到subscribe()方法，才可以实现让一个chrome浏览器用户完成使用VAPID公钥订阅推送服务。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e publicKey = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eUint8Array\x3c\/span\x3e([\x3cspan class=\x22hljs-number\x22\x3e0x4\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x37\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x77\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0xfe\x3c\/span\x3e, …. ]);  \nserviceWorkerRegistration.pushManager.subscribe(  \n  {  \n    \x3cspan class=\x22hljs-attr\x22\x3euserVisibleOnly\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,  \n    \x3cspan class=\x22hljs-attr\x22\x3eapplicationServerKey\x3c\/span\x3e: publicKey  \n  }  \n);\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e通过检测终结点是否收到订阅结果，就可以知道是否成功。 现在测试fcm.googleapis.com，它是成功的。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs crystal\x22\x3e\x3cspan class=\x22hljs-symbol\x22\x3ehttps:\x3c\/span\x3e\/\x3cspan class=\x22hljs-regexp\x22\x3e\/fcm.googleapis.com\/fcm\x3c\/span\x3e\x3cspan class=\x22hljs-regexp\x22\x3e\/send\/\x3c\/span\x3eABCD1234\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e\x3cstrong\x3e注意\x3c\/strong\x3e：即使是一个FCM URL，使用Web推送服务，而不是FCM协议，服务器端也是能够支持任何推送服务的。\x3c\/p\x3e\n\x3ch5\x3e推送一个消息\x3c\/h5\x3e\n\x3cp\x3e要使用VAPID推送一条消息，你需要发送一个普通的基于web推送协议的请求，这个请求带有两个额外的http headers： 用于验证的header和加密密钥的header。\x3c\/p\x3e\n\x3cp\x3e用于验证的header\x3c\/p\x3e\n\x3cp\x3e这个用于验证的header是一个以‘WebPush’开头的签名过的JSON Web Token(JWT)。\x3c\/p\x3e\n\x3cp\x3eJWT 提供了一种方法，使得推送者可以对它签名，而接收者可以通过验证签名来判定是否来自正确的推送者。 JWT的结构是以点作为分隔的3段加密字符串。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eJWTHeader\x3c\/span\x3e\x26gt;\x3c\/span\x3e.\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ePayload\x3c\/span\x3e\x26gt;\x3c\/span\x3e.\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eSignature\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3eJWT的header\x3c\/p\x3e\n\x3cp\x3eJWT的header包含了用于签名的算法名和自己的类型名。 用于VAPID的JWT header必须是：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs json\x22\x3e{  \n  \x3cspan class=\x22hljs-attr\x22\x3e\x22typ\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22JWT\x22\x3c\/span\x3e,  \n  \x3cspan class=\x22hljs-attr\x22\x3e\x22alg\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22ES256\x22\x3c\/span\x3e  \n}\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这些将会被用base64编码，并组成JWT的第一部分\x3c\/p\x3e\n\x3cp\x3e有效内容\x3c\/p\x3e\n\x3cp\x3e有效内容是另一个JSON对象，它包括一下内容：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eAudience (\x22aud\x22)\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e这个推送服务的源(并不是网站的源)。在javascript里，你可以通过const audience = new URL(subscription.endpoint).origin 来获得这个audience 。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eExpiration Time (\x22exp\x22)\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e这是请求将会被认为无效的时间秒数，必须在请求发起之后的24小时内(UTC时间)。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eSubject (\x22sub\x22)\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e主题需要是一个URL或者是一个邮箱地址，它是用来提供联系方式的，以便推送服务可以联系到消息的推送者。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e一个有效内容可能就像下面的一样：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs clojure\x22\x3e{  \n    \x3cspan class=\x22hljs-string\x22\x3e\x22aud\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22http:\/\/push-service.example.com\x22\x3c\/span\x3e,  \n    \x3cspan class=\x22hljs-string\x22\x3e\x22exp\x22\x3c\/span\x3e: Math.floor((\x3cspan class=\x22hljs-name\x22\x3eDate.now\x3c\/span\x3e() \/ \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e) \x2b (\x3cspan class=\x22hljs-number\x22\x3e12\x3c\/span\x3e * \x3cspan class=\x22hljs-number\x22\x3e60\x3c\/span\x3e * \x3cspan class=\x22hljs-number\x22\x3e60\x3c\/span\x3e)),  \n    \x3cspan class=\x22hljs-string\x22\x3e\x22sub\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22mailto: my-email@some-url.com\x22\x3c\/span\x3e  \n}\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这个JSON对象被用base64编码之后组成JWT的第二部分。\x3c\/p\x3e\n\x3cp\x3e签名\x3c\/p\x3e\n\x3cp\x3e签名是将前面编码过的header和有效内容加上点，然后在用之前创建的私钥加密而成的。签名也应该追加到前面的有效内容后面，中间以点作为间隔。\x3c\/p\x3e\n\x3cp\x3e我将不会给你展示一个示例， 因为有一个好用的工具可以做这些：\x3ca href=\x22https:\/\/jwt.io\/#libraries-io\x22\x3ehttps:\/\/jwt.io\/#libraries-io\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e‘WebPush’放在签名之后JWT之前，然后整体作为验证header，就像下面这样：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs gcode\x22\x3eWebPush eyJ\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3eeXAiOiJKV\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3eQiLCJhbGciOiJFUzI\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x3cspan class=\x22hljs-symbol\x22\x3eNiJ9\x3c\/span\x3e.eyJhdWQiOiJodHRwczovL\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3eZjbS\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\x3cspan class=\x22hljs-symbol\x22\x3enb29\x3c\/span\x3e\x3cspan class=\x22hljs-symbol\x22\x3enbGVhcGlzLmNvbSIsImV4\x3c\/span\x3ecCI\x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3eMTQ\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\x3cspan class=\x22hljs-symbol\x22\x3eNjY2\x3c\/span\x3eODU\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\x3cspan class=\x22hljs-symbol\x22\x3eNCwic3\x3c\/span\x3eViIjoibWFpbHRvO\x3cspan class=\x22hljs-symbol\x22\x3enNpbXBsZS1\x3c\/span\x3ewdX\x3cspan class=\x22hljs-symbol\x22\x3eNoLWRlbW9\x3c\/span\x3eAZ\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3eF\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3eb\x3cspan class=\x22hljs-symbol\x22\x3enRmYWNlLmNvLnVrIn0\x3c\/span\x3e.Ec\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3eVR\x3cspan class=\x22hljs-number\x22\x3e8\x3c\/span\x3edtf\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3eqb\x3cspan class=\x22hljs-number\x22\x3e8\x3c\/span\x3eFb\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3eWk\x3cspan class=\x22hljs-number\x22\x3e91\x3c\/span\x3ebr-evfh\x3cspan class=\x22hljs-meta\x22\x3eo9\x3c\/span\x3esZT\x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3ejBRuQwxVMFyK\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3eS\x3cspan class=\x22hljs-number\x22\x3e8\x3c\/span\x3ebhOjk\x3cspan class=\x22hljs-number\x22\x3e8\x3c\/span\x3ekuxvilLqTBmDXJ\x3cspan class=\x22hljs-name\x22\x3eM5\x3c\/span\x3el\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3euVrVOQirSsjq\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3eA\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e要注意的是，首先，这个验证header包含有\x27WebPush\x27，并且在\x27WebPush\x27之后必须有一个空格，之后才是JWT。同时，要用点号来分隔JWT的header，有效内容和签名。\x3c\/p\x3e\n\x3cp\x3e加密密钥header\x3c\/p\x3e\n\x3cp\x3e和验证header一样，你必须把VAPID的公钥加密然后通过base64加密，然后前面加上\x27p256ecdsa=\x27这一串。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs ini\x22\x3e\x3cspan class=\x22hljs-attr\x22\x3ep256ecdsa\x3c\/span\x3e=BDd3_hVL9fZi9Ybo2UUzA284WG5FZR\x3cspan class=\x22hljs-number\x22\x3e30_95\x3c\/span\x3eYeZJsiApwXKpNcF1rRPF3foIiBHXRdJI2Qhumhf6_LFTeZaNndIo\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e当你用加密的数据推送一个通知时，已经用上了加密的header，要加上web应用的服务端的密钥，只需要在后面加上一个分号就可以，就像下面这样：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs ini\x22\x3e\x3cspan class=\x22hljs-attr\x22\x3edh\x3c\/span\x3e=BGEw2wsHgLwzerjvnMTkbKrFRxdmwJ5S_k7zi7A1coR_sVjHmGrlvzYpAT1n4NPbioFlQkIrTNL8EH4V3ZZ4vJE;\n\x3cspan class=\x22hljs-attr\x22\x3ep256ecdsa\x3c\/span\x3e=BDd3_hVL9fZi9Ybo2UUzA284WG5FZR\x3cspan class=\x22hljs-number\x22\x3e30_95\x3c\/span\x3eYeZJsiApwXKpNcF1rRPF3foIiBHXRdJI2Qhumhf6_LFTeZaN\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e注意：这个分号本来是要使用逗号的，但是chrome 52之前的版本有问题，当使用逗号推送的时候，会被阻止掉，这个问题在chrome 53已经修复了，因此等稳定下来之后，你可以将分号改为逗号了。\x3c\/p\x3e\n\x3ch4\x3e这些变化有哪些用处呢\x3c\/h4\x3e\n\x3cp\x3e通过是使用VAPID，当你在chrome里使用推送服务时，不再需要登录GCM的账号了，而且可以用相同的代码在chrome浏览器和火狐浏览器实现用户订阅推送和推送消息给用户，而且都是遵循标准的。\x3c\/p\x3e\n\x3cp\x3e你需要记住的是，当使用chrome 51或者更早的版本，Android设备上的Opera和三星浏览器时，仍然需要在清单文件里定义\x27gcm_sender_id\x27和添加验证header到FCM终结点URL里。\x3c\/p\x3e\n\x3cp\x3eVAPID提供了一个逃离私有API束缚的捷径。使用VAPID可以使你在所有浏览器上都可以使用网络推送服务。随着越来越多的浏览器支持VAPID，你可以选择从你的清单文件里去掉gcm_sender_id了。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e注意\x3c\/strong\x3e： 你可以从下面的网址找到所有的文档和一些关于网络推送的最佳实践的例子。 (\x3ca href=\x22https:\/\/developers.google.com\/web\/fundamentals\/push-notifications\x22\x3ehttps:\/\/developers.google.com\/web\/fundamentals\/push-notifications\x3c\/a\x3e)\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>原文链接: <a href="https://www.zcfy.cc/article/web-push-interoperability-wins">https://www.zcfy.cc/article/web-push-interoperability-wins</a> 原文标题: 网络推送交互会变得好用 本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2>本文链接：</h2><a href="https://alili.tech/archive/71780e3d/" target="_blank">https://alili.tech/archive/71780e3d/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>