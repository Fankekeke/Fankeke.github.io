<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="JavaScript 使用 mediaDevices API 选择摄像头"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>JavaScript 使用 mediaDevices API 选择摄像头 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/8e82c37c/",
				"appid": "1613049289050283", 
				"title": "JavaScript 使用 mediaDevices API 选择摄像头 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-10-18T00:00:00"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/fc1b6dd6/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/2d483fa4/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f&text=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f&text=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f&title=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f&is_video=false&description=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f&title=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f&title=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f&title=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8e82c37c%2f&title=JavaScript%20%e4%bd%bf%e7%94%a8%20mediaDevices%20API%20%e9%80%89%e6%8b%a9%e6%91%84%e5%83%8f%e5%a4%b4"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">JavaScript 使用 mediaDevices API 选择摄像头</h1><div class="meta"><div class="postdate"><time datetime="2018-10-18" itemprop="datePublished">2018-10-18</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3cp\x3e大多数智能手机都有前置和后置摄像头，当你在创建视频应用时你可能想要选择或者切换前置、后置摄像头。\x3c\/p\x3e\n\x3cp\x3e如果你开发的是一款聊天应用，你很可能会想调用前置摄像头，但如果你开发的是一款拍照软件，那么你会更倾向于使用后置摄像头。在这篇文章中我们将探讨如何通过 mediaDevices API 和 media constraints (媒体约束) 选择或者切换摄像头。\x3c\/p\x3e\n\x3ch3\x3e准备工作\x3c\/h3\x3e\n\x3cp\x3e要跟着本文一起动手实践你需要：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e一款拥有两个可供测试的摄像头的 iOS 或 Android 设备，如果你的电脑有两个摄像头那也可以\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/ngrok.com\/\x22\x3engrok\x3c\/a\x3e 以便你能通过移动设备轻松访问到你的项目（也因为我觉得 \x3ca href=\x22https:\/\/www.twilio.com\/blog\/2015\/09\/6-awesome-reasons-to-use-ngrok-when-testing-webhooks.html\x22\x3engrok 炒鸡棒\x3c\/a\x3e）\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/github.com\/philnash\/mediadevices-camera-selection\x22\x3e这个 GitHub 库\x3c\/a\x3e  的代码让你起步\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e要获取代码，先把这个项目 clone 下来然后 checkout 到 \x3ccode\x3einitial-project\x3c\/code\x3e tag 下。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs armasm\x22\x3e\x3cspan class=\x22hljs-symbol\x22\x3egit\x3c\/span\x3e clone https:\/\/github.com\/philnash\/mediadevices-camera-\x3cspan class=\x22hljs-keyword\x22\x3eselection.git \x3c\/span\x3e-\x3cspan class=\x22hljs-keyword\x22\x3eb \x3c\/span\x3einitial-project\n\x3cspan class=\x22hljs-symbol\x22\x3ecd\x3c\/span\x3e mediadevices-camera-\x3cspan class=\x22hljs-keyword\x22\x3eselection\n\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这个起步项目已经为你准备好了一些 HTML 和 CSS，所以我们就可以把注意集中到 JavaScript 上了。你可以直接打开 index.html，但我建议你用一款 webserver 把这些文件托管起来。我喜欢用 \x3ca href=\x22https:\/\/www.npmjs.com\/package\/serve\x22\x3enpm 的 serve 模块\x3c\/a\x3e。我在这个库里已经引入了 serve，要使用它你需要先用 npm 安装依赖然后启动这个服务。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs coffeescript\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3enpm\x3c\/span\x3e install\n\x3cspan class=\x22hljs-built_in\x22\x3enpm\x3c\/span\x3e start\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e服务运行起来后，我们要用 ngrok 开启一条隧道。serve 用 5000 端口托管文件，要用 ngrok 开隧道通到这个端口，新开一个命令行窗口输入以下命令：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs livecodeserver\x22\x3engrok \x3cspan class=\x22hljs-keyword\x22\x3ehttp\x3c\/span\x3e  \x3cspan class=\x22hljs-number\x22\x3e5000\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e好了你现在可以公网访问这个站点了，你可以在移动设备上打开这个网站，这样接下来就可以测试啦。确保你打开的是 HTTPS 的 URL，因为我们用的 API 只能在安全环境下使用。\x3c\/p\x3e\n\x3cp\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t01a528795e35bfe51f.png\x22 alt=\x22ngrok 窗口显示了两个你可以用的 URL，选 HTTPS 版本的。\x22\x3e\x3c\/p\x3e\n\x3cp\x3e网站看起来像这样:\x3c\/p\x3e\n\x3cp\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t01e79d986b7c10a078.png\x22 alt=\x22网站应该有一个 \x27Camera fun\x27 的标题，一个按钮和一个空的下拉选择框\x22\x3e\x3c\/p\x3e\n\x3ch3\x3e获取 media stream\x3c\/h3\x3e\n\x3cp\x3e我们的第一个任务是从任意摄像头获取视频流显示到屏幕上。完成这个之后我们再调研如何选择特定摄像头。打开 app.js , 我们以从 DOM 中选择按钮和 video 元素开始：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs dart\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ app.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e  video  =  \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27video\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e  button  =  \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27button\x27\x3c\/span\x3e);\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e当用户点击或触摸按钮时，我们要使用 mediaDevices \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/MediaDevices\x22\x3eAPI\x3c\/a\x3e 请求摄像头权限。要这样做，我们要调用  \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/MediaDevices\/getUserMedia\x22\x3enavigator.mediaDevices.getUserMedia\x3c\/a\x3e ，传递 media constraints 对象。让我们从简单的 constraints 开始，我们只需要视频，因此我们把 video 设置为 true，audio 设置为 false。\x3c\/p\x3e\n\x3cp\x3egetUserMedia 会返回一个 promise，当 resolve 的时候我们就可以访问到摄像头的媒体流了。把媒体流赋值给 video 元素的 srcObj 属性，我们就能从屏幕上看到视频了。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs typescript\x22\x3ebutton.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eevent\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e constraints = {\n    video: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n    audio: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e\n  };\n  navigator.mediaDevices\n    .getUserMedia(constraints)\n    .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3estream\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      video.srcObject = stream;\n    })\n    .catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerror\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(error);\n    });\n});\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e保存文件，重新加载页面然后点击按钮。你应该能看到一个权限对话框请求访问你的摄像头，一旦授权屏幕上就应该会出现视频。在你的电脑和手机上试一试，我在我的 iPhone 上试了，被选择的是前置摄像头。\x3c\/p\x3e\n\x3cp\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t01fd64da9dfde140e8.jpg\x22 alt=\x22摄像头应用, 在之前的空白区域出现了我的脸\x22\x3e\x3c\/p\x3e\n\x3cp\x3e如果你用的是一部 iPhone 手机，确认你在 Safari 里尝试，因为其他浏览器貌似并没有效果。\x3c\/p\x3e\n\x3ch3\x3e可用摄像头\x3c\/h3\x3e\n\x3cp\x3emedia Devices API 为我们提供了一种枚举所有可用音频和视频输入设备的方式。我们要用 \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/MediaDevices\/enumerateDevices\x22\x3eenumerateDevices\x3c\/a\x3e 函数来为 \x26lt;select\x26gt; 框构建选项，这样我们就能用它来选择我们想看的摄像头了。再次打开 app.js，从 DOM 中选出 \x26lt;select\x26gt; 元素：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs dart\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e video = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27video\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e button = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27button\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e select = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27select\x27\x3c\/span\x3e);\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3eenumerateDevices 会返回一个 promise，所以让我们写一个用来接受 promise 结果的函数吧。这个函数接收一个 media device 数组作为参数。\x3c\/p\x3e\n\x3cp\x3e首先要做的是清空 \x26lt;select\x26gt; 现有的任何选项，然后插入一个空的 \x26lt;option\x26gt;。接着循环遍历所有设备，过滤掉非 “videoinput”类型的设备。然后我们创建一个 \x26lt;option\x26gt; 元素，用设备 ID 当作 option value，设备 label 当作 option text。我们还要处理一种情况，如果一个设备没有 label 存在，生成一个简单的 “Camera n” 作为标签。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e video = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27video\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e button = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27button\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e select = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27select\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egotDevices\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emediaDevices\x3c\/span\x3e) \x3c\/span\x3e{\n  select.innerHTML = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e;\n  select.appendChild(\x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x27option\x27\x3c\/span\x3e));\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e count = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n  mediaDevices.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3emediaDevice\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (mediaDevice.kind === \x3cspan class=\x22hljs-string\x22\x3e\x27videoinput\x27\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e option = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x27option\x27\x3c\/span\x3e);\n      option.value = mediaDevice.deviceId;\n      \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e label = mediaDevice.label || \x3cspan class=\x22hljs-string\x22\x3e`Camera \x3cspan class=\x22hljs-subst\x22\x3e${count\x2b\x2b}\x3c\/span\x3e`\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e textNode = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createTextNode(label);\n      option.appendChild(textNode);\n      select.appendChild(option);\n    }\n  });\n}\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e在 app.js 末尾调用一下 enumerateDevices。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs css\x22\x3e\x3cspan class=\x22hljs-selector-tag\x22\x3enavigator\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.mediaDevices\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.enumerateDevices\x3c\/span\x3e()\x3cspan class=\x22hljs-selector-class\x22\x3e.then\x3c\/span\x3e(\x3cspan class=\x22hljs-selector-tag\x22\x3egotDevices\x3c\/span\x3e);\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e刷新页面，看一下按钮旁边的下拉选择框。如果你用的是 Android ，或者使用 Chrome 或 Firefox，你就能看到可用的摄像头名称了。\x3c\/p\x3e\n\x3cp\x3e然而在 iPhone 上，你将看到我们函数生成的通用名字 “Camera 1” 和 “Camera 2”。在 iOS 上只有你授权至少一个摄像头给网站，你才能看到摄像头的名字。这让在我们的界面上选择摄像头变得更不方便，因为尽管你能获取到设备 ID，你还是不能分辨哪个摄像头是哪个。\x3c\/p\x3e\n\x3cp\x3e\x3cimg src=\x22https:\/\/www.twilio.com\/blog\/wp-content\/uploads\/2018\/04\/lkBjDsPZk87_aN3ONBWXs22xmkmQg_plaua_hNfWTFRxQFiieHyB3EXxZwn5zncsEAKKVdONDx3drBnlcYJDU3niHGu1naOEdujZHLWvUE4aRt4Fro-K-Km1diPqUZGM-5KkE.png\x22 alt=\x22在 iPhone 上你只能看到我们创建的摄像头标签, \x27Camera 1\x27 and \x27Camera 2\x27.\x22\x3e\x3c\/p\x3e\n\x3cp\x3e目前我们还没有处理下拉选择框来改变摄像头。在这之前，让我们来看另一种能改变哪个摄像头被使用的方法。\x3c\/p\x3e\n\x3ch3\x3eFacingMode\x3c\/h3\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/MediaTrackConstraints\/facingMode\x22\x3eFacingMode\x3c\/a\x3e 约束是一个可以用来选择摄像头的替代方法。这个方法比起通过 enumerateDevices 函数获取 ID 来说更不那么精确，但在移动设备上效果非常好。对于这个约束，一共有四种选项可供你选择：用户（user），环境（environment），左（left），右（right）。\x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/MediaTrackConstraints\/facingMode\x22\x3eMDN 上的文档对这个约束做了详细介绍\x3c\/a\x3e, 以本文的目的我们将使用用户和环境模式，在移动设备上它们正好对应到前置和后置摄像头。\x3c\/p\x3e\n\x3cp\x3e要使用 facingMode 约束我们需要修改调用 getUserMedia 时使用的 constraints 对象。对于 video 我们需要一个对象来控制具体的约束，而不是给一个 true 值。像这样修改代码来使用前置摄像头：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs typescript\x22\x3ebutton.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eevent\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e videoConstraints = {\n    facingMode: \x3cspan class=\x22hljs-string\x22\x3e\x27user\x27\x3c\/span\x3e\n  };\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e constraints = {\n    video: videoConstraints,\n    audio: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e\n  };\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e现在可以用你的手机测试。你应该能看到前置摄像头被使用。更改 facingMode 为 environment 再试一次, 使用的应该是后置摄像头。让我们把这些代码和上面通过 enumerateDevices 获取到的结果放到一块儿，只要我们获得了读取摄像头数据的权限，就能构建一个摄像头切换器了。\x3c\/p\x3e\n\x3ch3\x3e切换摄像头\x3c\/h3\x3e\n\x3cp\x3e现在我们有在首次选择时挑选用户或环境摄像头的代码了，但如果我们要切换摄像头那还有一丢丢额外的工作要做。\x3c\/p\x3e\n\x3cp\x3e首先，我们应该保留对当前流的引用，这样当我们切换到另一个流时就能停止当前流。在 app.js 的最前面添加一个额外的变量和辅助函数来停止流中的轨。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e video = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27video\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e button = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27button\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e select = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27select\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e currentStream;\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3estopMediaTracks\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3estream\x3c\/span\x3e) \x3c\/span\x3e{\n  stream.getTracks().forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3etrack\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    track.stop();\n  });\n}\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e函数 stopMediaTracks 接收一个媒体流，循环遍历流中的每一个媒体轨道，调用 stop 方法停止媒体轨。\x3c\/p\x3e\n\x3cp\x3e我们要在点击同一个按钮时改变摄像头，所以我们需要更新一下按钮的事件监听器了。如果当前有媒体流，我们应该先停止掉它。然后我们要检查 \x26lt;select\x26gt; 元素看是否选择了特定的设备，然后基于此构造 media constraints 对象。\x3c\/p\x3e\n\x3cp\x3e这样修改按钮的点击处理函数和 video constraints：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cs\x22\x3ebutton.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3eevent\x3c\/span\x3e =\x26gt; {\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e currentStream !== \x3cspan class=\x22hljs-string\x22\x3e\x27undefined\x27\x3c\/span\x3e) {\n    stopMediaTracks(currentStream);\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e videoConstraints = {};\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3eselect\x3c\/span\x3e.\x3cspan class=\x22hljs-keyword\x22\x3evalue\x3c\/span\x3e === \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e) {\n    videoConstraints.facingMode = \x3cspan class=\x22hljs-string\x22\x3e\x27environment\x27\x3c\/span\x3e;\n  } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n    videoConstraints.deviceId = { exact: \x3cspan class=\x22hljs-keyword\x22\x3eselect\x3c\/span\x3e.\x3cspan class=\x22hljs-keyword\x22\x3evalue\x3c\/span\x3e };\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e constraints = {\n    video: videoConstraints,\n    audio: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e\n  };\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e当我们想通过 deviceId 来选择设备时，使用 exact 约束。 可是对于 facingMode，我们没有使用 exact 约束, 否则在一个无法识别有没有用户或环境模式的设备上将会失败，导致我们什么媒体设备也拿不到。\x3c\/p\x3e\n\x3cp\x3e当我们获得使用视频的权限时，在点击处理函数内，我们还要修改一些别的东西。把传递给函数的新流赋值给 currentStream 以便后续调用 stop，触发另一次 enumerateDevices 的调用。\x3c\/p\x3e\n\x3cp\x3eenumerateDevices 返回一个 promise，所以在我们的 then 函数中可以直接返回它，然后链式创建一个新的 then 把结果传递给 gotDevices 函数处理。\x3c\/p\x3e\n\x3cp\x3e用以下代码替换现有的 getUserMedia 调用：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs typescript\x22\x3ebutton.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eevent\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e currentStream !== \x3cspan class=\x22hljs-string\x22\x3e\x27undefined\x27\x3c\/span\x3e) {\n    stopMediaTracks(currentStream);\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e videoConstraints = {};\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (select.value === \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e) {\n    videoConstraints.facingMode = \x3cspan class=\x22hljs-string\x22\x3e\x27environment\x27\x3c\/span\x3e;\n  } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n    videoConstraints.deviceId = { exact: select.value };\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e constraints = {\n    video: videoConstraints,\n    audio: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e\n  };\n\n  navigator.mediaDevices\n    .getUserMedia(constraints)\n    .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3estream\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      currentStream = stream;\n      video.srcObject = stream;\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e navigator.mediaDevices.enumerateDevices();\n    })\n    .then(gotDevices)\n    .catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerror\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(error);\n    });\n});\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e当你添加完所有的代码，你的 app.js 应该看起来像\x3ca href=\x22https:\/\/github.com\/philnash\/mediadevices-camera-selection\/blob\/master\/app.js\x22\x3e这个文件\x3c\/a\x3e一样。刷新页面然后你就能愉快地选择和改变摄像头了。这个页面在移动设备和电脑上都有效。\x3c\/p\x3e\n\x3cp\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t0128492d0e72faf9d7.gif\x22 alt=\x22最后的结果，这个动画展示你能选择和修改摄像头，从查看后置到前置摄像头\x22\x3e\x3c\/p\x3e\n\x3ch3\x3e下一步\x3c\/h3\x3e\n\x3cp\x3e我们已经看到如何通过使用 facingMode 和 deviceId 约束来选择用户的摄像头。记住，在你有权限使用摄像头之前，facingMode 更可靠，但是选择 deviceId 更加精确。你可以从 \x3ca href=\x22https:\/\/github.com\/philnash\/mediadevices-camera-selection\x22\x3eGitHub 仓库\x3c\/a\x3e  中得到所有本文中的代码，你也可以\x3ca href=\x22https:\/\/philnash.github.io\/mediadevices-camera-selection\/\x22\x3e从这里尝试在线版的应用\x3c\/a\x3e。\x3c\/p\x3e\n\x3cp\x3e如果你正在使用 \x3ca href=\x22https:\/\/www.twilio.com\/docs\/api\/video\x22\x3eTwilio Video\x3c\/a\x3e 构建视频应用，你可以在调用 \x3ca href=\x22https:\/\/media.twiliocdn.com\/sdk\/js\/video\/releases\/1.8.0\/docs\/global.html#connect\x22\x3econnect\x3c\/a\x3e 或者 \x3ca href=\x22https:\/\/media.twiliocdn.com\/sdk\/js\/video\/releases\/1.8.0\/docs\/global.html#createLocalVideoTrack\x22\x3ecreateLocalVideoTrack\x3c\/a\x3e 的时候使用这些 constraints。\x3c\/p\x3e\n\x3cp\x3e对于视频聊天来说，选择和切换摄像头是非常有用的功能，允许用户在你的应用界面准确地选择他们想用的摄像头，并且还能做到\x3ca href=\x22https:\/\/www.twilio.com\/blog\/2018\/01\/screen-sharing-twilio-video.html\x22\x3e在视频通话时分享你的屏幕\x3c\/a\x3e。\x3c\/p\x3e\n\x3cp\x3e还有哪些其他你想看到的在视频聊天中有用的功能？或者对这个功能有什么疑问？欢迎在评论中留言或者在 Twitter 上  \x3ca href=\x22https:\/\/twitter.com\/philnash\x22\x3e@philnash\x3c\/a\x3e。\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>原文链接: <a href="https://www.zcfy.cc/article/choosing-cameras-in-javascript-with-the-mediadevices-api">https://www.zcfy.cc/article/choosing-cameras-in-javascript-with-the-mediadevices-api</a> 原文标题: JavaScript 使用 mediaDevices API 选择摄像头 本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2>本文链接：</h2><a href="https://alili.tech/archive/8e82c37c/" target="_blank">https://alili.tech/archive/8e82c37c/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>