<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="使用Websocket框架之GatewayWorker开发电商平台买家与卖家实时通讯"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>使用Websocket框架之GatewayWorker开发电商平台买家与卖家实时通讯 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/8hyd8c2wfzm/",
				"appid": "1613049289050283", 
				"title": "使用Websocket框架之GatewayWorker开发电商平台买家与卖家实时通讯 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-16T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/swcnaf8875m/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/1c1ud1p632rh/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f&text=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f&text=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f&title=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f&is_video=false&description=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f&title=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f&title=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f&title=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8hyd8c2wfzm%2f&title=%e4%bd%bf%e7%94%a8Websocket%e6%a1%86%e6%9e%b6%e4%b9%8bGatewayWorker%e5%bc%80%e5%8f%91%e7%94%b5%e5%95%86%e5%b9%b3%e5%8f%b0%e4%b9%b0%e5%ae%b6%e4%b8%8e%e5%8d%96%e5%ae%b6%e5%ae%9e%e6%97%b6%e9%80%9a%e8%ae%af"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">使用Websocket框架之GatewayWorker开发电商平台买家与卖家实时通讯</h1><div class="meta"><div class="postdate"><time datetime="2018-12-16" itemprop="datePublished">2018-12-16</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e前段时间公司提了一个新的需求，在商品的详情页要实现站内买家和商品卖家实时通讯的功能以方便沟通促成交易，要开发此功能当时首先考虑到的就是swoole和workerman了，从网上大概了解了一下关于这两款工具的阐述，功能都是相当强大的，考虑到项目的进度问题，还是选择上手容易比较快的GatewayWorker。\x3c\/p\x3e\n\x3cp\x3e先看一下我们前端设计高大上的模板，分别是用户和卖家后台。 功能还是比较全的，几乎模仿的是QQ。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bV2ALr?w=378\x26amp;h=670\x22 src=\x22https:\/\/static.alili.tech\/img\/bV2ALr?w=378\x26amp;h=670\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bV2ALC?w=695\x26amp;h=419\x22 src=\x22https:\/\/static.alili.tech\/img\/bV2ALC?w=695\x26amp;h=419\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3cbr\x3e业务上的大概需求是，用户在进入某个商品详情页下，给用户提供一个和卖家沟通的接口，根据商品的ID找到对应的卖家，类似于淘宝，还有发送图片，发送对应的商品链接；商户后台也差不多。\x3c\/p\x3e\n\x3cp\x3e我们的平台上有虚拟商品和实体商品两大分类，当时也考虑到了消息的读取状态。我的表最初设计如下，没有加任何的索引，考虑的或许也不够周全，有见地的前辈还望指点一二！\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22DROP TABLE IF EXISTS `hp_chat_log`;\nCREATE TABLE `hp_chat_log` (\n  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT \x27聊天记录表主键id\x27,\n  `user_id` int(10) unsigned NOT NULL DEFAULT \x270\x27 COMMENT \x27用户id\x27,\n  `merchant_id` varchar(15) COLLATE utf8_unicode_ci NOT NULL DEFAULT \x27\x27 COMMENT \x27商家id\x27,\n  `send_message` text COLLATE utf8_unicode_ci NOT NULL,\n  `send_message_type` tinyint(1) NOT NULL DEFAULT \x271\x27 COMMENT \x27发送消息类型(1:普通文本；2：商品链接,3:用户发送图片)\x27,\n  `sender` tinyint(1) NOT NULL DEFAULT \x271\x27 COMMENT \x27发送方。1:用户。2：商家\x27,\n  `send_time` int(11) NOT NULL DEFAULT \x270\x27 COMMENT \x27发送时间\x27,\n  `read_status` tinyint(1) unsigned NOT NULL DEFAULT \x270\x27 COMMENT \x27是否已读。0：未读取。1：已读取\x27,\n  `acc_isonline` tinyint(1) NOT NULL DEFAULT \x270\x27 COMMENT \x27接收方是否在线 （0：不在线；1：在线）\x27,\n  PRIMARY KEY (`id`)\n) ENGINE=MyISAM AUTO_INCREMENT=157 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs sql\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eDROP\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eTABLE\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eIF\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eEXISTS\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e`hp_chat_log`\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3eCREATE\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eTABLE\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e`hp_chat_log`\x3c\/span\x3e (\n  \x3cspan class=\x22hljs-string\x22\x3e`id`\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eint\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e11\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3eunsigned\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e AUTO_INCREMENT \x3cspan class=\x22hljs-keyword\x22\x3eCOMMENT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27聊天记录表主键id\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e`user_id`\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eint\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3eunsigned\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eDEFAULT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x270\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCOMMENT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27用户id\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e`merchant_id`\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3evarchar\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e15\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3eCOLLATE\x3c\/span\x3e utf8_unicode_ci \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eDEFAULT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCOMMENT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27商家id\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e`send_message`\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3etext\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCOLLATE\x3c\/span\x3e utf8_unicode_ci \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e`send_message_type`\x3c\/span\x3e tinyint(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eDEFAULT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x271\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCOMMENT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27发送消息类型(1:普通文本；2：商品链接,3:用户发送图片)\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e`sender`\x3c\/span\x3e tinyint(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eDEFAULT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x271\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCOMMENT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27发送方。1:用户。2：商家\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e`send_time`\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eint\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e11\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eDEFAULT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x270\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCOMMENT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27发送时间\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e`read_status`\x3c\/span\x3e tinyint(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3eunsigned\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eDEFAULT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x270\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCOMMENT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27是否已读。0：未读取。1：已读取\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e`acc_isonline`\x3c\/span\x3e tinyint(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3eNOT\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eNULL\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eDEFAULT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x270\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCOMMENT\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27接收方是否在线 （0：不在线；1：在线）\x27\x3c\/span\x3e,\n  PRIMARY \x3cspan class=\x22hljs-keyword\x22\x3eKEY\x3c\/span\x3e (\x3cspan class=\x22hljs-string\x22\x3e`id`\x3c\/span\x3e)\n) \x3cspan class=\x22hljs-keyword\x22\x3eENGINE\x3c\/span\x3e=MyISAM AUTO_INCREMENT=\x3cspan class=\x22hljs-number\x22\x3e157\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eDEFAULT\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eCHARSET\x3c\/span\x3e=utf8 \x3cspan class=\x22hljs-keyword\x22\x3eCOLLATE\x3c\/span\x3e=utf8_unicode_ci;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e模板有了，表设计好了，接下来就是搭建服务了，当前项目开发的框架用的是TP5，选择的Websocket框架是GatewayWorker框架，关于GatewayWorker与TP5的整合方法可以看我的这篇文章，讲到了在Linux和\x3c\/p\x3e\n\x3cp\x3eWindows下的整合安装。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22http:\/\/www.cnblogs.com\/wt645631686\/p\/7219519.html\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs awk\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3ehttp:\x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3ewww.cnblogs.com\x3cspan class=\x22hljs-regexp\x22\x3e\/wt645631686\/\x3c\/span\x3ep\x3cspan class=\x22hljs-regexp\x22\x3e\/7219519.html\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e整合好了之后需要根据当前服务器的一些端口配置在修改一些默认的配置，因为需要客户端通过指定的端口建立连接。\x3c\/p\x3e\n\x3cp\x3eTP5整合好了之后Gateway和workerman的主体目录结构都在TP5的框架目录vendor下的workerman目录下。需要修改里面gateway目录下的一些文件的端口及IP地址配置。\x3c\/p\x3e\n\x3cp\x3e配置完成之后，进入项目目录，按照workerman官方手册提供的使用方法，用命令php start.php start启动socket服务，如以下截图，分别是1238和8282端口。当然可以在后台运行，详细的使用方法请参考手册。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bV2AMx?w=589\x26amp;h=171\x22 src=\x22https:\/\/static.alili.tech\/img\/bV2AMx?w=589\x26amp;h=171\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e启动好了之后那么就需要在客户端开始下手了，我们项目里是在前端页面里用建立的链接。看前端代码\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e当前的所有代码并不是最终的，目前只是阶段性开发，后期在项目中逐步完善。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var ws;\n    \/\/ 连接服务端\n    function connect() {\n       \/\/ 创建websocket\n       ws = new WebSocket(\x26quot;ws:\/\/\x26quot;\x2bdocument.domain\x2b\x26quot;:8282\x26quot;);　　\/\/当时为了方便以后的维护，这里在php的全局文件里定义了一个常量来定义ip，后来本地开发完提交到linux服务器环境之后发现链接失败！\n       console.log(ws);\n       ws.onopen = onopen;\n       ws.onmessage = onmessage;\n       ws.onclose = function(e) {\n        console.log(e);\n          console.log(\x26quot;连接关闭，定时重连\x26quot;);\n          connect();\n       };\n       ws.onerror = function(e) {\n        console.log(e);\n          console.log(\x26quot;出现错误\x26quot;);\n       };\n    }\n     \/\/ 握手\n    function onopen()\n    {\n        var joint = \x27{\x26quot;type\x26quot;:\x26quot;handshake\x26quot;,\x26quot;role\x26quot;:\x26quot;user\x26quot;}\x27;\n        ws.send(joint);\n    }\n    \/\/ 服务端发来消息时\n    function onmessage(e)\n    {\n        var data = JSON.parse(e.data);\n          console.log(data);\n        switch(data[\x27type\x27]){\n            \/\/ 服务端ping客户端\n            case \x27ping\x27:\n                ws.send(\x27{\x26quot;type\x26quot;:\x26quot;pong\x26quot;}\x27);\n                break;\n            \/\/ 登录 更新用户列表\n            case \x27handshake\x27:\n                bindUid(data.client_id);\n                $(\x27#client_id\x27).val(data.client_id);\n                break;\n            \/\/ 提醒\n            case \x27reception\x27:\n                \/\/{\x26quot;type\x26quot;:\x26quot;say\x26quot;,\x26quot;from_client_id\x26quot;:xxx,\x26quot;to_client_id\x26quot;:\x26quot;all\/client_id\x26quot;,\x26quot;content\x26quot;:\x26quot;xxx\x26quot;,\x26quot;time\x26quot;:\x26quot;xxx\x26quot;}\n                warn(data[\x27content\x27], data[\x27time\x27], data[\x27timestamp\x27]);\n                break;\n        }\n    }\n\n    \/\/绑定uid\n    function bindUid (client_id) {\n        var bindUrl = \x26quot;{:url(\x27push\/push\/BindUserClientId\x27)}\x26quot;;\n        $.post(bindUrl, {client_id: client_id}, function(data){\n            console.log(data);\n        }, \x27json\x27);\n    }\n\n    \/\/发送连接\n    function sendLink () {\n       sendTrigger(\x27link\x27);\n    }\n    \/\/ 发送信息\n    function sendMessage (){\n        sendTrigger(\x27message\x27);\n    }\n    function sendTrigger(sendType) {\n      var toMid     = $(\x27#toMid\x27).val();\n      var pid       = $(\x27#pid\x27).val();\n      var message   = $(\x26quot;footer .send_content\x26quot;).val();\n      var client_id = $(\x27#client_id\x27).val();\n      var sendUrl   = \x26quot;{:url(\x27push\/push\/SendMessageToMerchant\x27)}\x26quot;;\n      $.ajax({\n        url:sendUrl,\n        type:\x27POST\x27,\n        data:{message:message,toMid:toMid,pid:pid,client_id:client_id,sendType:sendType},\n        async:false,\n        dataType:\x27JSON\x27,\n        success:function(data){\n            data = JSON.parse(data);\n            if (data.status \x3c 0) {\n                alert(\x27发送失败，请稍后再试！\x27);\n            } else {\n                $(\x27#send_timestamp\x27).val(data.timeStamp);\n                $(\x27#send_timestr\x27).val(data.timeStr);\n                if (sendType == \x27link\x27) {\n                    $(\x27#main\x27).append(data.html);\n                }\n            }\n        }\n      })\n    }\n\n    \/\/ 提醒\n    function warn(content, time, prevTmestamp){\n        var V_image = $(\x27#V_image\x27).val();\n        var str = \x27\x3cdiv class=\x26quot;chat-receiver\x26quot;\x3e\x27 \x2b timestampWarn(prevTmestamp, time) \x2b \x27\x3cdiv class=\x26quot;chat-avatar\x26quot;\x3e\x3cimg src=\x26quot;\x27\x2b V_image\x2b \x27\x26quot; alt=\x26quot;\x26quot;\x3e\x3c\/div\x3e\n　　　　　　　　\x3cdiv class=\x26quot;chat-content\x26quot;\x3e\x3cdiv class=\x26quot;chat-triangle\x26quot;\x3e\x3c\/div\x3e\x3cspan\x3e\x27 \x2b content \x2b \x27\x3c\/span\x3e\x3c\/div\x3e\x27;\n        domChange(str);\n        $(\x26quot;#main\x26quot;).scrollTop($(\x26quot;#main\x26quot;)[0].scrollHeight);\n\n    }\n\n    \/\/发送\n    function sender(content, time, prevTmestamp) {\n        var user_image = $(\x27#user_image\x27).val();\n        var str = \x27\x3cdiv class=\x26quot;chat-sender\x26quot;\x3e\x27 \x2b timestampWarn(prevTmestamp, time) \x2b \x27\x3cdiv class=\x26quot;chat-avatar\x26quot;\x3e\x3cimg src=\x26quot;\x27 \x2buser_image \x2b \x27\x26quot; alt=\x26quot;\x26quot;\x3e\n\x3c\/div\x3e\x3cdiv class=\x26quot;chat-content\x26quot;\x3e\x3cdiv class=\x26quot;chat-triangle\x26quot;\x3e\x3c\/div\x3e\x27 \x2b\n        \x27\x3cspan\x3e\x27 \x2b content \x2b \x27\x3c\/span\x3e\x3c\/div\x3e\x3c\/div\x3e\x27;\n        domChange(str);\n    }\n\n    \/\/消息时间控制\n    function timestampWarn (nowTimestamp , nowTime) {\n        var prevTimestamp = $(\x27#prev_timestamp\x27).val();\n        $(\x27#prev_timestamp\x27).val(nowTimestamp);\n        var timeOffset    = 6;\n        var accTime = \x27\x27;\n        if ((nowTimestamp - prevTimestamp) \x3e timeOffset) {\n           accTime =  \x27\x3cdiv style=\x26quot;clear:both;\x26quot;\x3e\x3c\/div\x3e\x3cp class=\x26quot;chat-history-date\x26quot;\x3e\x27 \x2b nowTime \x2b \x27\x3c\/p\x3e\x27;\n        }\n        return accTime;\n    }\n\x3cbody onload=\x26quot;connect();\x26quot;\x3e\n\x3c\/body\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scilab\x22\x3e\x3ccode\x3evar ws;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 连接服务端\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3econnect\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e {\x3c\/span\x3e\n       \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 创建websocket\x3c\/span\x3e\n       ws = new WebSocket(\x3cspan class=\x22hljs-string\x22\x3e\x22ws:\/\/\x22\x3c\/span\x3e\x2bdocument.domain\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22:8282\x22\x3c\/span\x3e);　　\x3cspan class=\x22hljs-comment\x22\x3e\/\/当时为了方便以后的维护，这里在php的全局文件里定义了一个常量来定义ip，后来本地开发完提交到linux服务器环境之后发现链接失败！\x3c\/span\x3e\n       console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(ws);\n       ws.onopen = onopen;\n       ws.onmessage = onmessage;\n       ws.onclose = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(e)\x3c\/span\x3e {\x3c\/span\x3e\n        console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(e);\n          console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22连接关闭，定时重连\x22\x3c\/span\x3e);\n          connect();\n       };\n       ws.onerror = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(e)\x3c\/span\x3e {\x3c\/span\x3e\n        console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(e);\n          console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22出现错误\x22\x3c\/span\x3e);\n       };\n    }\n     \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 握手\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonopen\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e\n    {\n        var joint = \x3cspan class=\x22hljs-string\x22\x3e\x27{\x22\x3c\/span\x3e\x3cspan class=\x22hljs-built_in\x22\x3etype\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x22:\x22\x3c\/span\x3ehandshake\x3cspan class=\x22hljs-string\x22\x3e\x22,\x22\x3c\/span\x3erole\x3cspan class=\x22hljs-string\x22\x3e\x22:\x22\x3c\/span\x3euser\x3cspan class=\x22hljs-string\x22\x3e\x22}\x27\x3c\/span\x3e;\n        ws.send(joint);\n    }\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 服务端发来消息时\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonmessage\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(e)\x3c\/span\x3e\x3c\/span\x3e\n    {\n        var data = JSON.parse(e.data);\n          console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(data);\n        switch(data[\x3cspan class=\x22hljs-string\x22\x3e\x27type\x27\x3c\/span\x3e]){\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 服务端ping客户端\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27ping\x27\x3c\/span\x3e:\n                ws.send(\x3cspan class=\x22hljs-string\x22\x3e\x27{\x22\x3c\/span\x3e\x3cspan class=\x22hljs-built_in\x22\x3etype\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x22:\x22\x3c\/span\x3epong\x3cspan class=\x22hljs-string\x22\x3e\x22}\x27\x3c\/span\x3e);\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 登录 更新用户列表\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27handshake\x27\x3c\/span\x3e:\n                bindUid(data.client_id);\n                $(\x3cspan class=\x22hljs-string\x22\x3e\x27#client_id\x27\x3c\/span\x3e).val(data.client_id);\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 提醒\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27reception\x27\x3c\/span\x3e:\n                \x3cspan class=\x22hljs-comment\x22\x3e\/\/{\x22type\x22:\x22say\x22,\x22from_client_id\x22:xxx,\x22to_client_id\x22:\x22all\/client_id\x22,\x22content\x22:\x22xxx\x22,\x22time\x22:\x22xxx\x22}\x3c\/span\x3e\n                warn(data[\x3cspan class=\x22hljs-string\x22\x3e\x27content\x27\x3c\/span\x3e], data[\x3cspan class=\x22hljs-string\x22\x3e\x27time\x27\x3c\/span\x3e], data[\x3cspan class=\x22hljs-string\x22\x3e\x27timestamp\x27\x3c\/span\x3e]);\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n        }\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/绑定uid\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ebindUid\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(client_id)\x3c\/span\x3e {\x3c\/span\x3e\n        var bindUrl = \x3cspan class=\x22hljs-string\x22\x3e\x22{:url(\x27\x3c\/span\x3epush\/push\/BindUserClientId\x27)}\x3cspan class=\x22hljs-string\x22\x3e\x22;\n        $.post(bindUrl, {client_id: client_id}, function(data){\n            console.log(data);\n        }, \x27\x3c\/span\x3ejson\x27);\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/发送连接\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esendLink\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e {\x3c\/span\x3e\n       sendTrigger(\x3cspan class=\x22hljs-string\x22\x3e\x27link\x27\x3c\/span\x3e);\n    }\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 发送信息\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esendMessage\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e{\x3c\/span\x3e\n        sendTrigger(\x3cspan class=\x22hljs-string\x22\x3e\x27message\x27\x3c\/span\x3e);\n    }\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esendTrigger\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(sendType)\x3c\/span\x3e {\x3c\/span\x3e\n      var toMid     = $(\x3cspan class=\x22hljs-string\x22\x3e\x27#toMid\x27\x3c\/span\x3e).val();\n      var pid       = $(\x3cspan class=\x22hljs-string\x22\x3e\x27#pid\x27\x3c\/span\x3e).val();\n      var message   = $(\x3cspan class=\x22hljs-string\x22\x3e\x22footer .send_content\x22\x3c\/span\x3e).val();\n      var client_id = $(\x3cspan class=\x22hljs-string\x22\x3e\x27#client_id\x27\x3c\/span\x3e).val();\n      var sendUrl   = \x3cspan class=\x22hljs-string\x22\x3e\x22{:url(\x27\x3c\/span\x3epush\/push\/SendMessageToMerchant\x27)}\x3cspan class=\x22hljs-string\x22\x3e\x22;\n      $.ajax({\n        url:sendUrl,\n        type:\x27\x3c\/span\x3ePOST\x27,\n        data:{message:message,toMid:toMid,pid:pid,client_id:client_id,sendType:sendType},\n        async:false,\n        dataType:\x3cspan class=\x22hljs-string\x22\x3e\x27JSON\x27\x3c\/span\x3e,\n        success:\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(data)\x3c\/span\x3e{\x3c\/span\x3e\n            data = JSON.parse(data);\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (data.status \x26lt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n                alert(\x3cspan class=\x22hljs-string\x22\x3e\x27发送失败，请稍后再试！\x27\x3c\/span\x3e);\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                $(\x3cspan class=\x22hljs-string\x22\x3e\x27#send_timestamp\x27\x3c\/span\x3e).val(data.timeStamp);\n                $(\x3cspan class=\x22hljs-string\x22\x3e\x27#send_timestr\x27\x3c\/span\x3e).val(data.timeStr);\n                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (sendType == \x3cspan class=\x22hljs-string\x22\x3e\x27link\x27\x3c\/span\x3e) {\n                    $(\x3cspan class=\x22hljs-string\x22\x3e\x27#main\x27\x3c\/span\x3e).append(data.html);\n                }\n            }\n        }\n      })\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 提醒\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ewarn\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(content, time, prevTmestamp)\x3c\/span\x3e{\x3c\/span\x3e\n        var V_image = $(\x3cspan class=\x22hljs-string\x22\x3e\x27#V_image\x27\x3c\/span\x3e).val();\n        var str = \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div class=\x22\x3c\/span\x3echat-receiver\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x27\x3c\/span\x3e \x2b timestampWarn(prevTmestamp, time) \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div class=\x22\x3c\/span\x3echat-avatar\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x26lt;img src=\x22\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x27\x2b V_image\x2b \x27\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x22 alt=\x22\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x26lt;\/div\x26gt;\n　　　　　　　　\x26lt;div class=\x22\x3c\/span\x3echat-content\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x26lt;div class=\x22\x3c\/span\x3echat-triangle\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x26lt;\/div\x26gt;\x26lt;span\x26gt;\x27\x3c\/span\x3e \x2b content \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\/span\x26gt;\x26lt;\/div\x26gt;\x27\x3c\/span\x3e;\n        domChange(str);\n        $(\x3cspan class=\x22hljs-string\x22\x3e\x22#main\x22\x3c\/span\x3e).scrollTop($(\x3cspan class=\x22hljs-string\x22\x3e\x22#main\x22\x3c\/span\x3e)[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e].scrollHeight);\n\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/发送\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esender\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(content, time, prevTmestamp)\x3c\/span\x3e {\x3c\/span\x3e\n        var user_image = $(\x3cspan class=\x22hljs-string\x22\x3e\x27#user_image\x27\x3c\/span\x3e).val();\n        var str = \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div class=\x22\x3c\/span\x3echat-sender\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x27\x3c\/span\x3e \x2b timestampWarn(prevTmestamp, time) \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div class=\x22\x3c\/span\x3echat-avatar\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x26lt;img src=\x22\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x27 \x2buser_image \x2b \x27\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x22 alt=\x22\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\n\x26lt;\/div\x26gt;\x26lt;div class=\x22\x3c\/span\x3echat-content\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x26lt;div class=\x22\x3c\/span\x3echat-triangle\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x26lt;\/div\x26gt;\x27\x3c\/span\x3e \x2b\n        \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;span\x26gt;\x27\x3c\/span\x3e \x2b content \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\/span\x26gt;\x26lt;\/div\x26gt;\x26lt;\/div\x26gt;\x27\x3c\/span\x3e;\n        domChange(str);\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/消息时间控制\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3etimestampWarn\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(nowTimestamp , nowTime)\x3c\/span\x3e {\x3c\/span\x3e\n        var prevTimestamp = $(\x3cspan class=\x22hljs-string\x22\x3e\x27#prev_timestamp\x27\x3c\/span\x3e).val();\n        $(\x3cspan class=\x22hljs-string\x22\x3e\x27#prev_timestamp\x27\x3c\/span\x3e).val(nowTimestamp);\n        var timeOffset    = \x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e;\n        var accTime = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ((nowTimestamp - prevTimestamp) \x26gt; timeOffset) {\n           accTime =  \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div style=\x22\x3c\/span\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclear\x3c\/span\x3e:both;\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x26lt;\/div\x26gt;\x26lt;p class=\x22\x3c\/span\x3echat-history-date\x3cspan class=\x22hljs-string\x22\x3e\x22\x26gt;\x27\x3c\/span\x3e \x2b nowTime \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\/p\x26gt;\x27\x3c\/span\x3e;\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e accTime;\n    }\n\x26lt;body onload=\x3cspan class=\x22hljs-string\x22\x3e\x22connect();\x22\x3c\/span\x3e\x26gt;\n\x26lt;\/body\x26gt;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在开发过程中，修改的GatewayWorker文件并不多，除了几个主要的端口及IP需要修改之外，仅仅修改一个重要的文件就够了，那就是Push模块（项目的通讯模块）同级的Events.php文件。看一下项目需求里\x3c\/p\x3e\n\x3cp\x3e修改后的代码，一个方法；\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/**\n    * 当客户端发来消息时触发\n    * @param int $client_id 连接id\n    * @param mixed $message 具体消息\n    *\/\n   public static function onMessage($client_id, $message)\n   {\n        $message_data = json_decode($message,true);\n        if (!$message_data) {\n            return ;\n        }\n        switch($message_data[\x27type\x27]) {\n            case \x27pong\x27:\n                return;\n            case \x27handshake\x27:                \n                $new_message    = [\n                    \x27type\x27      =\x3e $message_data[\x27type\x27],\n                    \x27client_id\x27 =\x3e $client_id, \n                    \x27time\x27      =\x3e date(\x27H:i:s\x27)\n                ];\n                Gateway::sendToClient($client_id, json_encode($new_message));\n                return;\n            case \x27send\x27:\n                if (!isset($message_data[\x27toClientUid\x27])) {\n                  throw new \\Exception(\x26quot;toClient not set. client_ip:{$_SERVER[\x27REMOTE_ADDR\x27]}\x26quot;);\n                }\n                $toUid          = $message_data[\x27toClientUid\x27];\n                $message        = $message_data[\x27content\x27];\n                $new_message    = [\n                    \x27type\x27      =\x3e \x27reception\x27,\n                    \x27content\x27   =\x3e $message, \n                    \x27time\x27      =\x3e date(\x27H:i:s\x27),\n                    \x27timestamp\x27 =\x3e time(),\n                    \x27c_type\x27    =\x3e $message_data[\x27c_type\x27],\n                    \x27primary\x27   =\x3e $message_data[\x27Db_id\x27]\n                ];  \n                \/\/发送者角色\n                $source_info = explode(\x27_\x27, $message_data[\x27source\x27]);\n                if ($source_info[0] == \x27U\x27) {\n　　　　　　　　　　　　\/\/为了安全，特意做了加密\n                    $new_message[\x27source\x27] = encrypt_hopeband($source_info[1], \x27E\x27, \x27XXXXXXX\x27);　　　　\n                }\n\n                return Gateway::sendToUid($toUid, json_encode($new_message));\n        }\n   }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/**\n    * 当客户端发来消息时触发\n    * \x3cspan class=\x22hljs-doctag\x22\x3e@param\x3c\/span\x3e int $client_id 连接id\n    * \x3cspan class=\x22hljs-doctag\x22\x3e@param\x3c\/span\x3e mixed $message 具体消息\n    *\/\x3c\/span\x3e\n   \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3estatic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonMessage\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e($client_id, $message)\x3c\/span\x3e\n   \x3c\/span\x3e{\n        $message_data = json_decode($message,\x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!$message_data) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e ;\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3eswitch\x3c\/span\x3e($message_data[\x3cspan class=\x22hljs-string\x22\x3e\x27type\x27\x3c\/span\x3e]) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27pong\x27\x3c\/span\x3e:\n                \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27handshake\x27\x3c\/span\x3e:                \n                $new_message    = [\n                    \x3cspan class=\x22hljs-string\x22\x3e\x27type\x27\x3c\/span\x3e      =\x26gt; $message_data[\x3cspan class=\x22hljs-string\x22\x3e\x27type\x27\x3c\/span\x3e],\n                    \x3cspan class=\x22hljs-string\x22\x3e\x27client_id\x27\x3c\/span\x3e =\x26gt; $client_id, \n                    \x3cspan class=\x22hljs-string\x22\x3e\x27time\x27\x3c\/span\x3e      =\x26gt; date(\x3cspan class=\x22hljs-string\x22\x3e\x27H:i:s\x27\x3c\/span\x3e)\n                ];\n                Gateway::sendToClient($client_id, json_encode($new_message));\n                \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27send\x27\x3c\/span\x3e:\n                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-keyword\x22\x3eisset\x3c\/span\x3e($message_data[\x3cspan class=\x22hljs-string\x22\x3e\x27toClientUid\x27\x3c\/span\x3e])) {\n                  \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \\\x3cspan class=\x22hljs-keyword\x22\x3eException\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22toClient not set. client_ip:{$_SERVER[\x27REMOTE_ADDR\x27]}\x22\x3c\/span\x3e);\n                }\n                $toUid          = $message_data[\x3cspan class=\x22hljs-string\x22\x3e\x27toClientUid\x27\x3c\/span\x3e];\n                $message        = $message_data[\x3cspan class=\x22hljs-string\x22\x3e\x27content\x27\x3c\/span\x3e];\n                $new_message    = [\n                    \x3cspan class=\x22hljs-string\x22\x3e\x27type\x27\x3c\/span\x3e      =\x26gt; \x3cspan class=\x22hljs-string\x22\x3e\x27reception\x27\x3c\/span\x3e,\n                    \x3cspan class=\x22hljs-string\x22\x3e\x27content\x27\x3c\/span\x3e   =\x26gt; $message, \n                    \x3cspan class=\x22hljs-string\x22\x3e\x27time\x27\x3c\/span\x3e      =\x26gt; date(\x3cspan class=\x22hljs-string\x22\x3e\x27H:i:s\x27\x3c\/span\x3e),\n                    \x3cspan class=\x22hljs-string\x22\x3e\x27timestamp\x27\x3c\/span\x3e =\x26gt; time(),\n                    \x3cspan class=\x22hljs-string\x22\x3e\x27c_type\x27\x3c\/span\x3e    =\x26gt; $message_data[\x3cspan class=\x22hljs-string\x22\x3e\x27c_type\x27\x3c\/span\x3e],\n                    \x3cspan class=\x22hljs-string\x22\x3e\x27primary\x27\x3c\/span\x3e   =\x26gt; $message_data[\x3cspan class=\x22hljs-string\x22\x3e\x27Db_id\x27\x3c\/span\x3e]\n                ];  \n                \x3cspan class=\x22hljs-comment\x22\x3e\/\/发送者角色\x3c\/span\x3e\n                $source_info = explode(\x3cspan class=\x22hljs-string\x22\x3e\x27_\x27\x3c\/span\x3e, $message_data[\x3cspan class=\x22hljs-string\x22\x3e\x27source\x27\x3c\/span\x3e]);\n                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($source_info[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x27U\x27\x3c\/span\x3e) {\n　　　　　　　　　　　　\x3cspan class=\x22hljs-comment\x22\x3e\/\/为了安全，特意做了加密\x3c\/span\x3e\n                    $new_message[\x3cspan class=\x22hljs-string\x22\x3e\x27source\x27\x3c\/span\x3e] = encrypt_hopeband($source_info[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e], \x3cspan class=\x22hljs-string\x22\x3e\x27E\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27XXXXXXX\x27\x3c\/span\x3e);　　　　\n                }\n\n                \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e Gateway::sendToUid($toUid, json_encode($new_message));\n        }\n   }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后看一下Push模块下的控制器文件，在配合前端在绑定客户端ID及发送信息做的一些处理。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class Push extends Base{\n\n    protected static $user_headimage = \x27\x27;\n    protected static $uid = null;\n\n\n\n    public function __construct () {\n        parent::__construct();\n        $this-\x3echeckUserLogin();\n        \/\/用户头像昵称等信息\n        self::$uid            = session(\x27userinfo.uid\x27);\n        $user_info            = Hmodel\\User::getUserChatinfoById(self::$uid);\n        self::$user_headimage = json_decode($user_info[\x27headimgurl\x27],true)[0];\n\n    }\n\n\n    public function chatAction () {\n        $product_id = intval(input(\x27param.pid\x27, 0, \x27int\x27));\n        $toMid      = Hmodel\\Product::getMidByProductid($product_id);\n        if ($toMid === false) notFund();\n\n        $productHtml = $this-\x3ereturnProductData2Html($product_id, \x27default\x27);\n\n        $int_toMid = substr($toMid, 2);\n        $V_headInfo = Pmodel\\Push::getVmerchantHeadImageByVid($int_toMid);\n        $V_headimage = is_not_empty_array($V_headInfo) ? json_decode($V_headInfo[\x27headimgurl\x27])[0] :\x27\/uploads\/logo.png\x27;\n\n        if (substr($toMid, 0, 1) == \x27V\x27) {\n            $chatLogData = Pmodel\\Push::getChatlogByUseridAndVid(self::$uid, $int_toMid); \n            if (is_not_empty_array($chatLogData)) {\n                $chatLog = self::chatlogData2Html($chatLogData, $V_headimage);\n            }\n        } elseif (substr($toMid, 0, 1) == \x27E\x27) {\n\n        }\n\n\n        $view = new View;\n        $view-\x3eassign(\x27pHtml\x27, $productHtml);\n        $view-\x3eassign(\x27toMid\x27, $toMid);\n        $view-\x3eassign(\x27pid\x27, $product_id);\n        $view-\x3eassign(\x27chatlogHtml\x27, $chatLog);\n        $view-\x3eassign(\x27role\x27, \x27user\x27);\n        $view-\x3eassign(\x27user_image\x27, self::$user_headimage);\n        $view-\x3eassign(\x27V_image\x27, $V_headimage);\n        return $view-\x3efetch();\n    }\n\n\n      private static function chatlogData2Html ($data = [], $V_headimage = \x27\x27) {\n        $todayTimestamp = strtotime(date(\x27Y-m-d\x27));\n        $html = \x27\x27;\n        foreach ($data as $k =\x3e $v) {\n            $date = $v[\x27send_time\x27] \x3c $todayTimestamp ? date(\x27Y\/m\/d H:i:s\x27, $v[\x27send_time\x27]) : date(\x27H:i:s\x27, $v[\x27send_time\x27]);\n            $time_nodes = \x27\x27;\n            if (($data[$k][\x27send_time\x27] - $data[$k-1][\x27send_time\x27]) \x3e 180) {\n                $time_nodes = \x27\x3cdiv style=\x26quot;clear:both;\x26quot;\x3e\x3c\/div\x3e\x3cp class=\x26quot;chat-history-date\x26quot;\x3e\x27 .$date.\x27\x3c\/p\x3e\x27;\n            } \n            \/\/sender-\x3e发送方   1:用户。2：商家\n            if ($v[\x27sender\x27] == 1) {\n                \n                \/\/send_message_type-\x3e发送消息类型  (1:普通文本；2：商品链接)\n                if ($v[\x27send_message_type\x27] == 1) {\n                    $html.= \x27\x3cdiv class=\x26quot;chat-sender\x26quot;\x3e\x27;\n                    $html.= $time_nodes;\n                    $html.= \x27\x3cdiv class=\x26quot;chat-avatar\x26quot;\x3e\x3cimg src=\x26quot;\x27 . self::$user_headimage . \x27\x26quot; alt=\x26quot;\x26quot;\x3e\x3c\/div\x3e\x27;\n                    $html.= \x27\x3cdiv class=\x26quot;chat-content\x26quot;\x3e\x3cdiv class=\x26quot;chat-triangle\x26quot;\x3e\x3c\/div\x3e\x3cspan\x3e\x27 . $v[\x27send_message\x27].\x27\x3c\/span\x3e\x3c\/div\x3e\x27;\n                    $html.= \x27\x3c\/div\x3e\x27;\n                }elseif ($v[\x27send_message_type\x27] == 2) {\n                    $html.= $time_nodes;\n                    $product_info = json_decode($v[\x27send_message\x27],true);\n                    $html.= self::productData2SendHtml($product_info);\n                }elseif ($v[\x27send_message_type\x27] == 3) {\n                    $images_arr = json_decode($v[\x27send_message\x27],true);\n                  \n                    $html.= \x27\x3cdiv class=\x26quot;chat-sender\x26quot;\x3e\x27;\n                    $html.= $time_nodes;\n                    $html.= \x27\x3cdiv class=\x26quot;chat-avatar\x26quot;\x3e\x3cimg src=\x26quot;\x27 . self::$user_headimage . \x27\x26quot; alt=\x26quot;\x26quot;\x3e\x3c\/div\x3e\x27;\n                    $html.= \x27\x3cdiv class=\x26quot;chat-content\x26quot;\x3e\x3cdiv class=\x26quot;chat-triangle\x26quot;\x3e\x3c\/div\x3e\x27;\n                    foreach ($images_arr as $v ) {\n                        $html.= \x27\x3cimg src=\x26quot;\x27 .WEB_SITE. \x27\/\x27 . $v . \x27\x26quot; style=\x26quot;max-width:85%\x26quot;\x3e\x27;\n                    }\n                    $html.= \x27\x3c\/div\x3e\x27;\n                    $html.= \x27\x3c\/div\x3e\x27;\n                }\n            }else {\n                if ($v[\x27send_message_type\x27] == 1) {\n                    $html.= \x27\x3cdiv class=\x26quot;chat-receiver\x26quot;\x3e\x27;\n                    $html.= \x27\x3cdiv class=\x26quot;chat-avatar\x26quot;\x3e\x3cimg src=\x26quot;\x27 . $V_headimage . \x27\x26quot; alt=\x26quot;\x26quot;\x3e\x3c\/div\x3e\x27;\n                    $html.= \x27\x3cdiv class=\x26quot;chat-content\x26quot;\x3e\x3cdiv class=\x26quot;chat-triangle\x26quot;\x3e\x3c\/div\x3e\x3cspan\x3e\x27 . $v[\x27send_message\x27].\x27\x3c\/span\x3e\x3c\/div\x3e\x27;\n                    $html.= \x27\x3c\/div\x3e\x27;\n                }elseif ($v[\x27send_message_type\x27] == 2) {\n\n                }\n            }\n        }\n        return $html;\n    }\n    public function BindUserClientIdAction () {\n        if (!Request::instance()-\x3eisPost()) { notFund(); }\n        $bindUserid = \x27U_\x27 . session(\x27userinfo.uid\x27);\n        $client_id = input(\x26quot;param.client_id\x26quot;, 0, \x26quot;string\x26quot;); \n        \/\/ 设置GatewayWorker服务的Register服务ip和端口\n        Gateway::$registerAddress = SOCKET_SERVER_PORT;\n        \/\/ client_id与uid绑定\n        \/\/ Gateway::closeClient($client_id);\n        return Gateway::bindUid($client_id, $bindUserid);\n}\n\/\/用户发送消息给商家\n    public function SendMessageToMerchantAction () {\n        if (!Request::instance()-\x3eisPost()) { notFund(); }\n        $message   = $_POST[\x27message\x27]; \n        $toMid     = input(\x27post.toMid\x27, \x27\x27 , \x27string\x27);\n        $product_id= input(\x27post.pid\x27, 0, \x27int\x27);\n        $client_id = input(\x27post.client_id\x27, \x27\x27, \x27string\x27);\n        $sendType  = input(\x27post.sendType\x27, \x27\x27, \x27string\x27);\n\n\n\n        if (!in_array($sendType,[\x27link\x27, \x27message\x27])) {                             \/\/客户端错误\n            return json_encode([\x27status\x27 =\x3e -1]);\n        }\n        if (strlen($client_id) != 20 ) {                                            \/\/客户端错误\n            return json_encode([\x27status\x27 =\x3e -1]);\n        }\n        if (!is_not_empty_string($toMid) || !is_positive_integer($product_id)) {    \/\/系统错误\n            return json_encode([\x27status\x27 =\x3e -2]);\n        }\n        $db_toMid      = Hmodel\\Product::getMidByProductid($product_id);            \/\/数据错误\n        if ($db_toMid != $toMid) {\n            return json_encode([\x27status\x27 =\x3e -3]);\n        }\n        require_once dirname(dirname(__FILE__)) . \x27\/Events.php\x27;\n\n        $uid            = session(\x27userinfo.uid\x27);\n        $accIsOnline    = Gateway::isUidOnline($toMid) == 1 ? 1 : 0;                \/\/判读商家是否在线\n        $message_type   = 1;\n        if ($sendType == \x27link\x27) {\n            $message_type = 2;\n            $productData = $this-\x3ereferProductData($product_id);\n            unset($productData[\x27product_price\x27]);\n            unset($productData[\x27score\x27]);\n            unset($productData[\x27product_stock\x27]);\n            unset($productData[\x27product_param\x27]);\n            unset($productData[\x27product_desc\x27]);\n            unset($productData[\x27product_main\x27]);\n            unset($productData[\x27category_id\x27]);\n            unset($productData[\x27merchant_id\x27]);\n            $message = json_encode($productData);\n        }\n        \/\/Log入库\n        $insertId       = Pmodel\\Push::addChatLog($uid, $toMid, $message, $message_type, 1, $accIsOnline);\n        if($message_type == 1){\n            if(!is_numeric($message)){\n                $message = \x27\x26quot;\x27.$message.\x27\x26quot;\x27;\n            }\n            if ($message == \x27\x27) {\n                $message = \x27\x27;\n            }\n        }\n        if ($insertId === false) {                                                  \/\/入库失败（服务器故障）\n            return json_encode([\x27status\x27 =\x3e -3]);\n        }\n        $Worker = new \\Events;\n        $message_json   = \x27{\x26quot;type\x26quot;:\x26quot;send\x26quot;,\x26quot;source\x26quot;:\x26quot;U_\x27 . $uid . \x27\x26quot;,\x26quot;toClientUid\x26quot;:\x26quot;\x27 . $toMid . \x27\x26quot;,\x26quot;content\x26quot;:\x27 . $message .\x27,\n　　　　　　　　　　　　　　   \x26quot;c_type\x26quot;: \x27 . $message_type .\x27, \x26quot;Db_id\x26quot;:\x27 . $insertId . \x27}\x27;\n\n        $Worker::onMessage($client_id, $message_json);\n        \/\/成功返回相关数据\n        return json_encode([\n            \x27status\x27    =\x3e 1,\n            \x27timeStamp\x27 =\x3e time(),\n            \x27timeStr\x27   =\x3e date(\x27H:i:s\x27),\n            \x27html\x27      =\x3e $message_type == 1 ? \x27\x27 : self::productData2SendHtml($productData)\n        ]);\n\n }\n\/\/商家发送信息给用户\n    public function sendMessageToUserAction () {\n     if (!Request::instance()-\x3eisPost()) { notFund(); }\n        $post_message = is_not_empty_string($_POST[\x27message\x27]) ? $_POST[\x27message\x27] : \x27\x27; \n        $toUserCode   = input(\x27post.toUserCode\x27, \x27\x27 , \x27string\x27);\n        $toU_uid      = encrypt_hopeband($toUserCode, \x27D\x27, \x27xxxxx\x27);\n        $V_client_id  = input(\x27post.client_id\x27, \x27\x27, \x27string\x27);\n        $V_uid_code   = input(\x27post.myCode\x27, \x27\x27, \x27string\x27);\n        $V_uid        = encrypt_hopeband($V_uid_code, \x27D\x27, \x27xxxxx\x27);\n        $make_message = [];\n        $message = \x27\x27;\n        self::trimImageAndTextinfo2str($post_message, $make_message);\n\n        if (is_not_empty_array($make_message)) {\n            foreach ( $make_message as \x26amp;$v ) {\n                $message .= self::checkIflegalAndReturn($v);\n            }\n           \n        }\n       \n        if (strlen($V_client_id) != 20 || Gateway::isOnline($V_client_id) != 1) {       \/\/客户端错误\n            return json_encode([\x27status\x27 =\x3e -2]);\n        }    \n        $V_merchantInfo = Pmodel\\Push::getVmerchantInfoByVid($V_uid);\n        if (!is_not_empty_array($V_merchantInfo)) {                                     \/\/商家信息不存在\n            return json_encode([\x27status\x27 =\x3e -1]);\n        }\n        require_once dirname(dirname(__FILE__)) . \x27\/Events.php\x27;\n\n        $accIsOnline    = Gateway::isUidOnline(\x27U_\x27 . $toU_uid) == 1 ? 1 : 0;         \/\/判读用户是否在线\n        $message_type   = 1;\n        \/\/Log入库\n        $insertId       = Pmodel\\Push::addChatLog($toU_uid, \x27V_\x27 . $V_uid, $message, 1, 2, $accIsOnline);\n        if ($insertId === false) {                                                  \/\/入库失败（服务器故障）\n            return json_encode([\x27status\x27 =\x3e -3]);\n        }\n        $Worker = new \\Events;\n        $img_encrypt_code = encrypt_hopeband(\x27Hp_(legal)\x27, \x27E\x27, \x27Hp_HopeBand_Chat_img\x27);\n        $message = str_replace($img_encrypt_code .\x27 src=\x26quot;\x27, $img_encrypt_code . \x26quot; src=\x27\x26quot;, $message);\n        $message = str_replace(\x27\x26quot;\x3e\x27, \x26quot;\x27\x3e\x26quot;, $message);\n        $message_json   = \x27{\x26quot;type\x26quot;:\x26quot;send\x26quot;,\x26quot;toClientUid\x26quot;:\x26quot;U_\x27 . $toU_uid . \x27\x26quot;,\x26quot;content\x26quot;:\x26quot;\x27 . $message .\x27\x26quot;,\x26quot;Db_id\x26quot;: \x26quot;\x27 . $insertId . \x27\x26quot;}\x27;  \n        $Worker::onMessage($client_id, $message_json);\n        \/\/成功返回相关数据\n        return json_encode([\n            \x27status\x27    =\x3e 1,\n            \x27timeStamp\x27 =\x3e time(),\n            \x27timeStr\x27   =\x3e date(\x27H:i:s\x27),\n        ]);\n\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre\x3e\x3ccode\x3eclass Push extends Base{\n\n    protected static $user_headimage = \x27\x27;\n    protected static $uid = null;\n\n\n\n    public function __construct () {\n        parent::__construct();\n        $this-\x26gt;checkUserLogin();\n        \/\/用户头像昵称等信息\n        self::$uid            = session(\x27userinfo.uid\x27);\n        $user_info            = Hmodel\\User::getUserChatinfoById(self::$uid);\n        self::$user_headimage = json_decode($user_info[\x27headimgurl\x27],true)[0];\n\n    }\n\n\n    public function chatAction () {\n        $product_id = intval(input(\x27param.pid\x27, 0, \x27int\x27));\n        $toMid      = Hmodel\\Product::getMidByProductid($product_id);\n        if ($toMid === false) notFund();\n\n        $productHtml = $this-\x26gt;returnProductData2Html($product_id, \x27default\x27);\n\n        $int_toMid = substr($toMid, 2);\n        $V_headInfo = Pmodel\\Push::getVmerchantHeadImageByVid($int_toMid);\n        $V_headimage = is_not_empty_array($V_headInfo) ? json_decode($V_headInfo[\x27headimgurl\x27])[0] :\x27\/uploads\/logo.png\x27;\n\n        if (substr($toMid, 0, 1) == \x27V\x27) {\n            $chatLogData = Pmodel\\Push::getChatlogByUseridAndVid(self::$uid, $int_toMid); \n            if (is_not_empty_array($chatLogData)) {\n                $chatLog = self::chatlogData2Html($chatLogData, $V_headimage);\n            }\n        } elseif (substr($toMid, 0, 1) == \x27E\x27) {\n\n        }\n\n\n        $view = new View;\n        $view-\x26gt;assign(\x27pHtml\x27, $productHtml);\n        $view-\x26gt;assign(\x27toMid\x27, $toMid);\n        $view-\x26gt;assign(\x27pid\x27, $product_id);\n        $view-\x26gt;assign(\x27chatlogHtml\x27, $chatLog);\n        $view-\x26gt;assign(\x27role\x27, \x27user\x27);\n        $view-\x26gt;assign(\x27user_image\x27, self::$user_headimage);\n        $view-\x26gt;assign(\x27V_image\x27, $V_headimage);\n        return $view-\x26gt;fetch();\n    }\n\n\n      private static function chatlogData2Html ($data = [], $V_headimage = \x27\x27) {\n        $todayTimestamp = strtotime(date(\x27Y-m-d\x27));\n        $html = \x27\x27;\n        foreach ($data as $k =\x26gt; $v) {\n            $date = $v[\x27send_time\x27] \x26lt; $todayTimestamp ? date(\x27Y\/m\/d H:i:s\x27, $v[\x27send_time\x27]) : date(\x27H:i:s\x27, $v[\x27send_time\x27]);\n            $time_nodes = \x27\x27;\n            if (($data[$k][\x27send_time\x27] - $data[$k-1][\x27send_time\x27]) \x26gt; 180) {\n                $time_nodes = \x27\x26lt;div style=\x22clear:both;\x22\x26gt;\x26lt;\/div\x26gt;\x26lt;p class=\x22chat-history-date\x22\x26gt;\x27 .$date.\x27\x26lt;\/p\x26gt;\x27;\n            } \n            \/\/sender-\x26gt;发送方   1:用户。2：商家\n            if ($v[\x27sender\x27] == 1) {\n                \n                \/\/send_message_type-\x26gt;发送消息类型  (1:普通文本；2：商品链接)\n                if ($v[\x27send_message_type\x27] == 1) {\n                    $html.= \x27\x26lt;div class=\x22chat-sender\x22\x26gt;\x27;\n                    $html.= $time_nodes;\n                    $html.= \x27\x26lt;div class=\x22chat-avatar\x22\x26gt;\x26lt;img src=\x22\x27 . self::$user_headimage . \x27\x22 alt=\x22\x22\x26gt;\x26lt;\/div\x26gt;\x27;\n                    $html.= \x27\x26lt;div class=\x22chat-content\x22\x26gt;\x26lt;div class=\x22chat-triangle\x22\x26gt;\x26lt;\/div\x26gt;\x26lt;span\x26gt;\x27 . $v[\x27send_message\x27].\x27\x26lt;\/span\x26gt;\x26lt;\/div\x26gt;\x27;\n                    $html.= \x27\x26lt;\/div\x26gt;\x27;\n                }elseif ($v[\x27send_message_type\x27] == 2) {\n                    $html.= $time_nodes;\n                    $product_info = json_decode($v[\x27send_message\x27],true);\n                    $html.= self::productData2SendHtml($product_info);\n                }elseif ($v[\x27send_message_type\x27] == 3) {\n                    $images_arr = json_decode($v[\x27send_message\x27],true);\n                  \n                    $html.= \x27\x26lt;div class=\x22chat-sender\x22\x26gt;\x27;\n                    $html.= $time_nodes;\n                    $html.= \x27\x26lt;div class=\x22chat-avatar\x22\x26gt;\x26lt;img src=\x22\x27 . self::$user_headimage . \x27\x22 alt=\x22\x22\x26gt;\x26lt;\/div\x26gt;\x27;\n                    $html.= \x27\x26lt;div class=\x22chat-content\x22\x26gt;\x26lt;div class=\x22chat-triangle\x22\x26gt;\x26lt;\/div\x26gt;\x27;\n                    foreach ($images_arr as $v ) {\n                        $html.= \x27\x26lt;img src=\x22\x27 .WEB_SITE. \x27\/\x27 . $v . \x27\x22 style=\x22max-width:85%\x22\x26gt;\x27;\n                    }\n                    $html.= \x27\x26lt;\/div\x26gt;\x27;\n                    $html.= \x27\x26lt;\/div\x26gt;\x27;\n                }\n            }else {\n                if ($v[\x27send_message_type\x27] == 1) {\n                    $html.= \x27\x26lt;div class=\x22chat-receiver\x22\x26gt;\x27;\n                    $html.= \x27\x26lt;div class=\x22chat-avatar\x22\x26gt;\x26lt;img src=\x22\x27 . $V_headimage . \x27\x22 alt=\x22\x22\x26gt;\x26lt;\/div\x26gt;\x27;\n                    $html.= \x27\x26lt;div class=\x22chat-content\x22\x26gt;\x26lt;div class=\x22chat-triangle\x22\x26gt;\x26lt;\/div\x26gt;\x26lt;span\x26gt;\x27 . $v[\x27send_message\x27].\x27\x26lt;\/span\x26gt;\x26lt;\/div\x26gt;\x27;\n                    $html.= \x27\x26lt;\/div\x26gt;\x27;\n                }elseif ($v[\x27send_message_type\x27] == 2) {\n\n                }\n            }\n        }\n        return $html;\n    }\n    public function BindUserClientIdAction () {\n        if (!Request::instance()-\x26gt;isPost()) { notFund(); }\n        $bindUserid = \x27U_\x27 . session(\x27userinfo.uid\x27);\n        $client_id = input(\x22param.client_id\x22, 0, \x22string\x22); \n        \/\/ 设置GatewayWorker服务的Register服务ip和端口\n        Gateway::$registerAddress = SOCKET_SERVER_PORT;\n        \/\/ client_id与uid绑定\n        \/\/ Gateway::closeClient($client_id);\n        return Gateway::bindUid($client_id, $bindUserid);\n}\n\/\/用户发送消息给商家\n    public function SendMessageToMerchantAction () {\n        if (!Request::instance()-\x26gt;isPost()) { notFund(); }\n        $message   = $_POST[\x27message\x27]; \n        $toMid     = input(\x27post.toMid\x27, \x27\x27 , \x27string\x27);\n        $product_id= input(\x27post.pid\x27, 0, \x27int\x27);\n        $client_id = input(\x27post.client_id\x27, \x27\x27, \x27string\x27);\n        $sendType  = input(\x27post.sendType\x27, \x27\x27, \x27string\x27);\n\n\n\n        if (!in_array($sendType,[\x27link\x27, \x27message\x27])) {                             \/\/客户端错误\n            return json_encode([\x27status\x27 =\x26gt; -1]);\n        }\n        if (strlen($client_id) != 20 ) {                                            \/\/客户端错误\n            return json_encode([\x27status\x27 =\x26gt; -1]);\n        }\n        if (!is_not_empty_string($toMid) || !is_positive_integer($product_id)) {    \/\/系统错误\n            return json_encode([\x27status\x27 =\x26gt; -2]);\n        }\n        $db_toMid      = Hmodel\\Product::getMidByProductid($product_id);            \/\/数据错误\n        if ($db_toMid != $toMid) {\n            return json_encode([\x27status\x27 =\x26gt; -3]);\n        }\n        require_once dirname(dirname(__FILE__)) . \x27\/Events.php\x27;\n\n        $uid            = session(\x27userinfo.uid\x27);\n        $accIsOnline    = Gateway::isUidOnline($toMid) == 1 ? 1 : 0;                \/\/判读商家是否在线\n        $message_type   = 1;\n        if ($sendType == \x27link\x27) {\n            $message_type = 2;\n            $productData = $this-\x26gt;referProductData($product_id);\n            unset($productData[\x27product_price\x27]);\n            unset($productData[\x27score\x27]);\n            unset($productData[\x27product_stock\x27]);\n            unset($productData[\x27product_param\x27]);\n            unset($productData[\x27product_desc\x27]);\n            unset($productData[\x27product_main\x27]);\n            unset($productData[\x27category_id\x27]);\n            unset($productData[\x27merchant_id\x27]);\n            $message = json_encode($productData);\n        }\n        \/\/Log入库\n        $insertId       = Pmodel\\Push::addChatLog($uid, $toMid, $message, $message_type, 1, $accIsOnline);\n        if($message_type == 1){\n            if(!is_numeric($message)){\n                $message = \x27\x22\x27.$message.\x27\x22\x27;\n            }\n            if ($message == \x27\x27) {\n                $message = \x27\x27;\n            }\n        }\n        if ($insertId === false) {                                                  \/\/入库失败（服务器故障）\n            return json_encode([\x27status\x27 =\x26gt; -3]);\n        }\n        $Worker = new \\Events;\n        $message_json   = \x27{\x22type\x22:\x22send\x22,\x22source\x22:\x22U_\x27 . $uid . \x27\x22,\x22toClientUid\x22:\x22\x27 . $toMid . \x27\x22,\x22content\x22:\x27 . $message .\x27,\n　　　　　　　　　　　　　　   \x22c_type\x22: \x27 . $message_type .\x27, \x22Db_id\x22:\x27 . $insertId . \x27}\x27;\n\n        $Worker::onMessage($client_id, $message_json);\n        \/\/成功返回相关数据\n        return json_encode([\n            \x27status\x27    =\x26gt; 1,\n            \x27timeStamp\x27 =\x26gt; time(),\n            \x27timeStr\x27   =\x26gt; date(\x27H:i:s\x27),\n            \x27html\x27      =\x26gt; $message_type == 1 ? \x27\x27 : self::productData2SendHtml($productData)\n        ]);\n\n }\n\/\/商家发送信息给用户\n    public function sendMessageToUserAction () {\n     if (!Request::instance()-\x26gt;isPost()) { notFund(); }\n        $post_message = is_not_empty_string($_POST[\x27message\x27]) ? $_POST[\x27message\x27] : \x27\x27; \n        $toUserCode   = input(\x27post.toUserCode\x27, \x27\x27 , \x27string\x27);\n        $toU_uid      = encrypt_hopeband($toUserCode, \x27D\x27, \x27xxxxx\x27);\n        $V_client_id  = input(\x27post.client_id\x27, \x27\x27, \x27string\x27);\n        $V_uid_code   = input(\x27post.myCode\x27, \x27\x27, \x27string\x27);\n        $V_uid        = encrypt_hopeband($V_uid_code, \x27D\x27, \x27xxxxx\x27);\n        $make_message = [];\n        $message = \x27\x27;\n        self::trimImageAndTextinfo2str($post_message, $make_message);\n\n        if (is_not_empty_array($make_message)) {\n            foreach ( $make_message as \x26amp;$v ) {\n                $message .= self::checkIflegalAndReturn($v);\n            }\n           \n        }\n       \n        if (strlen($V_client_id) != 20 || Gateway::isOnline($V_client_id) != 1) {       \/\/客户端错误\n            return json_encode([\x27status\x27 =\x26gt; -2]);\n        }    \n        $V_merchantInfo = Pmodel\\Push::getVmerchantInfoByVid($V_uid);\n        if (!is_not_empty_array($V_merchantInfo)) {                                     \/\/商家信息不存在\n            return json_encode([\x27status\x27 =\x26gt; -1]);\n        }\n        require_once dirname(dirname(__FILE__)) . \x27\/Events.php\x27;\n\n        $accIsOnline    = Gateway::isUidOnline(\x27U_\x27 . $toU_uid) == 1 ? 1 : 0;         \/\/判读用户是否在线\n        $message_type   = 1;\n        \/\/Log入库\n        $insertId       = Pmodel\\Push::addChatLog($toU_uid, \x27V_\x27 . $V_uid, $message, 1, 2, $accIsOnline);\n        if ($insertId === false) {                                                  \/\/入库失败（服务器故障）\n            return json_encode([\x27status\x27 =\x26gt; -3]);\n        }\n        $Worker = new \\Events;\n        $img_encrypt_code = encrypt_hopeband(\x27Hp_(legal)\x27, \x27E\x27, \x27Hp_HopeBand_Chat_img\x27);\n        $message = str_replace($img_encrypt_code .\x27 src=\x22\x27, $img_encrypt_code . \x22 src=\x27\x22, $message);\n        $message = str_replace(\x27\x22\x26gt;\x27, \x22\x27\x26gt;\x22, $message);\n        $message_json   = \x27{\x22type\x22:\x22send\x22,\x22toClientUid\x22:\x22U_\x27 . $toU_uid . \x27\x22,\x22content\x22:\x22\x27 . $message .\x27\x22,\x22Db_id\x22: \x22\x27 . $insertId . \x27\x22}\x27;  \n        $Worker::onMessage($client_id, $message_json);\n        \/\/成功返回相关数据\n        return json_encode([\n            \x27status\x27    =\x26gt; 1,\n            \x27timeStamp\x27 =\x26gt; time(),\n            \x27timeStr\x27   =\x26gt; date(\x27H:i:s\x27),\n        ]);\n\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22public function BindUserClientIdAction () {\n        if (!Request::instance()-\x3eisPost()) { notFund(); }\n        $bindUserid = \x27U_\x27 . session(\x27userinfo.uid\x27);\n        $client_id = input(\x26quot;param.client_id\x26quot;, 0, \x26quot;string\x26quot;); \n        \/\/ 设置GatewayWorker服务的Register服务ip和端口\n        Gateway::$registerAddress = SOCKET_SERVER_PORT;\n        \/\/ client_id与uid绑定\n        \/\/ Gateway::closeClient($client_id);\n        return Gateway::bindUid($client_id, $bindUserid);\n}\n\/\/用户发送消息给商家\n    public function SendMessageToMerchantAction () {\n        if (!Request::instance()-\x3eisPost()) { notFund(); }\n        $message   = $_POST[\x27message\x27]; \n        $toMid     = input(\x27post.toMid\x27, \x27\x27 , \x27string\x27);\n        $product_id= input(\x27post.pid\x27, 0, \x27int\x27);\n        $client_id = input(\x27post.client_id\x27, \x27\x27, \x27string\x27);\n        $sendType  = input(\x27post.sendType\x27, \x27\x27, \x27string\x27);\n\n\n\n        if (!in_array($sendType,[\x27link\x27, \x27message\x27])) {                             \/\/客户端错误\n            return json_encode([\x27status\x27 =\x3e -1]);\n        }\n        if (strlen($client_id) != 20 ) {                                            \/\/客户端错误\n            return json_encode([\x27status\x27 =\x3e -1]);\n        }\n        if (!is_not_empty_string($toMid) || !is_positive_integer($product_id)) {    \/\/系统错误\n            return json_encode([\x27status\x27 =\x3e -2]);\n        }\n        $db_toMid      = Hmodel\\Product::getMidByProductid($product_id);            \/\/数据错误\n        if ($db_toMid != $toMid) {\n            return json_encode([\x27status\x27 =\x3e -3]);\n        }\n        require_once dirname(dirname(__FILE__)) . \x27\/Events.php\x27;\n\n        $uid            = session(\x27userinfo.uid\x27);\n        $accIsOnline    = Gateway::isUidOnline($toMid) == 1 ? 1 : 0;                \/\/判读商家是否在线\n        $message_type   = 1;\n        if ($sendType == \x27link\x27) {\n            $message_type = 2;\n            $productData = $this-\x3ereferProductData($product_id);\n            unset($productData[\x27product_price\x27]);\n            unset($productData[\x27score\x27]);\n            unset($productData[\x27product_stock\x27]);\n            unset($productData[\x27product_param\x27]);\n            unset($productData[\x27product_desc\x27]);\n            unset($productData[\x27product_main\x27]);\n            unset($productData[\x27category_id\x27]);\n            unset($productData[\x27merchant_id\x27]);\n            $message = json_encode($productData);\n        }\n        \/\/Log入库\n        $insertId       = Pmodel\\Push::addChatLog($uid, $toMid, $message, $message_type, 1, $accIsOnline);\n        if($message_type == 1){\n            if(!is_numeric($message)){\n                $message = \x27\x26quot;\x27.$message.\x27\x26quot;\x27;\n            }\n            if ($message == \x27\x27) {\n                $message = \x27\x27;\n            }\n        }\n        if ($insertId === false) {                                                  \/\/入库失败（服务器故障）\n            return json_encode([\x27status\x27 =\x3e -3]);\n        }\n        $Worker = new \\Events;\n        $message_json   = \x27{\x26quot;type\x26quot;:\x26quot;send\x26quot;,\x26quot;source\x26quot;:\x26quot;U_\x27 . $uid . \x27\x26quot;,\x26quot;toClientUid\x26quot;:\x26quot;\x27 . $toMid . \x27\x26quot;,\x26quot;content\x26quot;:\x27 . $message .\x27,\n　　　　　　　　　　　　　　   \x26quot;c_type\x26quot;: \x27 . $message_type .\x27, \x26quot;Db_id\x26quot;:\x27 . $insertId . \x27}\x27;\n\n        $Worker::onMessage($client_id, $message_json);\n        \/\/成功返回相关数据\n        return json_encode([\n            \x27status\x27    =\x3e 1,\n            \x27timeStamp\x27 =\x3e time(),\n            \x27timeStr\x27   =\x3e date(\x27H:i:s\x27),\n            \x27html\x27      =\x3e $message_type == 1 ? \x27\x27 : self::productData2SendHtml($productData)\n        ]);\n\n }\n\/\/商家发送信息给用户\n    public function sendMessageToUserAction () {\n     if (!Request::instance()-\x3eisPost()) { notFund(); }\n        $post_message = is_not_empty_string($_POST[\x27message\x27]) ? $_POST[\x27message\x27] : \x27\x27; \n        $toUserCode   = input(\x27post.toUserCode\x27, \x27\x27 , \x27string\x27);\n        $toU_uid      = encrypt_hopeband($toUserCode, \x27D\x27, \x27xxxxx\x27);\n        $V_client_id  = input(\x27post.client_id\x27, \x27\x27, \x27string\x27);\n        $V_uid_code   = input(\x27post.myCode\x27, \x27\x27, \x27string\x27);\n        $V_uid        = encrypt_hopeband($V_uid_code, \x27D\x27, \x27xxxxx\x27);\n        $make_message = [];\n        $message = \x27\x27;\n        self::trimImageAndTextinfo2str($post_message, $make_message);\n\n        if (is_not_empty_array($make_message)) {\n            foreach ( $make_message as \x26amp;$v ) {\n                $message .= self::checkIflegalAndReturn($v);\n            }\n           \n        }\n       \n        if (strlen($V_client_id) != 20 || Gateway::isOnline($V_client_id) != 1) {       \/\/客户端错误\n            return json_encode([\x27status\x27 =\x3e -2]);\n        }    \n        $V_merchantInfo = Pmodel\\Push::getVmerchantInfoByVid($V_uid);\n        if (!is_not_empty_array($V_merchantInfo)) {                                     \/\/商家信息不存在\n            return json_encode([\x27status\x27 =\x3e -1]);\n        }\n        require_once dirname(dirname(__FILE__)) . \x27\/Events.php\x27;\n\n        $accIsOnline    = Gateway::isUidOnline(\x27U_\x27 . $toU_uid) == 1 ? 1 : 0;         \/\/判读用户是否在线\n        $message_type   = 1;\n        \/\/Log入库\n        $insertId       = Pmodel\\Push::addChatLog($toU_uid, \x27V_\x27 . $V_uid, $message, 1, 2, $accIsOnline);\n        if ($insertId === false) {                                                  \/\/入库失败（服务器故障）\n            return json_encode([\x27status\x27 =\x3e -3]);\n        }\n        $Worker = new \\Events;\n        $img_encrypt_code = encrypt_hopeband(\x27Hp_(legal)\x27, \x27E\x27, \x27Hp_HopeBand_Chat_img\x27);\n        $message = str_replace($img_encrypt_code .\x27 src=\x26quot;\x27, $img_encrypt_code . \x26quot; src=\x27\x26quot;, $message);\n        $message = str_replace(\x27\x26quot;\x3e\x27, \x26quot;\x27\x3e\x26quot;, $message);\n        $message_json   = \x27{\x26quot;type\x26quot;:\x26quot;send\x26quot;,\x26quot;toClientUid\x26quot;:\x26quot;U_\x27 . $toU_uid . \x27\x26quot;,\x26quot;content\x26quot;:\x26quot;\x27 . $message .\x27\x26quot;,\x26quot;Db_id\x26quot;: \x26quot;\x27 . $insertId . \x27\x26quot;}\x27;  \n        $Worker::onMessage($client_id, $message_json);\n        \/\/成功返回相关数据\n        return json_encode([\n            \x27status\x27    =\x3e 1,\n            \x27timeStamp\x27 =\x3e time(),\n            \x27timeStr\x27   =\x3e date(\x27H:i:s\x27),\n        ]);\n\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eBindUserClientIdAction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!Request::instance()-\x26gt;isPost()) { notFund(); }\n        $bindUserid = \x3cspan class=\x22hljs-string\x22\x3e\x27U_\x27\x3c\/span\x3e . session(\x3cspan class=\x22hljs-string\x22\x3e\x27userinfo.uid\x27\x3c\/span\x3e);\n        $client_id = input(\x3cspan class=\x22hljs-string\x22\x3e\x22param.client_id\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22string\x22\x3c\/span\x3e); \n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 设置GatewayWorker服务的Register服务ip和端口\x3c\/span\x3e\n        Gateway::$registerAddress = SOCKET_SERVER_PORT;\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ client_id与uid绑定\x3c\/span\x3e\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Gateway::closeClient($client_id);\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e Gateway::bindUid($client_id, $bindUserid);\n}\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/用户发送消息给商家\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eSendMessageToMerchantAction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!Request::instance()-\x26gt;isPost()) { notFund(); }\n        $message   = $_POST[\x3cspan class=\x22hljs-string\x22\x3e\x27message\x27\x3c\/span\x3e]; \n        $toMid     = input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.toMid\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e , \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e);\n        $product_id= input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.pid\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27int\x27\x3c\/span\x3e);\n        $client_id = input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.client_id\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e);\n        $sendType  = input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.sendType\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e);\n\n\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!in_array($sendType,[\x3cspan class=\x22hljs-string\x22\x3e\x27link\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27message\x27\x3c\/span\x3e])) {                             \x3cspan class=\x22hljs-comment\x22\x3e\/\/客户端错误\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e]);\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (strlen($client_id) != \x3cspan class=\x22hljs-number\x22\x3e20\x3c\/span\x3e ) {                                            \x3cspan class=\x22hljs-comment\x22\x3e\/\/客户端错误\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e]);\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!is_not_empty_string($toMid) || !is_positive_integer($product_id)) {    \x3cspan class=\x22hljs-comment\x22\x3e\/\/系统错误\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-2\x3c\/span\x3e]);\n        }\n        $db_toMid      = Hmodel\\Product::getMidByProductid($product_id);            \x3cspan class=\x22hljs-comment\x22\x3e\/\/数据错误\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($db_toMid != $toMid) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-3\x3c\/span\x3e]);\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3erequire_once\x3c\/span\x3e dirname(dirname(\x3cspan class=\x22hljs-keyword\x22\x3e__FILE__\x3c\/span\x3e)) . \x3cspan class=\x22hljs-string\x22\x3e\x27\/Events.php\x27\x3c\/span\x3e;\n\n        $uid            = session(\x3cspan class=\x22hljs-string\x22\x3e\x27userinfo.uid\x27\x3c\/span\x3e);\n        $accIsOnline    = Gateway::isUidOnline($toMid) == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e : \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;                \x3cspan class=\x22hljs-comment\x22\x3e\/\/判读商家是否在线\x3c\/span\x3e\n        $message_type   = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($sendType == \x3cspan class=\x22hljs-string\x22\x3e\x27link\x27\x3c\/span\x3e) {\n            $message_type = \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e;\n            $productData = \x3cspan class=\x22hljs-keyword\x22\x3e$this\x3c\/span\x3e-\x26gt;referProductData($product_id);\n            \x3cspan class=\x22hljs-keyword\x22\x3eunset\x3c\/span\x3e($productData[\x3cspan class=\x22hljs-string\x22\x3e\x27product_price\x27\x3c\/span\x3e]);\n            \x3cspan class=\x22hljs-keyword\x22\x3eunset\x3c\/span\x3e($productData[\x3cspan class=\x22hljs-string\x22\x3e\x27score\x27\x3c\/span\x3e]);\n            \x3cspan class=\x22hljs-keyword\x22\x3eunset\x3c\/span\x3e($productData[\x3cspan class=\x22hljs-string\x22\x3e\x27product_stock\x27\x3c\/span\x3e]);\n            \x3cspan class=\x22hljs-keyword\x22\x3eunset\x3c\/span\x3e($productData[\x3cspan class=\x22hljs-string\x22\x3e\x27product_param\x27\x3c\/span\x3e]);\n            \x3cspan class=\x22hljs-keyword\x22\x3eunset\x3c\/span\x3e($productData[\x3cspan class=\x22hljs-string\x22\x3e\x27product_desc\x27\x3c\/span\x3e]);\n            \x3cspan class=\x22hljs-keyword\x22\x3eunset\x3c\/span\x3e($productData[\x3cspan class=\x22hljs-string\x22\x3e\x27product_main\x27\x3c\/span\x3e]);\n            \x3cspan class=\x22hljs-keyword\x22\x3eunset\x3c\/span\x3e($productData[\x3cspan class=\x22hljs-string\x22\x3e\x27category_id\x27\x3c\/span\x3e]);\n            \x3cspan class=\x22hljs-keyword\x22\x3eunset\x3c\/span\x3e($productData[\x3cspan class=\x22hljs-string\x22\x3e\x27merchant_id\x27\x3c\/span\x3e]);\n            $message = json_encode($productData);\n        }\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/Log入库\x3c\/span\x3e\n        $insertId       = Pmodel\\Push::addChatLog($uid, $toMid, $message, $message_type, \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, $accIsOnline);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e($message_type == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e){\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(!is_numeric($message)){\n                $message = \x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x27\x3c\/span\x3e.$message.\x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x27\x3c\/span\x3e;\n            }\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($message == \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e) {\n                $message = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e;\n            }\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($insertId === \x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e) {                                                  \x3cspan class=\x22hljs-comment\x22\x3e\/\/入库失败（服务器故障）\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-3\x3c\/span\x3e]);\n        }\n        $Worker = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \\Events;\n        $message_json   = \x3cspan class=\x22hljs-string\x22\x3e\x27{\x22type\x22:\x22send\x22,\x22source\x22:\x22U_\x27\x3c\/span\x3e . $uid . \x3cspan class=\x22hljs-string\x22\x3e\x27\x22,\x22toClientUid\x22:\x22\x27\x3c\/span\x3e . $toMid . \x3cspan class=\x22hljs-string\x22\x3e\x27\x22,\x22content\x22:\x27\x3c\/span\x3e . $message .\x3cspan class=\x22hljs-string\x22\x3e\x27,\n　　　　　　　　　　　　　　   \x22c_type\x22: \x27\x3c\/span\x3e . $message_type .\x3cspan class=\x22hljs-string\x22\x3e\x27, \x22Db_id\x22:\x27\x3c\/span\x3e . $insertId . \x3cspan class=\x22hljs-string\x22\x3e\x27}\x27\x3c\/span\x3e;\n\n        $Worker::onMessage($client_id, $message_json);\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/成功返回相关数据\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\n            \x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e    =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,\n            \x3cspan class=\x22hljs-string\x22\x3e\x27timeStamp\x27\x3c\/span\x3e =\x26gt; time(),\n            \x3cspan class=\x22hljs-string\x22\x3e\x27timeStr\x27\x3c\/span\x3e   =\x26gt; date(\x3cspan class=\x22hljs-string\x22\x3e\x27H:i:s\x27\x3c\/span\x3e),\n            \x3cspan class=\x22hljs-string\x22\x3e\x27html\x27\x3c\/span\x3e      =\x26gt; $message_type == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e : \x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e::productData2SendHtml($productData)\n        ]);\n\n }\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/商家发送信息给用户\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esendMessageToUserAction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n     \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!Request::instance()-\x26gt;isPost()) { notFund(); }\n        $post_message = is_not_empty_string($_POST[\x3cspan class=\x22hljs-string\x22\x3e\x27message\x27\x3c\/span\x3e]) ? $_POST[\x3cspan class=\x22hljs-string\x22\x3e\x27message\x27\x3c\/span\x3e] : \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e; \n        $toUserCode   = input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.toUserCode\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e , \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e);\n        $toU_uid      = encrypt_hopeband($toUserCode, \x3cspan class=\x22hljs-string\x22\x3e\x27D\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27xxxxx\x27\x3c\/span\x3e);\n        $V_client_id  = input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.client_id\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e);\n        $V_uid_code   = input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.myCode\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e);\n        $V_uid        = encrypt_hopeband($V_uid_code, \x3cspan class=\x22hljs-string\x22\x3e\x27D\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27xxxxx\x27\x3c\/span\x3e);\n        $make_message = [];\n        $message = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e::trimImageAndTextinfo2str($post_message, $make_message);\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (is_not_empty_array($make_message)) {\n            \x3cspan class=\x22hljs-keyword\x22\x3eforeach\x3c\/span\x3e ( $make_message \x3cspan class=\x22hljs-keyword\x22\x3eas\x3c\/span\x3e \x26amp;$v ) {\n                $message .= \x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e::checkIflegalAndReturn($v);\n            }\n           \n        }\n       \n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (strlen($V_client_id) != \x3cspan class=\x22hljs-number\x22\x3e20\x3c\/span\x3e || Gateway::isOnline($V_client_id) != \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) {       \x3cspan class=\x22hljs-comment\x22\x3e\/\/客户端错误\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-2\x3c\/span\x3e]);\n        }    \n        $V_merchantInfo = Pmodel\\Push::getVmerchantInfoByVid($V_uid);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!is_not_empty_array($V_merchantInfo)) {                                     \x3cspan class=\x22hljs-comment\x22\x3e\/\/商家信息不存在\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e]);\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3erequire_once\x3c\/span\x3e dirname(dirname(\x3cspan class=\x22hljs-keyword\x22\x3e__FILE__\x3c\/span\x3e)) . \x3cspan class=\x22hljs-string\x22\x3e\x27\/Events.php\x27\x3c\/span\x3e;\n\n        $accIsOnline    = Gateway::isUidOnline(\x3cspan class=\x22hljs-string\x22\x3e\x27U_\x27\x3c\/span\x3e . $toU_uid) == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e : \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;         \x3cspan class=\x22hljs-comment\x22\x3e\/\/判读用户是否在线\x3c\/span\x3e\n        $message_type   = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/Log入库\x3c\/span\x3e\n        $insertId       = Pmodel\\Push::addChatLog($toU_uid, \x3cspan class=\x22hljs-string\x22\x3e\x27V_\x27\x3c\/span\x3e . $V_uid, $message, \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, $accIsOnline);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($insertId === \x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e) {                                                  \x3cspan class=\x22hljs-comment\x22\x3e\/\/入库失败（服务器故障）\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-3\x3c\/span\x3e]);\n        }\n        $Worker = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \\Events;\n        $img_encrypt_code = encrypt_hopeband(\x3cspan class=\x22hljs-string\x22\x3e\x27Hp_(legal)\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27E\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27Hp_HopeBand_Chat_img\x27\x3c\/span\x3e);\n        $message = str_replace($img_encrypt_code .\x3cspan class=\x22hljs-string\x22\x3e\x27 src=\x22\x27\x3c\/span\x3e, $img_encrypt_code . \x3cspan class=\x22hljs-string\x22\x3e\x22 src=\x27\x22\x3c\/span\x3e, $message);\n        $message = str_replace(\x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x26gt;\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22\x27\x26gt;\x22\x3c\/span\x3e, $message);\n        $message_json   = \x3cspan class=\x22hljs-string\x22\x3e\x27{\x22type\x22:\x22send\x22,\x22toClientUid\x22:\x22U_\x27\x3c\/span\x3e . $toU_uid . \x3cspan class=\x22hljs-string\x22\x3e\x27\x22,\x22content\x22:\x22\x27\x3c\/span\x3e . $message .\x3cspan class=\x22hljs-string\x22\x3e\x27\x22,\x22Db_id\x22: \x22\x27\x3c\/span\x3e . $insertId . \x3cspan class=\x22hljs-string\x22\x3e\x27\x22}\x27\x3c\/span\x3e;  \n        $Worker::onMessage($client_id, $message_json);\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/成功返回相关数据\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\n            \x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e    =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,\n            \x3cspan class=\x22hljs-string\x22\x3e\x27timeStamp\x27\x3c\/span\x3e =\x26gt; time(),\n            \x3cspan class=\x22hljs-string\x22\x3e\x27timeStr\x27\x3c\/span\x3e   =\x26gt; date(\x3cspan class=\x22hljs-string\x22\x3e\x27H:i:s\x27\x3c\/span\x3e),\n        ]);\n\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e额外还有一些关于消息处理方面的；\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/验证是否是否是图片，如果是并且返回图片地址，否则返回字符串\n    private static function checkIflegalAndReturn ( $message = \x27\x27) {\n        header(\x27content-type:text\/html; charset=utf-8\x27);\n        $img_encrypt_code = encrypt_hopeband(\x27Hp_(legal)\x27, \x27E\x27, \x27Hp_HopeBand_Chat_img\x27);\n        if (substr($message, 0, 21) != \x27\x3cimg src=\x26quot;data:image\/\x27 || substr($message, strpos($message, \x27;\x27, 0) ,8) != \x27;base64,\x27 || \n            substr($message, -2, 2) != \x27\x26quot;\x3e\x27) {\n            return $message;\n        }\n        $preg = \x27\/\x3cimg.*?src=\x26quot;(.*?)\x26quot;.*?\x3e\/is\x27;\n        preg_match( $preg, $message,$arr);\n        $img_src = self::base64_upload($arr[1]);\n        return \x27\x3cimg \x27.$img_encrypt_code.\x27 src=\x26quot;\x27 . $img_src . \x27\x26quot;\x3e\x27;\n    }\n\n    \/\/把接受到的消息文本和图片有序提出并解析\n    private static function trimImageAndTextinfo2str ($message = \x27\x27, \x26amp;$message_arr = []) {\n        if (!is_not_empty_string($message)) return \x27\x27;\n        $img_start_code = \x27\x3cimg src=\x26quot;data:image\/\x27;\n        $img_end_code = \x27\x26quot;\x3e\x27;\n        $tmp_message = strlen($message);\n        $initial     = substr($message,0,strlen($img_start_code));\n   \n        if ($initial == $img_start_code) {\n            $start = strpos($message, $img_start_code, 0); \n            $end   = strpos($message, $img_end_code , 0); \n            $message_arr[] = substr($message, 0, $end \x2b 2);\n            $message = substr($message, $end \x2b 2);\n        }else{\n            $start = strpos($message, $img_start_code);\n            if ($start !== false) {\n                $message_arr[] = substr($message, 0, $start);\n                $message = substr($message, $start);\n            }else{\n                \/\/防止xss攻击\n                $message_arr[]= string_remove_xss(htmlspecialchars_decode($message));\n            }\n        }\n        if (($tmp_message) != strlen($message) \x26amp;\x26amp; is_not_empty_string($message)) {\n            self::trimImageAndTextinfo2str($message, $message_arr);\n        }\n      return $message_arr;\n\n    }\n\n    private static function base64_upload($base64 = \x27\x27) {\n    $base64_image = str_replace(\x27 \x27, \x27\x2b\x27, $base64);\n    if (preg_match(\x27\/^(data:\\s*image\\\/(\\w\x2b);base64,)\/\x27, $base64_image, $result)){\n        if($result[2] == \x27jpeg\x27){\n            $image_name = getCode(16,4).\x27.jpg\x27;\n        }else{\n            $image_name = getCode(16,4).\x27.\x27.$result[2];\n        }\n        $image_file = \x26quot;.\/upload\/chat\x26quot;.\x27\/\x27.date(\x27Y\x27).\x27\/\x27.date(\x27m\x27).\x27\/\x27.date(\x27d\x27).\x27\/\x27.$image_name;    \/\/服务器文件存储路径\n        \/\/判断文件路径是否存在\n        $path = \x26quot;.\/upload\/chat\x26quot;.\x27\/\x27.date(\x27Y\x27).\x27\/\x27.date(\x27m\x27).\x27\/\x27.date(\x27d\x27).\x27\/\x27;\n        is_dir($path) or mkdir($path,0777,true);\n        if (file_put_contents($image_file, base64_decode(str_replace($result[1], \x27\x27, $base64_image)))){\n            return $image_file;\n        }else{\n            return false;\n        }\n    }else{\n        return false;\n    }\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/验证是否是否是图片，如果是并且返回图片地址，否则返回字符串\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eprivate\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3estatic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3echeckIflegalAndReturn\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e( $message = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e)\x3c\/span\x3e \x3c\/span\x3e{\n        header(\x3cspan class=\x22hljs-string\x22\x3e\x27content-type:text\/html; charset=utf-8\x27\x3c\/span\x3e);\n        $img_encrypt_code = encrypt_hopeband(\x3cspan class=\x22hljs-string\x22\x3e\x27Hp_(legal)\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27E\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27Hp_HopeBand_Chat_img\x27\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (substr($message, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e21\x3c\/span\x3e) != \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;img src=\x22data:image\/\x27\x3c\/span\x3e || substr($message, strpos($message, \x3cspan class=\x22hljs-string\x22\x3e\x27;\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) ,\x3cspan class=\x22hljs-number\x22\x3e8\x3c\/span\x3e) != \x3cspan class=\x22hljs-string\x22\x3e\x27;base64,\x27\x3c\/span\x3e || \n            substr($message, \x3cspan class=\x22hljs-number\x22\x3e-2\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) != \x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x26gt;\x27\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e $message;\n        }\n        $preg = \x3cspan class=\x22hljs-string\x22\x3e\x27\/\x26lt;img.*?src=\x22(.*?)\x22.*?\x26gt;\/is\x27\x3c\/span\x3e;\n        preg_match( $preg, $message,$arr);\n        $img_src = \x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e::base64_upload($arr[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e]);\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;img \x27\x3c\/span\x3e.$img_encrypt_code.\x3cspan class=\x22hljs-string\x22\x3e\x27 src=\x22\x27\x3c\/span\x3e . $img_src . \x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x26gt;\x27\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/把接受到的消息文本和图片有序提出并解析\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eprivate\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3estatic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3etrimImageAndTextinfo2str\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e($message = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e, \x26amp;$message_arr = [])\x3c\/span\x3e \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!is_not_empty_string($message)) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e;\n        $img_start_code = \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;img src=\x22data:image\/\x27\x3c\/span\x3e;\n        $img_end_code = \x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x26gt;\x27\x3c\/span\x3e;\n        $tmp_message = strlen($message);\n        $initial     = substr($message,\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,strlen($img_start_code));\n   \n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($initial == $img_start_code) {\n            $start = strpos($message, $img_start_code, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e); \n            $end   = strpos($message, $img_end_code , \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e); \n            $message_arr[] = substr($message, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, $end \x2b \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e);\n            $message = substr($message, $end \x2b \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e);\n        }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n            $start = strpos($message, $img_start_code);\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($start !== \x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e) {\n                $message_arr[] = substr($message, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, $start);\n                $message = substr($message, $start);\n            }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n                \x3cspan class=\x22hljs-comment\x22\x3e\/\/防止xss攻击\x3c\/span\x3e\n                $message_arr[]= string_remove_xss(htmlspecialchars_decode($message));\n            }\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (($tmp_message) != strlen($message) \x26amp;\x26amp; is_not_empty_string($message)) {\n            \x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e::trimImageAndTextinfo2str($message, $message_arr);\n        }\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e $message_arr;\n\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eprivate\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3estatic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ebase64_upload\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e($base64 = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e)\x3c\/span\x3e \x3c\/span\x3e{\n    $base64_image = str_replace(\x3cspan class=\x22hljs-string\x22\x3e\x27 \x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x2b\x27\x3c\/span\x3e, $base64);\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (preg_match(\x3cspan class=\x22hljs-string\x22\x3e\x27\/^(data:\\s*image\\\/(\\w\x2b);base64,)\/\x27\x3c\/span\x3e, $base64_image, $result)){\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e($result[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x27jpeg\x27\x3c\/span\x3e){\n            $image_name = getCode(\x3cspan class=\x22hljs-number\x22\x3e16\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27.jpg\x27\x3c\/span\x3e;\n        }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n            $image_name = getCode(\x3cspan class=\x22hljs-number\x22\x3e16\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27.\x27\x3c\/span\x3e.$result[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e];\n        }\n        $image_file = \x3cspan class=\x22hljs-string\x22\x3e\x22.\/upload\/chat\x22\x3c\/span\x3e.\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e.date(\x3cspan class=\x22hljs-string\x22\x3e\x27Y\x27\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e.date(\x3cspan class=\x22hljs-string\x22\x3e\x27m\x27\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e.date(\x3cspan class=\x22hljs-string\x22\x3e\x27d\x27\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e.$image_name;    \x3cspan class=\x22hljs-comment\x22\x3e\/\/服务器文件存储路径\x3c\/span\x3e\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/判断文件路径是否存在\x3c\/span\x3e\n        $path = \x3cspan class=\x22hljs-string\x22\x3e\x22.\/upload\/chat\x22\x3c\/span\x3e.\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e.date(\x3cspan class=\x22hljs-string\x22\x3e\x27Y\x27\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e.date(\x3cspan class=\x22hljs-string\x22\x3e\x27m\x27\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e.date(\x3cspan class=\x22hljs-string\x22\x3e\x27d\x27\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e;\n        is_dir($path) \x3cspan class=\x22hljs-keyword\x22\x3eor\x3c\/span\x3e mkdir($path,\x3cspan class=\x22hljs-number\x22\x3e0777\x3c\/span\x3e,\x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (file_put_contents($image_file, base64_decode(str_replace($result[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e], \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e, $base64_image)))){\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e $image_file;\n        }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e;\n        }\n    }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e;\n    }\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e微信的图片上传\x3c\/p\x3e\n\x3cp\x3eJS部分\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/* 退款选择图片 -------- start *\/\n        \n$(\x26quot;#chooseImage\x26quot;).click(function()\n{\n                \n                wx.chooseImage(\n                {\n                    count: 9,                                 \/\/ 默认9\n                    sizeType: [\x27original\x27,\x27compressed\x27],     \/\/ 可以指定是原图还是压缩图，默认二者都有\n                    sourceType: [\x27album\x27, \x27camera\x27],         \/\/ 可以指定来源是相册还是相机，默认二者都有\n                    success: function (res)\n                    {\n                           images.localId = res.localIds; \/\/ 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片                       \n                            \/\/for(var j = 0;j\x3cimages.localId.length;j\x2b\x2b)\n                              \/\/ {                      \n                                    \/\/ var str = \x27\x3cdiv serverId=\x27\x2bimages.serverId[j]\x2b\x27 class=\x26quot;chat-sender\x26quot;\x3e\x3cdiv class=\x26quot;chat-avatar\x26quot;\x3e\n　　　　　　　　　　　　　　　　　　　　  \/\/\x3cimg src=\x26quot;\/home\/push\/img\/1.png\x26quot; alt=\x26quot;\x26quot;\x3e\n　　　　　　　　　　　　　　　　　　     \/\/\x3c\/div\x3e\x3cdiv class=\x26quot;chat-content\x26quot;\x3e\x3cdiv class=\x26quot;chat-triangle\x26quot;\x3e\x3c\/div\x3e\n　　　　　　　　　　　　　　　　　　　　  \/\/\x3cimg src=\x27\x2bimages.localId[j]\x2b\x27 data-originalDrawing-src=\x27\x2bimages.localId[j]\x2b\x27 data-preview-src=\x26quot;\x26quot; data-preview-group=\x26quot;1\x26quot;\/\x3e\x3c\/div\x3e\x3c\/div\x3e\x27\n                                    \/\/ $(\x26quot;#main\x26quot;).append(str);\n                                   \n                              \/\/ }\n                           var t = 0;\n                        var i = 0, length = images.localId.length;\n                        images.serverId = [];\n\n                        \/* upload 方法 -------- start *\/\n                        function upload()\n                        {\n                              wx.uploadImage(\n                              {\n                                localId: images.localId[i],\n                                success: function (res)\n                                {\n                                      i\x2b\x2b;\n\n                                      images.serverId.push(res.serverId);\n\n                                      if (i \x3c length) { upload(); }\n                                 \n                                      var str = \x27\x3cdiv serverId=\x27\x2bres.serverId\x2b\x27 class=\x26quot;chat-sender\x26quot;\x3e\x3cdiv class=\x26quot;chat-avatar\x26quot;\x3e\n　　　　　　　　　　　　　　　　　　　　　　　　       \x3cimg src=\x26quot;\/home\/push\/img\/1.png\x26quot; alt=\x26quot;\x26quot;\x3e\n　　　　　　　　　　　　　　　　　　　　　　　　　　　　\x3c\/div\x3e\x3cdiv class=\x26quot;chat-content\x26quot;\x3e\x3cdiv class=\x26quot;chat-triangle\x26quot;\x3e\x3c\/div\x3e\n　　　　　　　　　　　　　　　　　　　　　　　　       \x3cimg src=\x27\x2bimages.localId[i-1]\x2b\x27 data-originalDrawing-src=\x27\x2bimages.localId[i-1]\x2b\x27 data-preview-src=\x26quot;\x26quot; data-preview-group=\x26quot;1\x26quot;\/\x3e\n　　　　　　　　　　　　　　　　　　　　　　　　　　  \x3c\/div\x3e\x3c\/div\x3e\x27\n                                   $(\x26quot;#main\x26quot;).append(str);\n\n                                   if(i \x3e= length )    uploadImageToDb(images.serverId);\n\n                                  \n                                },\n                                fail: function (res){ }\n                              });\n\n                        }\n                        \/* upload 方法 -------- end *\/\n\n                        upload();\n                        \n\n                    }\n                })\n            });\n\n            function uploadImageToDb(images){\n                var str = \x26quot;\x26quot;;\n                var upUrl = \x26quot;http:\/\/xxxxxx.com\/push\/push\/uploadImgage\x26quot;;\n                var toMid     = $(\x27#toMid\x27).val();\n                  var client_id = $(\x27#client_id\x27).val();\n                $.post(upUrl,{images:images,toMid:toMid,client_id:client_id},function(data){\n                    if(data == 1){\n                        for(var n = 0 ; n \x3c $(\x26quot;.chat-sender\x26quot;).length ; n\x2b\x2b){\n                            str = $(\x26quot;.chat-sender\x26quot;).eq(n).attr(\x26quot;serverId\x26quot;)\x2b\x26quot;,\x26quot;;\n                            for(var z=0;z\x3cdata.length;z\x2b\x2b){\n                                if(data[z] == str){\n                                    $(\x26quot;.chat-sender\x26quot;).eq(n).find(\x26quot;.chat-content\x26quot;).append(\x27\x3cdiv class=\x26quot;chat-sender\x26quot;\x3e上传失败\x3c\/div\x3e\x27);\n                                }\n                            }\n                        }\n                    \n                    }\n                    \n                    \n                })\n            }\n            \/* 退款选择图片 -------- end *\/\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/* 退款选择图片 -------- start *\/\x3c\/span\x3e\n        \n$(\x3cspan class=\x22hljs-string\x22\x3e\x22#chooseImage\x22\x3c\/span\x3e).click(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\n\x3c\/span\x3e{\n                \n                wx.chooseImage(\n                {\n                    count: \x3cspan class=\x22hljs-number\x22\x3e9\x3c\/span\x3e,                                 \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 默认9\x3c\/span\x3e\n                    sizeType: [\x3cspan class=\x22hljs-string\x22\x3e\x27original\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x27compressed\x27\x3c\/span\x3e],     \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 可以指定是原图还是压缩图，默认二者都有\x3c\/span\x3e\n                    sourceType: [\x3cspan class=\x22hljs-string\x22\x3e\x27album\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27camera\x27\x3c\/span\x3e],         \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 可以指定来源是相册还是相机，默认二者都有\x3c\/span\x3e\n                    success: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(res)\x3c\/span\x3e\n                    \x3c\/span\x3e{\n                           images.localId = res.localIds; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片                       \x3c\/span\x3e\n                            \x3cspan class=\x22hljs-comment\x22\x3e\/\/for(var j = 0;j\x26lt;images.localId.length;j\x2b\x2b)\x3c\/span\x3e\n                              \x3cspan class=\x22hljs-comment\x22\x3e\/\/ {                      \x3c\/span\x3e\n                                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ var str = \x27\x26lt;div serverId=\x27\x2bimages.serverId[j]\x2b\x27 class=\x22chat-sender\x22\x26gt;\x26lt;div class=\x22chat-avatar\x22\x26gt;\x3c\/span\x3e\n　　　　　　　　　　　　　　　　　　　　  \x3cspan class=\x22hljs-comment\x22\x3e\/\/\x26lt;img src=\x22\/home\/push\/img\/1.png\x22 alt=\x22\x22\x26gt;\x3c\/span\x3e\n　　　　　　　　　　　　　　　　　　     \x3cspan class=\x22hljs-comment\x22\x3e\/\/\x26lt;\/div\x26gt;\x26lt;div class=\x22chat-content\x22\x26gt;\x26lt;div class=\x22chat-triangle\x22\x26gt;\x26lt;\/div\x26gt;\x3c\/span\x3e\n　　　　　　　　　　　　　　　　　　　　  \x3cspan class=\x22hljs-comment\x22\x3e\/\/\x26lt;img src=\x27\x2bimages.localId[j]\x2b\x27 data-originalDrawing-src=\x27\x2bimages.localId[j]\x2b\x27 data-preview-src=\x22\x22 data-preview-group=\x221\x22\/\x26gt;\x26lt;\/div\x26gt;\x26lt;\/div\x26gt;\x27\x3c\/span\x3e\n                                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ $(\x22#main\x22).append(str);\x3c\/span\x3e\n                                   \n                              \x3cspan class=\x22hljs-comment\x22\x3e\/\/ }\x3c\/span\x3e\n                           \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e t = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n                        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, length = images.localId.length;\n                        images.serverId = [];\n\n                        \x3cspan class=\x22hljs-comment\x22\x3e\/* upload 方法 -------- start *\/\x3c\/span\x3e\n                        \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eupload\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\n                        \x3c\/span\x3e{\n                              wx.uploadImage(\n                              {\n                                localId: images.localId[i],\n                                success: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(res)\x3c\/span\x3e\n                                \x3c\/span\x3e{\n                                      i\x2b\x2b;\n\n                                      images.serverId.push(res.serverId);\n\n                                      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (i \x26lt; length) { upload(); }\n                                 \n                                      \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e str = \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div serverId=\x27\x3c\/span\x3e\x2bres.serverId\x2b\x3cspan class=\x22hljs-string\x22\x3e\x27 class=\x22chat-sender\x22\x26gt;\x26lt;div class=\x22chat-avatar\x22\x26gt;\n　　　　　　　　　　　　　　　　　　　　　　　　       \x26lt;img src=\x22\/home\/push\/img\/1.png\x22 alt=\x22\x22\x26gt;\n　　　　　　　　　　　　　　　　　　　　　　　　　　　　\x26lt;\/div\x26gt;\x26lt;div class=\x22chat-content\x22\x26gt;\x26lt;div class=\x22chat-triangle\x22\x26gt;\x26lt;\/div\x26gt;\n　　　　　　　　　　　　　　　　　　　　　　　　       \x26lt;img src=\x27\x3c\/span\x3e\x2bimages.localId[i\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e]\x2b\x3cspan class=\x22hljs-string\x22\x3e\x27 data-originalDrawing-src=\x27\x3c\/span\x3e\x2bimages.localId[i\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e]\x2b\x3cspan class=\x22hljs-string\x22\x3e\x27 data-preview-src=\x22\x22 data-preview-group=\x221\x22\/\x26gt;\n　　　　　　　　　　　　　　　　　　　　　　　　　　  \x26lt;\/div\x26gt;\x26lt;\/div\x26gt;\x27\x3c\/span\x3e\n                                   $(\x3cspan class=\x22hljs-string\x22\x3e\x22#main\x22\x3c\/span\x3e).append(str);\n\n                                   \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(i \x26gt;= length )    uploadImageToDb(images.serverId);\n\n                                  \n                                },\n                                fail: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(res)\x3c\/span\x3e\x3c\/span\x3e{ }\n                              });\n\n                        }\n                        \x3cspan class=\x22hljs-comment\x22\x3e\/* upload 方法 -------- end *\/\x3c\/span\x3e\n\n                        upload();\n                        \n\n                    }\n                })\n            });\n\n            \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3euploadImageToDb\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(images)\x3c\/span\x3e\x3c\/span\x3e{\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e str = \x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e;\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e upUrl = \x3cspan class=\x22hljs-string\x22\x3e\x22http:\/\/xxxxxx.com\/push\/push\/uploadImgage\x22\x3c\/span\x3e;\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e toMid     = $(\x3cspan class=\x22hljs-string\x22\x3e\x27#toMid\x27\x3c\/span\x3e).val();\n                  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e client_id = $(\x3cspan class=\x22hljs-string\x22\x3e\x27#client_id\x27\x3c\/span\x3e).val();\n                $.post(upUrl,{images:images,toMid:toMid,client_id:client_id},\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(data)\x3c\/span\x3e\x3c\/span\x3e{\n                    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(data == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e){\n                        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e n = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ; n \x26lt; $(\x3cspan class=\x22hljs-string\x22\x3e\x22.chat-sender\x22\x3c\/span\x3e).length ; n\x2b\x2b){\n                            str = $(\x3cspan class=\x22hljs-string\x22\x3e\x22.chat-sender\x22\x3c\/span\x3e).eq(n).attr(\x3cspan class=\x22hljs-string\x22\x3e\x22serverId\x22\x3c\/span\x3e)\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22,\x22\x3c\/span\x3e;\n                            \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e z=\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;z\x26lt;data.length;z\x2b\x2b){\n                                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(data[z] == str){\n                                    $(\x3cspan class=\x22hljs-string\x22\x3e\x22.chat-sender\x22\x3c\/span\x3e).eq(n).find(\x3cspan class=\x22hljs-string\x22\x3e\x22.chat-content\x22\x3c\/span\x3e).append(\x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div class=\x22chat-sender\x22\x26gt;上传失败\x26lt;\/div\x26gt;\x27\x3c\/span\x3e);\n                                }\n                            }\n                        }\n                    \n                    }\n                    \n                    \n                })\n            }\n            \x3cspan class=\x22hljs-comment\x22\x3e\/* 退款选择图片 -------- end *\/\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e后台部分\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/微信上传图片\n    public function uploadImgageAction () {\n        if (!Request::instance()-\x3eisPost()) { notFund(); }\n        $images    = $_POST[\x27images\x27];\n        if (empty($images)) die;\n        $toMid     = input(\x27post.toMid\x27, \x27\x27 , \x27string\x27);\n        $client_id = input(\x27post.client_id\x27, \x27\x27, \x27string\x27);\n        if (strlen($client_id) != 20 ) {                                            \/\/客户端错误\n            return json_encode([\x27status\x27 =\x3e -1]);\n        }\n        if (!is_not_empty_string($toMid)) {                                         \/\/系统错误\n            return json_encode([\x27status\x27 =\x3e -2]);\n        }\n\n        require_once dirname(dirname(__FILE__)) . \x27\/Events.php\x27;\n \n        $accIsOnline    = Gateway::isUidOnline($toMid) == 1 ? 1 : 0;                \/\/判读商家是否在线\n        $message_type   = 3;\n        \/\/微信上传图片处理Start\n        $res = json_decode(file_get_contents(\x26quot;access_token.json\x26quot;));\n        foreach ($res as $key =\x3e $value) {\n            if($key == \x27access_token\x27){\n                $access_token = $value;\n            }\n        }\n        $data = [];\n        foreach ($images as $k =\x3e $v) {\n            $str = date(\x27YmdHis\x27).rand(1000,9999).\x27.jpg\x27;\n            $targetName = \x27.\/upload\/chat\/\x27.$str;\n            if (!file_exists(\x26quot;.\/upload\/chat\/\x26quot;)) {\n              mkdir(\x26quot;.\/upload\/chat\/\x26quot;, 0777, true);\n            }\n            $ch = curl_init(\x26quot;http:\/\/file.api.weixin.qq.com\/cgi-bin\/media\/get?access_token=\x26quot;.$access_token.\x26quot;\x26amp;media_id=\x26quot;.$v);\n            $fp = fopen($targetName, \x27wb\x27);\n            curl_setopt($ch, CURLOPT_FILE, $fp);\n            curl_setopt($ch, CURLOPT_HEADER, 0);\n            $msg[\x26quot;status\x26quot;] = curl_exec($ch);\n            $msg[\x26quot;filename\x26quot;] = $str;\n            curl_close($ch);\n            fclose($fp);\n            $data[] = $targetName;\n        }\n        \/\/微信上传图片处理End\n        if (!is_not_empty_array($data)) {                                       \/\/微信服务器端图片上传错误\n            return json_encode([\x27status\x27 =\x3e -2]); \n        }\n        $message = json_encode($data);\n        \/\/Log入库\n        $insertId       = Pmodel\\Push::addChatLog(self::$uid, $toMid, $message, $message_type, 1, $accIsOnline);\n        if ($insertId === false) {                                                  \/\/入库失败（服务器故障）\n            return json_encode([\x27status\x27 =\x3e -3]);\n        }\n        $Worker = new \\Events;\n        $message_json   = \x27{\x26quot;type\x26quot;:\x26quot;send\x26quot;,\x26quot;source\x26quot;:\x26quot;U_\x27 . self::$uid . \x27\x26quot;,\x26quot;toClientUid\x26quot;:\x26quot;\x27 . $toMid . \x27\x26quot;,\x26quot;content\x26quot;:\x27 . $message .\x27,\n　　　　　　　　　　　　　　  \x26quot;c_type\x26quot;: \x27 . $message_type .\x27, \x26quot;Db_id\x26quot;:\x27 . $insertId . \x27}\x27;\n        $Worker::onMessage($client_id, $message_json);\n        \/\/成功返回相关数据\n        return json_encode([\n            \x27status\x27    =\x3e 1,\n            \x27timeStamp\x27 =\x3e time(),\n            \x27timeStr\x27   =\x3e date(\x27H:i:s\x27)\n        ]);\n\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/微信上传图片\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3euploadImgageAction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!Request::instance()-\x26gt;isPost()) { notFund(); }\n        $images    = $_POST[\x3cspan class=\x22hljs-string\x22\x3e\x27images\x27\x3c\/span\x3e];\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3eempty\x3c\/span\x3e($images)) \x3cspan class=\x22hljs-keyword\x22\x3edie\x3c\/span\x3e;\n        $toMid     = input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.toMid\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e , \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e);\n        $client_id = input(\x3cspan class=\x22hljs-string\x22\x3e\x27post.client_id\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (strlen($client_id) != \x3cspan class=\x22hljs-number\x22\x3e20\x3c\/span\x3e ) {                                            \x3cspan class=\x22hljs-comment\x22\x3e\/\/客户端错误\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e]);\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!is_not_empty_string($toMid)) {                                         \x3cspan class=\x22hljs-comment\x22\x3e\/\/系统错误\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-2\x3c\/span\x3e]);\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3erequire_once\x3c\/span\x3e dirname(dirname(\x3cspan class=\x22hljs-keyword\x22\x3e__FILE__\x3c\/span\x3e)) . \x3cspan class=\x22hljs-string\x22\x3e\x27\/Events.php\x27\x3c\/span\x3e;\n \n        $accIsOnline    = Gateway::isUidOnline($toMid) == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e : \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;                \x3cspan class=\x22hljs-comment\x22\x3e\/\/判读商家是否在线\x3c\/span\x3e\n        $message_type   = \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/微信上传图片处理Start\x3c\/span\x3e\n        $res = json_decode(file_get_contents(\x3cspan class=\x22hljs-string\x22\x3e\x22access_token.json\x22\x3c\/span\x3e));\n        \x3cspan class=\x22hljs-keyword\x22\x3eforeach\x3c\/span\x3e ($res \x3cspan class=\x22hljs-keyword\x22\x3eas\x3c\/span\x3e $key =\x26gt; $value) {\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e($key == \x3cspan class=\x22hljs-string\x22\x3e\x27access_token\x27\x3c\/span\x3e){\n                $access_token = $value;\n            }\n        }\n        $data = [];\n        \x3cspan class=\x22hljs-keyword\x22\x3eforeach\x3c\/span\x3e ($images \x3cspan class=\x22hljs-keyword\x22\x3eas\x3c\/span\x3e $k =\x26gt; $v) {\n            $str = date(\x3cspan class=\x22hljs-string\x22\x3e\x27YmdHis\x27\x3c\/span\x3e).rand(\x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e9999\x3c\/span\x3e).\x3cspan class=\x22hljs-string\x22\x3e\x27.jpg\x27\x3c\/span\x3e;\n            $targetName = \x3cspan class=\x22hljs-string\x22\x3e\x27.\/upload\/chat\/\x27\x3c\/span\x3e.$str;\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!file_exists(\x3cspan class=\x22hljs-string\x22\x3e\x22.\/upload\/chat\/\x22\x3c\/span\x3e)) {\n              mkdir(\x3cspan class=\x22hljs-string\x22\x3e\x22.\/upload\/chat\/\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0777\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e);\n            }\n            $ch = curl_init(\x3cspan class=\x22hljs-string\x22\x3e\x22http:\/\/file.api.weixin.qq.com\/cgi-bin\/media\/get?access_token=\x22\x3c\/span\x3e.$access_token.\x3cspan class=\x22hljs-string\x22\x3e\x22\x26amp;media_id=\x22\x3c\/span\x3e.$v);\n            $fp = fopen($targetName, \x3cspan class=\x22hljs-string\x22\x3e\x27wb\x27\x3c\/span\x3e);\n            curl_setopt($ch, CURLOPT_FILE, $fp);\n            curl_setopt($ch, CURLOPT_HEADER, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n            $msg[\x3cspan class=\x22hljs-string\x22\x3e\x22status\x22\x3c\/span\x3e] = curl_exec($ch);\n            $msg[\x3cspan class=\x22hljs-string\x22\x3e\x22filename\x22\x3c\/span\x3e] = $str;\n            curl_close($ch);\n            fclose($fp);\n            $data[] = $targetName;\n        }\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/微信上传图片处理End\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!is_not_empty_array($data)) {                                       \x3cspan class=\x22hljs-comment\x22\x3e\/\/微信服务器端图片上传错误\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-2\x3c\/span\x3e]); \n        }\n        $message = json_encode($data);\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/Log入库\x3c\/span\x3e\n        $insertId       = Pmodel\\Push::addChatLog(\x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e::$uid, $toMid, $message, $message_type, \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, $accIsOnline);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e ($insertId === \x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e) {                                                  \x3cspan class=\x22hljs-comment\x22\x3e\/\/入库失败（服务器故障）\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e-3\x3c\/span\x3e]);\n        }\n        $Worker = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \\Events;\n        $message_json   = \x3cspan class=\x22hljs-string\x22\x3e\x27{\x22type\x22:\x22send\x22,\x22source\x22:\x22U_\x27\x3c\/span\x3e . \x3cspan class=\x22hljs-keyword\x22\x3eself\x3c\/span\x3e::$uid . \x3cspan class=\x22hljs-string\x22\x3e\x27\x22,\x22toClientUid\x22:\x22\x27\x3c\/span\x3e . $toMid . \x3cspan class=\x22hljs-string\x22\x3e\x27\x22,\x22content\x22:\x27\x3c\/span\x3e . $message .\x3cspan class=\x22hljs-string\x22\x3e\x27,\n　　　　　　　　　　　　　　  \x22c_type\x22: \x27\x3c\/span\x3e . $message_type .\x3cspan class=\x22hljs-string\x22\x3e\x27, \x22Db_id\x22:\x27\x3c\/span\x3e . $insertId . \x3cspan class=\x22hljs-string\x22\x3e\x27}\x27\x3c\/span\x3e;\n        $Worker::onMessage($client_id, $message_json);\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/成功返回相关数据\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode([\n            \x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e    =\x26gt; \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,\n            \x3cspan class=\x22hljs-string\x22\x3e\x27timeStamp\x27\x3c\/span\x3e =\x26gt; time(),\n            \x3cspan class=\x22hljs-string\x22\x3e\x27timeStr\x27\x3c\/span\x3e   =\x26gt; date(\x3cspan class=\x22hljs-string\x22\x3e\x27H:i:s\x27\x3c\/span\x3e)\n        ]);\n\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其他一些不是很重要的代码就不拿出来了。\x3c\/p\x3e\n\x3cp\x3e当前项目只是一个简单的需求，并没有把GatewayWorker很多强大的功能体现出来，大家以后在项目开发中遇到更为复杂的需求，参考官方手册提供的一些Demo就可以慢慢实现并开发出更为健壮的项目！\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>使用Websocket框架之GatewayWorker开发电商平台买家与卖家实时通讯</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000012971998">https://segmentfault.com/a/1190000012971998</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/8hyd8c2wfzm/" target="_blank">https://alili.tech/archive/8hyd8c2wfzm/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>