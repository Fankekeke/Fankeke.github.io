<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="从0实现一个tiny react（二）"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>从0实现一个tiny react（二） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/8lhmeamyell/",
				"appid": "1613049289050283", 
				"title": "从0实现一个tiny react（二） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-01T02:30:07"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/jn993zgejf/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/knkiaqob0y/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f&text=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f&text=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f&title=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f&is_video=false&description=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f&title=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f&title=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f&title=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8lhmeamyell%2f&title=%e4%bb%8e0%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aatiny%20react%ef%bc%88%e4%ba%8c%ef%bc%89"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">从0实现一个tiny react（二）</h1><div class="meta"><div class="postdate"><time datetime="2019-01-01" itemprop="datePublished">2019-01-01</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch1 id=\x22articleHeader0\x22\x3e从0实现一个tiny react（二）\x3c\/h1\x3e\n\x3cp\x3eui = f(d)！ 这是react考虑ui的方式，开发者可以把重心放到d 数据上面来了。 从开发者的角度来讲 d一旦改变，react将会把ui重新渲染，使其再次满足\x3cbr\x3eui = f(d), 开发者没有任何dom操作， 交给react就好！！\x3c\/p\x3e\n\x3cp\x3e怎么重新渲染呢？ (一)文 中我们实现了一种方式， state改变的时候，用新的dom树替换一下老的dom树， 这是完全可行的。\x3cbr\x3e考虑一下这个例子 \x3ca href=\x22http:\/\/jsfiddle.net\/yankang\/z0e9ngwL\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e在线演示地址\x3c\/a\x3e\x3cbutton class=\x22btn btn-xs btn-default ml10 preview\x22 data-url=\x22yankang\/z0e9ngwL\/\x22 data-typeid=\x220\x22\x3e点击预览\x3c\/button\x3e:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class AppWithNoVDOM extends Component {\n    constructor(props) {\n        super(props)\n    }\n\n    testApp3() {\n        let result = []\n        for(let i = 0; i \x3c 10000 ; i\x2b\x2b) {\n            result.push(\x3cdiv style=\x22{{\x22\n                width: \x2730px\x27,\n                color: \x27red\x27,\n                fontSize: \x2712px\x27,\n                fontWeight: 600,\n                height: \x2720px\x27,\n                textAlign: \x27center\x27,\n                margin:\x275px\x27,\n                padding: \x275px\x27,\n                border:\x271px solid red\x27,\n                position: \x27relative\x27,\n                left: \x2710px\x27,\n                top: \x2710px\x27,\n            \x22}}\x22 title={i} \x3e{i}\x3c\/div\x3e)\n        }\n        return result\n    }\n\n    render() {\n        return (\n            \x3cdiv\n                width={100}\x3e\n                \x3ca  onClick={e =\x3e {\n                    this.setState({})\n                \x22}}\x22\x3eclick me\x3c\/a\x3e\n                {this.testApp3()}\n            \x3c\/div\x3e\n        )\n    }\n}\n\nconst startTime = new Date().getTime()\nrender(\x3cApp\/\x3e, document.getElementById(\x26quot;root\x26quot;))\nconsole.log(\x26quot;duration:\x26quot;, new Date().getTime() - startTime)\n\n\n...\nsetState(state) {\n    setTimeout(() =\x3e {\n        this.state = state\n        const vnode = this.render()\n        let olddom = getDOM(this)\n        const startTime = new Date().getTime()\n        render(vnode, olddom.parentNode, this, olddom)\n        console.log(\x26quot;duration:\x26quot;, new Date().getTime() - startTime)\n    }, 0)\n}\n...\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eAppWithNoVDOM\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(props) {\n        \x3cspan class=\x22hljs-keyword\x22\x3esuper\x3c\/span\x3e(props)\n    }\n\n    testApp3() {\n        \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e result = []\n        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; \x3cspan class=\x22hljs-number\x22\x3e10000\x3c\/span\x3e ; i\x2b\x2b) {\n            result.push(\x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3estyle\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22{{\x22\x3c\/span\x3e\n                \x3cspan class=\x22hljs-attr\x22\x3ewidth:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3e30px\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3ecolor:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3ered\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3efontSize:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3e12px\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3efontWeight:\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3e600\x3c\/span\x3e,\n                \x3cspan class=\x22hljs-attr\x22\x3eheight:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3e20px\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3etextAlign:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3ecenter\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3emargin:\x3c\/span\x3e\x27\x3cspan class=\x22hljs-attr\x22\x3e5px\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3epadding:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3e5px\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3eborder:\x3c\/span\x3e\x27\x3cspan class=\x22hljs-attr\x22\x3e1px\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3esolid\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ered\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3eposition:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3erelative\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3eleft:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3e10px\x3c\/span\x3e\x27,\n                \x3cspan class=\x22hljs-attr\x22\x3etop:\x3c\/span\x3e \x27\x3cspan class=\x22hljs-attr\x22\x3e10px\x3c\/span\x3e\x27,\n            \x22}}\x22 \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{i}\x3c\/span\x3e \x26gt;\x3c\/span\x3e{i}\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/span\x3e)\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e result\n    }\n\n    render() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n            \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\n                \x3cspan class=\x22hljs-attr\x22\x3ewidth\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{100}\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n                \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ea\x3c\/span\x3e  \x3cspan class=\x22hljs-attr\x22\x3eonClick\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{e\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n                    this.setState({})\n                \x22}}\x22\x26gt;click me\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ea\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n                {this.testApp3()}\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/span\x3e\n        )\n    }\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e startTime = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e().getTime()\nrender(\x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eApp\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x22root\x22\x3c\/span\x3e))\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22duration:\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e().getTime() - startTime)\n\n\n...\nsetState(state) {\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state = state\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e vnode = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.render()\n        \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e olddom = getDOM(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e)\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e startTime = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e().getTime()\n        render(vnode, olddom.parentNode, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, olddom)\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22duration:\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e().getTime() - startTime)\n    }, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e)\n}\n...\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们在 render, setState 设置下时间点。 在10000万个div的情况下， 第一次render和setState触发的render 耗时大概在180ms （可能跟机器配置有关）\x3cbr\x3e当点击的时候， 由于调用\x3ccode\x3ethis.setState({})\x3c\/code\x3e, 页面将会重新渲染， 再次建立10000万个div， 但是实际上这里的DOM一点也没改。\x3cbr\x3e应用越复杂， 无用功越多，卡顿越明显\x3c\/p\x3e\n\x3cp\x3e为了解决这个问题， react提出了virtual-dom的概念：vnode(纯js对象) \x27代表\x27 dom， 在渲染之前， 先比较出oldvnode和newvode的 区别。 然后增量的\x3cbr\x3e更新dom。 virtual-dom 使得ui=f(d) 得以在实际项目上使用。 \x3cbr\x3e（注意： virtual-dom 并不会加快应用速度， 只是让应用在不直接操作dom的情况下，通过暴力的比较，增量更新 让应用没有那么慢）\x3c\/p\x3e\n\x3cp\x3e如何增量更新呢？\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e复用DOM\x3c\/h3\x3e\n\x3cp\x3e回想一下, 在 \x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000010822571\x22\x3e(一)\x3c\/a\x3e render函数 里面对于每一个判定为 dom类型的VDOM， 是直接创建一个新的DOM：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22...\nelse if(typeof vnode.nodeName == \x26quot;string\x26quot;) {\n    dom = document.createElement(vnode.nodeName)\n    ...\n} \n...\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lasso\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-params\x22\x3e...\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(typeof vnode.nodeName == \x3cspan class=\x22hljs-string\x22\x3e\x22string\x22\x3c\/span\x3e) {\n    dom = document.createElement(vnode.nodeName)\n    \x3cspan class=\x22hljs-params\x22\x3e...\x3c\/span\x3e\n} \n\x3cspan class=\x22hljs-params\x22\x3e...\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e一定要创建一个  新的DOM 结构吗？\x26lt;br\/\x26gt;\x3cbr\x3e考虑这种情况：假如一个组件， 初次渲染为 renderBefore， 调用setState再次渲染为 renderAfter  调用setState再再次渲染为 renderAfterAfter。 VNODE如下\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const renderBefore = {\n    tagName: \x27div\x27,\n    props: {\n        width: \x2720px\x27,\n        className: \x27xx\x27\n    },\n    children:[vnode1, vnode2, vnode3]\n}\nconst renderAfter = {\n    tagName: \x27div\x27,\n    props: {\n        width: \x2730px\x27,\n        title: \x27yy\x27\n    },\n    children:[vnode1, vnode2]\n}\nconst renderAfterAfter = {\n    tagName: \x27span\x27,\n    props: {\n        className: \x27xx\x27\n    },\n    children:[vnode1, vnode2, vnode3]\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs yaml\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-string\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3erenderBefore\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e=\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e{\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    tagName:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27div\x27\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e,\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    props:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e{\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e        width:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x2720px\x27\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e,\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e        className:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27xx\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-string\x22\x3e},\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    children:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e[vnode1,\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3evnode2,\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3evnode3]\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e}\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3erenderAfter\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e=\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e{\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    tagName:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27div\x27\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e,\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    props:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e{\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e        width:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x2730px\x27\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e,\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e        title:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27yy\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-string\x22\x3e},\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    children:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e[vnode1,\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3evnode2]\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e}\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3erenderAfterAfter\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e=\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e{\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    tagName:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27span\x27\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e,\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    props:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e{\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e        className:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27xx\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-string\x22\x3e},\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3e    children:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e[vnode1,\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3evnode2,\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3evnode3]\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e}\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3erenderBefore 和renderAfter 都是div， 只不过props和children有部分区别，那我们是不是可以通过修改DOM属性， 修改DOM子节点，把 rederBefore 变化为renderAfter呢？， 这样就避开了DOM创建。 而 renderAfter和renderAfterAfter\x3cbr\x3e属于不同的DOM类型， 浏览器还没提供修改DOM类型的Api，是无法复用的， 是一定要创建新的DOM的。\x3c\/p\x3e\n\x3cp\x3e原则如下：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e不同元素类型是无法复用的， span 是无法变成 div的。\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e对于相同元素:\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e更新属性，\x3c\/li\x3e\n\x3cli\x3e复用子节点。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e所以，现在的代码可能是这样的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22...\nelse if(typeof vnode.nodeName == \x26quot;string\x26quot;) {\n    if(!olddom || olddom.nodeName != vnode.nodeName.toUpperCase()) {\n        createNewDom(vnode, parent, comp, olddom)\n    } else {\n        diffDOM(vnode, parent, comp, olddom) \/\/ 包括 更新属性， 子节点复用\n    }\n}\n...\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lasso\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-params\x22\x3e...\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(typeof vnode.nodeName == \x3cspan class=\x22hljs-string\x22\x3e\x22string\x22\x3c\/span\x3e) {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(!olddom || olddom.nodeName != vnode.nodeName.toUpperCase()) {\n        createNewDom(vnode, \x3cspan class=\x22hljs-keyword\x22\x3eparent\x3c\/span\x3e, comp, olddom)\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        diffDOM(vnode, \x3cspan class=\x22hljs-keyword\x22\x3eparent\x3c\/span\x3e, comp, olddom) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 包括 更新属性， 子节点复用\x3c\/span\x3e\n    }\n}\n\x3cspan class=\x22hljs-params\x22\x3e...\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e更新属性\x3c\/h4\x3e\n\x3cp\x3e对于 renderBefore =\x26gt; renderAfter 。 属性部分需要做3件事情。\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3erenderBefore 和 renderAfter 的属性交集  如果值不同， 更新值 updateAttr\x3c\/li\x3e\n\x3cli\x3erenderBefore 和 renderAfter 的属性差集  置空  removeAttr\x3c\/li\x3e\n\x3cli\x3erenderAfter 和 renderBefore 的属性差集  设置新值 setAttr\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const {onlyInLeft, bothIn, onlyInRight} = diffObject(newProps, oldProps)\nsetAttrs(olddom, onlyInLeft)\nremoveAttrs(olddom, onlyInRight)\ndiffAttrs(olddom, bothIn.left, bothIn.right)\n\nfunction diffObject(leftProps, rightProps) {\n    const onlyInLeft = {}\n    const bothLeft = {}\n    const bothRight = {}\n    const onlyInRight = {}\n\n    for(let key in leftProps) {\n        if(rightProps[key] === undefined) {\n            onlyInLeft[key] = leftProps[key]\n        } else {\n            bothLeft[key] = leftProps[key]\n            bothRight[key] = rightProps[key]\n        }\n    }\n\n    for(let key in rightProps) {\n        if(leftProps[key] === undefined) {\n            onlyInRight[key] = rightProps[key]\n        }\n    }\n\n    return {\n        onlyInRight,\n        onlyInLeft,\n        bothIn: {\n            left: bothLeft,\n            right: bothRight\n        }\n    }\n}\n\nfunction setAttrs(dom, props) {\n    const allKeys = Object.keys(props)\n    allKeys.forEach(k =\x3e {\n        const v = props[k]\n\n        if(k == \x26quot;className\x26quot;) {\n            dom.setAttribute(\x26quot;class\x26quot;, v)\n            return\n        }\n\n        if(k == \x26quot;style\x26quot;) {\n            if(typeof v == \x26quot;string\x26quot;) {\n                dom.style.cssText = v \/\/IE\n            }\n\n            if(typeof v == \x26quot;object\x26quot;) {\n                for (let i in v) {\n                    dom.style[i] =  v[i]\n                }\n            }\n            return\n\n        }\n\n        if(k[0] == \x26quot;o\x26quot; \x26amp;\x26amp; k[1] == \x26quot;n\x26quot;) {\n            const capture = (k.indexOf(\x26quot;Capture\x26quot;) != -1)\n            dom.addEventListener(k.substring(2).toLowerCase(), v, capture)\n            return\n        }\n\n        dom.setAttribute(k, v)\n    })\n}\n\nfunction removeAttrs(dom, props) {\n    for(let k in props) {\n        if(k == \x26quot;className\x26quot;) {\n            dom.removeAttribute(\x26quot;class\x26quot;)\n            continue\n        }\n\n        if(k == \x26quot;style\x26quot;) {\n            dom.style.cssText = \x26quot;\x26quot; \/\/IE\n            continue\n        }\n\n\n        if(k[0] == \x26quot;o\x26quot; \x26amp;\x26amp; k[1] == \x26quot;n\x26quot;) {\n            const capture = (k.indexOf(\x26quot;Capture\x26quot;) != -1)\n            const v = props[k]\n            dom.removeEventListener(k.substring(2).toLowerCase(), v, capture)\n            continue\n        }\n\n        dom.removeAttribute(k)\n    }\n}\n\n\/**\n *  调用者保证newProps 与 oldProps 的keys是相同的\n * @param dom\n * @param newProps\n * @param oldProps\n *\/\nfunction diffAttrs(dom, newProps, oldProps) {\n    for(let k in newProps) {\n        let v = newProps[k]\n        let ov = oldProps[k]\n        if(v === ov) continue\n\n        if(k == \x26quot;className\x26quot;) {\n            dom.setAttribute(\x26quot;class\x26quot;, v)\n            continue\n        }\n\n        if(k == \x26quot;style\x26quot;) {\n            if(typeof v == \x26quot;string\x26quot;) {\n                dom.style.cssText = v\n            } else if( typeof v == \x26quot;object\x26quot; \x26amp;\x26amp; typeof ov == \x26quot;object\x26quot;) {\n                for(let vk in v) {\n                    if(v[vk] !== ov[vk]) {\n                        dom.style[vk] = v[vk]\n                    }\n                }\n\n                for(let ovk in ov) {\n                    if(v[ovk] === undefined){\n                        dom.style[ovk] = \x26quot;\x26quot;\n                    }\n                }\n            } else {  \/\/typeof v == \x26quot;object\x26quot; \x26amp;\x26amp; typeof ov == \x26quot;string\x26quot;\n                dom.style = {}\n                for(let vk in v) {\n                    dom.style[vk] = v[vk]\n                }\n            }\n            continue\n        }\n\n        if(k[0] == \x26quot;o\x26quot; \x26amp;\x26amp; k[1] == \x26quot;n\x26quot;) {\n            const capture = (k.indexOf(\x26quot;Capture\x26quot;) != -1)\n            let eventKey = k.substring(2).toLowerCase()\n            dom.removeEventListener(eventKey, ov, capture)\n            dom.addEventListener(eventKey, v, capture)\n            continue\n        }\n\n        dom.setAttribute(k, v)\n    }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e {onlyInLeft, bothIn, onlyInRight} = diffObject(newProps, oldProps)\nsetAttrs(olddom, onlyInLeft)\nremoveAttrs(olddom, onlyInRight)\ndiffAttrs(olddom, bothIn.left, bothIn.right)\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ediffObject\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eleftProps, rightProps\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e onlyInLeft = {}\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e bothLeft = {}\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e bothRight = {}\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e onlyInRight = {}\n\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e key \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e leftProps) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(rightProps[key] === \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e) {\n            onlyInLeft[key] = leftProps[key]\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            bothLeft[key] = leftProps[key]\n            bothRight[key] = rightProps[key]\n        }\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e key \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e rightProps) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(leftProps[key] === \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e) {\n            onlyInRight[key] = rightProps[key]\n        }\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n        onlyInRight,\n        onlyInLeft,\n        \x3cspan class=\x22hljs-attr\x22\x3ebothIn\x3c\/span\x3e: {\n            \x3cspan class=\x22hljs-attr\x22\x3eleft\x3c\/span\x3e: bothLeft,\n            \x3cspan class=\x22hljs-attr\x22\x3eright\x3c\/span\x3e: bothRight\n        }\n    }\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esetAttrs\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3edom, props\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e allKeys = \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(props)\n    allKeys.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ek\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e v = props[k]\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k == \x3cspan class=\x22hljs-string\x22\x3e\x22className\x22\x3c\/span\x3e) {\n            dom.setAttribute(\x3cspan class=\x22hljs-string\x22\x3e\x22class\x22\x3c\/span\x3e, v)\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k == \x3cspan class=\x22hljs-string\x22\x3e\x22style\x22\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e v == \x3cspan class=\x22hljs-string\x22\x3e\x22string\x22\x3c\/span\x3e) {\n                dom.style.cssText = v \x3cspan class=\x22hljs-comment\x22\x3e\/\/IE\x3c\/span\x3e\n            }\n\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e v == \x3cspan class=\x22hljs-string\x22\x3e\x22object\x22\x3c\/span\x3e) {\n                \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e i \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e v) {\n                    dom.style[i] =  v[i]\n                }\n            }\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e\n\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x22o\x22\x3c\/span\x3e \x26amp;\x26amp; k[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x22n\x22\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e capture = (k.indexOf(\x3cspan class=\x22hljs-string\x22\x3e\x22Capture\x22\x3c\/span\x3e) != \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e)\n            dom.addEventListener(k.substring(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e).toLowerCase(), v, capture)\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e\n        }\n\n        dom.setAttribute(k, v)\n    })\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eremoveAttrs\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3edom, props\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e k \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e props) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k == \x3cspan class=\x22hljs-string\x22\x3e\x22className\x22\x3c\/span\x3e) {\n            dom.removeAttribute(\x3cspan class=\x22hljs-string\x22\x3e\x22class\x22\x3c\/span\x3e)\n            \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k == \x3cspan class=\x22hljs-string\x22\x3e\x22style\x22\x3c\/span\x3e) {\n            dom.style.cssText = \x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/IE\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e\n        }\n\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x22o\x22\x3c\/span\x3e \x26amp;\x26amp; k[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x22n\x22\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e capture = (k.indexOf(\x3cspan class=\x22hljs-string\x22\x3e\x22Capture\x22\x3c\/span\x3e) != \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e)\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e v = props[k]\n            dom.removeEventListener(k.substring(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e).toLowerCase(), v, capture)\n            \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e\n        }\n\n        dom.removeAttribute(k)\n    }\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n *  调用者保证newProps 与 oldProps 的keys是相同的\n * @param dom\n * @param newProps\n * @param oldProps\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ediffAttrs\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3edom, newProps, oldProps\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e k \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e newProps) {\n        \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e v = newProps[k]\n        \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e ov = oldProps[k]\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(v === ov) \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k == \x3cspan class=\x22hljs-string\x22\x3e\x22className\x22\x3c\/span\x3e) {\n            dom.setAttribute(\x3cspan class=\x22hljs-string\x22\x3e\x22class\x22\x3c\/span\x3e, v)\n            \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k == \x3cspan class=\x22hljs-string\x22\x3e\x22style\x22\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e v == \x3cspan class=\x22hljs-string\x22\x3e\x22string\x22\x3c\/span\x3e) {\n                dom.style.cssText = v\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e v == \x3cspan class=\x22hljs-string\x22\x3e\x22object\x22\x3c\/span\x3e \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e ov == \x3cspan class=\x22hljs-string\x22\x3e\x22object\x22\x3c\/span\x3e) {\n                \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e vk \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e v) {\n                    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(v[vk] !== ov[vk]) {\n                        dom.style[vk] = v[vk]\n                    }\n                }\n\n                \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e ovk \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e ov) {\n                    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(v[ovk] === \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e){\n                        dom.style[ovk] = \x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e\n                    }\n                }\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {  \x3cspan class=\x22hljs-comment\x22\x3e\/\/typeof v == \x22object\x22 \x26amp;\x26amp; typeof ov == \x22string\x22\x3c\/span\x3e\n                dom.style = {}\n                \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e vk \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e v) {\n                    dom.style[vk] = v[vk]\n                }\n            }\n            \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(k[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x22o\x22\x3c\/span\x3e \x26amp;\x26amp; k[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x22n\x22\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e capture = (k.indexOf(\x3cspan class=\x22hljs-string\x22\x3e\x22Capture\x22\x3c\/span\x3e) != \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e)\n            \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e eventKey = k.substring(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e).toLowerCase()\n            dom.removeEventListener(eventKey, ov, capture)\n            dom.addEventListener(eventKey, v, capture)\n            \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e\n        }\n\n        dom.setAttribute(k, v)\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x27新\x27的dom结构 属性和  renderAfter对应了。\x26lt;br\/\x26gt;\x3cbr\x3e但是 children部分 还是之前的\x3c\/p\x3e\n\x3ch4\x3e操作子节点\x3c\/h4\x3e\n\x3cp\x3e之前 操作子节点的代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22for(let i = 0; i \x3c vnode.children.length; i\x2b\x2b) {\n    render(vnode.children[i], dom, null, null)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs matlab\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(let \x3cspan class=\x22hljs-built_in\x22\x3ei\x3c\/span\x3e = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; \x3cspan class=\x22hljs-built_in\x22\x3ei\x3c\/span\x3e \x26lt; vnode.children.\x3cspan class=\x22hljs-built_in\x22\x3elength\x3c\/span\x3e; \x3cspan class=\x22hljs-built_in\x22\x3ei\x3c\/span\x3e\x2b\x2b) {\n    render(vnode.children[i], dom, null, null)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3erender 的第3个参数comp \x27谁渲染了我\x27， 第4个参数olddom \x27之前的旧dom元素\x27。现在复用旧的dom， 所以第4个参数可能是有值的 代码如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let olddomChild = olddom.firstChild\nfor(let i = 0; i \x3c vnode.children.length; i\x2b\x2b) {\n    render(vnode.children[i], olddom, null, olddomChild)\n    olddomChild = olddomChild \x26amp;\x26amp; olddomChild.nextSibling\n}\n\n\/\/删除多余的子节点\nwhile (olddomChild) {\n    let next = olddomChild.nextSibling\n    olddom.removeChild(olddomChild)\n    olddomChild = next\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3elet olddomChild = olddom\x3cspan class=\x22hljs-selector-class\x22\x3e.firstChild\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-title\x22\x3efor\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(let i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; vnode.children.length; i\x2b\x2b)\x3c\/span\x3e\x3c\/span\x3e {\n    render(vnode\x3cspan class=\x22hljs-selector-class\x22\x3e.children\x3c\/span\x3e[i], olddom, null, olddomChild)\n    olddomChild = olddomChild \x26amp;\x26amp; olddomChild\x3cspan class=\x22hljs-selector-class\x22\x3e.nextSibling\x3c\/span\x3e\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/删除多余的子节点\x3c\/span\x3e\nwhile (olddomChild) {\n    let next = olddomChild\x3cspan class=\x22hljs-selector-class\x22\x3e.nextSibling\x3c\/span\x3e\n    olddom.removeChild(olddomChild)\n    olddomChild = next\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e综上所述  完整的diffDOM 如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function diffDOM(vnode, parent, comp, olddom) {\n    const {onlyInLeft, bothIn, onlyInRight} = diffObject(vnode.props, olddom.__vnode.props)\n    setAttrs(olddom, onlyInLeft)\n    removeAttrs(olddom, onlyInRight)\n    diffAttrs(olddom, bothIn.left, bothIn.right)\n\n\n    let olddomChild = olddom.firstChild\n    for(let i = 0; i \x3c vnode.children.length; i\x2b\x2b) {\n        render(vnode.children[i], olddom, null, olddomChild)\n        olddomChild = olddomChild \x26amp;\x26amp; olddomChild.nextSibling\n    }\n\n    while (olddomChild) { \/\/删除多余的子节点\n        let next = olddomChild.nextSibling\n        olddom.removeChild(olddomChild)\n        olddomChild = next\n    }\n    olddom.__vnode = vnode  \n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ediffDOM\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3evnode, parent, comp, olddom\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e {onlyInLeft, bothIn, onlyInRight} = diffObject(vnode.props, olddom.__vnode.props)\n    setAttrs(olddom, onlyInLeft)\n    removeAttrs(olddom, onlyInRight)\n    diffAttrs(olddom, bothIn.left, bothIn.right)\n\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e olddomChild = olddom.firstChild\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; vnode.children.length; i\x2b\x2b) {\n        render(vnode.children[i], olddom, \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, olddomChild)\n        olddomChild = olddomChild \x26amp;\x26amp; olddomChild.nextSibling\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (olddomChild) { \x3cspan class=\x22hljs-comment\x22\x3e\/\/删除多余的子节点\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e next = olddomChild.nextSibling\n        olddom.removeChild(olddomChild)\n        olddomChild = next\n    }\n    olddom.__vnode = vnode  \n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e由于需要在diffDOM的时候 从olddom获取 oldVNODE（即 diffObject(vnode.props, olddom.__vnode.props)）。 所以：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 在创建的时候\n...\nlet dom = document.createElement(vnode.nodeName)\ndom.__vnode = vnode\n...\n\n\n\/\/ diffDOM\n...\nconst {onlyInLeft, bothIn, onlyInRight} = diffObject(vnode.props, olddom.__vnode.props)\n...\nolddom.__vnode = vnode  \/\/ 更新完之后， 需要把__vnode的指向 更新\n...\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs clean\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 在创建的时候\x3c\/span\x3e\n...\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e dom = document.createElement(vnode.nodeName)\ndom.__vnode = vnode\n...\n\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ diffDOM\x3c\/span\x3e\n...\nconst {onlyInLeft, bothIn, onlyInRight} = diffObject(vnode.props, olddom.__vnode.props)\n...\nolddom.__vnode = vnode  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 更新完之后， 需要把__vnode的指向 更新\x3c\/span\x3e\n...\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e另外 对于 TextNode的复用:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22...\nif(typeof vnode == \x26quot;string\x26quot; || typeof vnode == \x26quot;number\x26quot;) {\n        if(olddom \x26amp;\x26amp; olddom.splitText) {\n            if(olddom.nodeValue !== vnode) {\n                olddom.nodeValue = vnode\n            }\n        } else {\n            dom = document.createTextNode(vnode)\n            if(olddom) {\n                parent.replaceChild(dom, olddom)\n            } else {\n                parent.appendChild(dom)\n            }\n        }\n    }\n...\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3e...\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-title\x22\x3eif\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(typeof vnode == \x3cspan class=\x22hljs-string\x22\x3e\x22string\x22\x3c\/span\x3e || typeof vnode == \x3cspan class=\x22hljs-string\x22\x3e\x22number\x22\x3c\/span\x3e)\x3c\/span\x3e\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(olddom \x26amp;\x26amp; olddom.splitText) {\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(olddom\x3cspan class=\x22hljs-selector-class\x22\x3e.nodeValue\x3c\/span\x3e !== vnode) {\n                olddom\x3cspan class=\x22hljs-selector-class\x22\x3e.nodeValue\x3c\/span\x3e = vnode\n            }\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            dom = document.createTextNode(vnode)\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(olddom) {\n                parent.replaceChild(dom, olddom)\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                parent.appendChild(dom)\n            }\n        }\n    }\n...\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e重新 跑一下开头 的例子 \x3ca href=\x22http:\/\/jsfiddle.net\/yankang\/cyc4ss5c\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e新的复用DOM演示\x3c\/a\x3e\x3cbutton class=\x22btn btn-xs btn-default ml10 preview\x22 data-url=\x22yankang\/cyc4ss5c\/\x22 data-typeid=\x220\x22\x3e点击预览\x3c\/button\x3e setState后渲染时间变成了 20ms 左右。 从 180ms 到20ms 差不多快有一个数量级的差距了。 \x3cbr\x3e到底快了多少，取决于前后结构的相似程度， 如果前后结构基本相同，diff是有意义的减少了DOM操作。\x3c\/p\x3e\n\x3ch4\x3e复用子节点 - \x3cstrong\x3ekey\x3c\/strong\x3e\n\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22初始渲染\n...\nrender() {\n    return (\n        \x3cdiv\x3e\n            \x3cWeightCompA\/\x3e\n            \x3cWeightCompB\/\x3e\n            \x3cWeightCompC\/\x3e\n        \x3c\/div\x3e\n    )\n}\n...\n\nsetState再次渲染\n...\nrender() {\n    return (\n        \x3cdiv\x3e\n            \x3cspan\x3ehi\x3c\/span\x3e\n            \x3cWeightCompA\/\x3e\n            \x3cWeightCompB\/\x3e\n            \x3cWeightCompC\/\x3e\n        \x3c\/div\x3e\n    )\n}\n...\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e初始渲染\n...\nrender() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n        \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eWeightCompA\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eWeightCompB\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eWeightCompC\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/span\x3e\n    )\n}\n...\n\nsetState再次渲染\n...\nrender() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n        \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3ehi\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eWeightCompA\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eWeightCompB\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eWeightCompC\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/span\x3e\n    )\n}\n...\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们之前的子节点复用顺序就是按照DOM顺序， 显然这里如果这样处理的话， 可能导致组件都复用不了。 针对这个问题， React是通过给每一个子组件提供一个 \x22key\x22属性来解决的\x3cbr\x3e对于拥有 同样key的节点， 认为结构相同。 所以问题变成了：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22f([{key: \x27wca\x27}, {key: \x27wcb}, {key: \x27wcc}]) = [{key:\x27spanhi\x27}, {key: \x27wca\x27}, {key: \x27wcb}, {key: \x27wcc}]\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs groovy\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3ef([{\x3cspan class=\x22hljs-string\x22\x3ekey:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27wca\x27\x3c\/span\x3e}, {\x3cspan class=\x22hljs-string\x22\x3ekey:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27wcb}, {key: \x27\x3c\/span\x3ewcc}]) = [{\x3cspan class=\x22hljs-string\x22\x3ekey:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x27spanhi\x27\x3c\/span\x3e}, {\x3cspan class=\x22hljs-string\x22\x3ekey:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27wca\x27\x3c\/span\x3e}, {\x3cspan class=\x22hljs-string\x22\x3ekey:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27wcb}, {key: \x27\x3c\/span\x3ewcc}]\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e函数f 通过删除， 插入操作，把olddom的children顺序， 改为和 newProps里面的children一样 （按照key值一样）。类似与 \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Edit_distance\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e字符串距离\x3c\/a\x3e,\x3cbr\x3e对于这个问题， 我将会另开一篇文章\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e总结\x3c\/h3\x3e\n\x3cp\x3e通过 diff 比较渲染前后 DOM的差别来复用实际的， 我们的性能得到了提高。现在 render方法的描述： \x26lt;br\/\x26gt;\x3cbr\x3erender 方法是根据的vnode， 渲染到实际的dom，如果存在olddom会先尝试复用的 一个递归方法 (由于组件 最终一定会render html的标签。 所以这个递归一定是能够正常返回的)\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3evnode是字符串， 如果存在olddom， 且可以复用， 复用之。否则创建textNode节点\x3c\/li\x3e\n\x3cli\x3e当vnode.nodeName是 字符串的时候， 如果存在olddom， 且可以复用， 复用之。否则创建dom节点， 根据props设置节点属性， 遍历render children\x3c\/li\x3e\n\x3cli\x3e当vnode.nodeName是 function的时候， 获取render方法的返回值 vnode\x27， 执行render(vnode\x27)\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/ykforerlang\/tinyreact\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e代码git地址\x3c\/a\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e相关文章\x3c\/h3\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000010822571\x22\x3e从0实现一个tiny react(一)\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000011052656\x22 target=\x22_blank\x22\x3e从0实现一个tiny react（二)\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000011156505\x22\x3e从0实现一个tiny react（三）生命周期\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000012696920\x22 target=\x22_blank\x22\x3e从0开始实现 react-router\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000011304634\x22\x3e从0实现一个tinyredux\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000011633971\x22 target=\x22_blank\x22\x3e从0实现一个tiny react-redux\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000011936772\x22\x3e为什么我们需要reselect\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>从0实现一个tiny react（二）</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000011052656">https://segmentfault.com/a/1190000011052656</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/8lhmeamyell/" target="_blank">https://alili.tech/archive/8lhmeamyell/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>