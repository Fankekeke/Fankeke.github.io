<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="nodejs微信支付之扫码支付"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>nodejs微信支付之扫码支付 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/9bd0m4mlh69/",
				"appid": "1613049289050283", 
				"title": "nodejs微信支付之扫码支付 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-13T02:30:07"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/z11z5dga6/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/q0npokfxbw/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f&text=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f&text=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f&title=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f&is_video=false&description=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f&title=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f&title=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f&title=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9bd0m4mlh69%2f&title=nodejs%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e4%b9%8b%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">nodejs微信支付之扫码支付</h1><div class="meta"><div class="postdate"><time datetime="2018-12-13" itemprop="datePublished">2018-12-13</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch1 id=\x22articleHeader0\x22\x3e前言\x3c\/h1\x3e\n\x3cp\x3e本篇文章主要是记录本人在微信扫码支付过程中所遇到的问题，给大家一个借鉴作用，希望对你们有帮助\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e开发环境\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3enodejs \x3ccode\x3ev8.1.0\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3eegg \x3ccode\x3ev1.1.0\x3c\/code\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e准备工作\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e微信公众号-appid\x3c\/li\x3e\n\x3cli\x3e微信商户号-mch_id\x3c\/li\x3e\n\x3cli\x3ekey值(签名算法所需,其实就是一个32位的密码，可以用md5生成一个)(key设置路径：微信商户平台(pay.weixin.qq.com)--\x26gt;账户设置--\x26gt;API安全--\x26gt;密钥设置)\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e扫码支付-统一下单\x3c\/h2\x3e\n\x3cp\x3e以下才用的是微信模式二，因为比较简单\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    let MD5 = require(\x27md5\x27),\n        xml2js = require(\x27xml2js\x27),\n        url = \x26quot;https:\/\/api.mch.weixin.qq.com\/pay\/unifiedorder\x26quot;,\/\/ 下单请求地址\n        appid = \x27公众号id\x27,\n        mch_id = \x27微信商户号\x27；\n        notify_url = \x27回调地址\x27,\n        out_trade_no = \x27自己设置的订单号\x27,\/\/ 微信会有自己订单号、我们自己的系统需要设置自己的订单号\n        total_fee = \x27订单金额\x27,\/\/ 注意，单位为分\n        body = \x27商品简单描述\x27, \n        trade_type = \x27NATIVE\x27,\/\/ 交易类型，JSAPI--公众号支付、NATIVE--原生扫码支付、APP--app支付\n        nonce_str = moment().format(\x27YYYYMMDDHHmmssSSS\x27),\/\/ 随机字符串32位以下\n        stringA = `appid=${公众号id}\x26amp;body=${body}\x26amp;mch_id=${微信商户号}\x26amp;nonce_str=${nonce_str}\x26amp;notify_url=${\n        notify_url}\x26amp;out_trade_no=${out_trade_no}\x26amp;spbill_create_ip=${ctx.request.ip}\x26amp;total_fee=${total_fee}\x26amp;trade_type=${trade_type}`,\n        stringSignTemp = stringA \x2b \x26quot;\x26amp;key=xxxxxxxxxxxxxxxxx\x26quot;, \/\/注：key为商户平台设置的密钥key\n        sign = MD5(stringSignTemp).toUpperCase();  \/\/注：MD5签名方式\n    \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e MD5 = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27md5\x27\x3c\/span\x3e),\n        xml2js = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27xml2js\x27\x3c\/span\x3e),\n        url = \x3cspan class=\x22hljs-string\x22\x3e\x22https:\/\/api.mch.weixin.qq.com\/pay\/unifiedorder\x22\x3c\/span\x3e,\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 下单请求地址\x3c\/span\x3e\n        appid = \x3cspan class=\x22hljs-string\x22\x3e\x27公众号id\x27\x3c\/span\x3e,\n        mch_id = \x3cspan class=\x22hljs-string\x22\x3e\x27微信商户号\x27\x3c\/span\x3e；\n        notify_url = \x3cspan class=\x22hljs-string\x22\x3e\x27回调地址\x27\x3c\/span\x3e,\n        out_trade_no = \x3cspan class=\x22hljs-string\x22\x3e\x27自己设置的订单号\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 微信会有自己订单号、我们自己的系统需要设置自己的订单号\x3c\/span\x3e\n        total_fee = \x3cspan class=\x22hljs-string\x22\x3e\x27订单金额\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 注意，单位为分\x3c\/span\x3e\n        body = \x3cspan class=\x22hljs-string\x22\x3e\x27商品简单描述\x27\x3c\/span\x3e, \n        trade_type = \x3cspan class=\x22hljs-string\x22\x3e\x27NATIVE\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 交易类型，JSAPI--公众号支付、NATIVE--原生扫码支付、APP--app支付\x3c\/span\x3e\n        nonce_str = moment().format(\x3cspan class=\x22hljs-string\x22\x3e\x27YYYYMMDDHHmmssSSS\x27\x3c\/span\x3e),\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 随机字符串32位以下\x3c\/span\x3e\n        stringA = \x3cspan class=\x22hljs-string\x22\x3e`appid=\x3cspan class=\x22hljs-subst\x22\x3e${公众号id}\x3c\/span\x3e\x26amp;body=\x3cspan class=\x22hljs-subst\x22\x3e${body}\x3c\/span\x3e\x26amp;mch_id=\x3cspan class=\x22hljs-subst\x22\x3e${微信商户号}\x3c\/span\x3e\x26amp;nonce_str=\x3cspan class=\x22hljs-subst\x22\x3e${nonce_str}\x3c\/span\x3e\x26amp;notify_url=\x3cspan class=\x22hljs-subst\x22\x3e${\n        notify_url}\x3c\/span\x3e\x26amp;out_trade_no=\x3cspan class=\x22hljs-subst\x22\x3e${out_trade_no}\x3c\/span\x3e\x26amp;spbill_create_ip=\x3cspan class=\x22hljs-subst\x22\x3e${ctx.request.ip}\x3c\/span\x3e\x26amp;total_fee=\x3cspan class=\x22hljs-subst\x22\x3e${total_fee}\x3c\/span\x3e\x26amp;trade_type=\x3cspan class=\x22hljs-subst\x22\x3e${trade_type}\x3c\/span\x3e`\x3c\/span\x3e,\n        stringSignTemp = stringA \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26amp;key=xxxxxxxxxxxxxxxxx\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/\/注：key为商户平台设置的密钥key\x3c\/span\x3e\n        sign = MD5(stringSignTemp).toUpperCase();  \x3cspan class=\x22hljs-comment\x22\x3e\/\/注：MD5签名方式\x3c\/span\x3e\n    \x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e以上就是我们所需要的一些参数\x3cbr\x3e签名生成算法见\x3ca href=\x22https:\/\/pay.weixin.qq.com\/wiki\/doc\/api\/native.php?chapter=4_3\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e微信官方\x3c\/a\x3e\x3cbr\x3espbill_create_ip 是 终端ip地址\x3c\/p\x3e\n\x3cp\x3e下面把所有的参数拼接成xml\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    const formData = \x26quot;\x3cxml\x3e\x26quot;;\n        formData \x2b= \x26quot;\x3cappid\x3e\x26quot; \x2b appid \x2b \x26quot;\x3c\/appid\x3e\x26quot;; \/\/appid\n        formData \x2b= \x26quot;\x3cbody\x3e\x26quot; \x2b body \x2b \x26quot;\x3c\/body\x3e\x26quot;; \/\/商品或支付单简要描述\n        formData \x2b= \x26quot;\x3cmch_id\x3e\x26quot; \x2b mch_id \x2b \x26quot;\x3c\/mch_id\x3e\x26quot;; \/\/商户号\n        formData \x2b= \x26quot;\x3cnonce_str\x3e\x26quot; \x2b nonce_str \x2b \x26quot;\x3c\/nonce_str\x3e\x26quot;; \/\/随机字符串，不长于32位\n        formData \x2b= \x26quot;\x3cnotify_url\x3e\x26quot; \x2b notify_url \x2b \x26quot;\x3c\/notify_url\x3e\x26quot;; \/\/支付成功后微信服务器通过POST请求通知这个地址\n        formData \x2b= \x26quot;\x3cout_trade_no\x3e\x26quot; \x2b out_trade_no \x2b \x26quot;\x3c\/out_trade_no\x3e\x26quot;; \/\/订单号\n        formData \x2b= \x26quot;\x3ctotal_fee\x3e\x26quot; \x2b total_fee \x2b \x26quot;\x3c\/total_fee\x3e\x26quot;; \/\/金额\n        formData \x2b= \x26quot;\x3cspbill_create_ip\x3e\x26quot; \x2b ctx.request.ip \x2b \x26quot;\x3c\/spbill_create_ip\x3e\x26quot;; \/\/ip\n        formData \x2b= \x26quot;\x3ctrade_type\x3eNATIVE\x3c\/trade_type\x3e\x26quot;; \/\/NATIVE会返回code_url ，JSAPI不会返回\n        formData \x2b= \x26quot;\x3csign\x3e\x26quot; \x2b sign \x2b \x26quot;\x3c\/sign\x3e\x26quot;;\n        formData \x2b= \x26quot;\x3c\/xml\x3e\x26quot;;\n    \/\/ 这里使用了egg里面请求的方式\n    const resultData = yield ctx.curl(url, {\n            method: \x27POST\x27,\n            content: formData,\n            headers: {\n                \x27content-type\x27: \x27text\/html\x27,\n            },\n        });\n\n    \/\/ xml转json格式\n    xml2js.parseString(resultData.data, function (err, json) {\n        if (err) {\n            new Error(\x26quot;解析xml报错\x26quot;)\n        } else {\n            var result = formMessage(json.xml); \/\/ 转换成正常的json 数据\n            console.log(result) \/\/打印出返回的结果\n        }\n    })\n    var formMessage = function (result) {\n        var message = {};\n        if (typeof result === \x27object\x27) {\n            var keys = Object.keys(result);\n            for (var i = 0; i \x3c keys.length; i\x2b\x2b) {\n                var item = result[keys[i]];\n                var key = keys[i];\n                if (!(item instanceof Array) || item.length === 0) {\n                    continue;\n                }\n                if (item.length === 1) {\n                    var val = item[0];\n                    if (typeof val === \x27object\x27) {\n                        message[key] = formMessage(val);\n                    } else {\n                        message[key] = (val || \x27\x27).trim();\n                    }\n                } else {\n                    message[key] = [];\n                    for (var j = 0, k = item.length; j \x3c k; j\x2b\x2b) {\n                        message[key].push(formMessage(itemp[j]));\n                    }\n                }\n            }\n        }\n        return message;\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e formData = \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;xml\x26gt;\x22\x3c\/span\x3e;\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;appid\x26gt;\x22\x3c\/span\x3e \x2b appid \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/appid\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/appid\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;body\x26gt;\x22\x3c\/span\x3e \x2b body \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/body\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/商品或支付单简要描述\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;mch_id\x26gt;\x22\x3c\/span\x3e \x2b mch_id \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/mch_id\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/商户号\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;nonce_str\x26gt;\x22\x3c\/span\x3e \x2b nonce_str \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/nonce_str\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/随机字符串，不长于32位\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;notify_url\x26gt;\x22\x3c\/span\x3e \x2b notify_url \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/notify_url\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/支付成功后微信服务器通过POST请求通知这个地址\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;out_trade_no\x26gt;\x22\x3c\/span\x3e \x2b out_trade_no \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/out_trade_no\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/订单号\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;total_fee\x26gt;\x22\x3c\/span\x3e \x2b total_fee \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/total_fee\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/金额\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;spbill_create_ip\x26gt;\x22\x3c\/span\x3e \x2b ctx.request.ip \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/spbill_create_ip\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ip\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;trade_type\x26gt;NATIVE\x26lt;\/trade_type\x26gt;\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/NATIVE会返回code_url ，JSAPI不会返回\x3c\/span\x3e\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;sign\x26gt;\x22\x3c\/span\x3e \x2b sign \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/sign\x26gt;\x22\x3c\/span\x3e;\n        formData \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;\/xml\x26gt;\x22\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 这里使用了egg里面请求的方式\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e resultData = \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e ctx.curl(url, {\n            \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27POST\x27\x3c\/span\x3e,\n            \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e: formData,\n            \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e: {\n                \x3cspan class=\x22hljs-string\x22\x3e\x27content-type\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27text\/html\x27\x3c\/span\x3e,\n            },\n        });\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ xml转json格式\x3c\/span\x3e\n    xml2js.parseString(resultData.data, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerr, json\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err) {\n            \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22解析xml报错\x22\x3c\/span\x3e)\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = formMessage(json.xml); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 转换成正常的json 数据\x3c\/span\x3e\n            \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(result) \x3cspan class=\x22hljs-comment\x22\x3e\/\/打印出返回的结果\x3c\/span\x3e\n        }\n    })\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e formMessage = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e message = {};\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e result === \x3cspan class=\x22hljs-string\x22\x3e\x27object\x27\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e keys = \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(result);\n            \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; keys.length; i\x2b\x2b) {\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e item = result[keys[i]];\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e key = keys[i];\n                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!(item \x3cspan class=\x22hljs-keyword\x22\x3einstanceof\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e) || item.length === \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n                    \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e;\n                }\n                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (item.length === \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) {\n                    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e val = item[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e];\n                    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e val === \x3cspan class=\x22hljs-string\x22\x3e\x27object\x27\x3c\/span\x3e) {\n                        message[key] = formMessage(val);\n                    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                        message[key] = (val || \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e).trim();\n                    }\n                } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                    message[key] = [];\n                    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e j = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, k = item.length; j \x26lt; k; j\x2b\x2b) {\n                        message[key].push(formMessage(itemp[j]));\n                    }\n                }\n            }\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e message;\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面使用了egg的请求方式，原生node可以使用request\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    var request = require(\x27request\x27);\n    request({\n        url: url,\n        method: \x26quot;POST\x26quot;,\n        body: formData\n    }, function(error, response, body) {\n        if (!error \x26amp;\x26amp; response.statusCode == 200) {\n        }\n    }); \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e request = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27request\x27\x3c\/span\x3e);\n    request({\n        \x3cspan class=\x22hljs-attr\x22\x3eurl\x3c\/span\x3e: url,\n        \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22POST\x22\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3ebody\x3c\/span\x3e: formData\n    }, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerror, response, body\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!error \x26amp;\x26amp; response.statusCode == \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e) {\n        }\n    }); \x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果请求成功会最终返回一个xml,然后我们进行解析成json的格式,里面会有一个\x3ccode\x3ecode_url\x3c\/code\x3e和\x3ccode\x3eout_trade_no\x3c\/code\x3e,我们需要把这两个返回给前端，然后通过生成二维码展示给用户扫码，完成支付\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e监听支付是否成功\x3c\/h2\x3e\n\x3cp\x3e上面操作完成之后，我们需要知道用户是否完成支付，因为用户会停留在该页面，我们需要在用户付完款之后，通知用户支付成功。\x3cbr\x3e首先，用户发起支付的时候我们会生成二维码，让用户完成扫码支付，我们还要做的是，开一个定时器，每隔一段时间去发送一个请求，这个时候，我们node后台就需要写一个查询订单的接口，之前我们拿到了\x3ccode\x3eout_trade_no\x3c\/code\x3e，也就是我们系统内部的订单号，我们把这个数据发送给后台查询订单的接口，然后后台接收到之后会请求微信的查询接口地址\x3ccode\x3ehttps:\/\/api.mch.weixin.qq.com\/pay\/orderquery\x3c\/code\x3e,流程跟上面一样，只是接口地址和微信返回的xml不一样而已，返回的字段会有一个状态即\x3ccode\x3eSUCCESS\x3c\/code\x3e和\x3ccode\x3eNOTPAY\x3c\/code\x3e，我们可以通过判断是否支付返回给前端，成功之后提示给用户支付成功，关闭定时器。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e回调地址\x3c\/h2\x3e\n\x3cp\x3e这个是非常重要的一环，大部分的操作其实在上面就可以完成，但是有特殊的情况，比如用户电脑断网发送不了请求，但是手机付款了，这就会导致我们记录不到用户支付的信息。这个时候回调地址就很重要了\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e设置回调地址\x3c\/h3\x3e\n\x3cp\x3e微信商户中心-\x26gt;产品中心-\x26gt;开发配置-\x26gt;扫码支付\x3c\/p\x3e\n\x3cp\x3e之后我们需要做的是后端用\x3ccode\x3epost\x3c\/code\x3e来接收微信发送的异步回调信息，也是\x3ccode\x3exml\x3c\/code\x3e的格式，这里注意，如果不支持接收xml，可能会得到空的数据\x3cbr\x3e这里还需要注意的是，我们在保存用户支付信息的同时，得先查改订单是否支付，以免重复操作，可能会插入多条记录的情况\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e总结\x3c\/h2\x3e\n\x3cp\x3e微信扫码支付坑还是有的，如果你是第一次摸索的话，下面罗列一下需要注意的地方\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e签名算法要写正确，不然是不会成功的，要拼接正确才行\x3c\/li\x3e\n\x3cli\x3e微信返回的是xml格式的数据，我们得通过插件转成json，这样才方便获取数据\x3c\/li\x3e\n\x3cli\x3e返回的\x3ccode\x3ecode_url\x3c\/code\x3e要给前端生成二维码用，然后需要开一个定时器查询该订单是否完成支付，最终通知用户结果\x3c\/li\x3e\n\x3cli\x3e回调地址很重要，我们后端需要\x3ccode\x3epost\x3c\/code\x3e接收微信返回的回调信息，然后保存信息，不过在保存用户支付信息的之前，我们得知道该订单是否已经保存过，以免重复添加。还有就是返回的是xml的数据，后端一定要保证能够接收得到，按照正常的方式是接收不了的，得额外设置。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e文章地址 \x3ca href=\x22http:\/\/www.wclimb.site\/2018\/02\/14\/nodejs%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E4%B9%8B%E6%89%AB%E7%A0%81%E6%94%AF%E4%BB%98\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3enodejs微信支付之扫码支付\x3c\/a\x3e\x3cbr\x3e个人博客地址 \x3ca href=\x22http:\/\/www.wclimb.site\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/www.wclimb.site\x3c\/a\x3e\x3cbr\x3eGitHub地址 \x3ca href=\x22https:\/\/github.com\/wclimb\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ewclimb\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>nodejs微信支付之扫码支付</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000013293668">https://segmentfault.com/a/1190000013293668</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/9bd0m4mlh69/" target="_blank">https://alili.tech/archive/9bd0m4mlh69/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>