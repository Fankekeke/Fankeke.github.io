<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="寻找真凶Echarts or Angular"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>寻找真凶Echarts or Angular | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/9oqkxji3c8/",
				"appid": "1613049289050283", 
				"title": "寻找真凶Echarts or Angular | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-25T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/digrum9c228/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/183dc9kj3x3/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f&text=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f&text=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f&title=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f&is_video=false&description=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f&title=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f&title=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f&title=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9oqkxji3c8%2f&title=%e5%af%bb%e6%89%be%e7%9c%9f%e5%87%b6Echarts%20or%20Angular"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">寻找真凶Echarts or Angular</h1><div class="meta"><div class="postdate"><time datetime="2018-12-25" itemprop="datePublished">2018-12-25</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch1 id=\x22articleHeader0\x22\x3e寻找真凶Echarts or Angular\x3c\/h1\x3e\n\x3cp\x3e这是一篇故事，就如同技术，我们所追求的不是一个结局，而是那些深受启发与共鸣的过程，那是我们成长的经验与生产力的积淀！\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e故事开始于“疯了”的ionic3应用\x3c\/h3\x3e\n\x3cp\x3e页面打开，什么也没做5s里angular的代码似乎一直在跑！\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYJkn?w=1587\x26amp;h=102\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYJkn?w=1587\x26amp;h=102\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e打开chrome性能调试工具，recorded 5秒，密密麻麻的调用栈，惨不忍睹！\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYJjr?w=1533\x26amp;h=689\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYJjr?w=1533\x26amp;h=689\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e\x3cem\x3eQustion1：难道真凶是angular脏检查，发生了循环脏检查？？要弄清这个问题前，我们先来介绍angular脏检查这个大人物。\x3c\/em\x3e\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e\x3cstrong\x3eRope1：angular2及以上版本脏检查方式\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3e新一代的angular一改angularjs（ng1）中受人唾弃的脏检查策略。\x3c\/p\x3e\n\x3ch4\x3e数据流的改变\x3c\/h4\x3e\n\x3cp\x3e\x3cstrong\x3eangularjs的策略：\x3c\/strong\x3e：是again and again直到稳定。也就是说在异步事件触发脏检查后，脏检查发生过程中某一个scope值改变后，会再次触发一次脏检查直到scope上数据稳定不变。这样一个过程很难找到一次脏检查是哪一次、哪一个对象发生改变导致的dom更新。    \x3cbr\x3e\x3cstrong\x3eangular的策略：\x3c\/strong\x3e：从组件树顶至下，各组件依次做自己的脏检查。如下图，左边是model右边是dom树也是组件树，每一次model数据的改变，触发一次脏检查，每次检查从跟节点开始单向向下，在这次检查时间片段中不会允许对model做修改，model数据处于稳定状态。\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVCLYD?w=554\x26amp;h=356\x22 src=\x22https:\/\/static.alili.tech\/img\/bVCLYD?w=554\x26amp;h=356\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch4\x3e谁告诉angular做脏检查的改变\x3c\/h4\x3e\n\x3cp\x3e\x3cstrong\x3eangularjs的方式：\x3c\/strong\x3e 注入ng事件来通知脏检查，例如，你不能在js原生的setTimeout里改变model值，必须注入ng事件$setTimeout。\x3cbr\x3e\x3cstrong\x3eangularjs的方式：\x3c\/strong\x3e zone.js （它也是个big man，想了解它可以看我的一篇NgZone.js文章\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000006820819\x22\x3ehttps:\/\/segmentfault.com\/a\/11...\x3c\/a\x3e）。什么都不用做，原生随意写，自然有家伙帮你通知angular去做脏检查。     \x3cbr\x3e\x3cstrong\x3e\x3cem\x3eanswer1：从以上线索可以断定，不是angular发生了循环脏检查\x3c\/em\x3e\x3c\/strong\x3e     \x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e\x3cem\x3eQustion2：是不是从组件树顶向下逐一组件进行脏检查，会不会是组件树太庞大log了太多checked，执行了太多次单个组件脏检查？\x3c\/em\x3e\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e\x3cstrong\x3eRope2： angular脏检查策略\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYQWi?w=886\x26amp;h=423\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYQWi?w=886\x26amp;h=423\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e先来看看现场，上面的图中圈出了一段代码changeDetection: ChangeDetectionStrategy.OnPush,它是做什么的呢？它可以改变脏检查的策略。上面提到一颗组件树中某一个节点某个event触发了脏检查，整棵组件树每一个节点都会跟着做脏检查对吧？对的，默认的策略是这样的。但angular可以更聪明点，使用OnPush策略。这个策略会让该个组件在input对象引用指针没发生变化时跳过该节点及该节点子节点脏检查（注意：是对象引用指针的变化）。\x3cbr\x3eexample 1：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22@Component({\n  selector: \x27echart\x27,\n  template: `\x3cdiv class=\x26quot;charts\x26quot; #root\x3e\x3c\/div\x3e`,\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class ChartComponent {\n  @Input(\x27option\x27) option: any;\n  constructor() {\n  }\n\n  ngOnInit(): void {\n    window.addEventListener(\x27resize\x27, this.resize, true);\n  }\n\n  click():void{\n     this.option= {\n     title:\x27hi\x27\n     }\n  }   \n\n  resize() {\n    this.option.title = \x27Hi\x27\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e@Component({\n  \x3cspan class=\x22hljs-attr\x22\x3eselector\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27echart\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3etemplate\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`\x26lt;div class=\x22charts\x22 #root\x26gt;\x26lt;\/div\x26gt;`\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3echangeDetection\x3c\/span\x3e: ChangeDetectionStrategy.OnPush\n})\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eChartComponent\x3c\/span\x3e \x3c\/span\x3e{\n  @Input(\x3cspan class=\x22hljs-string\x22\x3e\x27option\x27\x3c\/span\x3e) option: any;\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e() {\n  }\n\n  ngOnInit(): \x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27resize\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.resize, \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e);\n  }\n\n  click():\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e{\n     \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.option= {\n     \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x27hi\x27\x3c\/span\x3e\n     }\n  }   \n\n  resize() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.option.title = \x3cspan class=\x22hljs-string\x22\x3e\x27Hi\x27\x3c\/span\x3e\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个例子中，当页面窗口发生变化是resize中修改title，，dom不会有任何更新。如下图：   \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYQZP?w=825\x26amp;h=591\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYQZP?w=825\x26amp;h=591\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e而当click方法触发时，该组件会进行脏检查并更新dom。  \x3c\/p\x3e\n\x3cp\x3e如果使用了OnPush策略，又想让resize中的修改能能更新dom怎么办？代码如下\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22constructor(private ref: ChangeDetectorRef) {}\n  resize() {\n    this.option.title = \x27Hi\x27\n    this.ref.markForCheck();\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(private ref: ChangeDetectorRef) {}\n  resize() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.option.title = \x3cspan class=\x22hljs-string\x22\x3e\x27Hi\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ref.markForCheck();\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e依然是从上到下，angular会找到包含该组件的路径的所有component进行逐一脏检查（即使顶层组件设置了onPush策略）如下图：    \x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYQUQ?w=925\x26amp;h=637\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYQUQ?w=925\x26amp;h=637\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e\x3cem\x3eanswer2：很显然组件树庞大不会引起脏检查多，因为我们已经加了onPush策略,input也未改变，该组件及该组件向下的组件都不应该发生脏检查\x3c\/em\x3e\x3c\/strong\x3e   \x3cbr\x3e虽然加了onPush策略但页面上依然有很多不该运行的代码一直在执行，下图为页面稳定静止状态下记录5s内的浏览器执行情况，左图为未加onPush策略的记录，右图为已加onPush策略的记录，可以看见已加onPush策略的依然有script,render,Painting在执行。     \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYQ6M?w=377\x26amp;h=137\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYQ6M?w=377\x26amp;h=137\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYRiZ?w=418\x26amp;h=178\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYRiZ?w=418\x26amp;h=178\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e我们再来看一下调用栈，如下图：   \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYRmd?w=654\x26amp;h=595\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYRmd?w=654\x26amp;h=595\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e从图中我们发现了一个调用栈NgZone的代码执行过，还记得Rope1里提到NgZone吗？发起脏检查的通知者，它代理了原生事件，任何一个原生异步事件的触发都会导致NgZone的运行。那么一定是有原生事件在一直Loop执行！     \x3c\/p\x3e\n\x3cp\x3e【注：细心的人可能还发现图里有一些同学会发现有angular.core的代码在执行，不是在answer2中已经说了不会脏检查了吗？确实不会在做脏检查，rope2中也说明过脏检查策略的原理，别忘了再脏检查前还会check组件input引用来决定是否该组件做脏检查呢】     \x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e\x3cem\x3eQustion3：谁在调戏NgZone？\x3c\/em\x3e\x3c\/strong\x3e    \x3cbr\x3e我们再继续看下性能分析里的调用栈，只要该函数进入过\x22犯罪现场\x22我们都能找到它的足迹。Look this！我们找到了一个animation.js执行的step函数。     \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYRtb?w=391\x26amp;h=509\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYRtb?w=391\x26amp;h=509\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3elook this！果然有一个requestAnimationFrame定时器（）原生事件一直在执行，且从未销毁！   \x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYRtt?w=724\x26amp;h=299\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYRtt?w=724\x26amp;h=299\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e\x3cem\x3eanswer3：原来流氓是echarts的animation.js或者说是echarts核心组件zrender在动画结束后没调用animation中的stop方法，总之真凶是echarts！（如果你正在使用echarts，可以打开调试工具，可以看到那段代码一直在loop执行） \x3c\/em\x3e\x3c\/strong\x3e  \x3c\/p\x3e\n\x3cp\x3e凶手找到了，受害者还需要安抚解决，如何解决？弃用echarts？你要知道有一种流氓叫让你讨厌又让你干不掉，不得不承认echarts的绘制效率在移动端还是不错的，还有地图，用其它chart plugin谁来给你画某某市地图...    \x3cbr\x3e此时不得不再捧一把Angular，虽然我们管不了echarts，但NgZone是一个很开放的家伙。给我们很多自由操作的空间，就像下面的sample，使用runOutsideAngular将包裹的函数内部执行的代码都跳过zone.js的包装。那个echarts的requestAnimationFrame再也不会骚扰咱们的NgZone了。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22export class EChartsComponent implements OnInit, OnDestroy {\n  @Input() chartid: string;\n  @Input(\x27option\x27) option: any;\n  private chart: any;\n\n  @ViewChild(\x27root\x27)\n  private root;\n  constructor(private ngZone: NgZone) {\n  }\n  resizeListener = () =\x3e this.resize();\n\n  ngOnInit(): void {\n    this.ngZone.runOutsideAngular(() =\x3e {\n      this.chart = echarts.init(this.root.nativeElement);\n      this.chart.setOption(this.option, true);\n      window.addEventListener(\x27resize\x27, this.resizeListener, true);\n    })\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eEChartsComponent\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eimplements\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eOnInit\x3c\/span\x3e, \x3cspan class=\x22hljs-title\x22\x3eOnDestroy\x3c\/span\x3e \x3c\/span\x3e{\n  @Input() chartid: string;\n  @Input(\x3cspan class=\x22hljs-string\x22\x3e\x27option\x27\x3c\/span\x3e) option: any;\n  private chart: any;\n\n  @ViewChild(\x3cspan class=\x22hljs-string\x22\x3e\x27root\x27\x3c\/span\x3e)\n  private root;\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(private ngZone: NgZone) {\n  }\n  resizeListener = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.resize();\n\n  ngOnInit(): \x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ngZone.runOutsideAngular(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.chart = echarts.init(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.root.nativeElement);\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.chart.setOption(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.option, \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e);\n      \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27resize\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.resizeListener, \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e);\n    })\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e优化后5s内perfermance如图：    \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYRNM?w=407\x26amp;h=161\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYRNM?w=407\x26amp;h=161\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e故事的结局\x3c\/h3\x3e\n\x3cp\x3e虽然优化的结果不是最完美的，从图上可以看到页面稳定静止状态下还是有script（echarts的bad code）在执行。如何去解决echarts的loop requestAnimationFrame问题，后续提issue留给echarts团队去解决吧。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>寻找真凶Echarts or Angular</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000012084251">https://segmentfault.com/a/1190000012084251</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/9oqkxji3c8/" target="_blank">https://alili.tech/archive/9oqkxji3c8/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>