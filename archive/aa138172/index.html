<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="无密码验证：客户端"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>无密码验证：客户端 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/aa138172/",
				"appid": "1613049289050283", 
				"title": "无密码验证：客户端 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-10-21T00:00:00"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/242eb708/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/7e3006e1/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2faa138172%2f&text=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2faa138172%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2faa138172%2f&text=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2faa138172%2f&title=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2faa138172%2f&is_video=false&description=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2faa138172%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2faa138172%2f&title=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2faa138172%2f&title=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2faa138172%2f&title=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2faa138172%2f&title=%e6%97%a0%e5%af%86%e7%a0%81%e9%aa%8c%e8%af%81%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">无密码验证：客户端</h1><div class="meta"><div class="postdate"><time datetime="2018-10-21" itemprop="datePublished">2018-10-21</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3ch1\x3e\x3ca href=\x22#无密码验证客户端\x22\x3e\x3c\/a\x3e无密码验证：客户端\x3c\/h1\x3e\n\x3cp\x3e我们继续 \x3ca href=\x22https:\/\/linux.cn\/article-9748-1.html\x22\x3e无密码验证\x3c\/a\x3e 的文章。上一篇文章中，我们用 Go 写了一个 HTTP 服务，用这个服务来做无密码验证 API。今天，我们为它再写一个 JavaScript 客户端。\x3c\/p\x3e\n\x3cp\x3e我们将使用 \x3ca href=\x22https:\/\/linux.cn\/article-9815-1.html\x22\x3e这里的\x3c\/a\x3e 这个单页面应用程序（SPA）来展示使用的技术。如果你还没有读过它，请先读它。\x3c\/p\x3e\n\x3cp\x3e记住流程：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e用户输入其 email。\x3c\/li\x3e\n\x3cli\x3e用户收到一个带有魔法链接的邮件。\x3c\/li\x3e\n\x3cli\x3e用户点击该链接、\x3c\/li\x3e\n\x3cli\x3e用户验证成功。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e对于根 URL（\x3ccode\x3e\/\x3c\/code\x3e），我们将根据验证的状态分别使用两个不同的页面：一个是带有访问表单的页面，或者是已验证通过的用户的欢迎页面。另一个页面是验证回调的重定向页面。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#伺服\x22\x3e\x3c\/a\x3e伺服\x3c\/h3\x3e\n\x3cp\x3e我们将使用相同的 Go 服务器来为客户端提供服务，因此，在我们前面的 \x3ccode\x3emain.go\x3c\/code\x3e 中添加一些路由：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs accesslog\x22\x3erouter.Handle(\x3cspan class=\x22hljs-string\x22\x3e\x22\x3cspan class=\x22hljs-keyword\x22\x3eGET\x3c\/span\x3e\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22\/...\x22\x3c\/span\x3e, http.FileServer(SPAFileSystem{http.Dir(\x3cspan class=\x22hljs-string\x22\x3e\x22static\x22\x3c\/span\x3e)}))\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cpre\x3e\x3ccode class=\x22hljs go\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e SPAFileSystem \x3cspan class=\x22hljs-keyword\x22\x3estruct\x3c\/span\x3e {\n    fs http.FileSystem\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunc\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(spa SPAFileSystem)\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eOpen\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(name \x3cspan class=\x22hljs-keyword\x22\x3estring\x3c\/span\x3e)\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(http.File, error)\x3c\/span\x3e\x3c\/span\x3e {\n    f, err := spa.fs.Open(name)\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e err != \x3cspan class=\x22hljs-literal\x22\x3enil\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e spa.fs.Open(\x3cspan class=\x22hljs-string\x22\x3e\x22index.html\x22\x3c\/span\x3e)\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e f, \x3cspan class=\x22hljs-literal\x22\x3enil\x3c\/span\x3e\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这个伺服文件放在 \x3ccode\x3estatic\x3c\/code\x3e 下，配合 \x3ccode\x3estatic\/index.html\x3c\/code\x3e 作为回调。\x3c\/p\x3e\n\x3cp\x3e你可以使用你自己的服务器，但是你得在服务器上启用 \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/HTTP\/CORS\x22\x3eCORS\x3c\/a\x3e。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#html\x22\x3e\x3c\/a\x3eHTML\x3c\/h3\x3e\n\x3cp\x3e我们来看一下那个 \x3ccode\x3estatic\/index.html\x3c\/code\x3e 文件。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs xml\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e\x26lt;!DOCTYPE html\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ehtml\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3elang\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22en\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ehead\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3emeta\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3echarset\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22utf-8\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3emeta\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22viewport\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22width=device-width, initial-scale=1.0\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3etitle\x3c\/span\x3e\x26gt;\x3c\/span\x3ePasswordless Demo\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3etitle\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3elink\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3erel\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22shortcut icon\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ehref\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22data:,\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3esrc\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22\/js\/main.js\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22module\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22undefined\x22\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ehead\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebody\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ebody\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ehtml\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e单页面应用程序的所有渲染由 JavaScript 来完成，因此，我们使用了一个空的 body 部分和一个 \x3ccode\x3emain.js\x3c\/code\x3e 文件。\x3c\/p\x3e\n\x3cp\x3e我们将使用 \x3ca href=\x22https:\/\/linux.cn\/article-9815-1.html\x22\x3e上篇文章\x3c\/a\x3e 中的 Router。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#渲染\x22\x3e\x3c\/a\x3e渲染\x3c\/h3\x3e\n\x3cp\x3e现在，我们使用下面的内容来创建一个 \x3ccode\x3estatic\/js\/main.js\x3c\/code\x3e 文件：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Router \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27https:\/\/unpkg.com\/@nicolasparada\/router\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { isAuthenticated } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/auth.js\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e router = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Router()\n\nrouter.handle(\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e, guard(view(\x3cspan class=\x22hljs-string\x22\x3e\x27home\x27\x3c\/span\x3e)))\nrouter.handle(\x3cspan class=\x22hljs-string\x22\x3e\x27\/callback\x27\x3c\/span\x3e, view(\x3cspan class=\x22hljs-string\x22\x3e\x27callback\x27\x3c\/span\x3e))\nrouter.handle(\x3cspan class=\x22hljs-regexp\x22\x3e\/^\\\/\/\x3c\/span\x3e, view(\x3cspan class=\x22hljs-string\x22\x3e\x27not-found\x27\x3c\/span\x3e))\n\nrouter.install(\x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e resultPromise =\x26gt; {\n    \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.body.innerHTML = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.body.appendChild(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e resultPromise)\n})\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eview\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ename\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3e...args\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e`\/js\/pages\/\x3cspan class=\x22hljs-subst\x22\x3e${name}\x3c\/span\x3e-page.js`\x3c\/span\x3e)\n        .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3em\x3c\/span\x3e =\x26gt;\x3c\/span\x3e m.default(...args))\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eguard\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efn1, fn2 = view(\x3cspan class=\x22hljs-string\x22\x3e\x27welcome\x27\x3c\/span\x3e\x3c\/span\x3e)) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3e...args\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e isAuthenticated()\n        ? fn1(...args)\n        : fn2(...args)\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e与上篇文章不同的是，我们实现了一个 \x3ccode\x3eisAuthenticated()\x3c\/code\x3e 函数和一个 \x3ccode\x3eguard()\x3c\/code\x3e 函数，使用它去渲染两种验证状态的页面。因此，当用户访问 \x3ccode\x3e\/\x3c\/code\x3e 时，它将根据用户是否通过了验证来展示主页或者是欢迎页面。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#验证\x22\x3e\x3c\/a\x3e验证\x3c\/h3\x3e\n\x3cp\x3e现在，我们来编写 \x3ccode\x3eisAuthenticated()\x3c\/code\x3e 函数。使用下面的内容来创建一个 \x3ccode\x3estatic\/js\/auth.js\x3c\/code\x3e 文件：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetAuthUser\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e authUserItem = localStorage.getItem(\x3cspan class=\x22hljs-string\x22\x3e\x27auth_user\x27\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e expiresAtItem = localStorage.getItem(\x3cspan class=\x22hljs-string\x22\x3e\x27expires_at\x27\x3c\/span\x3e)\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (authUserItem !== \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \x26amp;\x26amp; expiresAtItem !== \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e expiresAt = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e(expiresAtItem)\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-built_in\x22\x3eisNaN\x3c\/span\x3e(expiresAt.valueOf()) \x26amp;\x26amp; expiresAt \x26gt; \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e()) {\n            \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n                \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.parse(authUserItem)\n            } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (_) { }\n        }\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eisAuthenticated\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e localStorage.getItem(\x3cspan class=\x22hljs-string\x22\x3e\x27jwt\x27\x3c\/span\x3e) !== \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \x26amp;\x26amp; getAuthUser() !== \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e当有人登入时，我们将保存 JSON 格式的 web 令牌、它的过期日期，以及在 \x3ccode\x3elocalStorage\x3c\/code\x3e 上的当前已验证用户。这个模块就是这个用处。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ccode\x3egetAuthUser()\x3c\/code\x3e 用于从 \x3ccode\x3elocalStorage\x3c\/code\x3e 获取已认证的用户，以确认 JSON 格式的 Web 令牌没有过期。\x3c\/li\x3e\n\x3cli\x3e\x3ccode\x3eisAuthenticated()\x3c\/code\x3e 在前面的函数中用于去检查它是否没有返回 \x3ccode\x3enull\x3c\/code\x3e。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3\x3e\x3ca href=\x22#获取\x22\x3e\x3c\/a\x3e获取\x3c\/h3\x3e\n\x3cp\x3e在继续这个页面之前，我将写一些与服务器 API 一起使用的 HTTP 工具。\x3c\/p\x3e\n\x3cp\x3e我们使用以下的内容去创建一个 \x3ccode\x3estatic\/js\/http.js\x3c\/code\x3e 文件：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { isAuthenticated } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/auth.js\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eget\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eurl, headers\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e fetch(url, {\n        \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign(getAuthHeader(), headers),\n    }).then(handleResponse)\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3epost\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eurl, body, headers\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e fetch(url, {\n        \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27POST\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign(getAuthHeader(), { \x3cspan class=\x22hljs-string\x22\x3e\x27content-type\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27application\/json\x27\x3c\/span\x3e }, headers),\n        \x3cspan class=\x22hljs-attr\x22\x3ebody\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(body),\n    }).then(handleResponse)\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetAuthHeader\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e isAuthenticated()\n        ? { \x3cspan class=\x22hljs-attr\x22\x3eauthorization\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`Bearer \x3cspan class=\x22hljs-subst\x22\x3e${localStorage.getItem(\x3cspan class=\x22hljs-string\x22\x3e\x27jwt\x27\x3c\/span\x3e)}\x3c\/span\x3e`\x3c\/span\x3e }\n        : {}\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ehandleResponse\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e body = \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e res.clone().json().catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res.text())\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e response = {\n        \x3cspan class=\x22hljs-attr\x22\x3estatusCode\x3c\/span\x3e: res.status,\n        \x3cspan class=\x22hljs-attr\x22\x3estatusText\x3c\/span\x3e: res.statusText,\n        \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e: res.headers,\n        body,\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!res.ok) {\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e message = \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e body === \x3cspan class=\x22hljs-string\x22\x3e\x27object\x27\x3c\/span\x3e \x26amp;\x26amp; body !== \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \x26amp;\x26amp; \x3cspan class=\x22hljs-string\x22\x3e\x27message\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e body\n            ? body.message\n            : \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e body === \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e \x26amp;\x26amp; body !== \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e\n                ? body\n                : res.statusText\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e err = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(message)\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign(err, response)\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e response\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e {\n    get,\n    post,\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这个模块导出了 \x3ccode\x3eget()\x3c\/code\x3e 和 \x3ccode\x3epost()\x3c\/code\x3e 函数。它们是 \x3ccode\x3efetch\x3c\/code\x3e API 的封装。当用户是已验证的，这二个函数注入一个 \x3ccode\x3eAuthorization: Bearer \x26lt;token_here\x26gt;\x3c\/code\x3e 头到请求中；这样服务器就能对我们进行身份验证。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#欢迎页\x22\x3e\x3c\/a\x3e欢迎页\x3c\/h3\x3e\n\x3cp\x3e我们现在来到欢迎页面。用如下的内容创建一个 \x3ccode\x3estatic\/js\/pages\/welcome-page.js\x3c\/code\x3e 文件：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs coffeescript\x22\x3econst template = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x27template\x27\x3c\/span\x3e)\ntemplate.innerHTML = `\x3cspan class=\x22javascript\x22\x3e\n    \x26lt;h1\x26gt;Passwordless Demo\x26lt;\x3cspan class=\x22hljs-regexp\x22\x3e\/h1\x26gt;\n    \x26lt;h2\x26gt;Access\x26lt;\/\x3c\/span\x3eh2\x26gt;\n    \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eform\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eid\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22access-form\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3einput\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22email\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eplaceholder\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22Email\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eautofocus\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3erequired\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebutton\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22submit\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3eSend Magic Link\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ebutton\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eform\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3c\/span\x3e\x3c\/span\x3e`\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e function welcomePage() {\n    const page = template.content.cloneNode(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e)\n\n    page.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27access-form\x27\x3c\/span\x3e)\n        .addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27submit\x27\x3c\/span\x3e, onAccessFormSubmit)\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e page\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这个页面使用一个 \x3ccode\x3eHTMLTemplateElement\x3c\/code\x3e 作为视图。这只是一个输入用户 email 的简单表单。\x3c\/p\x3e\n\x3cp\x3e为了避免干扰，我将跳过错误处理部分，只是将它们输出到控制台上。\x3c\/p\x3e\n\x3cp\x3e现在，我们来写 \x3ccode\x3eonAccessFormSubmit()\x3c\/code\x3e 函数。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e http \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27..\/http.js\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonAccessFormSubmit\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eev\x3c\/span\x3e) \x3c\/span\x3e{\n    ev.preventDefault()\n\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e form = ev.currentTarget\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e input = form.querySelector(\x3cspan class=\x22hljs-string\x22\x3e\x27input\x27\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e email = input.value\n\n    sendMagicLink(email).catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(err)\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err.statusCode === \x3cspan class=\x22hljs-number\x22\x3e404\x3c\/span\x3e \x26amp;\x26amp; wantToCreateAccount()) {\n            runCreateUserProgram(email)\n        }\n    })\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esendMagicLink\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eemail\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e http.post(\x3cspan class=\x22hljs-string\x22\x3e\x27\/api\/passwordless\/start\x27\x3c\/span\x3e, {\n        email,\n        \x3cspan class=\x22hljs-attr\x22\x3eredirectUri\x3c\/span\x3e: location.origin \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\/callback\x27\x3c\/span\x3e,\n    }).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        alert(\x3cspan class=\x22hljs-string\x22\x3e\x27Magic link sent. Go check your email inbox.\x27\x3c\/span\x3e)\n    })\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ewantToCreateAccount\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e prompt(\x3cspan class=\x22hljs-string\x22\x3e\x27No user found. Do you want to create an account?\x27\x3c\/span\x3e)\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e它对 \x3ccode\x3e\/api\/passwordless\/start\x3c\/code\x3e 发起了 POST 请求，请求体中包含 \x3ccode\x3eemail\x3c\/code\x3e 和 \x3ccode\x3eredirectUri\x3c\/code\x3e。在本例中它返回 \x3ccode\x3e404 Not Found\x3c\/code\x3e 状态码时，我们将创建一个用户。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3erunCreateUserProgram\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eemail\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e username = prompt(\x3cspan class=\x22hljs-string\x22\x3e\x22Enter username\x22\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (username === \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e\n\n    http.post(\x3cspan class=\x22hljs-string\x22\x3e\x27\/api\/users\x27\x3c\/span\x3e, { email, username })\n        .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res.body)\n        .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3euser\x3c\/span\x3e =\x26gt;\x3c\/span\x3e sendMagicLink(user.email))\n        .catch(\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error)\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这个用户创建程序，首先询问用户名，然后使用 email 和用户名做一个 \x3ccode\x3ePOST\x3c\/code\x3e 请求到 \x3ccode\x3e\/api\/users\x3c\/code\x3e。成功之后，给创建的用户发送一个魔法链接。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#回调页\x22\x3e\x3c\/a\x3e回调页\x3c\/h3\x3e\n\x3cp\x3e这是访问表单的全部功能，现在我们来做回调页面。使用如下的内容来创建一个 \x3ccode\x3estatic\/js\/pages\/callback-page.js\x3c\/code\x3e 文件：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e http \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27..\/http.js\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e template = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x27template\x27\x3c\/span\x3e)\ntemplate.innerHTML = \x3cspan class=\x22hljs-string\x22\x3e`\n    \x26lt;h1\x26gt;Authenticating you\x26lt;\/h1\x26gt;\n`\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecallbackPage\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e page = template.content.cloneNode(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e)\n\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e hash = location.hash.substr(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fragment = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e URLSearchParams(hash)\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e [k, v] \x3cspan class=\x22hljs-keyword\x22\x3eof\x3c\/span\x3e fragment.entries()) {\n        fragment.set(\x3cspan class=\x22hljs-built_in\x22\x3edecodeURIComponent\x3c\/span\x3e(k), \x3cspan class=\x22hljs-built_in\x22\x3edecodeURIComponent\x3c\/span\x3e(v))\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e jwt = fragment.get(\x3cspan class=\x22hljs-string\x22\x3e\x27jwt\x27\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e expiresAt = fragment.get(\x3cspan class=\x22hljs-string\x22\x3e\x27expires_at\x27\x3c\/span\x3e)\n\n    http.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/api\/auth_user\x27\x3c\/span\x3e, { \x3cspan class=\x22hljs-attr\x22\x3eauthorization\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`Bearer \x3cspan class=\x22hljs-subst\x22\x3e${jwt}\x3c\/span\x3e`\x3c\/span\x3e })\n        .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res.body)\n        .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eauthUser\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n            localStorage.setItem(\x3cspan class=\x22hljs-string\x22\x3e\x27jwt\x27\x3c\/span\x3e, jwt)\n            localStorage.setItem(\x3cspan class=\x22hljs-string\x22\x3e\x27auth_user\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(authUser))\n            localStorage.setItem(\x3cspan class=\x22hljs-string\x22\x3e\x27expires_at\x27\x3c\/span\x3e, expiresAt)\n\n            location.replace(\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e)\n        })\n        .catch(\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error)\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e page\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e请记住……当点击魔法链接时，我们会来到 \x3ccode\x3e\/api\/passwordless\/verify_redirect\x3c\/code\x3e，它将把我们重定向到重定向 URI，我们将放在哈希中的 JWT 和过期日期传递给 \x3ccode\x3e\/callback\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e回调页面解码 URL 中的哈希，提取这些参数去做一个 \x3ccode\x3eGET\x3c\/code\x3e 请求到 \x3ccode\x3e\/api\/auth_user\x3c\/code\x3e，用 JWT 保存所有数据到 \x3ccode\x3elocalStorage\x3c\/code\x3e 中。最后，重定向到主页面。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#主页\x22\x3e\x3c\/a\x3e主页\x3c\/h3\x3e\n\x3cp\x3e创建如下内容的 \x3ccode\x3estatic\/pages\/home-page.js\x3c\/code\x3e 文件：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { getAuthUser } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27..\/auth.js\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ehomePage\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e authUser = getAuthUser()\n\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e template = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x27template\x27\x3c\/span\x3e)\n    template.innerHTML = \x3cspan class=\x22hljs-string\x22\x3e`\n        \x26lt;h1\x26gt;Passwordless Demo\x26lt;\/h1\x26gt;\n        \x26lt;p\x26gt;Welcome back, \x3cspan class=\x22hljs-subst\x22\x3e${authUser.username}\x3c\/span\x3e 👋\x26lt;\/p\x26gt;\n        \x26lt;button id=\x22logout-button\x22\x26gt;Logout\x26lt;\/button\x26gt;\n    `\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e page = template.content\n\n    page.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27logout-button\x27\x3c\/span\x3e)\n        .addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, logout)\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e page\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3elogout\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    localStorage.clear()\n    location.reload()\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这个页面用于欢迎已验证用户，同时也有一个登出按钮。\x3ccode\x3elogout()\x3c\/code\x3e 函数的功能只是清理掉 \x3ccode\x3elocalStorage\x3c\/code\x3e 并重载这个页面。\x3c\/p\x3e\n\x3cp\x3e这就是全部内容了。我猜你在此之前已经看过这个 \x3ca href=\x22https:\/\/go-passwordless-demo.herokuapp.com\/\x22\x3edemo\x3c\/a\x3e 了。当然，这些源代码也在同一个 \x3ca href=\x22https:\/\/github.com\/nicolasparada\/go-passwordless-demo\x22\x3e仓库\x3c\/a\x3e 中。\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3evia: \x3ca href=\x22https:\/\/nicolasparada.netlify.com\/posts\/passwordless-auth-client\/\x22\x3ehttps:\/\/nicolasparada.netlify.com\/posts\/passwordless-auth-client\/\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e作者：\x3ca href=\x22https:\/\/nicolasparada.netlify.com\/\x22\x3eNicolás Parada\x3c\/a\x3e 选题：\x3ca href=\x22https:\/\/github.com\/lujun9972\x22\x3elujun9972\x3c\/a\x3e 译者：\x3ca href=\x22https:\/\/github.com\/qhwdw\x22\x3eqhwdw\x3c\/a\x3e 校对：\x3ca href=\x22https:\/\/github.com\/wxy\x22\x3ewxy\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e本文由 \x3ca href=\x22https:\/\/github.com\/LCTT\/TranslateProject\x22\x3eLCTT\x3c\/a\x3e 原创编译，\x3ca href=\x22https:\/\/linux.cn\/\x22\x3eLinux中国\x3c\/a\x3e 荣誉推出\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>原文链接: <a href="https://www.zcfy.cc/article/passwordless-auth-client">https://www.zcfy.cc/article/passwordless-auth-client</a> 原文标题: 无密码验证：客户端 本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2>本文链接：</h2><a href="https://alili.tech/archive/aa138172/" target="_blank">https://alili.tech/archive/aa138172/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>