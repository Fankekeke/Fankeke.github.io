<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="在 Node.js 中使用 Promise.prototype.finally"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>在 Node.js 中使用 Promise.prototype.finally | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/c8c91cd5/",
				"appid": "1613049289050283", 
				"title": "在 Node.js 中使用 Promise.prototype.finally | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-10-18T00:00:00"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/1d8683d3/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/3afe893/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f&text=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f&text=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f&title=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f&is_video=false&description=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f&title=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f&title=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f&title=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fc8c91cd5%2f&title=%e5%9c%a8%20Node.js%20%e4%b8%ad%e4%bd%bf%e7%94%a8%20Promise.prototype.finally"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">在 Node.js 中使用 Promise.prototype.finally</h1><div class="meta"><div class="postdate"><time datetime="2018-10-18" itemprop="datePublished">2018-10-18</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3cp\x3e\x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/JavaScript\/Reference\/Global_Objects\/Promise\/finally\x22\x3ePromise.prototype.finally()\x3c\/a\x3e  最近达到了 TC39 提案的 \x3ca href=\x22https:\/\/github.com\/tc39\/proposals\/blob\/master\/finished-proposals.md\x22\x3e第 4 阶段\x3c\/a\x3e 。这意味着 \x3ccode\x3ePromise.prototype.finally()\x3c\/code\x3e 提案被采纳成为 \x3ca href=\x22https:\/\/tc39.github.io\/ecma262\/#sec-promise.prototype.finally\x22\x3eECMAScript 最新特性草案\x3c\/a\x3e 的一部分，登陆 Node.js 现在只是时间问题了。这篇文章会向大家展示 \x3ccode\x3ePromise.prototype.finally()\x3c\/code\x3e 的用法和简化版 Polyfill 的写法。\x3c\/p\x3e\n\x3cp\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t01fc30e562a31d7177.png\x22 alt=\x22\x22\x3e\x3c\/p\x3e\n\x3ch2\x3ePromise.prototype.finally() 是什么？\x3c\/h2\x3e\n\x3cp\x3e假设你创建了一个新的 \x3ccode\x3ePromise\x3c\/code\x3e：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs lisp\x22\x3econst promiseThatFulfills = new Promise((\x3cspan class=\x22hljs-name\x22\x3eresolve\x3c\/span\x3e) =\x26gt; {\n  \/\/ 调用 resolve() 可以让 Promised 的状态变为 fulfilled。\x3cspan class=\x22hljs-string\x22\x3e\x22fulfilled\x22\x3c\/span\x3e 和 \x3cspan class=\x22hljs-string\x22\x3e\x22resolved\x22\x3c\/span\x3e 是不同的概念：\n  \/\/ 如果你 resolve() 一个非 Promise 值，Promise 会变成 \x3cspan class=\x22hljs-string\x22\x3e\x22fulfilled\x22\x3c\/span\x3e。\n  \/\/ 然而, 如果 resolve() 一个 Promise，外层（原来的） Promise 会保持 \x3cspan class=\x22hljs-string\x22\x3e\x22pending\x22\x3c\/span\x3e 状态\n  \/\/ 直到内层 Promise 变为 \x3cspan class=\x22hljs-string\x22\x3e\x22fulfilled\x22\x3c\/span\x3e 或者 \x3cspan class=\x22hljs-string\x22\x3e\x22rejected\x22\x3c\/span\x3e\n  setTimeout(() =\x26gt; resolve(\x27Hello, World\x27), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n})\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n\nconst promiseThatRejects = new Promise((\x3cspan class=\x22hljs-name\x22\x3eresolve\x3c\/span\x3e, reject) =\x26gt; {\n  setTimeout(() =\x26gt; reject(\x3cspan class=\x22hljs-name\x22\x3enew\x3c\/span\x3e Error(\x27whoops!\x27)), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n})\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e你可以用 \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/JavaScript\/Reference\/Global_Objects\/Promise\/then\x22\x3e\x3ccode\x3e.then()\x3c\/code\x3e 函数\x3c\/a\x3e把这些 \x3ccode\x3ePromise\x3c\/code\x3e 串联在一起。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs coffeescript\x22\x3epromiseThatFulfills.\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27Will print after about 1 second\x27\x3c\/span\x3e));\npromiseThatRejects.\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27Will print after about 1 second\x27\x3c\/span\x3e));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e注意 \x3ccode\x3e.then()\x3c\/code\x3e 需要两个函数作为参数。第一个参数是 \x3ccode\x3eonFulfilled()\x3c\/code\x3e，当 \x3ccode\x3ePromise\x3c\/code\x3e 为 fulfilled 时调用；第二个 \x3ccode\x3eonRejected()\x3c\/code\x3e 则是在 rejected 的时候调用。\x3ccode\x3ePromise\x3c\/code\x3e 是一个必定处于以下三种状态之一的状态机：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3epending（进行中）: Promise 中的操作正在进行中，状态未被凝固为 fulfilled 或 rejected。\x3c\/li\x3e\n\x3cli\x3efulfilled（已完成，\x3cem\x3e直译：已满足\x3c\/em\x3e）: Promise 中的操作已成功完成，现在 \x3ccode\x3ePromise\x3c\/code\x3e 里面关联有该操作的返回值。\x3c\/li\x3e\n\x3cli\x3erejected（已失败，\x3cem\x3e直译：已回绝\x3c\/em\x3e）: Promise 中的操作因某些原因失败，现在 \x3ccode\x3ePromise\x3c\/code\x3e 里面关联有该操作的错误信息。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e此外，处于 fulfilled 或者 rejected 状态的 \x3ccode\x3ePromise\x3c\/code\x3e 称作“已凝固”(settled) 的 \x3ccode\x3ePromise\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t0110b87cd2a79466d3.png\x22 alt=\x22\x22\x3e\x3c\/p\x3e\n\x3cp\x3e虽然 \x3ccode\x3e.then()\x3c\/code\x3e 是串联 \x3ccode\x3ePromise\x3c\/code\x3e 的核心机制，但并不独一无二。\x3ccode\x3ePromise\x3c\/code\x3e 用来处理抛出错误的 \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/JavaScript\/Reference\/Global_Objects\/Promise\/catch\x22\x3e\x3ccode\x3e.catch()\x3c\/code\x3e 函数\x3c\/a\x3e 也能串联 \x3ccode\x3ePromise\x3c\/code\x3e。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs coffeescript\x22\x3epromiseThatRejects.\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27Will print after about 1 second\x27\x3c\/span\x3e));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e\x3ccode\x3e.catch()\x3c\/code\x3e 函数只是一个只有 \x3ccode\x3eonRejected()\x3c\/code\x3e 参数的 \x3ccode\x3e.then()\x3c\/code\x3e 的语法糖：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs coffeescript\x22\x3epromiseThatRejects.\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27Will print after about 1 second\x27\x3c\/span\x3e));\n\x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e 等价于\npromiseThatRejects.\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27Will print after about 1 second\x27\x3c\/span\x3e));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e类似于 \x3ccode\x3e.catch()\x3c\/code\x3e，.\x3ccode\x3efinally()\x3c\/code\x3e 也是 \x3ccode\x3e.then()\x3c\/code\x3e 的一个语法糖。区别在于 \x3ccode\x3e.finally()\x3c\/code\x3e 当 \x3ccode\x3ePromise\x3c\/code\x3e 凝固（fulfilled \/ rejected）时执行一个 \x3ccode\x3eonFinally\x3c\/code\x3e 函数。当前 \x3ccode\x3e.finally()\x3c\/code\x3e 还没有加入 Node.js 发行版，但 \x3ca href=\x22https:\/\/www.npmjs.com\/package\/promise.prototype.finally\x22\x3enpm 上的 promise.prototype.finally 模块\x3c\/a\x3e 实现了它的 Polyfill。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs coffeescript\x22\x3econst promiseFinally = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27promise.prototype.finally\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e 向 Promise.prototype 增加 \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e()\npromiseFinally.shim();\n\nconst promiseThatFulfills = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Promise(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e(resolve)\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27Hello, World\x27\x3c\/span\x3e), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n});\n\nconst promiseThatRejects = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Promise(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e(resolve, reject)\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Error(\x3cspan class=\x22hljs-string\x22\x3e\x27whoops!\x27\x3c\/span\x3e)), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n});\n\npromiseThatFulfills.\x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27fulfilled\x27\x3c\/span\x3e));\npromiseThatRejects.\x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27rejected\x27\x3c\/span\x3e));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e上面代码的运行结果会打印 \x27fulfilled\x27 和 \x27rejected\x27，因为无论是 fulfilled 还是 rejected，只要状态凝固 \x3ccode\x3eonFinally\x3c\/code\x3e 都会立即执行。不过 \x3ccode\x3eonFinally\x3c\/code\x3e \x3cstrong\x3e不\x3c\/strong\x3e接受参数，所以你无法判断 \x3ccode\x3ePromise\x3c\/code\x3e 的状态到底是两个中的哪个。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3efinally()\x3c\/code\x3e 会返回一个 \x3ccode\x3ePromise\x3c\/code\x3e，所以你可以使用 \x3ccode\x3e.then()\x3c\/code\x3e \/ \x3ccode\x3e.catch()\x3c\/code\x3e \/ \x3ccode\x3e.finally()\x3c\/code\x3e 串联它的返回值。finally() 返回的 \x3ccode\x3ePromise\x3c\/code\x3e 会和它连接到的 \x3ccode\x3ePromise\x3c\/code\x3e 保持相同的 fulfill 条件。 例如下面的代码，即使 \x3ccode\x3eonFinally\x3c\/code\x3e 返回了 \x27bar\x27，它还是会打印 5 次 \x27foo\x27 。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs coffeescript\x22\x3econst promiseFinally = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27promise.prototype.finally\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e 向 Promise.prototype 增加 \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e()\npromiseFinally.shim();\n\nPromise.resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e).\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27bar\x27\x3c\/span\x3e).\n  \x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e 会打印 \x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e, **不是** \x3cspan class=\x22hljs-string\x22\x3e\x27bar\x27\x3c\/span\x3e，因为 \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e() 只起到转运的作用\n  \x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e fulfilled values \x3cspan class=\x22hljs-keyword\x22\x3eand\x3c\/span\x3e rejected errors\n  \x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(res =\x26gt; \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(res));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e类似地，下面代码中即使 \x3ccode\x3eonFinally\x3c\/code\x3e 没有抛出任何错误，仍然会打印 \x27foo\x27。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs typescript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e promiseFinally = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27promise.prototype.finally\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 向 Promise.prototype 增加 finally()\x3c\/span\x3e\npromiseFinally.shim();\n\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e)).\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27bar\x27\x3c\/span\x3e).\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 会打印 \x27foo\x27, **不是** \x27bar\x27，因为 finally() 只起到转运的作用\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 无论是 resolve 的值还是 reject 的错误\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err.message));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e上面代码展示了使用 \x3ccode\x3efinally()\x3c\/code\x3e 的一个重要细节：它 \x3cstrong\x3e不会\x3c\/strong\x3e 帮你处理 \x3ccode\x3ePromise\x3c\/code\x3e 的错误。如何让它能处理 \x3ccode\x3ePromise\x3c\/code\x3e 错误值得更深入的研究。\x3c\/p\x3e\n\x3ch2\x3e错误处理\x3c\/h2\x3e\n\x3cp\x3e\x3ccode\x3efinally()\x3c\/code\x3e \x3cstrong\x3e不是\x3c\/strong\x3e 用来处理 \x3ccode\x3ePromise\x3c\/code\x3e 的错误的。事实上，它会在 \x3ccode\x3eonFinally()\x3c\/code\x3e 执行后\x3ca href=\x22https:\/\/github.com\/tc39\/proposal-promise-finally\/blob\/fd934c0b42d59bf8d9446e737ba14d50a9067216\/polyfill.js#L40\x22\x3e显式重新抛错\x3c\/a\x3e。下面的代码会打印一个未被处理的 \x3ccode\x3ePromise\x3c\/code\x3e 错误警告。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs coffeescript\x22\x3econst promiseFinally = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27promise.prototype.finally\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e 向 Promise.prototype 增加 \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e()\npromiseFinally.shim();\n\nconst promiseThatRejects = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Promise(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e(resolve, reject)\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Error(\x3cspan class=\x22hljs-string\x22\x3e\x27whoops!\x27\x3c\/span\x3e)), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n});\n\npromiseThatRejects.\x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27rejected\x27\x3c\/span\x3e));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cpre\x3e\x3ccode class=\x22hljs crmsh\x22\x3e$ \x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efinally\x3c\/span\x3e.js\nrejected\n(\x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e\x3cspan class=\x22hljs-title\x22\x3e:5342\x3c\/span\x3e) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e): Error: whoops!\n(\x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e\x3cspan class=\x22hljs-title\x22\x3e:5342\x3c\/span\x3e) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. \x3cspan class=\x22hljs-keyword\x22\x3eIn\x3c\/span\x3e the future, promise rejections that are not handled will terminate the \x3cspan class=\x22hljs-keyword\x22\x3eNode\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3ejs\x3c\/span\x3e process with a non-zero exit code.\n$\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e与 \x3ca href=\x22https:\/\/www.w3schools.com\/jsref\/jsref_try_catch.asp\x22\x3e\x3ccode\x3etry\x3c\/code\x3e\/\x3ccode\x3ecatch\x3c\/code\x3e\/\x3ccode\x3efinally\x3c\/code\x3e\x3c\/a\x3e 类似，通常 \x3ccode\x3e.finally()\x3c\/code\x3e 都会在 \x3ccode\x3e.catch()\x3c\/code\x3e 后面被调用。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs typescript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e promiseFinally = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27promise.prototype.finally\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 向 Promise.prototype 增加 finally()\x3c\/span\x3e\npromiseFinally.shim();\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e promiseThatRejects = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27whoops!\x27\x3c\/span\x3e)), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n});\n\npromiseThatRejects.\n  \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e { \x3cspan class=\x22hljs-comment\x22\x3e\/* ignore the error *\/\x3c\/span\x3e }).\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27done\x27\x3c\/span\x3e));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e然而 \x3ccode\x3efinally()\x3c\/code\x3e 返回的也是 \x3ccode\x3ePromise\x3c\/code\x3e，所以你可以随意在 \x3ccode\x3efinally()\x3c\/code\x3e 后面调用 \x3ccode\x3e.catch()\x3c\/code\x3e。特别地，如果 \x3ccode\x3eonFinally\x3c\/code\x3e 会出错，例如 HTTP 请求，你应该在末尾添加 \x3ccode\x3e.catch()\x3c\/code\x3e 以处理可能发生的错误。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs typescript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e promiseFinally = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27promise.prototype.finally\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 向 Promise.prototype 增加 finally()\x3c\/span\x3e\npromiseFinally.shim();\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e promiseThatRejects = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27whoops!\x27\x3c\/span\x3e)), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n});\n\npromiseThatRejects.\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27rejected\x27\x3c\/span\x3e)).\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ No unhandled promise rejection because there\x27s a .catch()\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e { \x3cspan class=\x22hljs-comment\x22\x3e\/* ignore the error *\/\x3c\/span\x3e });\n\x3c\/code\x3e\x3c\/pre\x3e\x3ch2\x3e简版 Polyfill\x3c\/h2\x3e\n\x3cp\x3e我觉得想要真正搞懂一个东西，最简单的方式就是\x3ca href=\x22http:\/\/es2015generators.com\/\x22\x3e自己去实现一个\x3c\/a\x3e。\x3ccode\x3e.finally()\x3c\/code\x3e 是一个很好的选择，因为\x3ca href=\x22https:\/\/github.com\/tc39\/proposal-promise-finally\/blob\/fd934c0b42d59bf8d9446e737ba14d50a9067216\/polyfill.js\x22\x3e官方 Polyfill\x3c\/a\x3e 只有 45 行，而且大多数代码在验证原理时可以进一步精简。\x3c\/p\x3e\n\x3cp\x3e接下来是一些关于 \x3ccode\x3e.finally()\x3c\/code\x3e 的测试样例。下面的代码会打印 \x27foo\x27 5 次。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs typescript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回值被忽略，Promise 正常完成\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e).\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27bar\x27\x3c\/span\x3e).\n  then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(res));\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回值被忽略，Promise 正常抛错\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e)).\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27bar\x27\x3c\/span\x3e).\n  \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err.message));\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ onFinally 抛错，返回新抛出的错误\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27bar\x27\x3c\/span\x3e)).\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e { \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e); }).\n  \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err.message));\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ onFinally 返回的是一个抛错的 Promise，\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回新抛出的错误\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27bar\x27\x3c\/span\x3e)).\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e))).\n  \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err.message));\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ onFinally 返回的是一个 Promise， 需要等待它\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 状态凝固才能继续执行\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e start = \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now();\n本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。 \nspan\x3e.resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e).\n  \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresolve\x3c\/span\x3e =\x26gt;\x3c\/span\x3e setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e resolve(), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e))).\n  then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(res, \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now() - start));\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e下面是简版 Polyfill 的实现。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 向 Promise.prototype 增加 finally()\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.prototype.finally = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eonFinally\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.then(\n    \x3cspan class=\x22hljs-comment\x22\x3e\/* onFulfilled *\/\x3c\/span\x3e\n    res =\x26gt; \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve(onFinally()).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res),\n    \x3cspan class=\x22hljs-comment\x22\x3e\/* onRejected *\/\x3c\/span\x3e\n    err =\x26gt; \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve(onFinally()).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e { \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e err; })\n  );\n};\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这个实现背后关键的思路在于 \x3ccode\x3eonFinally\x3c\/code\x3e 可能返回 \x3ccode\x3ePromise\x3c\/code\x3e。在这种情况下你需要用 \x3ccode\x3e.then()\x3c\/code\x3e 来处理它并且给外层 \x3ccode\x3ePromise\x3c\/code\x3e 凝固状态。你可以显式检查 \x3ccode\x3eonFinally\x3c\/code\x3e 是否返回 \x3ccode\x3ePromise\x3c\/code\x3e，但 \x3ccode\x3ePromise.resolve()\x3c\/code\x3e 已经帮你做了，而且不需要 \x3ccode\x3eif\x3c\/code\x3e 语句。你还需要跟踪初始 \x3ccode\x3ePromise\x3c\/code\x3e 的值或错误，并确保 \x3ccode\x3efinally()\x3c\/code\x3e 返回的 \x3ccode\x3ePromise\x3c\/code\x3e 解析出初始值 \x3ccode\x3eres\x3c\/code\x3e，或重新抛出初始错误 \x3ccode\x3eerr\x3c\/code\x3e。\x3c\/p\x3e\n\x3ch2\x3e后记\x3c\/h2\x3e\n\x3cp\x3e在动笔时，\x3ccode\x3ePromise.prototype.finally()\x3c\/code\x3e 是 \x3ca href=\x22https:\/\/github.com\/tc39\/proposals\/blob\/master\/finished-proposals.md\x22\x3e8 个 TC39 第四阶段提案\x3c\/a\x3e 之一。这意味着 \x3ccode\x3efinally()\x3c\/code\x3e 将和 7 个其他新语言特性一起加入 Node.js。 \x3ccode\x3efinally()\x3c\/code\x3e 是这 8 个新特性中最令人兴奋的之一，皆因为它可以让异步操作结束后的清理更彻底。举个例子，下面我正用在生产环境的代码非常需要 \x3ccode\x3efinally()\x3c\/code\x3e 来在函数完成时释放资源的锁定。\x3c\/p\x3e\n\x3cp\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t01d067cf4198b33407.png\x22 alt=\x22\x22\x3e\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>原文链接: <a href="https://www.zcfy.cc/article/using-promise-prototype-finally-in-node-js">https://www.zcfy.cc/article/using-promise-prototype-finally-in-node-js</a> 原文标题: 在 Node.js 中使用 Promise.prototype.finally 本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2>本文链接：</h2><a href="https://alili.tech/archive/c8c91cd5/" target="_blank">https://alili.tech/archive/c8c91cd5/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>