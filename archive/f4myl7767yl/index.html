<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="【用故事解读 MobX源码（二）】 computed"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>【用故事解读 MobX源码（二）】 computed | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/f4myl7767yl/",
				"appid": "1613049289050283", 
				"title": "【用故事解读 MobX源码（二）】 computed | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-06T02:30:09"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/s59p038iusi/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/fvsu3n9kl9d/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f&text=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f&text=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f&is_video=false&description=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ff4myl7767yl%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%ba%8c%ef%bc%89%e3%80%91%20computed"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">【用故事解读 MobX源码（二）】 computed</h1><div class="meta"><div class="postdate"><time datetime="2018-12-06" itemprop="datePublished">2018-12-06</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e\x3cstrong\x3e================前言===================\x3c\/strong\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cstrong\x3e初衷\x3c\/strong\x3e：以系列故事的方式展现 MobX 源码逻辑，尽可能以易懂的方式讲解源码；\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e\x3cstrong\x3e本系列文章\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000013682735\x22\x3e【用故事解读 MobX源码（一）】 autorun\x3c\/a\x3e》\x3c\/li\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000014238836\x22 target=\x22_blank\x22\x3e【用故事解读 MobX源码（二）】 computed\x3c\/a\x3e》\x3c\/li\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000014726483\x22\x3e【用故事解读 MobX源码（三）】 shouldCompute\x3c\/a\x3e》\x3c\/li\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000015481998\x22 target=\x22_blank\x22\x3e【用故事解读 MobX 源码（四）】装饰器 和 Enhancer\x3c\/a\x3e》\x3c\/li\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000015875144\x22\x3e【用故事解读 MobX 源码（五）】 Observable\x3c\/a\x3e》\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cstrong\x3e文章编排\x3c\/strong\x3e：每篇文章分成两大段，第一大段以简单的侦探系列故事的形式讲解（\x3cstrong\x3e所涉及人物、场景都以 MobX 中的概念为原型创建\x3c\/strong\x3e），第二大段则是相对于的源码讲解。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e本文基于 MobX 4 源码讲解\x3c\/strong\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cstrong\x3e=======================================\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e在写本文的时候，由于 MobX 以及升级到 4.x，API 有较大的变化，因此后续的文章默认都将基于 4.x 以上版本进行源码阅读。\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000013682735\x22 target=\x22_blank\x22\x3e前一篇文章\x3c\/a\x3e仍然以 mobx v3.5.1 的源码，\x3ccode\x3eautorun\x3c\/code\x3e 逻辑在新版中没有更改，因此源码逻辑仍旧一致。\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader0\x22\x3eA. Story Time\x3c\/h1\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e1、 场景\x3c\/h2\x3e\n\x3cp\x3e为了多维度掌控嫌疑犯的犯罪特征数据，你（警署最高长官）想要获取并实时监控张三的 \x3cstrong\x3e贷款数额、存贷比（存款和贷款两者比率）\x3c\/strong\x3e 的变化。\x3c\/p\x3e\n\x3cp\x3e于是你就拟定了新的命令给执行官 MobX：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var bankUser = mobx.observable({\n  income: 3,\n  debit: 2\n});\n\nvar divisor = mobx.computed(() =\x3e {\n  return bankUser.income \/ bankUser.debit;\n});\n\nmobx.autorun(() =\x3e {\n  console.log(\x27张三的贷款：\x27, bankUser.debit, \x27；张三的存贷比: \x27 \x2b divisor);\n});\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e bankUser = mobx.observable({\n  \x3cspan class=\x22hljs-attr\x22\x3eincome\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3edebit\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\n});\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e divisor = mobx.computed(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e bankUser.income \/ bankUser.debit;\n});\n\nmobx.autorun(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的贷款：\x27\x3c\/span\x3e, bankUser.debit, \x3cspan class=\x22hljs-string\x22\x3e\x27；张三的存贷比: \x27\x3c\/span\x3e \x2b divisor);\n});\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e相比上一次的命令，除了监控张三贷款这项直接的指标，还需要监控 \x3cstrong\x3e贷款比\x3c\/strong\x3e（\x3ccode\x3edivisor\x3c\/code\x3e） 这项间接指标。\x3c\/p\x3e\n\x3cp\x3e执行官 MobX 稍作思忖，要完成这个任务比之前的要难一点点，需要费一点儿精力。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdE4?w=270\x26amp;h=400\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdE4?w=270\x26amp;h=400\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e不过，这也难不倒能力强大的 MobX 执行官，一番策略调整之后，重新拿出新的执行方案。部署实施之后，当张三去银行存款、贷款后，这些变化都实时反馈出来了：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981479?w=844\x26amp;h=446\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981479?w=844\x26amp;h=446\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e2、部署方案\x3c\/h2\x3e\n\x3cp\x3e这次的部署和前一次相差不大，除了需要让观察员 O2（监视 \x3ccode\x3eincome\x3c\/code\x3e）参与进来之外，考虑到警署最高长官所需的 \x3cstrong\x3e存贷比\x3c\/strong\x3e （\x3ccode\x3edivisor\x3c\/code\x3e），还得派出另一类职员 ——  \x3cstrong\x3e会计师\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\n\x3cstrong\x3e会计师\x3c\/strong\x3e：此类职员专门负责计算，从事 \x3cstrong\x3e数据的再加工\x3c\/strong\x3e（此项任务中，就是搜集数据并计算 \x3cstrong\x3e存贷比\x3c\/strong\x3e）\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdE8?w=88\x26amp;h=100\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdE8?w=88\x26amp;h=100\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e会计师是一个很有意思的角色，要想理解他们，必须得思考他们的数据“从哪儿来？到哪里去？” 这两个问题：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e从哪儿来：从\x3cstrong\x3e观察员\x3c\/strong\x3e那儿获取，也可以从\x3cstrong\x3e其他会计师\x3c\/strong\x3e那儿获取；\x3c\/li\x3e\n\x3cli\x3e到哪儿去：所生产的数据，要么是被\x3cstrong\x3e探长\x3c\/strong\x3e消费，要么被\x3cstrong\x3e其他会计师\x3c\/strong\x3e所用；（当然，没有人消费他所生产的数据也是可能的，不过这就得追究 MobX 执行官的责任了，浪费了人力资源）\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e引入了会计师角色之后，MobX 执行官重新绘制了部署计划图：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdE9?w=800\x26amp;h=439\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdE9?w=800\x26amp;h=439\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e解释一下此计划图的意思：\x3c\/p\x3e\n\x3col\x3e\x3cli\x3e明确此次任务是 \x3cstrong\x3e当张三账户存款或者贷款变更时，打印其贷款数额（\x3ccode\x3edebit\x3c\/code\x3e）和存贷比（\x3ccode\x3edivisor\x3c\/code\x3e）\x3c\/strong\x3e：\x3c\/li\x3e\x3c\/ol\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22() =\x3e {\n  console.log(\x27张三的贷款：\x27, bankUser.debit, \x27；张三的存贷比: \x27 \x2b divisor);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e() =\x26gt; {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的贷款：\x27\x3c\/span\x3e, bankUser.debit, \x3cspan class=\x22hljs-string\x22\x3e\x27；张三的存贷比: \x27\x3c\/span\x3e \x2b divisor);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3col\x3e\n\x3cli\x3e将任务指派给执行组中的探长 R1\x3c\/li\x3e\n\x3cli\x3e派遣 2 名观察组中的观察员 O1、O2 分别监察张三账户的 \x3ccode\x3ebankUser.income\x3c\/code\x3e 属性和 \x3ccode\x3ebankUser.debit\x3c\/code\x3e 属性；\x3c\/li\x3e\n\x3cli\x3e派遣计算组中的会计师 C1 计算张三的贷款比，其所需数值来源于观察员 O1、O2；\x3c\/li\x3e\n\x3cli\x3e探长 R1 任务中所需的“张三的账户存款” 数值从观察员 O2 那儿获取；所需的 “张三的存贷比” 数值从会计师 C1 那儿获取；\x3c\/li\x3e\n\x3cli\x3e同时架设数据情报室，方便信息交换；\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e2.1、部署细节\x3c\/h3\x3e\n\x3cp\x3e因为还是 \x3ccode\x3eautorun\x3c\/code\x3e 命令，所以仍然执行 A计划方案（详情参考上一篇《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000013682735\x22\x3e【用故事解读 MobX源码（一）】 autorun\x3c\/a\x3e》）MobX 执行官的部署方案从整体上看是一样的，考虑到多了\x3cstrong\x3e会计师\x3c\/strong\x3e这个角色的参与，所以特意在探长 \x3cstrong\x3e获取存贷比（\x3ccode\x3edivisor\x3c\/code\x3e）\x3c\/strong\x3e 逻辑处空出一部分留给会计师让它自由发挥：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFa?w=706\x26amp;h=1200\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFa?w=706\x26amp;h=1200\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e这样做，MobX 执行官也为了在实际行动中向他的警署长官证实该 A计划方案 的确拥有“良好的扩展性”。\x3c\/blockquote\x3e\n\x3cp\x3e解开这层新增的会计师计算逻辑 “面纱”，图示如下：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFb?w=800\x26amp;h=669\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFb?w=800\x26amp;h=669\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e你会发现历史总是惊人的相似，新增的会计师执行计算任务的逻辑其实 \x3cstrong\x3e探长\x3c\/strong\x3e 执行任务的逻辑是一样的，下图中我特意用 \x3cstrong\x3e相同的序号（不同的颜色形状）标示\x3c\/strong\x3e 出，序号所对应含义如下：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e设置成 \x3cstrong\x3e正在执勤人员\x3c\/strong\x3e\n\x3c\/li\x3e\n\x3cli\x3e开始执行任务\x3c\/li\x3e\n\x3cli\x3e从观察员或会计师那儿获取执行任务所需的数值，并同他们取得联系，\x3c\/li\x3e\n\x3cli\x3e计算任务执行完成后，更新与观察员 O1、观察员 O2 之间的联系；\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFd?w=704\x26amp;h=1200\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFd?w=704\x26amp;h=1200\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e此执行计算任务的逻辑，如果不告诉观察员的话，观察员还以为又来了一名“探长”上级。?\x3c\/p\x3e\n\x3cp\x3e从部署图里我们可以看出会计师具有两面性；\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e对探长而言：会计师和观察员地位差不多，都属于“下级”，都需要将自己的信息及时反馈给探长；\x3c\/li\x3e\n\x3cli\x3e对观察员而言：会计师是属于 “上级”，拥有部分类似探长执行任务权力，只不过其任务类型只能是 \x3cstrong\x3e计算类型\x3c\/strong\x3e的任务，执行任务结束之后，像探长那样和观察员互相关联起来，方便下一次的运算；\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e自从有了会计师的参与，探长还是那个探长，但他的下级已经不是之前的下级了。借助 A计划任务的执行，会计师 C1 在上报计算值的时候，会顺水推舟地执行计算任务，同时更新他的 ”\x3cstrong\x3e关系网\x3c\/strong\x3e“。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e2.2、 懒惰的会计师\x3c\/h3\x3e\n\x3cp\x3e会计师有一个特性就是\x3cstrong\x3e比较懒\x3c\/strong\x3e：就算观察员所观察到的值变更了，他们也不会立即重新计算，而只在必要的时候（比如\x3cstrong\x3e当上级前来索取时\x3c\/strong\x3e）才会重新计算。\x3c\/p\x3e\n\x3cp\x3e举个例子，当观察员 O1 发现张三的账户存款从原来的 3 变成 6 ：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22bankUser.income = 6;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3ebankUser.income = \x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个时候会触发一系列的 “涟漪”：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e① 观察员 O1 先注册事务，相当于到数据情报室”上班打卡“，声明这次事件由 观察员 O1 主导\x3c\/li\x3e\n\x3cli\x3e② 告知其上级，也就是会计师 C1 ，说是张三存款（\x3ccode\x3eincome\x3c\/code\x3e）有变更\x3c\/li\x3e\n\x3cli\x3e③  会计师 C1 获知消息后，”慵懒地“调整自己的状态\x3c\/li\x3e\n\x3cli\x3e④  随后会计师 C1 继续往上级汇报，告知本会计师的值有更改（注意，此时\x3cstrong\x3e会计师只是告诉上级自己的值有更改这一事实，但并没有执行计算任务\x3c\/strong\x3e ！）\x3c\/li\x3e\n\x3cli\x3e⑤  探长 R1 接收到会计师的反馈后，就向 MobX 执行官申请要执行任务！因为其下级会计师 C1 汇报说值有更改，说明这个时候应该要重新执行任务啦~\x3c\/li\x3e\n\x3cli\x3e⑥  执行官 MobX 调阅数据情报室信息一看，发现目前观察员 O1 正在执行事务，就让探长 R1 再等等，现在不是执行任务的最佳时机，等到事务结束再说。\x3c\/li\x3e\n\x3cli\x3e⑦  不一会儿观察员 O1 完成了自己的职责，”下班打卡“，在数据情报室中注销事务\x3c\/li\x3e\n\x3cli\x3e⑧  这个时候，执行官 MobX 才让探长 R1 开始执行任务\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e将上面的文字转换成流程图，可以清晰看到各角色在这次“涟漪”中所起到的作用：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFf?w=800\x26amp;h=688\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFf?w=800\x26amp;h=688\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这里需要注意 3 点：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e当观察员O1 汇报张三存款有更改的时候，会计师 C1 并没有立即重新计算值哦，仅仅是更改自身的状态；\x3c\/li\x3e\n\x3cli\x3e会计师告知上级（探长 R1）自己有值更改，探长申请执行任务，不过 MobX 执行官并没有允许他这么做，而是让他先等待一下，因为此时 \x3cstrong\x3e观察员 O1\x3c\/strong\x3e 还在汇报工作。等观察员 O1 工作汇报完毕，这个时候才让探长执行任务。因为有可能有其他计算组职员也正在响应该观察值的更改，事情一件一件来，不要着急，这和 debounce 思想一致，减少不必要的计算。\x3c\/li\x3e\n\x3cli\x3e只有在最后探长执行任务时 \x3cstrong\x3e需要用到会计师的值的时候，会计师才会去执行计算操作\x3c\/strong\x3e。这就是典型的惰性求值思维。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e会计师这种拖延到 \x3cstrong\x3e只有被需要的时候才进行计算\x3c\/strong\x3e 的行为，有没有让你回忆起学生时代寒假结束前一天疯狂补作业的场景？?\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFj?w=400\x26amp;h=297\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFj?w=400\x26amp;h=297\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e2.3、避免不必要的计算\x3c\/h3\x3e\n\x3cp\x3e当执行官 MobX 拿着这份执行报告送达给你（警署最高长官），阅览完毕：”不错，这套方案的确部分证实了你之前所言的可扩展性。但随着职员的引入，运转机构逐渐庞大，如何避免不必要的开销的呢？“\x3c\/p\x3e\n\x3cp\x3e”长官您高瞻远瞩，这的确是一个问题。在井然有序的规则下，个别职员的运作效率的确会打折扣。因此避免职员不必要的计算开销，也是在我方案部署规划之内。正如您所见，上述方案中会计师的‘惰性’、探员在事务之后再进行任务等机制，都是基于优化性能所采取的措施。“ 执行官 MobX 稍作停顿，继续道，”为了更好地阐述这套运行方案的性能优化机制，我明天呈上一份报告，好让您得以全面了解。“\x3c\/p\x3e\n\x3cp\x3e”Good Job！期待你的报告“。 \x3c\/p\x3e\n\x3cp\x3e那么，执行官 MobX 是凭借什么机制减少开销的呢？且听下回分解。\x3cbr\x3e（本节完，未完待续）\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader6\x22\x3eB. Source Code Time\x3c\/h1\x3e\n\x3cp\x3e本节部分，仍然是就着上面的”故事“来讲 MobX 中的源码。\x3c\/p\x3e\n\x3cp\x3e先罗列本文故事中新出现的 \x3cstrong\x3e会计师\x3c\/strong\x3e 角色与 MobX 源码概念映射关系：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth\x3e故事人物\x3c\/th\x3e\n\x3cth\x3eMobX 源码\x3c\/th\x3e\n\x3cth\x3e解释\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\x3ctr\x3e\n\x3ctd\x3e会计师\x3c\/td\x3e\n\x3ctd\x3e\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/core\/computedvalue.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ecomputedvalue\x3c\/a\x3e\x3c\/td\x3e\n\x3ctd\x3e官方文档 - \x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/computed-decorator.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e(@)computed 计算值\x3c\/a\x3e\n\x3c\/td\x3e\n\x3c\/tr\x3e\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3cblockquote\x3e探长、执行官等角色的映射关系，参考上一篇《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000013682735\x22\x3e【用故事解读 MobX源码（一）】 autorun\x3c\/a\x3e》\x3c\/blockquote\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFn?w=800\x26amp;h=312\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFn?w=800\x26amp;h=312\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e本文的重点内容就是 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/core\/computedvalue.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ecomputedvalue\x3c\/a\x3e 的部分源码（它在 \x3ccode\x3eautorun\x3c\/code\x3e 等场景中的应用）\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eautorun\x3c\/code\x3e（A 计划）的源码在上一节讲过，这里不再赘述。我们仅仅讲解一下 \x3cstrong\x3ecomputedValue\x3c\/strong\x3e 在 \x3ccode\x3eautorun\x3c\/code\x3e 中的表现。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e1、会计师，请开始你的表演\x3c\/h2\x3e\n\x3cp\x3e在故事中我们讲到过，当探长向会计师索要计算值的时候，此时懒惰的会计师为了 ”应付交差“，这时候才开始计算，其计算的过程和探长执行的任务流程几乎一致。\x3c\/p\x3e\n\x3cp\x3e从源码角度去看一下其中的原因。\x3c\/p\x3e\n\x3cp\x3e当探长执行任务：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22() =\x3e {\n  console.log(\x27张三的贷款：\x27, bankUser.debit, \x27；张三的存贷比: \x27 \x2b divisor);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e() =\x26gt; {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的贷款：\x27\x3c\/span\x3e, bankUser.debit, \x3cspan class=\x22hljs-string\x22\x3e\x27；张三的存贷比: \x27\x3c\/span\x3e \x2b divisor);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e任务中也涉及 \x3ccode\x3ebankUser.debit\x3c\/code\x3e 变量和 \x3ccode\x3edivisor\x3c\/code\x3e 变量；其中在获取 \x3ccode\x3ebankUser.debit\x3c\/code\x3e 变量之时会让观察员 O2 触发 \x3ccode\x3ereportObserved\x3c\/code\x3e方法，这个上一篇文章着重讲过，此处就不详细展开了；而请求 \x3ccode\x3edivisor\x3c\/code\x3e 数值的时候，则会触发该值的 \x3ccode\x3evalueOf()\x3c\/code\x3e 方法 —— 即调用会计师（\x3cstrong\x3ecomputedValue\x3c\/strong\x3e）的 \x3ccode\x3evalueOf()\x3c\/code\x3e 方法。\x3c\/p\x3e\n\x3cp\x3e为什么调用就触发 \x3ccode\x3evalueOf()\x3c\/code\x3e 方法呢？请看下方的“知识点”备注?\x3c\/p\x3e\n\x3cblockquote\x3e======== 插播知识点 =========\x3cp\x3e任何原始值还是对象其实都包含 \x3ccode\x3evalueOf()\x3c\/code\x3e 或 \x3ccode\x3etoString()\x3c\/code\x3e 方法，\x3ccode\x3evalueOf()\x3c\/code\x3e 会返回最适合该对象类型的原始值，\x3ccode\x3etoString()\x3c\/code\x3e 将该对象的原始值以字符串形式返回。\x3cbr\x3e这两个方法一般是交由 JS 去隐式调用，以满足不同的运算情况。比如在数值运算（如\x3ccode\x3ea \x2b b\x3c\/code\x3e）里会优先调用 \x3ccode\x3evalueOf()\x3c\/code\x3e，而在字符串运算（如alert(\x3ccode\x3ec\x3c\/code\x3e)）里，会优先调用 \x3ccode\x3etoString()\x3c\/code\x3e 方法\x3cbr\x3e顺带附上两篇 参考文章\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3ca href=\x22https:\/\/www.zhihu.com\/question\/24262399\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ejs中 toString 和 valueOf 的区别？\x3c\/a\x3e：知乎问答\x3c\/li\x3e\n\x3cli\x3e\n\x3ca href=\x22https:\/\/stackoverflow.com\/questions\/2485632\/valueof-vs-tostring-in-javascript\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3evalueOf() vs. toString() in Javascript\x3c\/a\x3e：SF 上的回答，非常详尽地告诉你其执行结果\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cblockquote\x3e======== 完毕 ==========\x3c\/blockquote\x3e\n\x3cp\x3e一旦调用调用会计师的 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/computedvalue.ts#L283\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3evalueOf\x3c\/a\x3e 方法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22valueOf(): T {\n    return toPrimitive(this.get())\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3evalueOf(): T {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e toPrimitive(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.get())\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其实就是调用 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/computedvalue.ts#L142\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ethis.get()\x3c\/a\x3e 方法，我们瞧一眼源码；\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFs?w=800\x26amp;h=385\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFs?w=800\x26amp;h=385\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e1.1、 \x3cstrong\x3e重量级计算\x3c\/strong\x3e 还是 \x3cstrong\x3e轻量级\x3c\/strong\x3e 计算？\x3c\/h3\x3e\n\x3cp\x3e这里有个分叉点，根据 \x3ccode\x3eglobalState.inBatch\x3c\/code\x3e 决定到底是启用 \x3cstrong\x3e重量级计算\x3c\/strong\x3e 还是 \x3cstrong\x3e轻量级计算\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e当 \x3ccode\x3eglobalState.inBatch\x3c\/code\x3e 值大于 \x3cstrong\x3e0\x3c\/strong\x3e，说明会计师被上级征调（处于上级事务中），比如此案例中，陷于 A 计划（\x3ccode\x3eautorun \x3c\/code\x3e）的会计师，在上级探长 R1 需要查阅计算值时候，就会进入\x3cstrong\x3e重量级计算\x3c\/strong\x3e模式\x3c\/li\x3e\n\x3cli\x3e当会计师无上级征调的时候，\x3ccode\x3eglobalState.inBatch\x3c\/code\x3e 值为 \x3cstrong\x3e0\x3c\/strong\x3e，就会进入\x3cstrong\x3e轻量级计算\x3c\/strong\x3e模式，简化计算的逻辑。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e但无论轻量级还是重量级计算，都会涉及到调用 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/computedvalue.ts#L209\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ecomputeValue()\x3c\/a\x3e 方法来执行计算任务。\x3c\/p\x3e\n\x3cp\x3e调用的时候，如果是 \x3cstrong\x3e重量级计算\x3c\/strong\x3e 则 \x3ccode\x3etrack\x3c\/code\x3e 这个 bool 值为 \x3cstrong\x3etrue\x3c\/strong\x3e，否则\x3ccode\x3etrack\x3c\/code\x3e 值为 \x3cstrong\x3efalse\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFv?w=800\x26amp;h=327\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFv?w=800\x26amp;h=327\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e计算值有个属性，\x3ccode\x3ethis.derivation\x3c\/code\x3e 就是会计师要计算数值时所依据的\x3cstrong\x3e计算表达式\x3c\/strong\x3e，也就是而我们定义会计师时所传入的匿名函数：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22() =\x3e {\n  return bankUser.income \/ bankUser.debit;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e() =\x26gt; {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e bankUser.income \/ bankUser.debit;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e无论是 \x3cstrong\x3e重量级计算\x3c\/strong\x3e 模式还是 \x3cstrong\x3e轻量级计算\x3c\/strong\x3e 模式，\x3cstrong\x3e最终都是会调用该计算表达式获取计算值\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e重量级计算\x3c\/strong\x3e 模式和 \x3cstrong\x3e轻量级计算\x3c\/strong\x3e 模式两者的差别只是在于前者在执行该计算表达式之前会设置很多环境，后者直接就按这个表达式计算数值返回。\x3c\/p\x3e\n\x3cp\x3e在上述的故事中，由于探长 R1 人物的存在，会计师会执行 \x3cstrong\x3e重量级计算\x3c\/strong\x3e 模式，接下来的源码分析也走这条分支路线。（ \x3cstrong\x3e轻量级计算\x3c\/strong\x3e 模式的情况当做课后思考题）。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e1.2、像探长学习\x3c\/h3\x3e\n\x3cp\x3e在 \x3cstrong\x3e重量级计算\x3c\/strong\x3e的时候，\x3ccode\x3ecomputeValue(true)\x3c\/code\x3e 就会走和  \x3cstrong\x3e探长\x3c\/strong\x3e 操作模式一样 \x3ccode\x3etrackDerivedFunction\x3c\/code\x3e 步骤。没错，探长和会计师调用的就是同一个方法，所以他们在执行任务的时候，行为痕迹是一样的，没毛病。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFw?w=800\x26amp;h=327\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFw?w=800\x26amp;h=327\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e如果忘记 \x3ccode\x3etrackDerivedFunction\x3c\/code\x3e 方法内容，请查看 《【用故事解读 MobX源码（一）】 autorun》的 ”2.2.2、trackDerivedFunction“ 部分\x3c\/blockquote\x3e\n\x3cp\x3e只不过会计师\x3cstrong\x3e只能执行计算类的任务\x3c\/strong\x3e（纯函数）罢了，探长可以执行任意类型的任务。\x3c\/p\x3e\n\x3cp\x3e和探长一样，会计师执行计算任务完毕之后调用 \x3ccode\x3ebindDependencies\x3c\/code\x3e 将绑定 观察员 O1 和 观察员 O2 ；而在执行计算之后，会计师会调用 \x3ccode\x3epropagateChangeConfirmed\x3c\/code\x3e 方法，更改自己和上级 \x3cstrong\x3e探长\x3c\/strong\x3e 的状态 —— 这说明，对探长而言，会计师就相当于 \x3cstrong\x3e观察员\x3c\/strong\x3e的角色，在探长执行任务结束后像观察员一样需要上报自己的计算值，并和 \x3cstrong\x3e探长\x3c\/strong\x3e 取得联系；\x3c\/p\x3e\n\x3cp\x3e这么看会计师还真 ”墙头草，两边倒”。\x3c\/p\x3e\n\x3cp\x3e至此，会计师这个角色以较低的成本就能完美地整合进执行官 MobX 所部署的 A 集合部署方案中。??\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader10\x22\x3e2、 响应观察值的变化\x3c\/h2\x3e\n\x3cp\x3e一旦张三的账户存款（\x3ccode\x3eincome\x3c\/code\x3e）发生变化，将会触发 MobX 所提供的 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/atom.ts#L52\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ereportChanged\x3c\/a\x3e 方法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  public reportChanged() {\n      startBatch()\n      propagateChanged(this)\n      endBatch()\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e  public reportChanged() {\n      startBatch()\n      propagateChanged(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e)\n      endBatch()\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cblockquote\x3e注意这里的 \x3ccode\x3estartBatch\x3c\/code\x3e 和 \x3ccode\x3eendBatch\x3c\/code\x3e 方法，说明观察员 O1 发起事务了。\x3c\/blockquote\x3e\n\x3ch3 id=\x22articleHeader11\x22\x3e2.1、传递变化的信息\x3c\/h3\x3e\n\x3cp\x3e我们知道（不知道的请阅读上一篇文章）该 \x3ccode\x3ereportChanged()\x3c\/code\x3e 方法中的 \x3ccode\x3epropagateChanged()\x3c\/code\x3e 会触发上级的 \x3ccode\x3eonBecomeStale()\x3c\/code\x3e 方法。\x3c\/p\x3e\n\x3cp\x3e观察员 O1 此时的上级是 \x3cstrong\x3e会计师 C1\x3c\/strong\x3e，其所定义的 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/computedvalue.ts#L130\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eonBecomeStale\x3c\/a\x3e 如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22onBecomeStale() {\n    propagateMaybeChanged(this)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eonBecomeStale() {\n    propagateMaybeChanged(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e看一下 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/observable.ts#L238\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3epropagateMaybeChanged(this)\x3c\/a\x3e 源码，也比较简单，主要做了两件事情，① 会计师会调整自身的状态； ②然后触发其上级（探长 R1）的 \x3ccode\x3eonBecomeStale()\x3c\/code\x3e 方法。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFE?w=800\x26amp;h=347\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFE?w=800\x26amp;h=347\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e可见观察员 01 会引起会计师 C1 的响应，而会计师会引起探长 R1 的响应，这种响应“涟漪”就是通过下级触发上级的 \x3ccode\x3eonBecomeStale\x3c\/code\x3e 方法形成的连锁反应。\x3c\/p\x3e\n\x3cblockquote\x3e不同上级（比如会计师和探长）的 \x3ccode\x3eonBecomeStale\x3c\/code\x3e 定义不同。\x3c\/blockquote\x3e\n\x3cp\x3e探长的这个 \x3ccode\x3eonBecomeStale\x3c\/code\x3e 方法在上一篇文章的 “3、响应观察值的变化 - propagateChanged”  中我们讲过，探长将请求 MobX 请求重新执行一遍 A 计划方案。\x3c\/p\x3e\n\x3cp\x3e然而，MobX 拒绝了这次请求，让他再等待一下。??\x3c\/p\x3e\n\x3cp\x3e这是因为在 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/reaction.ts#L198\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3erunReactions\x3c\/a\x3e 方法中：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22if (globalState.inBatch \x3e 0 || globalState.isRunningReactions) return\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (globalState.inBatch \x26gt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e || globalState.isRunningReactions) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e由于此时 \x3ccode\x3einBatch\x3c\/code\x3e 是 1（因为观察员执行了 \x3ccode\x3estartBatch()\x3c\/code\x3e），所以会直接 return 掉。\x3c\/p\x3e\n\x3cp\x3e直到观察员执行 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/observable.ts#L126\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eendBatch()\x3c\/a\x3e 的时候，除了会结束本次的上报事务，同时执行官 MobX 会重新执行 \x3ccode\x3erunReactions\x3c\/code\x3e 方法，让久等的探长去执行任务：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000014238855?w=1286\x26amp;h=326\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000014238855?w=1286\x26amp;h=326\x22 alt=\x22endBatch\x22 title=\x22endBatch\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e探长在执行任务的时候，就会打印张三的贷款（\x3ccode\x3edebit\x3c\/code\x3e）、存贷比（\x3ccode\x3edivisor\x3c\/code\x3e）了。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader12\x22\x3e2.2、虽然懒，但是懒得有技巧\x3c\/h3\x3e\n\x3cp\x3e综上，当张三存款（\x3ccode\x3eincome\x3c\/code\x3e）变更，就能让 A 计划（\x3ccode\x3eautorun\x3c\/code\x3e）自动运行，探长会打印张三的贷款（\x3ccode\x3edebit\x3c\/code\x3e）、存贷比（\x3ccode\x3edivisor\x3c\/code\x3e）。\x3c\/p\x3e\n\x3cp\x3e这里需要提及一下，关于会计师重新计算的时机，是在探长执行 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/4.1.1\/src\/core\/derivation.ts#L76\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eshouldCompute\x3c\/a\x3e 的时候，探长发现会计师值 \x3cstrong\x3e陈旧\x3c\/strong\x3e 了，就让会计师重新计算：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFK?w=800\x26amp;h=457\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFK?w=800\x26amp;h=457\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e看看这里，对计算值而言，\x3ccode\x3eisComputedValue()\x3c\/code\x3e（如果是计算值）返回 true，就会执行 \x3ccode\x3eobj.get()\x3c\/code\x3e 方法，这个方法刚才刚讲过，会让会计师执行 \x3cstrong\x3e重量型计算操作\x3c\/strong\x3e，更新自己的计算值。\x3c\/p\x3e\n\x3cp\x3e所以，\x3cstrong\x3e这次计算时机并非等到探长执行任务时（真正用到该值）的时候才让其重新计算，和第一次 \x3ccode\x3eautorun\x3c\/code\x3e 的时机不一致\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e估计这是 MobX 考虑到会计师的值肯定需要更新的（已经确定要被探长 R1 用到），还有可能会被其他上级引用，既然迟早要更新的，那就尽可能将更新前置，这样在整体上能降低成本。\x3c\/p\x3e\n\x3cp\x3e更新完之后，在探长执行任务的时候，会计师汇报自己是最新的值了，就不用再重新计算一遍。\x3c\/p\x3e\n\x3cp\x3e虽然懒，但是懒得有技巧。\x3c\/p\x3e\n\x3cp\x3e至此，有关会计师的源码解读已经差不多，后续有想到的再补充。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader13\x22\x3e3、其他说明\x3c\/h2\x3e\n\x3cp\x3e本文为了方便说明，所以单独使用 \x3ccode\x3emobx.computed\x3c\/code\x3e 方法定义计算值，平时使用中更多则是直接应用在 \x3cstrong\x3e对象中属性\x3c\/strong\x3e 上，使用 \x3cstrong\x3eget\x3c\/strong\x3e 语法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var bankUser = mobx.observable({\n  income: 3,\n  debit: 2,\n  get divisor() {\n    return this.income \/ this.debit;\n  }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e bankUser = mobx.observable({\n  \x3cspan class=\x22hljs-attr\x22\x3eincome\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3edebit\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\n  get divisor() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.income \/ \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.debit;\n  }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这仅仅是写法上不一样，源码分析的思路是一致的。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader14\x22\x3e4、小测试\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader15\x22\x3e4.1、测试1\x3c\/h3\x3e\n\x3cp\x3e\x3cstrong\x3e问题\x3c\/strong\x3e：当我们更改张三贷款数额 \x3ccode\x3ebankUser.debit = 4;\x3c\/code\x3e 时，请从源码角度解答 MobX 的执行流程是如何的？\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e参考答案提示\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22reportChanged() \n    =\x3e propagateChanged() \n    =\x3e propagateMaybeChanged() \n    =\x3e runReaction() \n    =\x3e track() \n    =\x3e get() \n    =\x3e computeValue() \n    =\x3e bindDependencies()\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3ereportChanged() \n    =\x26gt; propagateChanged() \n    =\x26gt; propagateMaybeChanged() \n    =\x26gt; runReaction() \n    =\x26gt; track() \n    =\x26gt; get() \n    =\x26gt; computeValue() \n    =\x26gt; bindDependencies()\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader16\x22\x3e4.2、测试2\x3c\/h3\x3e\n\x3cp\x3e\x3cstrong\x3e问题\x3c\/strong\x3e：如果不存在 \x3ccode\x3eautorun\x3c\/code\x3e （即没有探长参与，仅有观察员和会计师），此时仅改变张三存款数值：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var bankUser = mobx.observable({\n  income: 3,\n  debit: 2\n});\n\nvar divisor = mobx.computed(() =\x3e {\n  return bankUser.income \/ bankUser.debit;\n});\n\nbankUser.income = 6; \/\/ 请问此时的执行情况是什么样的？\n\nconsole.log(\x27张三的存贷比：\x27, divisor)\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e bankUser = mobx.observable({\n  \x3cspan class=\x22hljs-attr\x22\x3eincome\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3edebit\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\n});\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e divisor = mobx.computed(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e bankUser.income \/ bankUser.debit;\n});\n\nbankUser.income = \x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 请问此时的执行情况是什么样的？\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的存贷比：\x27\x3c\/span\x3e, divisor)\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e请问会计师会重新计算数值么？此时这套系统的执行情况又会是怎么样的呢？\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e参考答案提示\x3c\/strong\x3e：会计师此时执行 \x3cstrong\x3e轻量级计算模式\x3c\/strong\x3e。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader17\x22\x3e5、小结\x3c\/h2\x3e\n\x3cp\x3e此篇文章讲解 MobX 中 \x3cstrong\x3e计算值\x3c\/strong\x3e （computedValue） 的概念，类比故事中的会计师角色。总结一下 \x3cstrong\x3e计算值\x3c\/strong\x3e （computedValue）的特征：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e计算值是基于现有状态或其他计算值衍生出的数值，一般是通过 \x3cstrong\x3e纯函数\x3c\/strong\x3e 的方式衍生而得。\x3c\/li\x3e\n\x3cli\x3e一旦观察值更改之后，计算值是能够重新执行计算，不过并非立即执行，而是 \x3cstrong\x3e惰性\x3c\/strong\x3e 的 ———— 只有在必要的时候才会执行计算。\x3c\/li\x3e\n\x3cli\x3e对观察值而言，计算值和 \x3ccode\x3eautorun\x3c\/code\x3e（或\x3ccode\x3ereaction\x3c\/code\x3e） 很像，之所以相似是在 \x3cstrong\x3e执行任务\x3c\/strong\x3e 时都涉及到调用 \x3ccode\x3etrackDerivedFunction\x3c\/code\x3e 方法；而对 \x3ccode\x3eautorun\x3c\/code\x3e（或\x3ccode\x3ereaction\x3c\/code\x3e）而言，计算值和观察值很相，都是数据提供者。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e正如 \x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/computed-decorator.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e官方文档\x3c\/a\x3e 而言，计算值是高度优化过的，所以尽可能应用他们。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdFR?w=800\x26amp;h=421\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdFR?w=800\x26amp;h=421\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e下一篇文章将探讨 MobX 中与 \x3ccode\x3eautorun\x3c\/code\x3e 和 \x3ccode\x3ecomputed\x3c\/code\x3e 相关的计算性能优化的机制，看看 MobX 如何平衡复杂场景下状态管理时的效率和性能。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>【用故事解读 MobX源码（二）】 computed</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000014238836">https://segmentfault.com/a/1190000014238836</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/f4myl7767yl/" target="_blank">https://alili.tech/archive/f4myl7767yl/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>