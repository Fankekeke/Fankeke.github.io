<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="【用故事解读 MobX源码（一）】 autorun"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>【用故事解读 MobX源码（一）】 autorun | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/g56pd1r6omk/",
				"appid": "1613049289050283", 
				"title": "【用故事解读 MobX源码（一）】 autorun | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-10T02:30:08"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/d9gv17x8eli/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/2vknppsxd7d/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f&text=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f&text=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f&is_video=false&description=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg56pd1r6omk%2f&title=%e3%80%90%e7%94%a8%e6%95%85%e4%ba%8b%e8%a7%a3%e8%af%bb%20MobX%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%80%ef%bc%89%e3%80%91%20autorun"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">【用故事解读 MobX源码（一）】 autorun</h1><div class="meta"><div class="postdate"><time datetime="2018-12-10" itemprop="datePublished">2018-12-10</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e\x3cstrong\x3e================前言===================\x3c\/strong\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cstrong\x3e初衷\x3c\/strong\x3e：网上已有很多关于 MobX 源码解读的文章，但大多阅读成本甚高。本人在找文章时对此深有体会，故将以系列故事的方式展现源码逻辑，尽可能以易懂的方式讲解 MobX 源码；\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e\x3cstrong\x3e本系列文章\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000013682735\x22\x3e【用故事解读 MobX源码（一）】 autorun\x3c\/a\x3e》\x3c\/li\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000014238836\x22 target=\x22_blank\x22\x3e【用故事解读 MobX源码（二）】 computed\x3c\/a\x3e》\x3c\/li\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000014726483\x22\x3e【用故事解读 MobX源码（三）】 shouldCompute\x3c\/a\x3e》\x3c\/li\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000015481998\x22 target=\x22_blank\x22\x3e【用故事解读 MobX 源码（四）】装饰器 和 Enhancer\x3c\/a\x3e》\x3c\/li\x3e\n\x3cli\x3e《\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000015875144\x22\x3e【用故事解读 MobX 源码（五）】 Observable\x3c\/a\x3e》\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cstrong\x3e文章编排\x3c\/strong\x3e：每篇文章分成两大段，第一大段以简单的侦探系列故事的形式讲解（\x3cstrong\x3e所涉及人物、场景都以 MobX 中的概念为原型创建\x3c\/strong\x3e），第二大段则是相对于的源码讲解。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e本文基于 MobX 3 源码讲解\x3c\/strong\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cstrong\x3e=======================================\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader0\x22\x3eA. Story Time\x3c\/h1\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e1、 场景\x3c\/h2\x3e\n\x3chr\x3e\n\x3cp\x3e\x3cstrong\x3e场景\x3c\/strong\x3e：\x3cbr\x3e一位名为 \x3cstrong\x3e张三\x3c\/strong\x3e 的银行用户账户情况为：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e账户存款为 3（万元）\x3c\/li\x3e\n\x3cli\x3e信用借贷为 2（万元）\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e你作为警署最高长官，在一起金融犯罪中认定 \x3cstrong\x3e张三\x3c\/strong\x3e 为金融犯罪嫌疑犯，想自动化跟踪这位用户的储蓄情况，比如他一旦银行存款有变更就打印出他当前的账户存款\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3e为了实现这个任务，你下发命令给你的执行官（MobX）：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var bankUser = mobx.observable({\n  name: \x27张三\x27,\n  income: 3,\n  debit: 2\n});\n\nmobx.autorun(() =\x3e {\n  console.log(\x27张三的账户存款:\x27, bankUser.income);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e bankUser = mobx.observable({\n  \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27张三\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eincome\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3edebit\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\n});\n\nmobx.autorun(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的账户存款:\x27\x3c\/span\x3e, bankUser.income);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981309?w=600\x26amp;h=431\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981309?w=600\x26amp;h=431\x22 alt=\x22start\x22 title=\x22start\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e执行官拿着这几行代码开始部署警力来完成你下发的指令，并将这次行动命名为 \x3cstrong\x3eA计划\x3c\/strong\x3e （是不是很酷？??）。你所要做的，就是等执行官 MobX 执行行动部署完毕之后，坐在办公室里一边惬意地喝着咖啡，一边在电脑上观察张三账户的存款变化。\x3c\/p\x3e\n\x3cp\x3e执行官部署完毕后，首先会立即打印出 \x3cstrong\x3e张三的账户存款: 3\x3c\/strong\x3e \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013682741?w=548\x26amp;h=132\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013682741?w=548\x26amp;h=132\x22 alt=\x22income\x22 title=\x22income\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e后续张三的账户存款有更改的话，会 \x3cstrong\x3e自动执行该部署方案\x3c\/strong\x3e，控制台里就自动打印其存款；\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 更改账户存款\nbankUser.income = 4;\nbankUser.income = 10;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 更改账户存款\x3c\/span\x3e\nbankUser.income = \x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e;\nbankUser.income = \x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013682742?w=379\x26amp;h=115\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013682742?w=379\x26amp;h=115\x22 alt=\x22autorun\x22 title=\x22autorun\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981310?w=600\x26amp;h=343\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981310?w=600\x26amp;h=343\x22 alt=\x22income\x22 title=\x22income\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e是不是很神奇很自动化？\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e2、 部署方案\x3c\/h2\x3e\n\x3cp\x3e作为警署最高长官，你不必事必躬亲过问执行官（MobX）部署的细节，只要等着要结果就可以。\x3c\/p\x3e\n\x3cp\x3e而作为执行官（MobX），你得知道 \x3cstrong\x3eA计划\x3c\/strong\x3e 中部署方案的每一步细节。下面我们来一探究竟执行官 MobX 到底是如何部署 \x3cstrong\x3eA计划\x3c\/strong\x3e 的。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e2.1、 组织架构\x3c\/h3\x3e\n\x3cp\x3e执行官（MobX） 拥有一套成熟的运作机构组织支撑任务的执行。为了执行这项任务，涉及到 2 类职员和 1 个数据情报室：\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\n\x3cstrong\x3e观察员\x3c\/strong\x3e：其工作职责是观察并监督嫌疑人特定信息，比如这里，监视张三的收入（\x3ccode\x3eincome\x3c\/code\x3e）属性，当这项特征有变更的时候，及时向上级汇报（并执行特定的操作）；\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981311?w=59\x26amp;h=100\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981311?w=59\x26amp;h=100\x22 alt=\x22observer\x22 title=\x22observer\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\n\x3cstrong\x3e探长\x3c\/strong\x3e：一方面负责管理划归给他的 \x3cstrong\x3e观察员\x3c\/strong\x3e，整合观察员反馈的资讯；另一方面接受 MobX 执行官交给他的任务，在 \x3cstrong\x3e适当的时机\x3c\/strong\x3e 执行这项任务（此任务是打印张三的存款）；\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981312?w=50\x26amp;h=100\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981312?w=50\x26amp;h=100\x22 alt=\x22tanzhang\x22 title=\x22tanzhang\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e此外还会架设一个 \x3cstrong\x3e数据情报室\x3c\/strong\x3e，方便执行官 MobX、探长和观察员们 互相通过情报室进行数据信息的交换。\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981313?w=100\x26amp;h=81\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981313?w=100\x26amp;h=81\x22 alt=\x22room\x22 title=\x22room\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e具体组织架构关系图如下：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981314?w=800\x26amp;h=418\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981314?w=800\x26amp;h=418\x22 alt=\x22structor\x22 title=\x22structor\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e按照组织架构，执行官 MobX 分解计划细节并安排人员如下：\x3c\/p\x3e\n\x3cp\x3e1.明确此次任务是 \x3cstrong\x3e当张三账户存款变更时，打印其存款\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22() =\x3e {\n  console.log(\x27张三的账户存款:\x27, bankUser.income);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs autoit\x22\x3e\x3ccode class=\x22c\x22\x3e() =\x26gt; {\n  console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的账户存款:\x27\x3c\/span\x3e, bankUser.income)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e2.将任务指派给执行组中的探长 R1\x3cbr\x3e 3.派遣观察组中的观察员 O1 监察张三账户的 \x3ccode\x3ebankUser.income\x3c\/code\x3e 属性\x3cbr\x3e 4.探长 R1 任务中所需的“张三的账户存款” 数值必须从观察员 O1 那儿获取；\x3cbr\x3e 5.同时架设数据情报室，方便信息交换；\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e2.2、 部署细节\x3c\/h3\x3e\n\x3cp\x3e人员安排完毕，执行官拿出一份 \x3cstrong\x3e部署方案书\x3c\/strong\x3e，一声令下 “各位就按这套方案执行任务吧！”；\x3c\/p\x3e\n\x3cp\x3e在部署方案中下达之后，机构各组成员各司其职，开始有条不紊地开始运作，具体操作时序图如下所示：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013682748?w=1849\x26amp;h=2627\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013682748?w=1849\x26amp;h=2627\x22 alt=\x22detail\x22 title=\x22detail\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e对时序图中的关键点做一下解释：\x3c\/p\x3e\n\x3col\x3e\x3cli\x3e\n\x3cp\x3e执行官 MobX 先将探长 R1 信息注册到中心情报室；（有些情况下，比如侦破大案要案时需要多位探长协作，将存在多位探长同时待命的情况；当然此次任务中，只有探长 R1 在待命）\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e中心情报室给执行官 MobX  返回所有待命探长列表（此例中仅有探长 R1）；\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e执行官 MobX 挨个让每位待命探长按以下步骤操作：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e3.1. 探长出发做任务时，记得给中心情报室通告一声，好比上班“打卡”操作。（记录事务序号，好让中心情报室知晓案情复杂度；有些案件中将有很多探长同时执行任务）\x3c\/li\x3e\n\x3cli\x3e3.2 探长 R1 开始监督并执行 MobX 交给他的任务（“打印张三的存款”）\x3c\/li\x3e\n\x3cli\x3e3.3 首先在数据情报室中“注册”，将自己设置成 \x3cstrong\x3e正在执勤人员\x3c\/strong\x3e；（这一步很重要）\x3c\/li\x3e\n\x3cli\x3e3.4 随后真正进入执行任务的状态\x3c\/li\x3e\n\x3cli\x3e3.5 在执行任务的时候，发现需要张三的存款（\x3ccode\x3eincome\x3c\/code\x3e）这个数值，可这个数值探长 R1 不能直接获取，\x3cstrong\x3e必须通过观察员 O1 取得\x3c\/strong\x3e，于是通过专用通讯机和观察员 O1 取得联系，请求获取要张三的存款（\x3ccode\x3eincome\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e3.6 观察员 O1 发现有人通过专用通讯机请求张三的存款（\x3ccode\x3eincome\x3c\/code\x3e），就开始如下操作：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e3.6.1 将自己的信息 \x3cstrong\x3e经过 数据情报室\x3c\/strong\x3e，然后传达给请求方；只有上级（不一定是探长，有可能是其他的上级领导）才能通过这个专用通讯机发消息给观察员；\x3c\/li\x3e\n\x3cli\x3e3.6.2 \x3cstrong\x3e数据情报室\x3c\/strong\x3e 将该信息同步给 \x3cstrong\x3e正在执勤人员\x3c\/strong\x3e —— 即探长 R1\x3c\/li\x3e\n\x3cli\x3e3.6.3 同时将张三的存款（\x3ccode\x3eincome\x3c\/code\x3e）返回给请求方；（该消息不用经过 \x3cstrong\x3e数据情报室\x3c\/strong\x3e）\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e3.7 此时探长拥有两份信息：任务所需要的张三的存款（\x3ccode\x3eincome\x3c\/code\x3e），以及观察员 O1 的相关信息；因时间紧，执行任务优先级高，探长 R1 先拿着张三的存款（\x3ccode\x3eincome\x3c\/code\x3e）数据，先做完任务。（至于观察员 O1 的信息 \x3cstrong\x3e先临时保存\x3c\/strong\x3e ，方便后续处理）；\x3c\/li\x3e\n\x3cli\x3e3.8 等到任务执行完了，探长松了一口气，汇总并整理临时保存的观察员信息；\x3cstrong\x3e在这一阶段，探长 R1 才和 观察员 O1 互相建立牢固的关系（可以理解为，互留联系方式，可随时联系得上对方），也是在这个时候，观察员 O1 才知晓其上级领导是探长 01\x3c\/strong\x3e；\x3c\/li\x3e\n\x3cli\x3e3.9 此后，探长 R1 发消息告知中心情报室，削去此次事务（说明事务执行完了），好比下班 “打卡”操作。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e至此 A 计划部署完毕\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3c\/li\x3e\x3c\/ol\x3e\n\x3cp\x3e上述时序图中有些地方需要强调一下：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e张三的存款（\x3ccode\x3eincome\x3c\/code\x3e）只归观察员 O1 监视，探长 R1 所获取的张三的存款只能通过观察员 O1 \x3cstrong\x3e间接获取到\x3c\/strong\x3e，探长不能越权去直接获取；\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e探长 R1 和观察员 O1 建立关系并非一步到位，是 \x3cstrong\x3e分两个阶段\x3c\/strong\x3e 的：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e第一阶段（对应上述步骤中 3.6.2）是在执行任务期间，仅仅是建立短暂的 \x3cstrong\x3e单向关系\x3c\/strong\x3e；\x3cstrong\x3e即，此时探长 R1 知晓观察员 O1 的情况，但反过来，但观察员 O1 并不知晓探长 R1 ；\x3c\/strong\x3e\n\x3c\/li\x3e\n\x3cli\x3e第二阶段（对应上述步骤中 3.8）在任务执行完，收尾阶段的时候，探长才有时间梳理、整合任务期间的探员信息（因为任务中涉及到有可能多个观察员，当然此次任务中只有 1 个），那时候才有时间 \x3cstrong\x3e慢慢地\x3c\/strong\x3e 和各位探员互相交换信息，建立 \x3cstrong\x3e明确且牢固\x3c\/strong\x3e 的关系；\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e2.3、 任务执行自动化\x3c\/h3\x3e\n\x3cp\x3e作为警署最高长官的你，拿着这份部署方案，眉头紧锁：“我说执行官 ，就为了区区获取张三的存款这么件事儿，耗费那么多人力资源，值么？直接获取 \x3ccode\x3ebankUser.income\x3c\/code\x3e 不就行了？！”\x3c\/p\x3e\n\x3cp\x3e“emm...，这所做的努力，图的是普适性和 \x3cstrong\x3e自动化响应\x3c\/strong\x3e。”执行官 MobX 淡然自如，不紧不慢徐徐道来，“有了上面那套机制，一方面每当张三的存款变更后，就会 \x3cstrong\x3e自动化执行上述部署方案的过程\x3c\/strong\x3e；另一方面很方便扩展，后续针对其他监察，只需要在此部署方案中稍加改动就可以，所需要的高级功能都是基于这个方案做延伸。真正做到了 ’部署一次，全自动化执行‘ 的目的。“\x3c\/p\x3e\n\x3cp\x3e随后，执行官 MobX 给出一张当张三存款发生变化之时，此机构的运作时序图；\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981315?w=766\x26amp;h=511\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981315?w=766\x26amp;h=511\x22 alt=\x22auto\x22 title=\x22auto\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x22的确，小机构靠人力运作，大机构才靠制度运转。那就先试运行这份部署计划，看它能否经受得起时间的考验吧。\x22 警署最高长官拍拍执行官 MobX 的肩膀，若有所思地踱步出了办公室。\x3c\/p\x3e\n\x3cp\x3e（此节完。未完待续）\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader6\x22\x3eB. Source Code Time\x3c\/h1\x3e\n\x3cp\x3e上面讲那么久的故事，是为了给讲源码做铺垫。\x3c\/p\x3e\n\x3cp\x3e接下来将会贴 MobX 源码相关的代码，稍显枯燥，我只能尽量用通俗易懂的话来分析讲解。\x3c\/p\x3e\n\x3cp\x3e先罗列本文故事中人物与 MobX 源码概念映射关系：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth\x3e故事人物\x3c\/th\x3e\n\x3cth\x3eMobX 源码\x3c\/th\x3e\n\x3cth\x3e解释\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\n\x3ctr\x3e\n\x3ctd\x3e警署最高长官\x3c\/td\x3e\n\x3ctd\x3e(无)\x3c\/td\x3e\n\x3ctd\x3eMobX 用户，没错，就是你\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3e执行官 MobX\x3c\/td\x3e\n\x3ctd\x3eMobX\x3c\/td\x3e\n\x3ctd\x3e整个 MobX 运行环境\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3eA计划\x3c\/td\x3e\n\x3ctd\x3e\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/api\/autorun.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eautorun\x3c\/a\x3e\x3c\/td\x3e\n\x3ctd\x3e官方文档 -\x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/autorun.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3emobx.autorun\x3c\/a\x3e方法\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3e探长\x3c\/td\x3e\n\x3ctd\x3e\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/core\/reaction.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ereaction\x3c\/a\x3e\x3c\/td\x3e\n\x3ctd\x3e官方文档 - \x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/extending.html#reactions%E5%8F%8D%E5%BA%94\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eReaction 响应对象\x3c\/a\x3e\n\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3e观察员\x3c\/td\x3e\n\x3ctd\x3e\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/core\/observable.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eobservable\x3c\/a\x3e\x3c\/td\x3e\n\x3ctd\x3e官方文档 - \x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/observable.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eObservable 对象\x3c\/a\x3e\n\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3e数据情报室\x3c\/td\x3e\n\x3ctd\x3e\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/globalstate.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eglobalstate\x3c\/a\x3e\x3c\/td\x3e\n\x3ctd\x3eMobX 运行环境中的 ”全局变量“，不同对象通过它进行数据传递通信，十分重要；（但这其实在一定程度上破坏了内聚性，给源码阅读、程序 debug 造成一定的难度）\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981316?w=800\x26amp;h=354\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981316?w=800\x26amp;h=354\x22 alt=\x22reflect\x22 title=\x22reflect\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e本文的重点是讲解 A 计划所对应的 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/api\/autorun.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eautorun\x3c\/a\x3e 的源码，先从整体上对 MobX 的运行有个大致了解，而所涉及到的 \x3ccode\x3eReaction\x3c\/code\x3e、\x3ccode\x3eObservable\x3c\/code\x3e 等细节概念后续章节再做展开，这里仅仅大致提及其部分功能和属性；\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e1、下达的命令\x3c\/h2\x3e\n\x3cp\x3e回到故事的最开始，你给 MobX 下达的命令如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var bankUser = mobx.observable({\n  name: \x27张三\x27,\n  income: 3,\n  debit: 2\n});\n\nmobx.autorun(() =\x3e {\n  console.log(\x27张三的账户存款:\x27, bankUser.income);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e bankUser = mobx.observable({\n  \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27张三\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eincome\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3edebit\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\n});\n\nmobx.autorun(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的账户存款:\x27\x3c\/span\x3e, bankUser.income);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e只有两条语句，第一条语句是创建观察员，第二条语句是执行 A 计划（内含委派探长、架设情报局等工作）\x3c\/p\x3e\n\x3cp\x3e我们挨个细分讲解。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e1.1、第一条语句：创建观察员 - Observable\x3c\/h3\x3e\n\x3cp\x3e第一条语句：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const bankUser = mobx.observable({\n  name: \x27张三\x27,\n  income: 3,\n  debit: 2\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e bankUser = mobx.observable({\n  \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27张三\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eincome\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3edebit\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们调用 \x3ccode\x3emobx.observable\x3c\/code\x3e 的时候，就创建了 \x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/observable.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eObservable 对象\x3c\/a\x3e，对象的所有属性都将被拷贝至一个克隆对象并将克隆对象转变成可观察的。\x3c\/p\x3e\n\x3cp\x3e因此这一行代码执行后， \x3ccode\x3ename\x3c\/code\x3e、\x3ccode\x3eincome\x3c\/code\x3e 和 \x3ccode\x3edebit\x3c\/code\x3e 这三个属性都变成可观察的；\x3c\/p\x3e\n\x3cp\x3e若以故事场景来叙述中，执行官 MobX 在部署的时候委派了 3 位探员，分别监视这 3 个属性；而故事中交给探长任务中仅仅涉及了那位监视 \x3ccode\x3eincome\x3c\/code\x3e 属性的观察员 O1；（所以另外两位探员都还在休息）\x3c\/p\x3e\n\x3cblockquote\x3e在这里可以看到 \x3cstrong\x3e惰性求值\x3c\/strong\x3e 的思想的应用，只有在 \x3cstrong\x3e必要的时候\x3c\/strong\x3e 启用 \x3cstrong\x3e所观察对象\x3c\/strong\x3e，粒度细，有利于性能提升；\x3c\/blockquote\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981317?w=128\x26amp;h=200\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981317?w=128\x26amp;h=200\x22 alt=\x22o1\x22 title=\x22o1\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e之所以只有 1 位观察员，是因为由于上级下达的具体任务内容是：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22() =\x3e {\n  console.log(\x27张三的账户存款:\x27, bankUser.income);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e() =\x26gt; {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的账户存款:\x27\x3c\/span\x3e, bankUser.income);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e看看任务中出现 \x3ccode\x3ebankUser.income\x3c\/code\x3e 而并没有出现 \x3ccode\x3ebankUser.debit\x3c\/code\x3e 和 \x3ccode\x3ebankUser.name\x3c\/code\x3e，说明这个任务只 \x3cstrong\x3e牵连\x3c\/strong\x3e 探员O1，而和其他探员无关。\x3c\/p\x3e\n\x3cblockquote\x3e注：本文暂时先不分析 \x3ccode\x3emobx.observable\x3c\/code\x3e 的源码，留待后续专门的一章来分析；迫不及待的读者，可以先阅读网上其他源码文章，比如：\x3ca href=\x22https:\/\/zhuanlan.zhihu.com\/p\/31705632\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMobx 源码解读（二） Observable\x3c\/a\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e观察员有两个非常重要的行为特征：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e当有人请求观察员所监控的值（比如\x3ccode\x3eincome\x3c\/code\x3e）时，会触发 MobX 所提供的 \x3ccode\x3ereportObserved\x3c\/code\x3e 方法；\x3c\/li\x3e\n\x3cli\x3e当观察员所监控的值（比如\x3ccode\x3eincome\x3c\/code\x3e）发生变化时，会触发 MobX 所提供的 \x3ccode\x3epropagateChanged\x3c\/code\x3e 方法；\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e这里留一个印象，本文后续在适当的时机再讲解这两个方法是在什么时候触发的；\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e1.2、第二条语句：A 计划的实施 - \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/api\/autorun.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eautorun\x3c\/a\x3e\n\x3c\/h3\x3e\n\x3cp\x3e第二条语句：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22mobx.autorun(() =\x3e {\n  console.log(\x27张三的账户存款:\x27, bankUser.income);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3emobx.autorun(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的账户存款:\x27\x3c\/span\x3e, bankUser.income);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里出现的 MobX 中的 \x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/autorun.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3emobx.autorun\x3c\/a\x3e 方法对应故事中的 \x3cstrong\x3e整个A计划的实施\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981318?w=400\x26amp;h=214\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981318?w=400\x26amp;h=214\x22 alt=\x22autorun\x22 title=\x22autorun\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3eautorun 的直观含义就是 \x3cstrong\x3e响应式函数\x3c\/strong\x3e —— 响应观察值的变化而自动执行指定的函数。\x3c\/p\x3e\n\x3cp\x3e我们看一下其源码：\x3c\/p\x3e\n\x3cblockquote\x3e附源码位置：\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/api\/autorun.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eautorun\x3c\/a\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000015981319?w=800\x26amp;h=423\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000015981319?w=800\x26amp;h=423\x22 alt=\x22autorun\x22 title=\x22autorun\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e从这里可以看出 autorun 大致的脉络如下：\x3c\/p\x3e\n\x3cp\x3e① \x3cstrong\x3e首先创建 Reaction 类型对象\x3c\/strong\x3e。\x3ccode\x3enew Reaction\x3c\/code\x3e 操作可以理解为创建探长 R1 ；\x3c\/p\x3e\n\x3cp\x3e探长对应的类是  \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/core\/reaction.ts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eReaction\x3c\/a\x3e，其关键特征是 \x3cstrong\x3e监督并控制任务的执行\x3c\/strong\x3e；\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdDb?w=122\x26amp;h=200\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdDb?w=122\x26amp;h=200\x22 alt=\x22reaction\x22 title=\x22reaction\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e本文的下一节将详细介绍探长们的 \x22生活日常\x22，此处先放一放。\x3c\/p\x3e\n\x3cp\x3e② \x3cstrong\x3e其次分配任务\x3c\/strong\x3e。源码中所涉及到的 \x3ccode\x3eview()\x3c\/code\x3e 方法 就是具体的任务内容，即上述故事中的 \x3cstrong\x3e打印张三账户存款\x3c\/strong\x3e 这项任务：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22() =\x3e {\n  console.log(\x27张三的账户存款:\x27, bankUser.income);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e() =\x26gt; {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27张三的账户存款:\x27\x3c\/span\x3e, bankUser.income);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e③ 最后,\x3cstrong\x3e立即执行一次部署方案\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e代码中的 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/reaction.ts#L77\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ereaction.schedule()\x3c\/a\x3e  表示让探长 R1 立即执行执行一次部署任务，\x3cstrong\x3e执行的结果是完成人员部署，并让探长 R1 打印了一次张三账户存款\x3c\/strong\x3e；（同时和观察员 O1 建立关系）\x3c\/p\x3e\n\x3cp\x3e现在你应该会理解\x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/autorun.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e官方文档\x3c\/a\x3e中的那句 ”使用 autorun 时，所提供的函数总是\x3cstrong\x3e立即被触发一次\x3c\/strong\x3e“ 话了。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdDJ?w=800\x26amp;h=406\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdDJ?w=800\x26amp;h=406\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e看一下 schedule 方法：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdDS?w=800\x26amp;h=226\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdDS?w=800\x26amp;h=226\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e看上去很简单，不到 5 行代码做了两件事情：\x3cbr\x3e ① 将探长入列；\x3cbr\x3e ② 让队列中的 \x3cstrong\x3e所有探长\x3c\/strong\x3e（当然，在我们的示例中仅仅只有 1 名探长）都执行 \x3ccode\x3erunReaction\x3c\/code\x3e 方法\x3c\/p\x3e\n\x3cp\x3e对应时序图中所标注的 1、2 两部分：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdDW?w=800\x26amp;h=267\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdDW?w=800\x26amp;h=267\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e所谓的 \x3cstrong\x3e部署\x3c\/strong\x3e（schedule） 就是敦促 \x3cstrong\x3e各位探长执行 \x3ccode\x3erunReaction\x3c\/code\x3e 方法\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e第二条语句从整体上看就这样了。\x3c\/p\x3e\n\x3cp\x3e接下来就让我们来详细分析探长的 \x3ccode\x3erunReaction\x3c\/code\x3e 的方法，在该方法中 \x3cstrong\x3e探长将联动观察员、数据情报室一起在部署方案中发挥监督、自动化响应功能\x3c\/strong\x3e。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader10\x22\x3e2、每位探长的生活日常\x3c\/h2\x3e\n\x3cp\x3e任务的执行全靠探长，不过探长的存在常常是 \x3cstrong\x3e依赖观察员\x3c\/strong\x3e 的，这是因为在任务过程中，\x3cstrong\x3e如果想要获取所监视的张三的存款（\x3ccode\x3eincome\x3c\/code\x3e），必须通过观察员获取，自身是没有权力绕过观察员直接获取的哦\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e每位探长的任务执行流大致如下：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdD3?w=800\x26amp;h=561\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdD3?w=800\x26amp;h=561\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3cbr\x3e主流程大致只有 4 步：\x3cbr\x3e ① 开始执行（\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/core\/reaction.ts#L92\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3erunReaction\x3c\/a\x3e）\x3cbr\x3e ② 判断是否执行（\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/derivation.ts#L77\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eshouldCompute\x3c\/a\x3e）\x3cbr\x3e ③ 执行任务（onInvalidate）\x3cbr\x3e ④ 结束\x3c\/p\x3e\n\x3cp\x3e这些基就是每位探长的生活的总体了。下面我们挑其中的第 ① 、 ③ 步来讲解。\x3c\/p\x3e\n\x3cblockquote\x3e其实图中另外有一个很重要的 \x3cstrong\x3e\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/derivation.ts#L77\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eshouldCompute\x3c\/a\x3e\x3c\/strong\x3e 判断方法步骤，根据这个方法探长可以自行判断 \x3cstrong\x3e是否执行任务\x3c\/strong\x3e，并非所有的任务都需要执行，这一步的作用是优化 MobX 执行效率。该方法源码内容先略过，后续章节再展开。\x3c\/blockquote\x3e\n\x3ch3 id=\x22articleHeader11\x22\x3e2.1、开始执行 - \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/master\/src\/core\/reaction.ts#L92\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3erunReaction\x3c\/a\x3e\n\x3c\/h3\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdD7?w=800\x26amp;h=422\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdD7?w=800\x26amp;h=422\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e该函数比较简单，主要是为执行任务 ”做一些准备“，给任务营造氛围。用 \x3ccode\x3estartBatch()\x3c\/code\x3e 开头，用 \x3ccode\x3eendBatch()\x3c\/code\x3e 结尾，中间隔着 \x3ccode\x3eonInvalidate\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3estartBatch()\x3c\/code\x3e 和 \x3ccode\x3eendBatch()\x3c\/code\x3e 这两个方法一定是成对出现，用于影响 \x3ccode\x3eglobalState\x3c\/code\x3e 的 \x3ccode\x3einBatch\x3c\/code\x3e 属性，表明开启\/关闭 \x3cstrong\x3e一层新的事务\x3c\/strong\x3e，可以理解为 \x3cstrong\x3e上下班打卡\x3c\/strong\x3e 操作。\x3c\/p\x3e\n\x3cp\x3e只不过 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/observable.ts#L122\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3estartBatch()\x3c\/a\x3e 是 ”上班打卡“，对应时序图（3.1) 部分：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdD9?w=800\x26amp;h=88\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdD9?w=800\x26amp;h=88\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/observable.ts#L126\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eendBatch()\x3c\/a\x3e 相当于 “下班打卡”，不过稍微复杂一些，包含一些 \x3cstrong\x3e收尾\x3c\/strong\x3e 操作，对应时序图（3.9）部分：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEb?w=787\x26amp;h=82\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEb?w=787\x26amp;h=82\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e我们继续看隔在中间的 \x3ccode\x3eonInvalidate\x3c\/code\x3e 方法。?\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader12\x22\x3e2.2、执行任务 - onInvalidate\x3c\/h3\x3e\n\x3cp\x3e此阶段是流程中最重要的阶段。\x3c\/p\x3e\n\x3cp\x3e你翻看源码，将会发现此方法 \x3ccode\x3eonInvalidate\x3c\/code\x3e 是 Reaction 类的一个属性，且在初始化 Reaction 时传入到构造函数中的，这样做的目的是方便做扩展。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e所以，autorun 方法本质就是一种预定义好的 Reaction\x3c\/strong\x3e —— 你可以依葫芦画瓢，将自定义 \x3ccode\x3eonInvalidate\x3c\/code\x3e 方法传给 \x3cstrong\x3eReaction\x3c\/strong\x3e 来实现自己的 \x3cstrong\x3e计划任务\x3c\/strong\x3e（什么 \x3cstrong\x3eZ计划\x3c\/strong\x3e啊、\x3cstrong\x3e阿波罗计划\x3c\/strong\x3e啊，名字都起好了，就差实现了！！....）；\x3c\/p\x3e\n\x3cp\x3e回过头来，在刚才所述的 autorun 源码中找到 Reaction 类初始化部分：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const reaction = new Reaction(name, function() {\n    this.track(reactionRunner)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e reaction = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Reaction(name, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.track(reactionRunner)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e可以看到 \x3cstrong\x3eonInvalidate\x3c\/strong\x3e 方法就是：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function() {\n    this.track(reactionRunner)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.track(reactionRunner)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这就不难理解 \x3ccode\x3eonInvalidate\x3c\/code\x3e 实际执行的是 \x3ccode\x3ereaction.track\x3c\/code\x3e 方法。\x3c\/p\x3e\n\x3cp\x3e继续跟踪源码，会发现该 \x3ccode\x3eonInvalidate\x3c\/code\x3e 阶段主要是由 3 个很重要的子流程所构成：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e3.1 跟踪任务（\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/reaction.ts#L112\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3etrack\x3c\/a\x3e）\x3c\/li\x3e\n\x3cli\x3e3.2 执行任务（\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/derivation.ts#L131\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3etrackDerivedFunction\x3c\/a\x3e）\x3c\/li\x3e\n\x3cli\x3e3.3 更新依赖（\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/derivation.ts#L156\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ebindDependencies\x3c\/a\x3e）\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e这 3 个函数并非是并行关系，而是嵌套关系，后者是嵌套在前者内执行的：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEc?w=507\x26amp;h=448\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEc?w=507\x26amp;h=448\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e题外话：是不是很像 Koa 的 \x3ca href=\x22https:\/\/eggjs.org\/zh-cn\/intro\/egg-and-koa.html#middleware\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e洋葱圈模型\x3c\/a\x3e ？?\x3c\/blockquote\x3e\n\x3ch4\x3e2.2.1、\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/reaction.ts#L112\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3etrack\x3c\/a\x3e\n\x3c\/h4\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013682763?w=1374\x26amp;h=412\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013682763?w=1374\x26amp;h=412\x22 alt=\x22track\x22 title=\x22track\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3etrack 方法内容也简单，和刚才所说的 \x3cstrong\x3erunReaction\x3c\/strong\x3e 方法类似 —— 也是用 \x3ccode\x3estartBatch()\x3c\/code\x3e 开头，用 \x3ccode\x3eendBatch()\x3c\/code\x3e 结尾，中间隔着 \x3ccode\x3etrackDerivedFunction\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e所以在这个案例中，整个部署阶段是执行 \x3cstrong\x3e两次\x3c\/strong\x3e \x3ccode\x3estartBatch()\x3c\/code\x3e 和 \x3ccode\x3eendBatch()\x3c\/code\x3e 的；在往后复杂的操作中，执行的次数有可能更多。\x3c\/p\x3e\n\x3cp\x3e我们都知道数据库中的事务概念，其表示一组原子性的操作。Mobx 则借鉴了 \x3cstrong\x3e事务\x3c\/strong\x3e 这个概念，它实现比较简单，就是通过 \x3cstrong\x3e成对\x3c\/strong\x3e 使用 \x3ccode\x3estartBatch\x3c\/code\x3e 和 \x3ccode\x3eendBatch\x3c\/code\x3e 来开始和结束一个事务，用于批量处理 Reaction 的执行，避免不必要的重新计算。\x3c\/p\x3e\n\x3cp\x3e因此到目前这一步，MobX 程序正处在 \x3cstrong\x3e第二层\x3c\/strong\x3e 事务中。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEg?w=519\x26amp;h=481\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEg?w=519\x26amp;h=481\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3eMobX 暴露了 \x3ccode\x3etransaction\x3c\/code\x3e 这一底层 API 供用户调用，让用户能够实现一些较为高级的应用，具体可参考 \x3ca href=\x22http:\/\/cn.mobx.js.org\/refguide\/transaction.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e官方文档 - Transaction(事务)\x3c\/a\x3e 章节获取更多信息。\x3c\/p\x3e\n\x3cp\x3e接下来继续看隔在中间的 \x3ccode\x3etrackDerivedFunction\x3c\/code\x3e 方法。?\x3c\/p\x3e\n\x3ch4\x3e2.2.2、\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/derivation.ts#L131\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3etrackDerivedFunction\x3c\/a\x3e\n\x3c\/h4\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEq?w=800\x26amp;h=411\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEq?w=800\x26amp;h=411\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e我们总算到了探长 \x3cstrong\x3e真正执行任务\x3c\/strong\x3e 的步骤了，之前讲的所有流程都是为了这个函数服务的。\x3c\/p\x3e\n\x3cp\x3e该环节的第 1 条语句：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22globalState.trackingDerivation = derivation;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3eglobalState.trackingDerivation = derivation;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e对应时序图（3.3）：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEs?w=639\x26amp;h=95\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEs?w=639\x26amp;h=95\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e作用是将 \x3cstrong\x3ederivation\x3c\/strong\x3e （此处等同于 \x3ccode\x3ereaction\x3c\/code\x3e 对象）挂载到 ”全局变量“ \x3ccode\x3eglobalState\x3c\/code\x3e 的 \x3ccode\x3etrackingDerivation\x3c\/code\x3e 属性上，这样其他对象就能获取到该 \x3ccode\x3ederivation\x3c\/code\x3e 对象的数据了。这好比将探长在数据情报室中注册为 \x3cstrong\x3e正在执勤人员\x3c\/strong\x3e，后续观察员 O1 会向数据情报室索取 \x3cstrong\x3e正在执勤人员\x3c\/strong\x3e 人，然后将自身信息输送给他 —— 从结果上看，就相当于 \x3cstrong\x3e观察员 O1\x3c\/strong\x3e 直接和 \x3cstrong\x3e探长 R1\x3c\/strong\x3e 汇报；（之所以要经由数据情报室，是因为在执行任务时候，有可能其他工种的人也需要 \x3cstrong\x3e正在执勤人员\x3c\/strong\x3e 的信息）\x3c\/p\x3e\n\x3cp\x3e该环节的第 2 条语句：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22result = f.call(context); \/\/ 效果等同于 result = console.log(\x27张三的账户存款:\x27, bankUser.income);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3eresult = f.call(context); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 效果等同于 result = console.log(\x27张三的账户存款:\x27, bankUser.income);\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e对应时序图（3.4）:\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEx?w=603\x26amp;h=99\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEx?w=603\x26amp;h=99\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e没错，就是本次部署的 \x3cstrong\x3e终极目的\x3c\/strong\x3e —— 打印张三账户存款！\x3c\/p\x3e\n\x3cp\x3eMobX 将真正的目的执行之前里三层外三层地包裹其他操作，是为了将任务的运行情况\x3cstrong\x3e控制在自己营造的环境氛围中\x3c\/strong\x3e。为什么这么做呢？\x3c\/p\x3e\n\x3cp\x3e这么做是基于一个前提，该前提是：\x3cstrong\x3e所运行的任务 MobX 它无法控制（警署长官今天下达 A 命令，明天下达 B 命令，控制不了）\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e所以 MobX 就将任务的执行笼罩在自己所营造的氛围中，改变不了任务实体，我改变环境总行了吧？！！\x3c\/p\x3e\n\x3cp\x3e由于环境是自己营造的，MobX 可以为所欲为，在环境中穿插各种因素：探长、观察员、数据情报室等等（后续还有其他角色），这样就将任务的运行尽最大可能地控制在这套所创造的体系中 —— 孙猴子不也翻不出如来佛的五指山么？\x3c\/p\x3e\n\x3cp\x3e虽然更改不了任务内容，不过 MobX 实际在任务中安插观察员 O1 了，所以呢，当探长在执行任务时，将触发时序图中 （3.5）（3.6）两步反应：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEz?w=466\x26amp;h=203\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEz?w=466\x26amp;h=203\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e复杂么？也还好，（3.6）是由 （3.5）触发的，（3.5）对应的操作是：探长 R1 想要获取的张三 \x3cstrong\x3eincome\x3c\/strong\x3e 属性。\x3cbr\x3e（所以，划重点，敲黑板！！ 如果任务中不涉及到 \x3cstrong\x3eincome\x3c\/strong\x3e 这项属性，那么就不会有 （3.5）的操作，也就没有 （3.6）什么事）\x3c\/p\x3e\n\x3cp\x3e由于探长 R1 所执行的任务中用到 \x3ccode\x3ebankUser.income\x3c\/code\x3e 变量，这里的 \x3ccode\x3e.\x3c\/code\x3e 符号其实就是 \x3cstrong\x3eget()\x3c\/strong\x3e 操作；一旦涉及到 \x3cstrong\x3eget()\x3c\/strong\x3e 操作，监督这个 \x3ccode\x3eincome\x3c\/code\x3e 属性的观察员 O1 就会执行 \x3cstrong\x3e\x3ccode\x3ereportObserved\x3c\/code\x3e\x3c\/strong\x3e 方法。 该 \x3cstrong\x3e\x3ccode\x3ereportObserved\x3c\/code\x3e\x3c\/strong\x3e 方法对应的源码如下：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEB?w=800\x26amp;h=408\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEB?w=800\x26amp;h=408\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e那么多行代码，我们主要关注其中操作影响到探长（\x3ccode\x3ederivation\x3c\/code\x3e）中的操作：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3col\x3e\x3cli\x3e更新探长的 \x3ccode\x3elastAccessedBy\x3c\/code\x3e 属性（事务 id），这个是为了避免重复操作而设置的\x3c\/li\x3e\x3c\/ol\x3e\x3c\/li\x3e\n\x3cli\x3e\x3col\x3e\x3cli\x3e更新探长的 \x3ccode\x3enewObserving\x3c\/code\x3e 属性，将探员信息推入到该队列中（对应时序图 （3.6.2）操作），这个比较重要，\x3cstrong\x3e后续探长和观察员更新依赖关系就靠这个属性了\x3c\/strong\x3e；\x3c\/li\x3e\x3c\/ol\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e随后，任务执行完（时序图（3.7））后，探长就开始着手更新和观察员 O1 的关联关系了。?\x3c\/p\x3e\n\x3ch4\x3e2.2.3、\x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/derivation.ts#L156\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ebindDependencies\x3c\/a\x3e\n\x3c\/h4\x3e\n\x3cp\x3e探长 R1 整理和观察员的关系是在时序图 （3.8）处：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEE?w=679\x26amp;h=136\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEE?w=679\x26amp;h=136\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e两者依赖更新的算法在参考文章\x3ca href=\x22https:\/\/zhuanlan.zhihu.com\/p\/31706360\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMobx 源码解读（四） Reaction\x3c\/a\x3e 中有详细的注解，推荐阅读。这里也做一下简单介绍。\x3c\/p\x3e\n\x3cp\x3e该函数的目的，是用 \x3ccode\x3ederivation.newObserving\x3c\/code\x3e 去更新 \x3ccode\x3ederivation.observing\x3c\/code\x3e 属性：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3ccode\x3ederivation.newObserving\x3c\/code\x3e 就是刚才在所述时序图 （3.6.2）操作是生成的\x3c\/li\x3e\n\x3cli\x3e执行完之后 \x3ccode\x3ederivation.newObserving\x3c\/code\x3e 会置空，而 \x3ccode\x3ederivation.observing\x3c\/code\x3e 属性获得更新，该属性反映的 \x3cstrong\x3e探长\x3c\/strong\x3e 和 \x3cstrong\x3e观察员\x3c\/strong\x3e 之间最新的关联关系；\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e依赖更新肯定需要遍历，由于涉及到探长、观察员两个维度的数组，朴素算法的时间复杂度将是 \x3cstrong\x3eO(n^2)\x3c\/strong\x3e，而 MobX 中使用 3 次遍历  \x2b \x3ccode\x3ediffValue\x3c\/code\x3e 属性的辅助将复杂度降到了 \x3cstrong\x3eO(n)\x3c\/strong\x3e。? ?\x3c\/p\x3e\n\x3cp\x3e下面我用示例来展现这 3 次遍历过程。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e2.2.3.1、先看一下整体的 input \/ output\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e假设在执行 \x3ccode\x3ebindDependencies\x3c\/code\x3e 函数之前， \x3ccode\x3ederivation.observing\x3c\/code\x3e 已有 2 个元素，\x3ccode\x3ederivation.newObserving\x3c\/code\x3e 有 5 个对象（由于 A、B 各重复一次，实际只有 3 个不同的对象 A、B、C），经过 \x3ccode\x3ebindDependencies\x3c\/code\x3e 函数后 \x3ccode\x3ederivation.observing\x3c\/code\x3e 将获得更新，如下所示：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEH?w=680\x26amp;h=440\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEH?w=680\x26amp;h=440\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e2.2.3.2、第一次循环：\x3ccode\x3enewObserving\x3c\/code\x3e 数组去重\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e第一次循环遍历 \x3ccode\x3enewObserving\x3c\/code\x3e，利用 \x3ccode\x3ediffValue\x3c\/code\x3e 进行去重，一次遍历就完成了（这种 \x3cstrong\x3e数组去重算法\x3c\/strong\x3e 可以添加到面试题库中了??）。注意其中 \x3ccode\x3ediffValue\x3c\/code\x3e 改变情况：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEJ?w=783\x26amp;h=467\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEJ?w=783\x26amp;h=467\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e由于 A 对象（引用）既在 \x3ccode\x3eobserving\x3c\/code\x3e 数组也在 \x3ccode\x3enewObserving\x3c\/code\x3e 数组中，\x3cstrong\x3e当改变 \x3ccode\x3enewObserving\x3c\/code\x3e 中 A 元素的 \x3ccode\x3ediffValue\x3c\/code\x3e 值的时候，\x3ccode\x3eobserving\x3c\/code\x3e 数组 A 属性也自然跟着改变\x3c\/strong\x3e；\x3c\/blockquote\x3e\n\x3cp\x3e这次遍历后，所有 \x3cstrong\x3e最新的依赖\x3c\/strong\x3e 的 \x3ccode\x3ediffValue\x3c\/code\x3e 值都是 1 了哦，而且去除了所有重复的依赖。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e2.2.3.3、第二次循环：去除\x3ccode\x3eobserving\x3c\/code\x3e 数组陈旧关联\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e接下去第二次遍历针对 \x3cstrong\x3e\x3ccode\x3eobserving\x3c\/code\x3e 数组\x3c\/strong\x3e，做了两件事：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e如果对象的 \x3ccode\x3ediffValue\x3c\/code\x3e 值为 0 （为 0 说明不在 \x3ccode\x3enewObserving\x3c\/code\x3e 数组中，是陈旧的关联），则调用 \x3ccode\x3eremoveObserver\x3c\/code\x3e 去除该关联；因此这次遍历之后会删除 \x3ccode\x3eobserving\x3c\/code\x3e 数组中 \x3cstrong\x3eD 对象\x3c\/strong\x3e\n\x3c\/li\x3e\n\x3cli\x3e让 \x3ccode\x3eobserving\x3c\/code\x3e 数组中剩余对象的 \x3ccode\x3ediffValue\x3c\/code\x3e 值变成 0；\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEN?w=799\x26amp;h=447\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEN?w=799\x26amp;h=447\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这一次遍历之后，去除了所有陈旧的依赖，且遗留下来的对象的 \x3ccode\x3ediffValue\x3c\/code\x3e 值都是 0 了。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e2.2.3.4、第三次循环：将新增依赖添加到 \x3ccode\x3eobserving\x3c\/code\x3e\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e第二次遍历针对 \x3cstrong\x3e\x3ccode\x3enewObserving\x3c\/code\x3e 数组\x3c\/strong\x3e，做了一件事：\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e如果 \x3ccode\x3ediffValue\x3c\/code\x3e 为 1，说明是新增的依赖，调用 \x3ccode\x3eaddObserver\x3c\/code\x3e 新增依赖，并将 \x3ccode\x3ediffValue\x3c\/code\x3e 置为 0\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEP?w=800\x26amp;h=447\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEP?w=800\x26amp;h=447\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这最后一次遍历，\x3ccode\x3eobserving\x3c\/code\x3e 数组关联都是最新，且 \x3ccode\x3ediffValue\x3c\/code\x3e 都是 0 ，为下一次的 \x3ccode\x3ebindDependencies\x3c\/code\x3e 做好了准备。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e至此，A计划部署方案（autorun 源码）就讲完了。 A 计划执行后，探长 R1 完成上级下达的任务，同时也和观察员 O1 建立起明确且牢固的依赖\x3c\/strong\x3e。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader13\x22\x3e3、响应观察值的变化 - \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/observable.ts#L183\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3epropagateChanged\x3c\/a\x3e\n\x3c\/h2\x3e\n\x3cp\x3e一旦张三存款发生变化，那么一定会被观察员 O1 监视到，请问此时观察员会怎么做？\x3c\/p\x3e\n\x3cp\x3e或许有人会说，\x3cstrong\x3e观察员 O1 然后上报给探长 R1 ，然后让探长 R1 再执行一次打印任务\x3c\/strong\x3e；\x3c\/p\x3e\n\x3cp\x3e从最终结果角度去理解，上面的陈述其实没毛病，\x3cstrong\x3e的确是观察员 O1 驱动探长 R1 再打印一次\x3c\/strong\x3e；\x3c\/p\x3e\n\x3cp\x3e但若从执行过程角度去看，以上陈述是 \x3cstrong\x3e错误的\x3c\/strong\x3e！ ?\x3c\/p\x3e\n\x3cp\x3e观察员 O1 监视到变化之后，的确通知探长 R1了，\x3cstrong\x3e但探长并非直接执行任务，而是通知 MobX 再按照 A 计划部署方案执行一遍！\x3c\/strong\x3e；（不得不感慨，这是多么死板地执行机制）\x3c\/p\x3e\n\x3cp\x3e源码中是怎么体现的呢？\x3c\/p\x3e\n\x3cp\x3e上面提及到过，当观察员所监控的值（比如\x3ccode\x3eincome\x3c\/code\x3e）发生变化时，会触发 MobX 所提供的 \x3ccode\x3epropagateChanged\x3c\/code\x3e 方法。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3epropagateChanged\x3c\/code\x3e 对应的源码如下：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdES?w=800\x26amp;h=328\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdES?w=800\x26amp;h=328\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e代码很简单，即遍历观察员的上级们，让他们调用 \x3cstrong\x3eonBecomeStale()\x3c\/strong\x3e 方法 。该观察员有可能不止对一位上级（上级也不一定只有探长）负责，每位上级的 \x3cstrong\x3eonBecomeStale()\x3c\/strong\x3e 是不一样的。（当然，此故事中观察员 O1 只有 1 位上级 —— 探长 R1）\x3c\/p\x3e\n\x3cp\x3e我们看一下探长这类上级所定义的 \x3ca href=\x22https:\/\/github.com\/mobxjs\/mobx\/blob\/3.5.1\/src\/core\/reaction.ts#L73\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eonBecomeStale\x3c\/a\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22onBecomeStale() {\n        this.schedule()\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eonBecomeStale() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.schedule()\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e简单明了，就是直接 \x3cstrong\x3e再一次执行部署方案\x3c\/strong\x3e。如此简单朴素，真正做到了 “一视同仁” —— 无论什么任务，一旦部署就绪，任何观察员反馈情况有变（比如张三账户余额发生变动了），探长都是让 MobX 重新执行一遍部署方案，并不会直接执行任务，反正部署方案中有探长执行任务的步骤嘛。??\x3c\/p\x3e\n\x3cp\x3e所谓的流程化、设计模式，\x3cstrong\x3e都多多少少在一定程度上约束个体行为（丧失了一部分灵活性），而取得整体上的普适性和可扩展性\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e现在再回过头来看刚才官方文档截图中的第二句话：\x22\x3cstrong\x3e然后每次它的依赖关系改变时会再次被触发\x3c\/strong\x3e\x22 \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdET?w=800\x26amp;h=406\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdET?w=800\x26amp;h=406\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e它所表达的意思其实就是：当张三余额发生变化的时候，将 \x3cstrong\x3e自动触发\x3c\/strong\x3e 上述的 A 计划部署方案。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader14\x22\x3e4、小测试\x3c\/h2\x3e\n\x3cp\x3e问：下列代码中 \x3ccode\x3emessage.title = \x22Hello world\x22\x3c\/code\x3e 为何不会触发 autorun 再次执行？\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const message = observable({ title: \x26quot;hello\x26quot; })\n\nautorun(() =\x3e {\n    console.log(message)\n})\n\n\/\/ 不会触发重新运行\nmessage.title = \x26quot;Hello world\x26quot;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e message = observable({ \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22hello\x22\x3c\/span\x3e })\n\nautorun(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(message)\n})\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 不会触发重新运行\x3c\/span\x3e\nmessage.title = \x3cspan class=\x22hljs-string\x22\x3e\x22Hello world\x22\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其实上述问题来自官方的一个问题，若无思路的，可以先参考官方文档 \x3ca href=\x22http:\/\/cn.mobx.js.org\/best\/react.html#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1-consolelog\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e常见陷阱: console.log\x3c\/a\x3e。如果能从源码角度回答这个问题，则说明已经理解本节所讲的 \x3cstrong\x3eautorun\x3c\/strong\x3e 的知识点了\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader15\x22\x3e5、小结\x3c\/h2\x3e\n\x3cp\x3e此篇是开篇，所阐述的概念仅仅占 MobX 体系冰山一角。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbfdEU?w=451\x26amp;h=284\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbfdEU?w=451\x26amp;h=284\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e故事中还还有很多问题，比如：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e如何成为一名合格的探员、观察员？（用程序员的话讲，就是有哪些属性和方法）\x3c\/li\x3e\n\x3cli\x3e数据情报室到底还存有哪些关键信息？\x3c\/li\x3e\n\x3cli\x3e组织机构中是否还有其他组、成员？\x3c\/li\x3e\n\x3cli\x3e多个探长、观察员情况下，这套部署方案又是如何的呢？\x3c\/li\x3e\n\x3cli\x3e....\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e以上问题的答案，读者可能已经知道，那些还不知道的可以自己留作自己思考；在后续章节，我也会在适当的时机解答上述中的问题；\x3cbr\x3e（也欢迎大家提问，将有可能采纳编入后续的故事叙述中来解答）\x3c\/p\x3e\n\x3cp\x3e后续的章节中，将继续介绍 \x3ccode\x3eComputedValue\x3c\/code\x3e、\x3ccode\x3eAction\x3c\/code\x3e、\x3ccode\x3eAtom\x3c\/code\x3e、\x3ccode\x3eDerivation\x3c\/code\x3e、\x3ccode\x3eSpy\x3c\/code\x3e 等，正是这些功能角色使得 MobX 有着强大的自动化能力，合理运用了惰性求值、函数式编程等编程范式，使 MobX 在复杂交互应用中大放异彩；\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader16\x22\x3e参考文章\x3c\/h2\x3e\n\x3cp\x3e罗列本文所参考的文章，感谢他们所给予的帮助：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3ca href=\x22http:\/\/cn.mobx.js.org\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e官方中文文档\x3c\/a\x3e：不多讲，官方文档最好翻一遍。\x3c\/li\x3e\n\x3cli\x3e\n\x3ca href=\x22https:\/\/github.com\/mobxjs\/awesome-mobx\/blob\/master\/README-CN.md\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eawesome-mobx\x3c\/a\x3e： MobX 相关资源整合，方便多看多练。\x3c\/li\x3e\n\x3cli\x3e\n\x3ca href=\x22https:\/\/zhuanlan.zhihu.com\/p\/31704920\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMobx 源码解读（一） 基本概念\x3c\/a\x3e：优质的 MobX 源码解读文章，受益匪浅。\x3c\/li\x3e\n\x3cli\x3e\n\x3ca href=\x22https:\/\/qiutc.me\/post\/mobx-core.html#comment-wrap\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMobX 核心源码解析\x3c\/a\x3e：本文深入 MobX 源码来解析其核心原理以及工作流程，推荐阅读；\x3c\/li\x3e\n\x3cli\x3e\n\x3ca href=\x22http:\/\/blog.fedeoo.cn\/2017\/03\/30\/%E6%8E%A2%E7%A7%98-MobX\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e探秘 MobX\x3c\/a\x3e：本文短小精悍，主讲\x3ccode\x3eobservable\x3c\/code\x3e 和 \x3ccode\x3eautorun\x3c\/code\x3e 原理\x3c\/li\x3e\n\x3cli\x3e\n\x3ca href=\x22https:\/\/github.com\/sorrycc\/blog\/issues\/3\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMobX 原理\x3c\/a\x3e：本文对 \x3ccode\x3edeviration\x3c\/code\x3e 着墨较多\x3c\/li\x3e\n\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>【用故事解读 MobX源码（一）】 autorun</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000013682735">https://segmentfault.com/a/1190000013682735</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/g56pd1r6omk/" target="_blank">https://alili.tech/archive/g56pd1r6omk/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>