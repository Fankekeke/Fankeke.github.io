<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="React 进阶设计与控制权问题"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>React 进阶设计与控制权问题 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/g6uxhl9lurc/",
				"appid": "1613049289050283", 
				"title": "React 进阶设计与控制权问题 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-03T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/2hua9mvi1pv/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/hy68c9soav/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f&text=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f&text=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f&title=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f&is_video=false&description=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f&title=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f&title=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f&title=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg6uxhl9lurc%2f&title=React%20%e8%bf%9b%e9%98%b6%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%8e%a7%e5%88%b6%e6%9d%83%e9%97%ae%e9%a2%98"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">React 进阶设计与控制权问题</h1><div class="meta"><div class="postdate"><time datetime="2019-01-03" itemprop="datePublished">2019-01-03</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e控制权——这个概念在编程中至关重要。比如，“轮子”封装层与业务消费层对于控制权的“争夺”，就是一个很有意思的话题。这在 React 世界里也不例外。表面上看，我们当然希望“轮子”掌控的事情越多越好：\x3cstrong\x3e因为抽象层处理的逻辑越多，业务调用时关心的事情就越少，使用就越方便。可是有些设计却“不敢越雷池一步”。“轮子”与业务在控制权上的拉锯，就非常有意思了。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e同时，控制能力与组件设计也息息相关：Atomic components 这样的原子组件设计被受推崇；在原子组件这个概念之上，还有分子组件：Molecules components。不管是分子还是原子，在解决业务问题上都有存在的理由。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e这篇文章将以 React 框架为背景，谈谈我在开发当中对于控制权的一些想法和总结。如果你并不使用 React，原则上仍不妨碍阅读。\x3c\/strong\x3e\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3e在文章开始之前，我想先向大家介绍一本书。\x3c\/p\x3e\n\x3cp\x3e从去年起，我和知名技术大佬\x3ca href=\x22https:\/\/www.zhihu.com\/people\/yanhaijing\/activities\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e颜海镜\x3c\/a\x3e开始了合著之旅，今年我们共同打磨的书籍\x3cstrong\x3e《React 状态管理与同构实战》\x3c\/strong\x3e终于正式出版了！这本书以 React 技术栈为核心，在介绍 React 用法的基础上，从源码层面分析了 Redux 思想，同时着重介绍了服务端渲染和同构应用的架构模式。书中包含许多项目实例，不仅为用户打开了 React 技术栈的大门，更能提升读者对前沿领域的整体认知。\x3c\/p\x3e\n\x3cp\x3e如果各位对图书内容或接下来的内容感兴趣，还望多多支持！\x3cstrong\x3e文末有详情，不要走开！\x3c\/strong\x3e\x3c\/p\x3e\n\x3chr\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e从受控与非受控组件说起\x3c\/h2\x3e\n\x3cp\x3e初入 React 大门，关于控制权概念，我们最先接触到的就是受控组件与非受控组件。这两个概念往往与表单关联在一起。在大部分情况下，推荐使用受控组件来实现表单、输入框等状态控制。在受控组件中，表单等数据都由 React 组件自己处理。而非受控组件，是指表单的数据由 Dom 自己控制。下面就是一个典型的非受控组件：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cform\x3e\n  \x3clabel\x3e\n    Name:\n    \x3cinput type=\x26quot;text\x26quot; name=\x26quot;name\x26quot; \/\x3e\n  \x3c\/label\x3e\n  \x3cinput type=\x26quot;submit\x26quot; value=\x26quot;Submit\x26quot; \/\x3e\n\x3c\/form\x3e\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stata\x22\x3e\x3ccode\x3e\x26lt;\x3cspan class=\x22hljs-keyword\x22\x3eform\x3c\/span\x3e\x26gt;\n  \x26lt;\x3cspan class=\x22hljs-keyword\x22\x3elabel\x3c\/span\x3e\x26gt;\n    Name:\n    \x26lt;\x3cspan class=\x22hljs-keyword\x22\x3einput\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22text\x22\x3c\/span\x3e name=\x3cspan class=\x22hljs-string\x22\x3e\x22name\x22\x3c\/span\x3e \/\x26gt;\n  \x26lt;\/\x3cspan class=\x22hljs-keyword\x22\x3elabel\x3c\/span\x3e\x26gt;\n  \x26lt;\x3cspan class=\x22hljs-keyword\x22\x3einput\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22submit\x22\x3c\/span\x3e value=\x3cspan class=\x22hljs-string\x22\x3e\x22Submit\x22\x3c\/span\x3e \/\x26gt;\n\x26lt;\/\x3cspan class=\x22hljs-keyword\x22\x3eform\x3c\/span\x3e\x26gt;\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e对于 React 来说，非受控组件的状态和用户输入都无法直接掌控，只能依赖 form 标签的原生能力进行交互。如果使上例非受控组件变为一个受控组件，代码也很简单：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class NameForm extends React.Component {\n  state= {value: \x27\x27}\n\n  handleChange = event =\x3e {\n    this.setState({value: event.target.value});\n  }\n\n  handleSubmit = event =\x3e {\n    alert(\x27A name was submitted: \x27 \x2b this.state.value);\n    event.preventDefault();\n  }\n\n  render() {\n    return (\n      \x3cform onSubmit={this.handleSubmit}\x3e\n        \x3clabel\x3e\n          Name:\n          \x3cinput type=\x26quot;text\x26quot; value={this.state.value} onChange={this.handleChange} \/\x3e\n        \x3c\/label\x3e\n        \x3cinput type=\x26quot;submit\x26quot; value=\x26quot;Submit\x26quot; \/\x3e\n      \x3c\/form\x3e\n    )\n  }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scala\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eNameForm\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eReact\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n  state= {value: \x27\x27}\n\n  handleChange = event =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({value: event.target.value});\n  }\n\n  handleSubmit = event =\x26gt; {\n    alert(\x3cspan class=\x22hljs-symbol\x22\x3e\x27A\x3c\/span\x3e name was submitted: \x27 \x2b \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state.value);\n    event.preventDefault();\n  }\n\n  render() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n      \x26lt;form onSubmit={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handleSubmit}\x26gt;\n        \x26lt;label\x26gt;\n          \x3cspan class=\x22hljs-type\x22\x3eName\x3c\/span\x3e:\n          \x26lt;input \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22text\x22\x3c\/span\x3e value={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state.value} onChange={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handleChange} \/\x26gt;\n        \x26lt;\/label\x26gt;\n        \x26lt;input \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22submit\x22\x3c\/span\x3e value=\x3cspan class=\x22hljs-string\x22\x3e\x22Submit\x22\x3c\/span\x3e \/\x26gt;\n      \x26lt;\/form\x26gt;\n    )\n  }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这时候表单值和行为都由 React 组件控制，使得开发更加便利。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e这当然是很基础的概念，借此抛出控制权的话题，请读者继续阅读。\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eUI “轮子”与 Control Props 模式\x3c\/h2\x3e\n\x3cp\x3e前文介绍的样例，我称之为“\x3cstrong\x3e狭义\x3c\/strong\x3e受控和非受控”组件。\x3cstrong\x3e广义来说，我认为完全的非受控组件是指：不含有内部 states，只接受 props 的函数式组件或无状态组件\x3c\/strong\x3e。它的渲染行为完全由外部传入的 props 控制，没有自身的“自治权”。这样的组件在很好地实现了复用性，且具有良好的测试性。\x3c\/p\x3e\n\x3cp\x3e但在 UI “轮子”设计当中，\x3cstrong\x3e“半自治”或者“不完全受控”\x3c\/strong\x3e组件，有时也会是一个更好的选择。我们将此称之为 “control props” 模式。简单来说就是：\x3cstrong\x3e组件具有自身 state，当没有相关 porps 传入时，使用自身状态 statea 完成渲染和交互逻辑；当该组件被调用时，如果有相关 props 传入，那么将会交出控制权，由业务消费层面控制其行为。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e在研究大量社区 UI “轮子” 之后，我发现由 Kent C. Dodds 编写的，在 paypal 使用的组件库 \x3ca href=\x22https:\/\/github.com\/paypal\/downshift\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3edownshift\x3c\/a\x3e 便广泛采用了这样的模式。\x3c\/p\x3e\n\x3cp\x3e简单用一个 Toogle 组件举例，这个组件由业务方调用时：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class Example extends React.Component {\n  state = {on: false, inputValue: \x27off\x27}\n  handleToggle = on =\x3e {\n    this.setState({on, inputValue: on ? \x27on\x27 : \x27off\x27})\n  }\n  handleChange = ({target: {value\x22}}\x22) =\x3e {\n    if (value === \x27on\x27) {\n      this.setState({on: true})\n    } else if (value === \x27off\x27) {\n      this.setState({on: false})\n    }\n    this.setState({inputValue: value})\n  }\n  render() {\n    const {on} = this.state\n    return (\n      \x3cdiv\x3e\n        \x3cinput\n          value={this.state.inputValue}\n          onChange={this.handleChange}\n        \/\x3e\n        \x3cToggle on={on} onToggle={this.handleToggle} \/\x3e\n      \x3c\/div\x3e\n    )\n  }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs coffeescript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eExample\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eReact\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e {\x3c\/span\x3e\n  state = {on: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e, inputValue: \x3cspan class=\x22hljs-string\x22\x3e\x27off\x27\x3c\/span\x3e}\n  handleToggle = \x3cspan class=\x22hljs-literal\x22\x3eon\x3c\/span\x3e =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({\x3cspan class=\x22hljs-literal\x22\x3eon\x3c\/span\x3e, inputValue: \x3cspan class=\x22hljs-literal\x22\x3eon\x3c\/span\x3e ? \x3cspan class=\x22hljs-string\x22\x3e\x27on\x27\x3c\/span\x3e : \x3cspan class=\x22hljs-string\x22\x3e\x27off\x27\x3c\/span\x3e})\n  }\n\x3cspan class=\x22hljs-function\x22\x3e  \x3cspan class=\x22hljs-title\x22\x3ehandleChange\x3c\/span\x3e = \x3cspan class=\x22hljs-params\x22\x3e({target: {value\x22}}\x22)\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (value === \x3cspan class=\x22hljs-string\x22\x3e\x27on\x27\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({on: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e})\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (value === \x3cspan class=\x22hljs-string\x22\x3e\x27off\x27\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({on: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e})\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({inputValue: value})\n  }\n  render() {\n    const {\x3cspan class=\x22hljs-literal\x22\x3eon\x3c\/span\x3e} = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n      \x26lt;div\x26gt;\n        \x26lt;input\n          value={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state.inputValue}\n          onChange={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handleChange}\n        \/\x26gt;\n        \x26lt;Toggle \x3cspan class=\x22hljs-literal\x22\x3eon\x3c\/span\x3e={\x3cspan class=\x22hljs-literal\x22\x3eon\x3c\/span\x3e} onToggle={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handleToggle} \/\x26gt;\n      \x26lt;\/div\x26gt;\n    )\n  }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e效果如图：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016374193?w=552\x26amp;h=458\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016374193?w=552\x26amp;h=458\x22 alt=\x22Toggle 效果\x22 title=\x22Toggle 效果\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e我们可以通过输入框来控制 Toggle 组件状态切换（输入 “on“ 激活状态，输入 ”off“ 状态置灰），同时也可以通过鼠标来点击切换，此时输入框内容也会相应变化。\x3c\/p\x3e\n\x3cp\x3e请思考：对于 UI 组件 Toggle 来说，它的状态可以由业务调用方来控制其状态，这就赋予了使用层面上的消费便利。在业务代码中，不管是 Input 还是其他任何组件都可以控制其状态，调用时我们具有完全的控制权掌控能力。\x3c\/p\x3e\n\x3cp\x3e同时，如果在调用 Toggle 组件时，不去传 props 值，该组件仍然可以正常发挥。如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  \x3cToggle\x3e\n    {({on, getTogglerProps}) =\x3e (\n      \x3cdiv\x3e\n        \x3cbutton {...getTogglerProps()}\x3eToggle me\x3c\/button\x3e\n        \x3cdiv\x3e{on ? \x27Toggled On\x27 : \x27Toggled Off\x27}\x3c\/div\x3e\n      \x3c\/div\x3e\n    )}\n  \x3c\/Toggle\x3e\n  \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs dust\x22\x3e\x3ccode\x3e\x3cspan class=\x22xml\x22\x3e  \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eToggle\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3c\/span\x3e\x3cspan class=\x22hljs-template-variable\x22\x3e{({on, getTogglerProps}\x3c\/span\x3e\x3cspan class=\x22xml\x22\x3e) =\x26gt; (\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebutton\x3c\/span\x3e \x3c\/span\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-template-variable\x22\x3e{...getTogglerProps()}\x3c\/span\x3e\x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26gt;\x3c\/span\x3eToggle me\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ebutton\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-template-variable\x22\x3e{on ? \x27Toggled On\x27 : \x27Toggled Off\x27}\x3c\/span\x3e\x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    )}\n  \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eToggle\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n  \x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eToggle 组件在状态切换时，自己维护内部状态，实现切换效果，同时通过 render prop 模式，对外输出本组件的状态信息。\x3c\/p\x3e\n\x3cp\x3e我们看 Toggle 源码（部分环节已删减）：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const callAll = (...fns) =\x3e (...args) =\x3e fns.forEach(fn =\x3e fn \x26amp;\x26amp; fn(...args))\n\nclass Toggle extends Component {\n  static defaultProps = {\n    defaultOn: false,\n    onToggle: () =\x3e {},\n  }\n  state = {\n    on: this.getOn({on: this.props.defaultOn}),\n  }\n  getOn(state = this.state) {\n    return this.isOnControlled() ? this.props.on : state.on\n  }\n  isOnControlled() {\n    return this.props.on !== undefined\n  }\n  getTogglerStateAndHelpers() {\n    return {\n      on: this.getOn(),\n      setOn: this.setOn,\n      setOff: this.setOff,\n      toggle: this.toggle,\n    }\n  }\n  setOnState = (state = !this.getOn()) =\x3e {\n    if (this.isOnControlled()) {\n      this.props.onToggle(state, this.getTogglerStateAndHelpers())\n    } else {\n      this.setState({on: state}, () =\x3e {\n        this.props.onToggle(\n          this.getOn(),\n          this.getTogglerStateAndHelpers()\n        )\n      })\n    }\n  }\n  setOn = this.setOnState.bind(this, true)\n  setOff = this.setOnState.bind(this, false)\n  toggle = this.setOnState.bind(this, undefined)\n  render() {\n    const renderProp = unwrapArray(this.props.children)\n    return renderProp(this.getTogglerStateAndHelpers())\n  }\n}\n\nfunction unwrapArray(arg) {\n  return Array.isArray(arg) ? arg[0] : arg\n}\nexport default Toggle\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3econst callAll = (...fns) =\x26gt; (...args) =\x26gt; fns.forEach(fn =\x26gt; fn \x26amp;\x26amp; fn(...args))\n\n\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eToggle\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n  static defaultProps = {\n    defaultOn: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n    onToggle: () =\x26gt; {},\n  }\n  state = {\n    on: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getOn({on: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props.defaultOn}),\n  }\n  getOn(state = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.isOnControlled() ? \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props.on : state.on\n  }\n  isOnControlled() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props.on !== undefined\n  }\n  getTogglerStateAndHelpers() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n      on: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getOn(),\n      setOn: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setOn,\n      setOff: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setOff,\n      toggle: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.toggle,\n    }\n  }\n  setOnState = (state = !\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getOn()) =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.isOnControlled()) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props.onToggle(state, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getTogglerStateAndHelpers())\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({on: state}, () =\x26gt; {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props.onToggle(\n          \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getOn(),\n          \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getTogglerStateAndHelpers()\n        )\n      })\n    }\n  }\n  setOn = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setOnState.bind(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e)\n  setOff = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setOnState.bind(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e)\n  toggle = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setOnState.bind(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, undefined)\n  render() {\n    const renderProp = unwrapArray(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props.children)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e renderProp(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getTogglerStateAndHelpers())\n  }\n}\n\nfunction unwrapArray(arg) {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e Array.isArray(arg) ? arg[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] : arg\n}\nexport \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e Toggle\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e关键的地方在于组件内 isOnControlled 方法判断是否有命名为 on 的属性传入：如果有，则使用 this.props.on 作为本组件状态，反之用自身 this.state.on 来管理状态。同时在 render 方法中，\x3cstrong\x3e使用了 render prop 模式，关于这个模式本文不再探讨，感兴趣的读者可以在社区中找到很多资料，同时也可以在我新书中找到相关内容。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e盘点一下，control props 模式反应了典型的控制权问题。这样的\x3cstrong\x3e“半自治”\x3c\/strong\x3e能够完美适应业务需求，在组件设计上也更加灵活有效。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3eRedux 异步状态管理与控制权\x3c\/h2\x3e\n\x3cp\x3e提到控制权话题，怎能少得了 Redux 这样的状态管理工具。\x3cstrong\x3eRedux 的设计在方方面面都体现出来良好的控制权处理\x3c\/strong\x3e，这里我们把注意力集中在\x3cstrong\x3e异步状态\x3c\/strong\x3e上，更多的内容还请读者关注我的新书。\x3c\/p\x3e\n\x3cp\x3eRedux 处理异步，最为人熟知的就是 Redux-thunk 这样的中间件，它由 Dan 亲自编写，并在 Redux 官方文档上被安利。\x3cstrong\x3e它与其他所有中间件一样，将 action 到 reducer 中间的过程进行掌控，使得业务使用时可以直接 dispatch 一个函数类型的 action\x3c\/strong\x3e，实现代码也很简单：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function createThunkMiddleware(extraArgument) {\n  return ({ dispatch, getState }) =\x3e next =\x3e action =\x3e {\n    if (typeof action === \x27function\x27) {\n      return action(dispatch, getState, extraArgument);\n    }\n\n    return next(action);\n  };\n}\n\nconst thunk = createThunkMiddleware();\n\nexport default thunk;\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecreateThunkMiddleware\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eextraArgument\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3e{ dispatch, getState }\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e next =\x26gt; \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eaction\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e action === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e action(dispatch, getState, extraArgument);\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next(action);\n  };\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e thunk = createThunkMiddleware();\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e thunk;\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e但是很快就有人认为，这样的方案因为在中间件实现中的控制不足，导致了业务代码不够精简。我们还是需要遵循传统的 Redux 步骤：八股文似的编写 action，action creactor，reducer......于是，\x3cstrong\x3e控制粒度更大的中间件方案应运而生\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3eRedux-promise 中间件控制了 action type，它限制业务方在 dispatch 异步 action 时，action的 payload 属性需要是一个 Promise 对象时，执行 resolve，该中间件触发一个类型相同的 action，并将 payload 设置为 promise 的 value，并设 action.status 属性为 \x22success\x22。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22export default function promiseMiddleware({ dispatch }) {\n  return next =\x3e action =\x3e {\n    if (!isFSA(action)) {\n      return isPromise(action) ? action.then(dispatch) : next(action);\n    }\n\n    return isPromise(action.payload)\n      ? action.payload\n          .then(result =\x3e dispatch({ ...action, payload: result }))\n          .catch(error =\x3e {\n            dispatch({ ...action, payload: error, error: true });\n            return Promise.reject(error);\n          })\n      : next(action);\n  };\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs fortran\x22\x3e\x3ccode\x3eexport \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3c\/span\x3e promiseMiddleware({ dispatch }) {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next =\x26gt; \x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-comment\x22\x3e!isFSA(action)) {\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e isPromise(\x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e) ? \x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e.\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(dispatch) : next(\x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e);\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e isPromise(\x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e.payload)\n      ? \x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e.payload\n          .\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(result =\x26gt; dispatch({ ...\x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e, payload: result }))\n          .catch(error =\x26gt; {\n            dispatch({ ...\x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e, payload: error, error: true });\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e Promise.reject(error);\n          })\n      : next(\x3cspan class=\x22hljs-keyword\x22\x3eaction\x3c\/span\x3e);\n  };\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样的设计与 Redux-thunk 完全不同，\x3cstrong\x3e它将 thunk 过程控制在中间件自身中\x3c\/strong\x3e，这样一来，第三方轮子做的事情更多，因此在业务调用时更加简练方便。我们只需要正常编写 action 即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22dispatch({\n    type: GET_USER,\n    payload: http.getUser(userId) \/\/ payload 为 promise 对象\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs css\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-selector-tag\x22\x3edispatch\x3c\/span\x3e({\n    \x3cspan class=\x22hljs-attribute\x22\x3etype\x3c\/span\x3e: GET_USER,\n    payload: http.\x3cspan class=\x22hljs-built_in\x22\x3egetUser\x3c\/span\x3e(userId) \/\/ payload 为 promise 对象\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们对比一下 Redux-thunk，相对于“轮子”控制权较弱，业务方控制权更多的 Redux-thunk，实现上述三行代码，就得不得不需要：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22dispatch(\n    function(dispatch, getState) {\n        dispatch({\n            type: GET_USERE, \n            payload: userId\n        })\n        http.getUser(id)\n            .then(response =\x3e {\n                dispatch({\n                    type: GET_USER_SUCCESS,\n                    payload: response\n                })\n            })\n            .catch(error =\x3e {\n                dispatch({\n                    type: GET_DATA_FAILED,\n                    payload: error\n                })\n            }) \n    }\n)\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lisp\x22\x3e\x3ccode\x3edispatch(\n    \x3cspan class=\x22hljs-name\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-name\x22\x3edispatch\x3c\/span\x3e, getState) {\n        dispatch({\n            type: GET_USERE, \n            payload: userId\n        })\n        http.getUser(\x3cspan class=\x22hljs-name\x22\x3eid\x3c\/span\x3e)\n            .then(\x3cspan class=\x22hljs-name\x22\x3eresponse\x3c\/span\x3e =\x26gt; {\n                dispatch({\n                    type: GET_USER_SUCCESS,\n                    payload: response\n                })\n            })\n            .catch(\x3cspan class=\x22hljs-name\x22\x3eerror\x3c\/span\x3e =\x26gt; {\n                dispatch({\n                    type: GET_DATA_FAILED,\n                    payload: error\n                })\n            }) \n    }\n)\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3e当然，Redux-promise 控制权越多，一方面带来了简练，但是另一方面，业务控制权越弱，也丧失了一定的自主性\x3c\/strong\x3e。比如如果想实现乐观更新（Optimistic updates），那就很难做了。具体详见 \x3ca href=\x22https:\/\/github.com\/redux-utilities\/flux-standard-action\/issues\/7\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eIssue #7\x3c\/a\x3e \x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e为了平衡这个矛盾，在 Redux-thunk 和 Redux-promise 这两个极端控制权理念的中间件之间，于是便存在了中间状态的中间件：Redux-promise-middleware\x3c\/strong\x3e，它与 Redux-thunk 类似，掌控粒度也类似，但是在 action 处理上更加温和和渐进，它会在适当的时机 dispatch XXX_PENDING、XXX_FULFILLED 、XXX_REJECTED 三种类型的 action，\x3cstrong\x3e也就是说这个中间件在掌控更多逻辑的基础上，增加了和外界第三方的通信程度，不再是直接高冷地触发 XXX_FULFILLED 、XXX_REJECTED，请读者仔细体会其中不同\x3c\/strong\x3e。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e状态管理中的控制主义和极简主义\x3c\/h2\x3e\n\x3cp\x3e了解了异步状态中的控制权问题，我们再从 Redux 全局角度进行分析。在内部分享时，我将\x3cstrong\x3e基于 Redux 封装的状态管理类库共同特性\x3c\/strong\x3e总结为这一页 slide:\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016374194\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016374194\x22 alt=\x22slide\x22 title=\x22slide\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e以上四点都是相关类库基于 Redux 所进行的简化\x3c\/strong\x3e，其中非常有意思的就是后面三点，\x3cstrong\x3e它们无一例外地与控制权相关\x3c\/strong\x3e。以 Rematch 为代表，它不再是处理 action 到 reducer 的中间件，而是完全控制了 action creator，reducer 以及联通过程。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e具体来看\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e业务方不再需要显示申明 action type，它由类库直接函数名直接生成，如果 reducer 命名为 increment，那么 action.type 就是 increment；\x3c\/li\x3e\n\x3cli\x3e同时控制 reducer 和 action creator 合二为一，态管理从未变得如此简单、高效。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e我把这样的实践称为控制主义或者极简主义，相比 Redux-actions 这样的状态管理类库，这样的做法更加彻底、完善。具体思想可参考 Shawn McKay 的\x3ca href=\x22https:\/\/hackernoon.com\/redesigning-redux-b2baee8b8a38\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e文章\x3c\/a\x3e，介绍的比较充分，这里我不再赘述。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e总结：码农和控制权\x3c\/h2\x3e\n\x3cp\x3e控制权说到底是一种设计思想，是第三方类库和业务消费的交锋和碰撞。它与语言和框架无关，本文只是以 React 举例，实际上在编程领域控制权的争夺随处可见；他与抽象类别无关，本文已经在 UI 抽象和状态抽象中分别例举分析；控制权与码农息息相关，它直接决定了我们的编程体验和开发效率。\x3c\/p\x3e\n\x3cp\x3e可是在编程的初期阶段，优秀的控制权设计难以一蹴而就。只有投身到一线开发当中，真正了解自身业务需求，进而总结大量最佳实践，同时参考社区精华，分析优秀开源作品，相信我们都会得到成长。\x3c\/p\x3e\n\x3cp\x3e最后，前端学习永无止境，希望和每一位技术爱好者共同进步，大家可以在\x3ca href=\x22https:\/\/www.zhihu.com\/people\/lucas-hc\/activities\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e知乎找到我！\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3eHappy coding!\x3c\/p\x3e\n\x3cp\x3eHappy coding!\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3e《React 状态管理与同构实战》这本书由我和前端知名技术大佬\x3ca href=\x22https:\/\/www.zhihu.com\/people\/yanhaijing\/activities\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e颜海镜\x3c\/a\x3e合力打磨，凝结了我们在学习、实践 React 框架过程中的积累和心得。\x3cstrong\x3e除了 React 框架使用介绍以外，着重剖析了状态管理以及服务端渲染同构应用方面的内容。\x3c\/strong\x3e同时吸取了社区大量优秀思想，进行归纳比对。\x3c\/p\x3e\n\x3cp\x3e本书受到百度公司副总裁沈抖、百度资深前端工程师董睿，以及知名 JavaScript 语言专家阮一峰、Node.js 布道者狼叔、Flarum 中文社区创始人 justjavac、新浪移动前端技术专家小爝、百度资深前端工程师顾轶灵等前端圈众多专家大咖的联合力荐。\x3c\/p\x3e\n\x3cp\x3e有兴趣的读者可以\x3ca href=\x22https:\/\/item.m.jd.com\/product\/12403508.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e点击这里，了解详情。\x3c\/a\x3e也可以扫描下面的二维码购买。再次感谢各位的支持与鼓励！恳请各位批评指正！\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016374195\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016374195\x22 alt=\x22React 状态管理与同构实战\x22 title=\x22React 状态管理与同构实战\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016008111\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016008111\x22 alt=\x22React 状态管理与同构实战\x22 title=\x22React 状态管理与同构实战\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>React 进阶设计与控制权问题</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000016374190">https://segmentfault.com/a/1190000016374190</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/g6uxhl9lurc/" target="_blank">https://alili.tech/archive/g6uxhl9lurc/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>