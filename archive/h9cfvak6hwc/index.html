<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="利用 socket.io 实现消息实时推送"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>利用 socket.io 实现消息实时推送 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/h9cfvak6hwc/",
				"appid": "1613049289050283", 
				"title": "利用 socket.io 实现消息实时推送 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-02T02:30:09"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/wswdipd7mxq/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/hhs8iog5474/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f&text=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f&text=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f&title=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f&is_video=false&description=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f&title=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f&title=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f&title=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fh9cfvak6hwc%2f&title=%e5%88%a9%e7%94%a8%20socket.io%20%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%ae%9e%e6%97%b6%e6%8e%a8%e9%80%81"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">利用 socket.io 实现消息实时推送</h1><div class="meta"><div class="postdate"><time datetime="2019-01-02" itemprop="datePublished">2019-01-02</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e项目背景介绍\x3c\/h2\x3e\n\x3cp\x3e最近在写的项目中存在着社交模块，需要实现这样的一个功能：当发生了用户被点赞、评论、关注等操作时，需要由服务器向用户实时地推送一条消息。最终完成的项目地址为：\x3ca href=\x22https:\/\/github.com\/noiron\/socket-message-push\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3esocket-message-push\x3c\/a\x3e，这里将介绍一下实现的思路及部分代码。\x3c\/p\x3e\n\x3cp\x3e项目的流程中存在着这样的几个对象：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e用 Java 实现的后端服务器\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e用 Node.js 实现的消息推送服务器\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e用户进行操作的客户端\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e事件处理的流程如下：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e用户进行点赞操作时，后端服务器会进行处理，并向 Node.js 消息推送服务器发送一条消息\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eNode.js 消息推送服务器接收到后端发送的消息后，处理数据，并确定向哪个用户进行推送\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e用户的客户端接收到由 Node.js 服务器推送来的消息后，即可进行通知的显示。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e上面的流程中，Java 后端服务器是如何实现的不在此篇文章的讨论范围内，本文将主要介绍如何使用 Node.js 来实现这个消息推送服务器。\x3c\/p\x3e\n\x3cp\x3e考虑消息推送服务器上必须记录下当前在线用户的信息，这样才能向特定的用户推送消息。所以当用户登录时，必须将自身的用户信息发到 Node.js 服务器上。为了达到这种双向的实时消息传递，很明显地考虑用 WebSocket 来实现。既然我们在消息推送服务器上使用了 Node.js，我们就有了一个很方便的选项：socket.io。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eSocket.io 介绍\x3c\/h2\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/socket.io\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eSocket.io\x3c\/a\x3e是一个用 JavaScript 实现的实时双向通信的库，利用它来实现我们的功能会很简单。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3esocket.io\x3c\/code\x3e 包含两个部分：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e服务器端（server）：运行在 Node.js 服务器上\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e客户端（client）：运行在浏览器中\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e可以看看如下的 \x3ccode\x3esocket.io\x3c\/code\x3e 的示例代码，它给出了 \x3ccode\x3esocket.io\x3c\/code\x3e 发出及监听事件的基本用法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22io.on(\x27connection\x27, function(socket){\n  socket.emit(\x27request\x27, \/* *\/); \/\/ emit an event to the socket\n  io.emit(\x27broadcast\x27, \/* *\/); \/\/ emit an event to all connected sockets\n  socket.on(\x27reply\x27, function(){ \/* *\/ }); \/\/ listen to the event\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eio.on(\x3cspan class=\x22hljs-string\x22\x3e\x27connection\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3esocket\x3c\/span\x3e)\x3c\/span\x3e{\n  socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27request\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/* *\/\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ emit an event to the socket\x3c\/span\x3e\n  io.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27broadcast\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/* *\/\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ emit an event to all connected sockets\x3c\/span\x3e\n  socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27reply\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{ \x3cspan class=\x22hljs-comment\x22\x3e\/* *\/\x3c\/span\x3e }); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ listen to the event\x3c\/span\x3e\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e关于 Socket.io 还有一点需要注意：Socke.io 并不完全是 WebSocket 的实现。\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3eNote: Socket.IO is not a WebSocket implementation. Although Socket.IO indeed uses WebSocket as a transport when possible, it adds some metadata to each packet: the packet type, the namespace and the ack id when a message acknowledgement is needed.\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e接下来我们需要用 Express.js 来建立一个服务器端程序，并在其中引入 Socket.io。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3eNode.js 服务器的搭建\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e利用 Express.js 搭建基础服务器\x3c\/h3\x3e\n\x3cp\x3e我们使用了 Express.js 来搭建 Node.js 消息推送服务器，先利用一个简要的例子来浏览其功能：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ server.js\nconst express = require(\x27express\x27);\nconst app = express();\nconst path = require(\x27path\x27);\nconst http = require(\x27http\x27).Server(app);\n\nconst port = 4001;\n\napp.use(express.static(path.join(__dirname, \x27public\x27)));\n\napp.get(\x27\/\x27, function(req, res) {\n    res.sendFile(__dirname \x2b \x27\/public\/index.html\x27);\n});\n\napp.get(\x27\/api\x27, function(req, res) {\n    res.send(\x27.\x27);\n});\n\nhttp.listen(port, function() {\n    console.log(`listening on port:${port}`);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ server.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e express = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27express\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = express();\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e http = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27http\x27\x3c\/span\x3e).Server(app);\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e port = \x3cspan class=\x22hljs-number\x22\x3e4001\x3c\/span\x3e;\n\napp.use(express.static(path.join(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27public\x27\x3c\/span\x3e)));\n\napp.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res\x3c\/span\x3e) \x3c\/span\x3e{\n    res.sendFile(__dirname \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\/public\/index.html\x27\x3c\/span\x3e);\n});\n\napp.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/api\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res\x3c\/span\x3e) \x3c\/span\x3e{\n    res.send(\x3cspan class=\x22hljs-string\x22\x3e\x27.\x27\x3c\/span\x3e);\n});\n\nhttp.listen(port, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e`listening on port:\x3cspan class=\x22hljs-subst\x22\x3e${port}\x3c\/span\x3e`\x3c\/span\x3e);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e将上面的代码保存为 \x3ccode\x3eserver.js\x3c\/code\x3e，新建一个 \x3ccode\x3epublic\x3c\/code\x3e 文件夹，在其中放入 \x3ccode\x3eindex.html\x3c\/code\x3e 文件。运行以下命令：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22node server.js\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs crmsh\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eserver\x3c\/span\x3e.js\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e现在即可在 \x3ccode\x3elocalhost:4001\x3c\/code\x3e 查看效果了。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e引入 Socket.io\x3c\/h3\x3e\n\x3cp\x3e现在已经有了一个基础的 Express 服务器，接下来需要将 Socket.io 加入其中。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const io = require(\x27socket.io\x27)(http);\n\nio.on(\x27connection\x27, function(socket) {\n    console.log(\x27a user connected\x27);\n    socket.broadcast.emit(\x27new_user\x27, {});\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e io = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27socket.io\x27\x3c\/span\x3e)(http);\n\nio.on(\x3cspan class=\x22hljs-string\x22\x3e\x27connection\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3esocket\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27a user connected\x27\x3c\/span\x3e);\n    socket.broadcast.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27new_user\x27\x3c\/span\x3e, {});\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里的 \x3ccode\x3eio\x3c\/code\x3e 监听 \x3ccode\x3econnection\x3c\/code\x3e 事件，当 \x3ccode\x3eclient\x3c\/code\x3e 与 \x3ccode\x3eserver\x3c\/code\x3e 建立了连接之后，这里的回调函数会被调用（\x3ccode\x3eclient\x3c\/code\x3e 中的代码将在下一节介绍）。\x3c\/p\x3e\n\x3cp\x3e函数的参数 \x3ccode\x3esocket\x3c\/code\x3e 代表的是当前的 \x3ccode\x3eclient\x3c\/code\x3e 和 \x3ccode\x3eserver\x3c\/code\x3e 间建立的这个连接。可在 \x3ccode\x3eclient\x3c\/code\x3e 程序中将这个建立的 socket 连接打印出来，如下图所示：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVUc4e?w=713\x26amp;h=385\x22 src=\x22https:\/\/static.alili.tech\/img\/bVUc4e?w=713\x26amp;h=385\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e其中的 \x3ccode\x3eid\x3c\/code\x3e 属性可以用于标识出这一连接，从而 \x3ccode\x3eserver\x3c\/code\x3e 可以向特定的用户发送消息。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22socket.broadcast.emit(\x27new_user\x27, {});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3esocket.broadcast.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27new_user\x27\x3c\/span\x3e, {});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这一行代码表示 \x3ccode\x3esocket\x3c\/code\x3e 将向当前所有与 \x3ccode\x3eserver\x3c\/code\x3e 建立了连接的 \x3ccode\x3eclient\x3c\/code\x3e（不包括自己） 广播一条名为 \x3ccode\x3enew_user\x3c\/code\x3e 的消息。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e后端推送消息的处理流程\x3c\/h3\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e在 Node 服务器建立一个用户信息和 socket id 的映射表，因为同一用户可能打开了多个页面，所以他的 socket id 可能存在多个值。当用户建立连接时，往其中添加值；用户断开连接后，删除相应值。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e当 Java 后台存在需要推送的消息时，会向 Node 服务器的 \x3ccode\x3e\/api\x3c\/code\x3e 路径 post 一条消息，其中包括用于标识用户的 tokenId 和其它数据。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eNode 服务器接收到 post 请求后，对请求内容进行处理。根据 tokenId 找出与该用户对应的 socket id，socket.io 会根据 id 来向用户推送消息。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e对用户信息的处理\x3c\/h3\x3e\n\x3cp\x3e方便起见，这里只用一个数组保存用户信息，实际工作中可以根据需要放入数据库中保存。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22global.users = []; \/\/ 记录下登录用户的tokenId, socketId\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3eglobal.users = []; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 记录下登录用户的tokenId, socketId\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当用户登录时，\x3ccode\x3eclient\x3c\/code\x3e 会向 \x3ccode\x3eserver\x3c\/code\x3e 发送 \x3ccode\x3euser_login\x3c\/code\x3e 事件，服务器接收到后会做如下操作：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22socket.on(\x27user_login\x27, function(info) {\n    const { tokenId, userId, socketId } = info;\n    addSocketId(users, { tokenId, socketId, userId });\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3esocket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27user_login\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3einfo\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { tokenId, userId, socketId } = info;\n    addSocketId(users, { tokenId, socketId, userId });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3eaddSocketId()\x3c\/code\x3e 会向 \x3ccode\x3eusers\x3c\/code\x3e 数组中添加用户信息，不同用户通过 tokenId 进行区分，每个用户有一个 \x3ccode\x3esocketIds\x3c\/code\x3e 数组，保存可能存在的多个 \x3ccode\x3esocketId\x3c\/code\x3e。该函数的具体代码可见 \x3ccode\x3esrc\/utils.js\x3c\/code\x3e 文件。\x3c\/p\x3e\n\x3cp\x3e同理，还有一个 \x3ccode\x3edeleteSocketId()\x3c\/code\x3e 函数用于删除用户信息，代码可见同一文件。\x3c\/p\x3e\n\x3cp\x3e在获取了用户的 tokenId 之后，就需要找到对应的 socketId，然后向特定用户推送消息。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 只向 id = socketId 的这一连接发送消息 \nio.sockets.to(socketId).emit(\x27receive_message\x27, {\n    entityType,\n    data\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 只向 id = socketId 的这一连接发送消息 \x3c\/span\x3e\nio.sockets.to(socketId).emit(\x3cspan class=\x22hljs-string\x22\x3e\x27receive_message\x27\x3c\/span\x3e, {\n    entityType,\n    data\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e服务器的思路大致如此，接下来介绍客户端中是如何进行相应的处理的。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e客户端\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3eSocket.io 的初始化\x3c\/h3\x3e\n\x3cp\x3e首先在 html 文件中引入 Socket.io 的 client 端文件，例如通过 CDN 引入：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cscript src=\x26quot;https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/socket.io\/2.0.3\/socket.io.js\x26quot;\x3e\x3c\/script\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3esrc\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/socket.io\/2.0.3\/socket.io.js\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22undefined\x22\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其它的引入方式:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cscript src=\x26quot;\/socket.io\/socket.io.js\x26quot;\x3e\x3c\/script\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3esrc\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22\/socket.io\/socket.io.js\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22undefined\x22\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const io = require(\x27socket.io-client\x27);\n\/\/ or with import syntax\nimport io from \x27socket.io-client\x27;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e io = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27socket.io-client\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ or with import syntax\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e io \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27socket.io-client\x27\x3c\/span\x3e;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e引入 Socket.io 后就获得了 \x3ccode\x3eio\x3c\/code\x3e 函数，通过它来与消息推送服务器建立连接。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 假设你将 Node 服务器部署后的地址为：https:\/\/www.example.com\/ws\n\/\/ 则： WS_HOST = \x27https:\/\/www.example.com\x27\nconst msgSocket = io(`${WS_HOST}`, {\n    secure: true,\n    path: \x27\/ws\/socket.io\x27\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 假设你将 Node 服务器部署后的地址为：https:\/\/www.example.com\/ws\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 则： WS_HOST = \x27https:\/\/www.example.com\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e msgSocket = io(\x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${WS_HOST}\x3c\/span\x3e`\x3c\/span\x3e, {\n    \x3cspan class=\x22hljs-attr\x22\x3esecure\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/ws\/socket.io\x27\x3c\/span\x3e\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果监听本地：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const msgSocket = io(\x27http:\/\/localhost:4001\x27);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e msgSocket = io(\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/localhost:4001\x27\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里如果写成 \x3ccode\x3eio(\x27https:\/\/www.example.com\/ws\x27)\x3c\/code\x3e 会出现错误，需要将 \x3ccode\x3e\/ws\x3c\/code\x3e 写入path中。\x3c\/p\x3e\n\x3cp\x3e为了能在其它文件使用这一变量，可将 \x3ccode\x3emsgSocket\x3c\/code\x3e 作为一个全局变量：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22window.msgSocket = msgSocket;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.msgSocket = msgSocket;\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e用户建立连接\x3c\/h3\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 用户登录时，向服务器发送用户的信息。服务器会在收到信息后建立 socket 与用户的映射。\nmsgSocket.emit(\x27user_login\x27, {\n    userId,\n    socketId: msgSocket.id,\n    tokenId\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 用户登录时，向服务器发送用户的信息。服务器会在收到信息后建立 socket 与用户的映射。\x3c\/span\x3e\nmsgSocket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27user_login\x27\x3c\/span\x3e, {\n    userId,\n    \x3cspan class=\x22hljs-attr\x22\x3esocketId\x3c\/span\x3e: msgSocket.id,\n    tokenId\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader10\x22\x3e接收到推送的消息后的处理\x3c\/h3\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ WebSocket 连接建立后，监听名为 receive_message 的事件 \nmsgSocket.on(\x27receive_message\x27, msg =\x3e {\n    store.dispatch({\n        type: \x27NEW_SOCKET_MSG\x27,\n        payload: msg\n    });\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ WebSocket 连接建立后，监听名为 receive_message 的事件 \x3c\/span\x3e\nmsgSocket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27receive_message\x27\x3c\/span\x3e, msg =\x26gt; {\n    store.dispatch({\n        \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27NEW_SOCKET_MSG\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3epayload\x3c\/span\x3e: msg\n    });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当 WebSocket 服务器向客户端推送了消息之后，客户端需要监听 \x3ccode\x3ereceive_message\x3c\/code\x3e 事件，接收到的参数中有相应待处理的信息。\x3c\/p\x3e\n\x3cp\x3e由于使用了 Redux 进行数据的处理，所以这里 dispatch 了一个 \x3ccode\x3eNEW_SOCKET_MSG\x3c\/code\x3e action，后续则是常规的 redux 处理流程了。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader11\x22\x3e项目的使用\x3c\/h2\x3e\n\x3cp\x3eGitHub 上的项目地址：\x3ca href=\x22https:\/\/github.com\/noiron\/socket-message-push\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3esocket-message-push\x3c\/a\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22npm run dev\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs dockerfile\x22\x3e\x3ccode\x3enpm \x3cspan class=\x22hljs-keyword\x22\x3erun\x3c\/span\x3e\x3cspan class=\x22bash\x22\x3e dev\n\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e即可在 devlopment 环境下进行测试，现在你就有了一个运行在4001端口的消息推送服务器了。\x3c\/p\x3e\n\x3cp\x3e但是这里并没有后端的服务器来向我们发送消息，所以我们将利用 Postman 来模拟发送消息。\x3c\/p\x3e\n\x3cp\x3e为了展示程序的功能，在项目的 client 文件夹下放置了一个 \x3ccode\x3eindex.html\x3c\/code\x3e 文件。注意这个文件并不能用在实际的项目中，只是用来显示消息推送的效果而已。\x3c\/p\x3e\n\x3cp\x3e在开启了服务器之后，打开 \x3ccode\x3eclient\/index.html\x3c\/code\x3e，根据提示随意输入一个 tokenId 即可。\x3c\/p\x3e\n\x3cp\x3e现在利用 Postman 向 \x3ccode\x3elocalhost:4001\/api\x3c\/code\x3e post 如下的一条信息：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22{ \n    \/\/ tokens 数组表示你想向哪个用户推送消息\n    \x26quot;tokens\x26quot;: [\x26quot;1\x26quot;, \x26quot;2\x26quot;], \n    \x26quot;data\x26quot;: \x26quot;You shall not pass!!!\x26quot;\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs clojure\x22\x3e\x3ccode\x3e{ \n    \/\/ tokens 数组表示你想向哪个用户推送消息\n    \x3cspan class=\x22hljs-string\x22\x3e\x22tokens\x22\x3c\/span\x3e: [\x3cspan class=\x22hljs-string\x22\x3e\x221\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x222\x22\x3c\/span\x3e], \n    \x3cspan class=\x22hljs-string\x22\x3e\x22data\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22You shall not pass!!!\x22\x3c\/span\x3e\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVUc4h?w=849\x26amp;h=246\x22 src=\x22https:\/\/static.alili.tech\/img\/bVUc4h?w=849\x26amp;h=246\x22 alt=\x22postman-post-a-message\x22 title=\x22postman-post-a-message\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e至此，如果一切顺利，你应该能够在 client 的控制台中看到收到的消息了。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVUc4m?w=896\x26amp;h=79\x22 src=\x22https:\/\/static.alili.tech\/img\/bVUc4m?w=896\x26amp;h=79\x22 alt=\x22client-message\x22 title=\x22client-message\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e你可以打开多个 client 页面，输入不同的 tokenId，然后检查消息是否发送给了正确的用户。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader12\x22\x3e参考资料\x3c\/h2\x3e\n\x3cblockquote\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/socketio\/socket.io\/tree\/master\/examples\/chat\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/socketio\/s...\x3c\/a\x3e\x3cbr\x3e\x3ca href=\x22https:\/\/socket.io\/docs\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/socket.io\/docs\/\x3c\/a\x3e\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3chr\x3e\n\x3cp\x3e本文在我博客上的原地址：\x3ca href=\x22http:\/\/www.wukai.me\/2017\/08\/27\/push-message-with-socketio\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e利用 socket.io 实现消息实时推送\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>利用 socket.io 实现消息实时推送</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010974426">https://segmentfault.com/a/1190000010974426</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/h9cfvak6hwc/" target="_blank">https://alili.tech/archive/h9cfvak6hwc/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>