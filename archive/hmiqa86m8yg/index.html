<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="从koa-session中间件源码学习cookie与session"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>从koa-session中间件源码学习cookie与session | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/hmiqa86m8yg/",
				"appid": "1613049289050283", 
				"title": "从koa-session中间件源码学习cookie与session | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-22T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/1lt4pr18iyg/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/kjyexy6mtxq/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f&text=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f&text=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f&title=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f&is_video=false&description=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f&title=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f&title=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f&title=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fhmiqa86m8yg%2f&title=%e4%bb%8ekoa-session%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0cookie%e4%b8%8esession"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">从koa-session中间件源码学习cookie与session</h1><div class="meta"><div class="postdate"><time datetime="2018-12-22" itemprop="datePublished">2018-12-22</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch1 id=\x22articleHeader0\x22\x3e从koa-session中间件学习cookie与session\x3c\/h1\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e\x3ca href=\x22https:\/\/github.com\/zyl1314\/blog\/issues\/3\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e原文链接\x3c\/a\x3e\x3c\/h2\x3e\n\x3cp\x3e关于cookie和session是什么网上有很多介绍，但是具体的用法自己事实上一直不是很清楚，通过koa-session中间件的源码自己也算是对cookie和session大致搞明白了。\x3c\/p\x3e\n\x3cp\x3e在我了解cookie的时候，大多数教程讲的是这些：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function setCookie(name,value) \n{ \n    var Days = 30; \n    var exp = new Date(); \n    exp.setTime(exp.getTime() \x2b Days*24*60*60*1000); \n    document.cookie = name \x2b \x26quot;=\x26quot;\x2b escape (value) \x2b \x26quot;;expires=\x26quot; \x2b exp.toGMTString(); \n} \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esetCookie\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ename,value\x3c\/span\x3e) \n\x3c\/span\x3e{ \n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e Days = \x3cspan class=\x22hljs-number\x22\x3e30\x3c\/span\x3e; \n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e exp = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e(); \n    exp.setTime(exp.getTime() \x2b Days*\x3cspan class=\x22hljs-number\x22\x3e24\x3c\/span\x3e*\x3cspan class=\x22hljs-number\x22\x3e60\x3c\/span\x3e*\x3cspan class=\x22hljs-number\x22\x3e60\x3c\/span\x3e*\x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e); \n    \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.cookie = name \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22=\x22\x3c\/span\x3e\x2b \x3cspan class=\x22hljs-built_in\x22\x3eescape\x3c\/span\x3e (value) \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22;expires=\x22\x3c\/span\x3e \x2b exp.toGMTString(); \n} \x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e它给我一个错觉：cookie只能在客户端利用js设置读取删除等，但事实上很多的cookie是由服务端在response的headers里面写进去的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const Koa = require(\x27koa\x27);\nconst app = new Koa();\n\napp.use((ctx) =\x3e {\n  ctx.cookies.set(\x27test\x27, \x27hello\x27, {httpOnly: false});\n  ctx.body = \x27hello world\x27;\n})\n\napp.listen(3000);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Koa = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Koa();\n\napp.use(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ectx\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  ctx.cookies.set(\x3cspan class=\x22hljs-string\x22\x3e\x27test\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27hello\x27\x3c\/span\x3e, {\x3cspan class=\x22hljs-attr\x22\x3ehttpOnly\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e});\n  ctx.body = \x3cspan class=\x22hljs-string\x22\x3e\x27hello world\x27\x3c\/span\x3e;\n})\n\napp.listen(\x3cspan class=\x22hljs-number\x22\x3e3000\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e访问localhost:3000,打开控制台可以看到：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012412304?w=289\x26amp;h=50\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012412304?w=289\x26amp;h=50\x22 alt=\x22img\x22 title=\x22img\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012412305?w=293\x26amp;h=41\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012412305?w=293\x26amp;h=41\x22 alt=\x22img\x22 title=\x22img\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e那么下次浏览器再访问localhost:3000的时候就会把这些cookie信息通过request的headers带给服务器。\x3c\/p\x3e\n\x3cp\x3e了解http协议的话可以经常看到这么一句话：http是无状态的协议。什么意思呢？大致这么理解一下，就是你请求一个网站的时候，服务器不知道你是谁，比如你第一次访问了www.google.com,过了三秒钟你又访问了www.google.com,虽然这两次都是你操作的但是服务器事实上是不知道的。不过根据我们的生活经验，你登录了一个网站后，过了三秒你刷新一下，你还是在登录态的，这好像与无状态的http矛盾，其实这是因为有session。  \x3c\/p\x3e\n\x3cp\x3e按照上面的说法，session是用来保存用户信息的，那他与cookie有什么关系，事实上按照我的理解session只是一个信息保存的解决方法，实现这个方法可以有多种途径。既然cookie可以保存信息，那么我们可以直接利用cookie来实现session。对应于koa-session中间件，当我们没有写store的时候，默认即利用cookie实现session。  \x3c\/p\x3e\n\x3cp\x3e看一个官方例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const session = require(\x27koa-session\x27);\nconst Koa = require(\x27koa\x27);\nconst app = new Koa();\n\napp.keys = [\x27some secret hurr\x27];\n\nconst CONFIG = {\n  key: \x27koa:sess\x27, \/** (string) cookie key (default is koa:sess) *\/\n  \/** (number || \x27session\x27) maxAge in ms (default is 1 days) *\/\n  \/** \x27session\x27 will result in a cookie that expires when session\/browser is closed *\/\n  \/** Warning: If a session cookie is stolen, this cookie will never expire *\/\n  maxAge: 86400000,\n  overwrite: true, \/** (boolean) can overwrite or not (default true) *\/\n  httpOnly: true, \/** (boolean) httpOnly or not (default true) *\/\n  signed: true, \/** (boolean) signed or not (default true) *\/\n  rolling: false, \/** (boolean) Force a session identifier cookie to be set on every response. The expiration is reset to the original maxAge, resetting the expiration countdown. default is false **\/\n};\n\napp.use(session(CONFIG, app));\n\/\/ or if you prefer all default config, just use =\x3e app.use(session(app));\n\napp.use(ctx =\x3e {\n  \/\/ ignore favicon\n  if (ctx.path === \x27\/favicon.ico\x27) return;\n\n  let n = ctx.session.views || 0;\n  ctx.session.views = \x2b\x2bn;\n  ctx.body = n \x2b \x27 views\x27;\n});\n\napp.listen(3000);\nconsole.log(\x27listening on port 3000\x27);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs zephir\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e session = \x3cspan class=\x22hljs-keyword\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-session\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Koa = \x3cspan class=\x22hljs-keyword\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Koa();\n\napp.keys = [\x3cspan class=\x22hljs-string\x22\x3e\x27some secret hurr\x27\x3c\/span\x3e];\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e CONFIG = {\n  key: \x3cspan class=\x22hljs-string\x22\x3e\x27koa:sess\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (string) cookie key (default is koa:sess) *\/\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/** (number || \x27session\x27) maxAge in ms (default is 1 days) *\/\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/** \x27session\x27 will result in a cookie that expires when session\/browser is closed *\/\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/** Warning: If a session cookie is stolen, this cookie will never expire *\/\x3c\/span\x3e\n  maxAge: \x3cspan class=\x22hljs-number\x22\x3e86400000\x3c\/span\x3e,\n  overwrite: \x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (boolean) can overwrite or not (default true) *\/\x3c\/span\x3e\n  httpOnly: \x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (boolean) httpOnly or not (default true) *\/\x3c\/span\x3e\n  signed: \x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (boolean) signed or not (default true) *\/\x3c\/span\x3e\n  rolling: \x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (boolean) Force a session identifier cookie to be set on every response. The expiration is reset to the original maxAge, resetting the expiration countdown. default is false **\/\x3c\/span\x3e\n};\n\napp.\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e(session(CONFIG, app));\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ or if you prefer all default config, just use =\x26gt; app.use(session(app));\x3c\/span\x3e\n\napp.\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e(ctx =\x26gt; {\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ignore favicon\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (ctx.path === \x3cspan class=\x22hljs-string\x22\x3e\x27\/favicon.ico\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e n = ctx.session.views || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n  ctx.session.views = \x2b\x2bn;\n  ctx.body = n \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27 views\x27\x3c\/span\x3e;\n});\n\napp.listen(\x3cspan class=\x22hljs-number\x22\x3e3000\x3c\/span\x3e);\nconsole.log(\x3cspan class=\x22hljs-string\x22\x3e\x27listening on port 3000\x27\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e每次我们访问views都会\x2b1。  \x3c\/p\x3e\n\x3cp\x3e看一下koa-session是怎么实现的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22module.exports = function(opts, app) {\n  \/\/ session(app[, opts])\n  if (opts \x26amp;\x26amp; typeof opts.use === \x27function\x27) {\n    [ app, opts ] = [ opts, app ];\n  }\n  \/\/ app required\n  if (!app || typeof app.use !== \x27function\x27) {\n    throw new TypeError(\x27app instance required: `session(opts, app)`\x27);\n  }\n\n  opts = formatOpts(opts);\n  extendContext(app.context, opts);\n\n  return async function session(ctx, next) {\n    const sess = ctx[CONTEXT_SESSION];\n    if (sess.store) await sess.initFromExternal();\n    try {\n      await next();\n    } catch (err) {\n      throw err;\n    } finally {\n      await sess.commit();\n    }\n  };\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eopts, app\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ session(app[, opts])\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (opts \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e opts.use === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n    [ app, opts ] = [ opts, app ];\n  }\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ app required\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!app || \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e app.use !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eTypeError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27app instance required: `session(opts, app)`\x27\x3c\/span\x3e);\n  }\n\n  opts = formatOpts(opts);\n  extendContext(app.context, opts);\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esession\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ectx, next\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e sess = ctx[CONTEXT_SESSION];\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (sess.store) \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e sess.initFromExternal();\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e next();\n    } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e err;\n    } \x3cspan class=\x22hljs-keyword\x22\x3efinally\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e sess.commit();\n    }\n  };\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e一步一步的来看，formatOpts是用来做一些默认参数处理，extendContext的主要任务是对ctx做一个拦截器，如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function extendContext(context, opts) {\n  Object.defineProperties(context, {\n    [CONTEXT_SESSION]: {\n      get() {\n        if (this[_CONTEXT_SESSION]) return this[_CONTEXT_SESSION];\n        this[_CONTEXT_SESSION] = new ContextSession(this, opts);\n        return this[_CONTEXT_SESSION];\n      },\n    },\n    session: {\n      get() {\n        return this[CONTEXT_SESSION].get();\n      },\n      set(val) {\n        this[CONTEXT_SESSION].set(val);\n      },\n      configurable: true,\n    },\n    sessionOptions: {\n      get() {\n        return this[CONTEXT_SESSION].opts;\n      },\n    },\n  });\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3efunction extendContext(context, opts) {\n  Object.defineProperties(context, {\n    [CONTEXT_SESSION]: {\n      \x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e() {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[_CONTEXT_SESSION]) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[_CONTEXT_SESSION];\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[_CONTEXT_SESSION] = new ContextSession(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, opts);\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[_CONTEXT_SESSION];\n      },\n    },\n    session: {\n      \x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[CONTEXT_SESSION].\x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e();\n      },\n      \x3cspan class=\x22hljs-keyword\x22\x3eset\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3eval\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[CONTEXT_SESSION].\x3cspan class=\x22hljs-keyword\x22\x3eset\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3eval\x3c\/span\x3e);\n      },\n      configurable: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n    },\n    sessionOptions: {\n      \x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[CONTEXT_SESSION].opts;\n      },\n    },\n  });\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e所以走到下面这个代码时，事实上是新建了一个ContextSession对象sess。这个对象有个属性为session（要保存的session对象），有一些方法用来初始化session（如initFromExternal、initFromCookie），具体是什么下面用到再看。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const sess = ctx[CONTEXT_SESSION]\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs accesslog\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3econst sess = ctx\x3cspan class=\x22hljs-string\x22\x3e[CONTEXT_SESSION]\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e接着看是执行了如下代码，也即执行我们的业务逻辑\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22await next();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs hsp\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enext\x3c\/span\x3e()\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后就是下面这个了，看样子应该是类似保存cookie的操作。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22await sess.commit();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs abnf\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3eawait sess.commit()\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e至此全部流程结束，好像并没有看到有什么初始化session的操作。其实在执行我们的业务逻辑时，假入我们操作了session，如例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let n = ctx.session.views || 0;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs coq\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e n = ctx.session.views |\x3cspan class=\x22hljs-type\x22\x3e| 0\x3c\/span\x3e;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e就会触发ctx的session属性拦截器，ctx.session实际上是sess的get方法返回值（返回值其实是一个Session对象），代码如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  get() {\n    const session = this.session;\n    \/\/ already retrieved\n    if (session) return session;\n    \/\/ unset\n    if (session === false) return null;\n\n    \/\/ cookie session store\n    if (!this.store) this.initFromCookie();\n    return this.session;\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e  \x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e() {\n    const session = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.session;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ already retrieved\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (session) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e session;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ unset\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (session === \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ cookie session store\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.store) \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.initFromCookie();\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.session;\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在get里面执行了session的初始化操作，我们考虑没有store的情况即执行initFromCookie();\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  initFromCookie() {\n    debug(\x27init from cookie\x27);\n    const ctx = this.ctx;\n    const opts = this.opts;\n    const cookie = ctx.cookies.get(opts.key, opts);\n    if (!cookie) {\n      this.create();\n      return;\n    }\n\n    let json;\n    debug(\x27parse %s\x27, cookie);\n    try {\n      json = opts.decode(cookie);\n    } catch (err) {\n      \/\/ backwards compatibility:\n      \/\/ create a new session if parsing fails.\n      \/\/ new Buffer(string, \x27base64\x27) does not seem to crash\n      \/\/ when `string` is not base64-encoded.\n      \/\/ but `JSON.parse(string)` will crash.\n      debug(\x27decode %j error: %s\x27, cookie, err);\n      if (!(err instanceof SyntaxError)) {\n        \/\/ clean this cookie to ensure next request won\x27t throw again\n        ctx.cookies.set(opts.key, \x27\x27, opts);\n        \/\/ ctx.onerror will unset all headers, and set those specified in err\n        err.headers = {\n          \x27set-cookie\x27: ctx.response.get(\x27set-cookie\x27),\n        };\n        throw err;\n      }\n      this.create();\n      return;\n    }\n\n    debug(\x27parsed %j\x27, json);\n\n    if (!this.valid(json)) {\n      this.create();\n      return;\n    }\n\n    \/\/ support access `ctx.session` before session middleware\n    this.create(json);\n    this.prevHash = util.hash(this.session.toJSON());\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e  initFromCookie() {\n    debug(\x3cspan class=\x22hljs-string\x22\x3e\x27init from cookie\x27\x3c\/span\x3e);\n    const ctx = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ctx;\n    const opts = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.opts;\n    const cookie = ctx.cookies.\x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e(opts.key, opts);\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!cookie) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.create();\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    let json;\n    debug(\x3cspan class=\x22hljs-string\x22\x3e\x27parse %s\x27\x3c\/span\x3e, cookie);\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n      json = opts.decode(cookie);\n    } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ backwards compatibility:\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ create a new session if parsing fails.\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ new Buffer(string, \x27base64\x27) does not seem to crash\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ when `string` is not base64-encoded.\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ but `JSON.parse(string)` will crash.\x3c\/span\x3e\n      debug(\x3cspan class=\x22hljs-string\x22\x3e\x27decode %j error: %s\x27\x3c\/span\x3e, cookie, err);\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!(err instanceof SyntaxError)) {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ clean this cookie to ensure next request won\x27t throw again\x3c\/span\x3e\n        ctx.cookies.\x3cspan class=\x22hljs-keyword\x22\x3eset\x3c\/span\x3e(opts.key, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e, opts);\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ctx.onerror will unset all headers, and set those specified in err\x3c\/span\x3e\n        err.headers = {\n          \x3cspan class=\x22hljs-string\x22\x3e\x27set-cookie\x27\x3c\/span\x3e: ctx.response.\x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27set-cookie\x27\x3c\/span\x3e),\n        };\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e err;\n      }\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.create();\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    debug(\x3cspan class=\x22hljs-string\x22\x3e\x27parsed %j\x27\x3c\/span\x3e, json);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.valid(json)) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.create();\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ support access `ctx.session` before session middleware\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.create(json);\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.prevHash = util.hash(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.session.toJSON());\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class Session {\n  \/**\n   * Session constructor\n   * @param {Context} ctx\n   * @param {Object} obj\n   * @api private\n   *\/\n\n  constructor(ctx, obj) {\n    this._ctx = ctx;\n    if (!obj) {\n      this.isNew = true;\n    } else {\n      for (const k in obj) {\n        \/\/ restore maxAge from store\n        if (k === \x27_maxAge\x27) this._ctx.sessionOptions.maxAge = obj._maxAge;\n        else this[k] = obj[k];\n      }\n    }\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eSession\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/**\n   * Session constructor\n   * \x3cspan class=\x22hljs-doctag\x22\x3e@param\x3c\/span\x3e {Context} ctx\n   * \x3cspan class=\x22hljs-doctag\x22\x3e@param\x3c\/span\x3e {Object} obj\n   * \x3cspan class=\x22hljs-doctag\x22\x3e@api\x3c\/span\x3e private\n   *\/\x3c\/span\x3e\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(ctx, obj) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._ctx = ctx;\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!obj) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.isNew = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (const k \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e obj) {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ restore maxAge from store\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (k === \x3cspan class=\x22hljs-string\x22\x3e\x27_maxAge\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._ctx.sessionOptions.maxAge = obj._maxAge;\n        \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[k] = obj[k];\n      }\n    }\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e很明了的可以看出来其主要逻辑就是新建一个session，第一次访问服务器时session.isNew为true。  \x3c\/p\x3e\n\x3cp\x3e当我们执行完业务逻辑时，最后执行sess.commit()\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  async commit() {\n    const session = this.session;\n    const prevHash = this.prevHash;\n    const opts = this.opts;\n    const ctx = this.ctx;\n    \/\/ not accessed\n    if (undefined === session) return;\n\n    \/\/ removed\n    if (session === false) {\n      await this.remove();\n      return;\n    }\n\n    \/\/ force save session when `session._requireSave` set\n    let changed = true;\n    if (!session._requireSave) {\n      const json = session.toJSON();\n      \/\/ do nothing if new and not populated\n      if (!prevHash \x26amp;\x26amp; !Object.keys(json).length) return;\n      changed = prevHash !== util.hash(json);\n      \/\/ do nothing if not changed and not in rolling mode\n      if (!this.opts.rolling \x26amp;\x26amp; !changed) return;\n    }\n\n    if (typeof opts.beforeSave === \x27function\x27) {\n      debug(\x27before save\x27);\n      opts.beforeSave(ctx, session);\n    }\n    await this.save(changed);\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs coffeescript\x22\x3e\x3ccode\x3e  async commit() {\n    const session = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.session;\n    const prevHash = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.prevHash;\n    const opts = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.opts;\n    const ctx = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ctx;\n    \x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e accessed\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e === session) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e removed\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (session === \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.remove();\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e force save session \x3cspan class=\x22hljs-keyword\x22\x3ewhen\x3c\/span\x3e `\x3cspan class=\x22javascript\x22\x3esession._requireSave\x3c\/span\x3e` set\n    let changed = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!session._requireSave) {\n      const json = session.toJSON();\n      \x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edo\x3c\/span\x3e nothing \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eand\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e populated\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!prevHash \x26amp;\x26amp; !Object.keys(json).length) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n      changed = prevHash !== util.hash(json);\n      \x3cspan class=\x22hljs-regexp\x22\x3e\/\/\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edo\x3c\/span\x3e nothing \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e changed \x3cspan class=\x22hljs-keyword\x22\x3eand\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e rolling mode\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.opts.rolling \x26amp;\x26amp; !changed) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e opts.beforeSave === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n      debug(\x3cspan class=\x22hljs-string\x22\x3e\x27before save\x27\x3c\/span\x3e);\n      opts.beforeSave(ctx, session);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.save(changed);\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3ecommit事保存session前的准备工作，比如在我们没有强制保存session的时候它会判断时候保存session\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    let changed = true;\n    if (!session._requireSave) {\n      const json = session.toJSON();\n      \/\/ do nothing if new and not populated\n      if (!prevHash \x26amp;\x26amp; !Object.keys(json).length) return;\n      changed = prevHash !== util.hash(json);\n      \/\/ do nothing if not changed and not in rolling mode\n      if (!this.opts.rolling \x26amp;\x26amp; !changed) return;\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs maxima\x22\x3e\x3ccode\x3e    \x3cspan class=\x22hljs-built_in\x22\x3elet\x3c\/span\x3e changed = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!session._requireSave) {\n      const json = session.toJSON();\n      \/\/ \x3cspan class=\x22hljs-keyword\x22\x3edo\x3c\/span\x3e nothing \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eand\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e populated\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!prevHash \x26amp;\x26amp; !Object.keys(json).\x3cspan class=\x22hljs-built_in\x22\x3elength\x3c\/span\x3e) \x3cspan class=\x22hljs-built_in\x22\x3ereturn\x3c\/span\x3e;\n      changed = prevHash !== util.hash(json);\n      \/\/ \x3cspan class=\x22hljs-keyword\x22\x3edo\x3c\/span\x3e nothing \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e changed \x3cspan class=\x22hljs-keyword\x22\x3eand\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e rolling mode\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!this.opts.rolling \x26amp;\x26amp; !changed) \x3cspan class=\x22hljs-built_in\x22\x3ereturn\x3c\/span\x3e;\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e还提供了hook给我们使用\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    if (typeof opts.beforeSave === \x27function\x27) {\n      debug(\x27before save\x27);\n      opts.beforeSave(ctx, session);\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs less\x22\x3e\x3ccode\x3e    \x3cspan class=\x22hljs-selector-tag\x22\x3eif\x3c\/span\x3e (typeof opts.beforeSave === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-selector-tag\x22\x3edebug\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27before save\x27\x3c\/span\x3e);\n      \x3cspan class=\x22hljs-selector-tag\x22\x3eopts\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.beforeSave\x3c\/span\x3e(ctx, session);\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e到此开始真正的save session\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  async save(changed) {\n    const opts = this.opts;\n    const key = opts.key;\n    const externalKey = this.externalKey;\n    let json = this.session.toJSON();\n    \/\/ set expire for check\n    const maxAge = opts.maxAge ? opts.maxAge : ONE_DAY;\n    if (maxAge === \x27session\x27) {\n      \/\/ do not set _expire in json if maxAge is set to \x27session\x27\n      \/\/ also delete maxAge from options\n      opts.maxAge = undefined;\n    } else {\n      \/\/ set expire for check\n      json._expire = maxAge \x2b Date.now();\n      json._maxAge = maxAge;\n    }\n\n    \/\/ save to external store\n    if (externalKey) {\n      debug(\x27save %j to external key %s\x27, json, externalKey);\n      await this.store.set(externalKey, json, maxAge, {\n        changed,\n        rolling: opts.rolling,\n      });\n      this.ctx.cookies.set(key, externalKey, opts);\n      return;\n    }\n\n    \/\/ save to cookie\n    debug(\x27save %j to cookie\x27, json);\n    json = opts.encode(json);\n    \n    debug(\x27save %s\x27, json);\n\n    this.ctx.cookies.set(key, json, opts);\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs processing\x22\x3e\x3ccode\x3e  async \x3cspan class=\x22hljs-built_in\x22\x3esave\x3c\/span\x3e(changed) {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e opts = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.opts;\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ekey\x3c\/span\x3e = opts.\x3cspan class=\x22hljs-built_in\x22\x3ekey\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e externalKey = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.externalKey;\n    let json = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.session.toJSON();\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ set expire for check\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e maxAge = opts.maxAge ? opts.maxAge : ONE_DAY;\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (maxAge === \x3cspan class=\x22hljs-string\x22\x3e\x27session\x27\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ do not set _expire in json if maxAge is set to \x27session\x27\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ also delete maxAge from options\x3c\/span\x3e\n      opts.maxAge = undefined;\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ set expire for check\x3c\/span\x3e\n      json._expire = maxAge \x2b Date.now();\n      json._maxAge = maxAge;\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ save to external store\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (externalKey) {\n      debug(\x3cspan class=\x22hljs-string\x22\x3e\x27save %j to external key %s\x27\x3c\/span\x3e, json, externalKey);\n      await \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.store.\x3cspan class=\x22hljs-built_in\x22\x3eset\x3c\/span\x3e(externalKey, json, maxAge, {\n        changed,\n        rolling: opts.rolling,\n      });\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ctx.cookies.\x3cspan class=\x22hljs-built_in\x22\x3eset\x3c\/span\x3e(\x3cspan class=\x22hljs-built_in\x22\x3ekey\x3c\/span\x3e, externalKey, opts);\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ save to cookie\x3c\/span\x3e\n    debug(\x3cspan class=\x22hljs-string\x22\x3e\x27save %j to cookie\x27\x3c\/span\x3e, json);\n    json = opts.encode(json);\n    \n    debug(\x3cspan class=\x22hljs-string\x22\x3e\x27save %s\x27\x3c\/span\x3e, json);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ctx.cookies.\x3cspan class=\x22hljs-built_in\x22\x3eset\x3c\/span\x3e(\x3cspan class=\x22hljs-built_in\x22\x3ekey\x3c\/span\x3e, json, opts);\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e对于我们讨论的这种情况，可以看到就是将信息encode之后写入了cookie，并且包含了两个字段_expire和_maxAge。  \x3c\/p\x3e\n\x3cp\x3e简单验证一下,CONFIG添加encode和decode\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const CONFIG = {\n  key: \x27koa:sess\x27, \/** (string) cookie key (default is koa:sess) *\/\n  \/** (number || \x27session\x27) maxAge in ms (default is 1 days) *\/\n  \/** \x27session\x27 will result in a cookie that expires when session\/browser is closed *\/\n  \/** Warning: If a session cookie is stolen, this cookie will never expire *\/\n  maxAge: 86400000,\n  overwrite: true, \/** (boolean) can overwrite or not (default true) *\/\n  httpOnly: true, \/** (boolean) httpOnly or not (default true) *\/\n  signed: true, \/** (boolean) signed or not (default true) *\/\n  rolling: false, \/** (boolean) Force a session identifier cookie to be set on every response. The expiration is reset to the original maxAge, resetting the expiration countdown. default is false **\/\n  encode: json =\x3e JSON.stringify(json),\n  decode: str =\x3e JSON.parse(str)\n};\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs vbscript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e CONFIG = {\n  key: \x3cspan class=\x22hljs-comment\x22\x3e\x27koa:sess\x27, \/** (string) cookie key (default is koa:sess) *\/\x3c\/span\x3e\n  \/** (number || \x3cspan class=\x22hljs-comment\x22\x3e\x27session\x27) maxAge in ms (default is 1 days) *\/\x3c\/span\x3e\n  \/** \x3cspan class=\x22hljs-comment\x22\x3e\x27session\x27 will result in a cookie that expires when session\/browser is closed *\/\x3c\/span\x3e\n  \/** Warning: \x3cspan class=\x22hljs-keyword\x22\x3eIf\x3c\/span\x3e a session cookie \x3cspan class=\x22hljs-keyword\x22\x3eis\x3c\/span\x3e stolen, this cookie will never expire *\/\n  maxAge: \x3cspan class=\x22hljs-number\x22\x3e86400000\x3c\/span\x3e,\n  overwrite: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \/** (boolean) can overwrite \x3cspan class=\x22hljs-keyword\x22\x3eor\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e) *\/\n  httpOnly: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \/** (boolean) httpOnly \x3cspan class=\x22hljs-keyword\x22\x3eor\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e) *\/\n  signed: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \/** (boolean) signed \x3cspan class=\x22hljs-keyword\x22\x3eor\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e) *\/\n  rolling: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e, \/** (boolean) Force a session identifier cookie \x3cspan class=\x22hljs-keyword\x22\x3eto\x3c\/span\x3e be \x3cspan class=\x22hljs-keyword\x22\x3eset\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eon\x3c\/span\x3e every \x3cspan class=\x22hljs-built_in\x22\x3eresponse\x3c\/span\x3e. The expiration \x3cspan class=\x22hljs-keyword\x22\x3eis\x3c\/span\x3e reset \x3cspan class=\x22hljs-keyword\x22\x3eto\x3c\/span\x3e the original maxAge, resetting the expiration countdown. \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eis\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e **\/\n  encode: json =\x26gt; JSON.stringify(json),\n  decode: str =\x26gt; JSON.parse(str)\n};\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e第一次访问时\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012412306?w=582\x26amp;h=27\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012412306?w=582\x26amp;h=27\x22 alt=\x22img\x22 title=\x22img\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e再次访问  \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012412307?w=596\x26amp;h=34\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012412307?w=596\x26amp;h=34\x22 alt=\x22img\x22 title=\x22img\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e_expire用来下次访问服务器时判断session是否已过期\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  valid(json) {\n    if (!json) return false;\n\n    if (json._expire \x26amp;\x26amp; json._expire \x3c Date.now()) {\n      debug(\x27expired session\x27);\n      return false;\n    }\n\n    const valid = this.opts.valid;\n    if (typeof valid === \x27function\x27 \x26amp;\x26amp; !valid(this.ctx, json)) {\n      \/\/ valid session value fail, ignore this session\n      debug(\x27invalid session\x27);\n      return false;\n    }\n    return true;\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e  valid(json) {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!json) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (json._expire \x26amp;\x26amp; json._expire \x26lt; Date.now()) {\n      debug(\x3cspan class=\x22hljs-string\x22\x3e\x27expired session\x27\x3c\/span\x3e);\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n    }\n\n    const valid = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.opts.valid;\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (typeof valid === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e \x26amp;\x26amp; !valid(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ctx, json)) {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ valid session value fail, ignore this session\x3c\/span\x3e\n      debug(\x3cspan class=\x22hljs-string\x22\x3e\x27invalid session\x27\x3c\/span\x3e);\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e_maxAge用来保存过期时间,ctx.sessionOptions经过拦截器指向的其实是sess.opts\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class Session {\n  \/**\n   * Session constructor\n   * @param {Context} ctx\n   * @param {Object} obj\n   * @api private\n   *\/\n\n  constructor(ctx, obj) {\n    this._ctx = ctx;\n    if (!obj) {\n      this.isNew = true;\n    } else {\n      for (const k in obj) {\n        \/\/ restore maxAge from store\n        if (k === \x27_maxAge\x27) this._ctx.sessionOptions.maxAge = obj._maxAge;\n        else this[k] = obj[k];\n      }\n    }\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eSession\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/**\n   * Session constructor\n   * \x3cspan class=\x22hljs-doctag\x22\x3e@param\x3c\/span\x3e {Context} ctx\n   * \x3cspan class=\x22hljs-doctag\x22\x3e@param\x3c\/span\x3e {Object} obj\n   * \x3cspan class=\x22hljs-doctag\x22\x3e@api\x3c\/span\x3e private\n   *\/\x3c\/span\x3e\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(ctx, obj) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._ctx = ctx;\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!obj) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.isNew = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (const k \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e obj) {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ restore maxAge from store\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (k === \x3cspan class=\x22hljs-string\x22\x3e\x27_maxAge\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._ctx.sessionOptions.maxAge = obj._maxAge;\n        \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[k] = obj[k];\n      }\n    }\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e画一个简单的流程图看一下这整个逻辑时怎样的  \x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012412308?w=1177\x26amp;h=443\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012412308?w=1177\x26amp;h=443\x22 alt=\x22img\x22 title=\x22img\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e通常情况下，把session保存在cookie有下面两个缺点：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3eSession is stored on client side unencrypted\x3c\/li\x3e\n\x3cli\x3eBrowser cookies always have length limits\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e所以可以把session保存在数据库中等，在koa-session中，可以设置store并提供三个方法：get、set、destroy。\x3c\/p\x3e\n\x3cp\x3e当设置了store的时候，初始化操作是在initFromExternal完成的\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  async initFromExternal() {\n    debug(\x27init from external\x27);\n    const ctx = this.ctx;\n    const opts = this.opts;\n\n    const externalKey = ctx.cookies.get(opts.key, opts);\n    debug(\x27get external key from cookie %s\x27, externalKey);\n\n    if (!externalKey) {\n      \/\/ create a new `externalKey`\n      this.create();\n      return;\n    }\n\n    const json = await this.store.get(externalKey, opts.maxAge, { rolling: opts.rolling });\n    if (!this.valid(json)) {\n      \/\/ create a new `externalKey`\n      this.create();\n      return;\n    }\n\n    \/\/ create with original `externalKey`\n    this.create(json, externalKey);\n    this.prevHash = util.hash(this.session.toJSON());\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e  async initFromExternal() {\n    debug(\x3cspan class=\x22hljs-string\x22\x3e\x27init from external\x27\x3c\/span\x3e);\n    const ctx = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ctx;\n    const opts = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.opts;\n\n    const externalKey = ctx.cookies.\x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e(opts.key, opts);\n    debug(\x3cspan class=\x22hljs-string\x22\x3e\x27get external key from cookie %s\x27\x3c\/span\x3e, externalKey);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!externalKey) {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ create a new `externalKey`\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.create();\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    const json = await \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.store.\x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e(externalKey, opts.maxAge, { rolling: opts.rolling });\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.valid(json)) {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ create a new `externalKey`\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.create();\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ create with original `externalKey`\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.create(json, externalKey);\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.prevHash = util.hash(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.session.toJSON());\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eexternalKey事实上是session数据的索引，此时相比于直接把session存在cookie来说多了一层，cookie里面存的不是session而是找到session的钥匙。当然我们保存的时候就要做两个工作，一是将session存入数据库，另一个是将session对应的key即（externalKey）写入到cookie,如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    \/\/ save to external store\n    if (externalKey) {\n      debug(\x27save %j to external key %s\x27, json, externalKey);\n      await this.store.set(externalKey, json, maxAge, {\n        changed,\n        rolling: opts.rolling,\n      });\n      this.ctx.cookies.set(key, externalKey, opts);\n      return;\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ save to external store\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (externalKey) {\n      debug(\x3cspan class=\x22hljs-string\x22\x3e\x27save %j to external key %s\x27\x3c\/span\x3e, json, externalKey);\n      await \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.store.\x3cspan class=\x22hljs-keyword\x22\x3eset\x3c\/span\x3e(externalKey, json, maxAge, {\n        changed,\n        rolling: opts.rolling,\n      });\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ctx.cookies.\x3cspan class=\x22hljs-keyword\x22\x3eset\x3c\/span\x3e(key, externalKey, opts);\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们可以测试一下，事实上我们可以把session存在任意的媒介，不一定非要是数据库（主要是电脑没装数据库），只要store提供了三个接口即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const session = require(\x27koa-session\x27);\nconst Koa = require(\x27koa\x27);\nconst app = new Koa();\nconst path = require(\x27path\x27);\nconst fs = require(\x27fs\x27);\n\napp.keys = [\x27some secret hurr\x27];\n\nconst store = {\n  get(key) {\n    const sessionDir = path.resolve(__dirname, \x27.\/session\x27);\n    const files = fs.readdirSync(sessionDir);\n\n    for (let i = 0; i \x3c files.length; i\x2b\x2b) {\n      if (files[i].startsWith(key)) {\n        const filepath = path.resolve(sessionDir, files[i]);\n        delete require.cache[require.resolve(filepath)];\n        const result = require(filepath);\n        return result;\n      }\n    }\n  },\n  set(key, session) {\n    const filePath = path.resolve(__dirname, \x27.\/session\x27, `${key}.js`);\n    const content = `module.exports = ${JSON.stringify(session)};`;\n    \n    fs.writeFileSync(filePath, content);\n  },\n\n  destroy(key){\n    const filePath = path.resolve(__dirname, \x27.\/session\x27, `${key}.js`);\n    fs.unlinkSync(filePath);\n  }\n}\n\nconst CONFIG = {\n  key: \x27koa:sess\x27, \/** (string) cookie key (default is koa:sess) *\/\n  \/** (number || \x27session\x27) maxAge in ms (default is 1 days) *\/\n  \/** \x27session\x27 will result in a cookie that expires when session\/browser is closed *\/\n  \/** Warning: If a session cookie is stolen, this cookie will never expire *\/\n  maxAge: 86400000,\n  overwrite: true, \/** (boolean) can overwrite or not (default true) *\/\n  httpOnly: true, \/** (boolean) httpOnly or not (default true) *\/\n  signed: true, \/** (boolean) signed or not (default true) *\/\n  rolling: false, \/** (boolean) Force a session identifier cookie to be set on every response. The expiration is reset to the original maxAge, resetting the expiration countdown. default is false **\/\n  store\n};\n\napp.use(session(CONFIG, app));\n\/\/ or if you prefer all default config, just use =\x3e app.use(session(app));\n\napp.use(ctx =\x3e {\n  \/\/ ignore favicon\n  if (ctx.path === \x27\/favicon.ico\x27) return;\n  let n = ctx.session.views || 0;\n  ctx.session.views = \x2b\x2bn;\n  if (n \x3e=5 ) ctx.session = null;\n  ctx.body = n \x2b \x27 views\x27;\n});\n\napp.listen(3000);\nconsole.log(\x27listening on port 3000\x27);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs typescript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e session = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-session\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Koa = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Koa();\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fs = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fs\x27\x3c\/span\x3e);\n\napp.keys = [\x3cspan class=\x22hljs-string\x22\x3e\x27some secret hurr\x27\x3c\/span\x3e];\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e store = {\n  \x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e(key) {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e sessionDir = path.resolve(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27.\/session\x27\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e files = fs.readdirSync(sessionDir);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; files.length; i\x2b\x2b) {\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (files[i].startsWith(key)) {\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e filepath = path.resolve(sessionDir, files[i]);\n        \x3cspan class=\x22hljs-keyword\x22\x3edelete\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e.cache[\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e.resolve(filepath)];\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e result = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(filepath);\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e result;\n      }\n    }\n  },\n  \x3cspan class=\x22hljs-keyword\x22\x3eset\x3c\/span\x3e(key, session) {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e filePath = path.resolve(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27.\/session\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${key}\x3c\/span\x3e.js`\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e content = \x3cspan class=\x22hljs-string\x22\x3e`module.exports = \x3cspan class=\x22hljs-subst\x22\x3e${JSON.stringify(session)}\x3c\/span\x3e;`\x3c\/span\x3e;\n    \n    fs.writeFileSync(filePath, content);\n  },\n\n  destroy(key){\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e filePath = path.resolve(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27.\/session\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${key}\x3c\/span\x3e.js`\x3c\/span\x3e);\n    fs.unlinkSync(filePath);\n  }\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e CONFIG = {\n  key: \x3cspan class=\x22hljs-string\x22\x3e\x27koa:sess\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (string) cookie key (default is koa:sess) *\/\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/** (number || \x27session\x27) maxAge in ms (default is 1 days) *\/\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/** \x27session\x27 will result in a cookie that expires when session\/browser is closed *\/\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/** Warning: If a session cookie is stolen, this cookie will never expire *\/\x3c\/span\x3e\n  maxAge: \x3cspan class=\x22hljs-number\x22\x3e86400000\x3c\/span\x3e,\n  overwrite: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (boolean) can overwrite or not (default true) *\/\x3c\/span\x3e\n  httpOnly: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (boolean) httpOnly or not (default true) *\/\x3c\/span\x3e\n  signed: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (boolean) signed or not (default true) *\/\x3c\/span\x3e\n  rolling: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/** (boolean) Force a session identifier cookie to be set on every response. The expiration is reset to the original maxAge, resetting the expiration countdown. default is false **\/\x3c\/span\x3e\n  store\n};\n\napp.use(session(CONFIG, app));\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ or if you prefer all default config, just use =\x26gt; app.use(session(app));\x3c\/span\x3e\n\napp.use(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ectx\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ignore favicon\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (ctx.path === \x3cspan class=\x22hljs-string\x22\x3e\x27\/favicon.ico\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e n = ctx.session.views || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n  ctx.session.views = \x2b\x2bn;\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (n \x26gt;=\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e ) ctx.session = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n  ctx.body = n \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27 views\x27\x3c\/span\x3e;\n});\n\napp.listen(\x3cspan class=\x22hljs-number\x22\x3e3000\x3c\/span\x3e);\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27listening on port 3000\x27\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e浏览器输入localhost:3000，刷新五次则views重新开始计数。  \x3c\/p\x3e\n\x3cp\x3e全文完。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>从koa-session中间件源码学习cookie与session</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000012412299">https://segmentfault.com/a/1190000012412299</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/hmiqa86m8yg/" target="_blank">https://alili.tech/archive/hmiqa86m8yg/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>