<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="【babel&#43;小程序】记“编写babel插件”与“通过语法解析替换小程序路由表”的经历"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>【babel&#43;小程序】记“编写babel插件”与“通过语法解析替换小程序路由表”的经历 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/i9f8gg837si/",
				"appid": "1613049289050283", 
				"title": "【babel&#43;小程序】记“编写babel插件”与“通过语法解析替换小程序路由表”的经历 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-14T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/eweftqpdx8m/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/gye0ej77uom/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f&text=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f&text=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f&title=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f&is_video=false&description=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f&title=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f&title=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f&title=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fi9f8gg837si%2f&title=%e3%80%90babel%2b%e5%b0%8f%e7%a8%8b%e5%ba%8f%e3%80%91%e8%ae%b0%e2%80%9c%e7%bc%96%e5%86%99babel%e6%8f%92%e4%bb%b6%e2%80%9d%e4%b8%8e%e2%80%9c%e9%80%9a%e8%bf%87%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90%e6%9b%bf%e6%8d%a2%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%b7%af%e7%94%b1%e8%a1%a8%e2%80%9d%e7%9a%84%e7%bb%8f%e5%8e%86"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">【babel&#43;小程序】记“编写babel插件”与“通过语法解析替换小程序路由表”的经历</h1><div class="meta"><div class="postdate"><time datetime="2018-12-14" itemprop="datePublished">2018-12-14</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e话不多说先上图，简要说明一下干了些什么事。图可能太模糊，可以点\x3ca href=\x22http:\/\/o8swwgh2r.bkt.clouddn.com\/babel-pages.svg\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3esvg\x3c\/a\x3e看看\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bV3fs4?w=771\x26amp;h=631\x22 src=\x22https:\/\/static.alili.tech\/img\/bV3fs4?w=771\x26amp;h=631\x22 alt=\x22流程图\x22 title=\x22流程图\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e背景\x3c\/h2\x3e\n\x3cp\x3e最近公司开展了小程序的业务，派我去负责这一块的业务，其中需要处理的一个问题是接入我们web开发的传统架构--\x3cstrong\x3e模块化开发\x3c\/strong\x3e。\x3cbr\x3e我们来详细说一下模块化开发具体是怎么样的。\x3cbr\x3e我们的git工作流采用的是\x3ca href=\x22https:\/\/danielkummer.github.io\/git-flow-cheatsheet\/index.zh_CN.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3egit flow\x3c\/a\x3e。一个项目会拆分成几个模块，然后一人负责一个模块（对应git flow的一个feature）独立开发。模块开发并与后端联通后再合并至develop进行集成测试，后续经过一系列测试再发布版本。\x3cbr\x3e目录结构大体如图所示，一个模块包含了他自己的pages \/ components \/ assets \/ model \/ mixins \/ apis \/ routes \/ scss等等。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bV3ft6?w=718\x26amp;h=796\x22 src=\x22https:\/\/static.alili.tech\/img\/bV3ft6?w=718\x26amp;h=796\x22 alt=\x22开发目录\x22 title=\x22开发目录\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这种开发模式的好处不言而喻，每个人都可以并行开发，大大提升开发速度。这次就是要移植这种开发模式到小程序中。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e目标\x3c\/h2\x3e\n\x3cp\x3e背景说完了，那么来明确一下我们的目标。\x3cbr\x3e我采用的是\x3ca href=\x22https:\/\/github.com\/Tencent\/wepy\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ewepy\x3c\/a\x3e框架，类vue语法的开发，开发体验非常棒。在vue中，一个组件就是单文件，包含了js、html、css。wepy采用vue的语法，但由与vue稍稍有点区别，wepy的组件分为三种--wepy.app类，wepy.page类，wepy.component类。\x3cbr\x3e对应到我们的目录结构中，每个模块实际上就是一系列的page组件。要组合这一系列的模块，那么很简单，我们要做的就是把这一系列page的路由扫描成一个路由表，然后\x3ca href=\x22https:\/\/mp.weixin.qq.com\/debug\/wxadoc\/dev\/framework\/config.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e插入到小程序的入口--app.json中\x3c\/a\x3e。对应wepy框架那即是app.wpy中的pages字段。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bV3fu8?w=994\x26amp;h=520\x22 src=\x22https:\/\/static.alili.tech\/img\/bV3fu8?w=994\x26amp;h=520\x22 alt=\x22pages字段\x22 title=\x22pages字段\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e扫描路由表\x3c\/h2\x3e\n\x3cp\x3e第一步！先得到所有pages的路由并综合成一个\x3cstrong\x3e路由表\x3c\/strong\x3e！\x3cbr\x3e我的方案是，在每个模块中新建一份routes文件，相当于注册每个需要插入到入口的page的路由，不需要接入业务的page就不用注册啦。是不是很熟悉呢，对的，就是参考vue-router的注册语法。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/routes.js\nmodule.exports = [\n    {\n        name: \x27home-detail\x27,\/\/TODO: name先占位，后续再尝试通过读name跳转某页\n        page: \x27detail\x27,\/\/需要接入入口的page的文件名。例如这里是index.wpy。相对于src\/的路径就是`modules\/${moduleName}\/pages\/index`。\n    },\n    {\n        name: \x27home-index\x27,\n        page: \x27index\x27,\n        meta: {\n            weight: 100\/\/这里加了一个小功能，因为小程序指定pages数组的第一项为首页，后续我会通过这个权重字段来给pages路由排序。权重越高位置越前。\n        }\n    }\n]\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/routes.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = [\n    {\n        \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27home-detail\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-comment\x22\x3e\/\/\x3cspan class=\x22hljs-doctag\x22\x3eTODO:\x3c\/span\x3e name先占位，后续再尝试通过读name跳转某页\x3c\/span\x3e\n        page: \x3cspan class=\x22hljs-string\x22\x3e\x27detail\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-comment\x22\x3e\/\/需要接入入口的page的文件名。例如这里是index.wpy。相对于src\/的路径就是`modules\/${moduleName}\/pages\/index`。\x3c\/span\x3e\n    },\n    {\n        \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27home-index\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3epage\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27index\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3emeta\x3c\/span\x3e: {\n            \x3cspan class=\x22hljs-attr\x22\x3eweight\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e100\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/这里加了一个小功能，因为小程序指定pages数组的第一项为首页，后续我会通过这个权重字段来给pages路由排序。权重越高位置越前。\x3c\/span\x3e\n        }\n    }\n]\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e而扫描各个模块并合并路由表的脚本非常简单，读写文件就ok了。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const fs = require(\x27fs\x27)\nconst path = require(\x27path\x27)\n\nconst routeDest = path.join(__dirname, \x27..\/src\/config\/routes.js\x27)\nconst modulesPath = path.join(__dirname, \x27..\/src\/modules\x27)\n\nlet routes = []\n\nfs.readdirSync(modulesPath).forEach(module =\x3e {\n    if(module.indexOf(\x27.DS_Store\x27) \x3e -1) return \n\n    const route = require(`${modulesPath}\/${module}\/route`)\n    route.forEach(item =\x3e {\n        item.page = `modules\/${module}\/pages\/${item.page.match(\/\\\/?(.*)\/)[1]}`\n    })\n    routes = routes.concat(route)\n})\n\nfs.writeFileSync(routeDest,`module.exports = ${JSON.stringify(routes)}`, e =\x3e {\n    console.log(e)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fs = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fs\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e routeDest = path.join(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27..\/src\/config\/routes.js\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e modulesPath = path.join(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27..\/src\/modules\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e routes = []\n\nfs.readdirSync(modulesPath).forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3emodule\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.indexOf(\x3cspan class=\x22hljs-string\x22\x3e\x27.DS_Store\x27\x3c\/span\x3e) \x26gt; \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \n\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e route = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${modulesPath}\x3c\/span\x3e\/\x3cspan class=\x22hljs-subst\x22\x3e${\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e}\x3c\/span\x3e\/route`\x3c\/span\x3e)\n    route.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eitem\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        item.page = \x3cspan class=\x22hljs-string\x22\x3e`modules\/\x3cspan class=\x22hljs-subst\x22\x3e${\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e}\x3c\/span\x3e\/pages\/\x3cspan class=\x22hljs-subst\x22\x3e${item.page.match(\x3cspan class=\x22hljs-regexp\x22\x3e\/\\\/?(.*)\/\x3c\/span\x3e)[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e]}\x3c\/span\x3e`\x3c\/span\x3e\n    })\n    routes = routes.concat(route)\n})\n\nfs.writeFileSync(routeDest,\x3cspan class=\x22hljs-string\x22\x3e`module.exports = \x3cspan class=\x22hljs-subst\x22\x3e${\x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(routes)}\x3c\/span\x3e`\x3c\/span\x3e, e =\x26gt; {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(e)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e路由排序策略\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const strategies = {\n    sortByWeight(routes) {\n        routes.sort((a, b) =\x3e {\n            a.meta = a.meta || {}\n            b.meta = b.meta || {}\n\n            const weightA = a.meta.weight || 0\n            const weightB = b.meta.weight || 0\n\n            return weightB - weightA\n        })\n        return routes\n    }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e strategies = {\n    sortByWeight(routes) {\n        routes.sort(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ea, b\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n            a.meta = a.meta || {}\n            b.meta = b.meta || {}\n\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e weightA = a.meta.weight || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e weightB = b.meta.weight || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e weightB - weightA\n        })\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e routes\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e最后得出路由表\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const Strategies = require(\x27..\/src\/lib\/routes-model\x27)\nconst routes = Strategies.sortByWeight(require(\x27..\/src\/config\/routes\x27))\nconst pages = routes.map(item =\x3e item.page)\nconsole.log(pages)\/\/[\x27modules\/home\/pages\/index\x27, \x27modules\/home\/pages\/detail\x27]\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Strategies = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/src\/lib\/routes-model\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e routes = Strategies.sortByWeight(\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/src\/config\/routes\x27\x3c\/span\x3e))\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e pages = routes.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eitem\x3c\/span\x3e =\x26gt;\x3c\/span\x3e item.page)\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(pages)\x3cspan class=\x22hljs-comment\x22\x3e\/\/[\x27modules\/home\/pages\/index\x27, \x27modules\/home\/pages\/detail\x27]\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e替换路由数组\x3c\/h2\x3e\n\x3cp\x3eSo far so good...问题来了，如何替换入口文件中的路由数组。我如下做了几步尝试。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e直接引入\x3c\/h3\x3e\n\x3cp\x3e我第一感觉就是，这不很简单吗？在wepy编译之前，先跑脚本得出路由表，再import这份路由表就得了。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import routes from \x27.\/routes\x27\nexport default class extends wepy.app {\n  config = {\n    pages: routes,\/\/[\x27modules\/home\/pages\/index\x27]\n    window: {\n      backgroundTextStyle: \x27light\x27,\n      navigationBarBackgroundColor: \x27#fff\x27,\n      navigationBarTitleText: \x27大家好我是渣渣辉\x27,\n      navigationBarTextStyle: \x27black\x27\n    }\n  }\n\/\/...\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e routes \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/routes\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ewepy\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eapp\x3c\/span\x3e \x3c\/span\x3e{\n  config = {\n    \x3cspan class=\x22hljs-attr\x22\x3epages\x3c\/span\x3e: routes,\x3cspan class=\x22hljs-comment\x22\x3e\/\/[\x27modules\/home\/pages\/index\x27]\x3c\/span\x3e\n    \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3ebackgroundTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27light\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarBackgroundColor\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27#fff\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTitleText\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27大家好我是渣渣辉\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27black\x27\x3c\/span\x3e\n    }\n  }\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然而这样小程序肯定会炸啦，pages字段的值必须是静态的，在小程序运行之前就配置好，动态引入是不行的！不信的话诸君可以试试。那么就是说，划重点---\x3cstrong\x3e我们必须在wepy编译之前再预编译一次\x3c\/strong\x3e---事先替换掉pages字段的值！\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e正则匹配替换\x3c\/h3\x3e\n\x3cp\x3e既然要事先替换，那就是要精准定位pages字段的值，然后再替换掉。难点在于如果精准定位pages字段的值呢？\x3cbr\x3e最捞然而最快的方法：正则匹配。\x3cbr\x3e事先定好编码规范，在pages字段的值的前后添加\x3ccode\x3e\/* __ROUTES__ *\/\x3c\/code\x3e的注释\x3c\/p\x3e\n\x3cp\x3e脚本如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const fs = require(\x27fs\x27)\nconst path = require(\x27path\x27)\nimport routes from \x27.\/routes\x27\n\nfunction replace(source, arr) {\n    const matchResult = source.match(\/\\\/\\* __ROUTE__ \\*\\\/([\\s\\S]*)\\\/\\* __ROUTE__ \\*\\\/\/)\n    if(!matchResult) {\n        throw new Error(\x27必须包含\/* __ROUTE__ *\/标记注释\x27)\n    }\n    const str = arr.reduce((pre, next, index, curArr) =\x3e {\n        return pre \x2b= `\x27${curArr[index]}\x27, `\n    }, \x27\x27)\n    return source.replace(matchResult[1], str)\n}\n\nconst entryFile = path.join(__dirname, \x27..\/src\/app.wpy\x27)\nlet entry = fs.readFileSync(entryFile, {encoding: \x27UTF-8\x27})\n\nentry = replace(entry, routes)\n\nfs.writeFileSync(entryFile, entry)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fs = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fs\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e routes \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/routes\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereplace\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3esource, arr\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e matchResult = source.match(\x3cspan class=\x22hljs-regexp\x22\x3e\/\\\/\\* __ROUTE__ \\*\\\/([\\s\\S]*)\\\/\\* __ROUTE__ \\*\\\/\/\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(!matchResult) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27必须包含\/* __ROUTE__ *\/标记注释\x27\x3c\/span\x3e)\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e str = arr.reduce(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3epre, next, index, curArr\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e pre \x2b= \x3cspan class=\x22hljs-string\x22\x3e`\x27\x3cspan class=\x22hljs-subst\x22\x3e${curArr[index]}\x3c\/span\x3e\x27, `\x3c\/span\x3e\n    }, \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e source.replace(matchResult[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e], str)\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e entryFile = path.join(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27..\/src\/app.wpy\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e entry = fs.readFileSync(entryFile, {\x3cspan class=\x22hljs-attr\x22\x3eencoding\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27UTF-8\x27\x3c\/span\x3e})\n\nentry = replace(entry, routes)\n\nfs.writeFileSync(entryFile, entry)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eapp.wpy的变化如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/before\nexport default class extends wepy.app {\n  config = {\n    pages: [\n    \/* __ROUTE__ *\/\n    \/* __ROUTE__ *\/\n    ],\n    window: {\n      backgroundTextStyle: \x27light\x27,\n      navigationBarBackgroundColor: \x27#fff\x27,\n      navigationBarTitleText: \x27大家好我是渣渣辉\x27,\n      navigationBarTextStyle: \x27black\x27\n    }\n  }\n\/\/...\n}\n\/\/after\nexport default class extends wepy.app {\n  config = {\n    pages: [\n\/* __ROUTE__ *\/\x27modules\/home\/pages\/index\x27, \/* __ROUTE__ *\/\n    ],\n    window: {\n      backgroundTextStyle: \x27light\x27,\n      navigationBarBackgroundColor: \x27#fff\x27,\n      navigationBarTitleText: \x27大家好我是渣渣辉\x27,\n      navigationBarTextStyle: \x27black\x27\n    }\n  }\n\/\/...\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/before\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ewepy\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eapp\x3c\/span\x3e \x3c\/span\x3e{\n  config = {\n    \x3cspan class=\x22hljs-attr\x22\x3epages\x3c\/span\x3e: [\n    \x3cspan class=\x22hljs-comment\x22\x3e\/* __ROUTE__ *\/\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/* __ROUTE__ *\/\x3c\/span\x3e\n    ],\n    \x3cspan class=\x22hljs-attr\x22\x3ewindow\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3ebackgroundTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27light\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarBackgroundColor\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27#fff\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTitleText\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27大家好我是渣渣辉\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27black\x27\x3c\/span\x3e\n    }\n  }\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n}\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/after\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ewepy\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eapp\x3c\/span\x3e \x3c\/span\x3e{\n  config = {\n    \x3cspan class=\x22hljs-attr\x22\x3epages\x3c\/span\x3e: [\n\x3cspan class=\x22hljs-comment\x22\x3e\/* __ROUTE__ *\/\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x27modules\/home\/pages\/index\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/* __ROUTE__ *\/\x3c\/span\x3e\n    ],\n    \x3cspan class=\x22hljs-attr\x22\x3ewindow\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3ebackgroundTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27light\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarBackgroundColor\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27#fff\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTitleText\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27大家好我是渣渣辉\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27black\x27\x3c\/span\x3e\n    }\n  }\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e行吧，也总算跑通了。因为项目很赶，所以先用这个方案开发了一个半星期。开发完之后总觉得这种方案太难受，于是密谋着换另一种各精准的自动的方案。。。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3ebabel插件替换全局常量\x3c\/h3\x3e\n\x3ch4\x3e1.思路\x3c\/h4\x3e\n\x3cp\x3e想必大家肯定很熟悉这种模式\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let host = \x27http:\/\/www.tanwanlanyue.com\/\x27\nif(process.env.NODE_ENV === \x27production\x27){\n    host = \x27http:\/\/www.zhazhahui.com\/\x27\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e host = \x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/www.tanwanlanyue.com\/\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(process.env.NODE_ENV === \x3cspan class=\x22hljs-string\x22\x3e\x27production\x27\x3c\/span\x3e){\n    host = \x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/www.zhazhahui.com\/\x27\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e通过这种只在编译过程中存在的全局常量，我们可以做很多值的匹配。\x3cbr\x3e因为wepy已经预编译了一层，在框架内的业务代码是读取不了process.env.NODE_ENV的值。我就想着要不做一个类似于webpack的DefinePlugin的babel插件吧。具体的思路是babel编译过程中访问ast时匹配需要替换的标识符或者表达式，然后替换掉相应的值。例如：\x3cbr\x3e\x3cstrong\x3eIn\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22export default class extends wepy.app {\n  config = {\n    pages: __ROUTE__,\n    window: {\n      backgroundTextStyle: \x27light\x27,\n      navigationBarBackgroundColor: \x27#fff\x27,\n      navigationBarTitleText: \x27大家好我是渣渣辉\x27,\n      navigationBarTextStyle: \x27black\x27\n    }\n  }\n\/\/...\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ewepy\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eapp\x3c\/span\x3e \x3c\/span\x3e{\n  config = {\n    \x3cspan class=\x22hljs-attr\x22\x3epages\x3c\/span\x3e: __ROUTE__,\n    \x3cspan class=\x22hljs-attr\x22\x3ewindow\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3ebackgroundTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27light\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarBackgroundColor\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27#fff\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTitleText\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27大家好我是渣渣辉\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27black\x27\x3c\/span\x3e\n    }\n  }\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3eOut\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22export default class extends wepy.app {\n  config = {\n    pages: [\n        \x27modules\/home\/pages\/index\x27,\n    ],\n    window: {\n      backgroundTextStyle: \x27light\x27,\n      navigationBarBackgroundColor: \x27#fff\x27,\n      navigationBarTitleText: \x27大家好我是渣渣辉\x27,\n      navigationBarTextStyle: \x27black\x27\n    }\n  }\n\/\/...\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ewepy\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eapp\x3c\/span\x3e \x3c\/span\x3e{\n  config = {\n    \x3cspan class=\x22hljs-attr\x22\x3epages\x3c\/span\x3e: [\n        \x3cspan class=\x22hljs-string\x22\x3e\x27modules\/home\/pages\/index\x27\x3c\/span\x3e,\n    ],\n    \x3cspan class=\x22hljs-attr\x22\x3ewindow\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3ebackgroundTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27light\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarBackgroundColor\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27#fff\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTitleText\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27大家好我是渣渣辉\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3enavigationBarTextStyle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27black\x27\x3c\/span\x3e\n    }\n  }\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e2.学习如何编写babel插件\x3c\/h4\x3e\n\x3cp\x3e在这里先要给大家推荐几份学习资料：\x3cbr\x3e首先是babel官网推荐的这份\x3ca href=\x22https:\/\/github.com\/thejameskyle\/the-super-tiny-compiler\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e迷你编译器的代码\x3c\/a\x3e，读完之后基本能理解编译器做的三件事：解析，转换，生成的过程了。\x3cbr\x3e其次是\x3ca href=\x22https:\/\/github.com\/thejameskyle\/babel-handbook\/blob\/master\/translations\/zh-Hans\/plugin-handbook.md\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e编写Babel插件入门手册\x3c\/a\x3e。基本涵盖了编写插件的方方面面，不过由于babel几个工具文档的缺失，在写插件的时候需要去翻查代码中的注释阅读api用法。\x3cbr\x3e然后是大杀器\x3ca href=\x22https:\/\/astexplorer.net\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eAST转换器\x3c\/a\x3e--astexplorer.net。我们来看一下，babel的解析器--babylon的文档，\x3ca href=\x22https:\/\/github.com\/babel\/babylon\/blob\/master\/ast\/spec.md\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e涵盖的节点类型\x3c\/a\x3e这么多，脑绘一张AST树不现实。我在编写脚本的时候会先把代码放在转换器内生成AST树，再一步一步走。\x3c\/p\x3e\n\x3cp\x3e编写babel插件之前先要理解抽象语法树这个概念。编译器做的事可以总结为：解析，转换，生成。具体的概念解释去看入门手册可能会更好。这里讲讲我自己的一些理解。\x3c\/p\x3e\n\x3cp\x3e解析包括词法分析与语法分析。\x3cbr\x3e解析过程吧。其实按我的理解（不知道这样合适不合适= =）抽象语法树跟DOM树其实很类似。词法分析有点像是把html解析成一个一个的dom节点的过程，语法分析则有点像是将dom节点描述成dom树。\x3c\/p\x3e\n\x3cp\x3e转换过程是编译器最复杂逻辑最集中的地方。首先要理解“树形遍历”与“访问者模式”两个概念。\x3c\/p\x3e\n\x3cp\x3e“树形遍历”如手册中所举例子:\x3cbr\x3e假设有这么一段代码:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function square(n) {\n  return n * n;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs ada\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esquare\x3c\/span\x3e(n) {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3en\x3c\/span\x3e * n;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e那么有如下的树形结构:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22- FunctionDeclaration\n  - Identifier (id)\n  - Identifier (params[0])\n  - BlockStatement (body)\n    - ReturnStatement (body)\n      - BinaryExpression (argument)\n        - Identifier (left)\n        - Identifier (right)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e- FunctionDeclaration\n  - Identifier (id)\n  - Identifier (params[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e])\n  - BlockStatement (body)\n    - ReturnStatement (body)\n      - BinaryExpression (argument)\n        - Identifier (left)\n        - Identifier (right)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3e\n\x3cp\x3e进入\x3ccode\x3eFunctionDeclaration\x3c\/code\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e进入\x3ccode\x3eIdentifier (id)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3e走到尽头\x3c\/li\x3e\n\x3cli\x3e退出\x3ccode\x3eIdentifier (id)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3e进入\x3ccode\x3eIdentifier (params[0])\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3e走到尽头\x3c\/li\x3e\n\x3cli\x3e退出\x3ccode\x3eIdentifier (params[0])\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e进入\x3ccode\x3eBlockStatement (body)\x3c\/code\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cp\x3e进入 \x3ccode\x3eReturnStatement (body)\x3c\/code\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cp\x3e进入 \x3ccode\x3eBinaryExpression (argument)\x3c\/code\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e进入 \x3ccode\x3eIdentifier (left)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3e退出 \x3ccode\x3eIdentifier (left)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3e进入 \x3ccode\x3eIdentifier (right)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3cli\x3e退出 \x3ccode\x3eIdentifier (right)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e退出 \x3ccode\x3eBinaryExpression (argument)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e退出 \x3ccode\x3eReturnStatement (body)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e退出\x3ccode\x3eBlockStatement (body)\x3c\/code\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e“访问者模式”则可以理解为，进入一个节点时被调用的方法。例如有如下的访问者：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const idVisitor = {\n  Identifier() {\/\/在进行树形遍历的过程中，节点为标识符时，访问者就会被调用\n    console.log(\x26quot;visit an Identifier\x26quot;)\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs cpp\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e idVisitor = {\n  Identifier() {\x3cspan class=\x22hljs-comment\x22\x3e\/\/在进行树形遍历的过程中，节点为标识符时，访问者就会被调用\x3c\/span\x3e\n    console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22visit an Identifier\x22\x3c\/span\x3e)\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e结合树形遍历来看，就是说每个访问者有进入、退出两次机会来访问一个节点。\x3cbr\x3e\x3cstrong\x3e而我们这个替换常量的插件的关键之处就是在于，访问节点时，通过识别节点为我们的目标，然后替换他的值！\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch4\x3e3.动手写插件\x3c\/h4\x3e\n\x3cp\x3e话不多说，直接上代码。这里要用到的一个工具是\x3ccode\x3ebabel-types\x3c\/code\x3e，用来检查节点。\x3c\/p\x3e\n\x3cp\x3e难度其实并不大，主要工作在于熟悉如何匹配目标节点。如匹配memberExpression时使用matchesPattern方法，匹配标识符则直接检查节点的name等等套路。最终成品及用法可以见\x3ca href=\x22https:\/\/github.com\/ZhaZhengRefn\/babel-plugin-global-define\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e我的github\x3c\/a\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const memberExpressionMatcher = (path, key) =\x3e path.matchesPattern(key)\/\/复杂表达式的匹配条件\nconst identifierMatcher = (path, key) =\x3e path.node.name === key\/\/标识符的匹配条件\n\nconst replacer = (path, value, valueToNode) =\x3e {\/\/替换操作的工具函数\n    path.replaceWith(valueToNode(value))\n\n    if(path.parentPath.isBinaryExpression()){\/\/转换父节点的二元表达式，如：var isProp = __ENV__ === \x27production\x27   ===\x3e   var isProp = true\n        const result = path.parentPath.evaluate()\n        if(result.confident){\n            path.parentPath.replaceWith(valueToNode(result.value))\n        }\n    }\n}\n\nexport default function ({ types: t }){\/\/这里需要用上babel-types这个工具\n    return {\n        visitor: {\n            MemberExpression(path, { opts: params }){\/\/匹配复杂表达式\n                Object.keys(params).forEach(key =\x3e {\/\/遍历Options\n                    if(memberExpressionMatcher(path, key)){\n                        replacer(path, params[key], t.valueToNode)\n                    }\n                })\n            },\n        \n            Identifier(path, { opts: params }){\/\/匹配标识符\n                Object.keys(params).forEach(key =\x3e {\/\/遍历Options\n                    if(identifierMatcher(path, key)){\n                        replacer(path, params[key], t.valueToNode)\n                    }           \n                })\n            },\n        }        \n    }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e memberExpressionMatcher = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3epath, key\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e path.matchesPattern(key)\x3cspan class=\x22hljs-comment\x22\x3e\/\/复杂表达式的匹配条件\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e identifierMatcher = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3epath, key\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e path.node.name === key\x3cspan class=\x22hljs-comment\x22\x3e\/\/标识符的匹配条件\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e replacer = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3epath, value, valueToNode\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\x3cspan class=\x22hljs-comment\x22\x3e\/\/替换操作的工具函数\x3c\/span\x3e\n    path.replaceWith(valueToNode(value))\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(path.parentPath.isBinaryExpression()){\x3cspan class=\x22hljs-comment\x22\x3e\/\/转换父节点的二元表达式，如：var isProp = __ENV__ === \x27production\x27   ===\x26gt;   var isProp = true\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e result = path.parentPath.evaluate()\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(result.confident){\n            path.parentPath.replaceWith(valueToNode(result.value))\n        }\n    }\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e{ types: t }\x3c\/span\x3e)\x3c\/span\x3e{\x3cspan class=\x22hljs-comment\x22\x3e\/\/这里需要用上babel-types这个工具\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-attr\x22\x3evisitor\x3c\/span\x3e: {\n            MemberExpression(path, { \x3cspan class=\x22hljs-attr\x22\x3eopts\x3c\/span\x3e: params }){\x3cspan class=\x22hljs-comment\x22\x3e\/\/匹配复杂表达式\x3c\/span\x3e\n                \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(params).forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ekey\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\x3cspan class=\x22hljs-comment\x22\x3e\/\/遍历Options\x3c\/span\x3e\n                    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(memberExpressionMatcher(path, key)){\n                        replacer(path, params[key], t.valueToNode)\n                    }\n                })\n            },\n        \n            Identifier(path, { \x3cspan class=\x22hljs-attr\x22\x3eopts\x3c\/span\x3e: params }){\x3cspan class=\x22hljs-comment\x22\x3e\/\/匹配标识符\x3c\/span\x3e\n                \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(params).forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ekey\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\x3cspan class=\x22hljs-comment\x22\x3e\/\/遍历Options\x3c\/span\x3e\n                    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(identifierMatcher(path, key)){\n                        replacer(path, params[key], t.valueToNode)\n                    }           \n                })\n            },\n        }        \n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e4.结果\x3c\/h4\x3e\n\x3cp\x3e当然啦，这块插件不可以写在wepy.config.js中配置。因为必须在wepy编译之前执行我们的编译脚本，替换pages字段。所以的方案是在跑\x3ccode\x3ewepy build --watch\x3c\/code\x3e\x3cbr\x3e之前跑我们的编译脚本，具体操作是引入\x3ccode\x3ebabel-core\x3c\/code\x3e来转换代码\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const babel = require(\x27babel-core\x27)\n\/\/...省略获取app.wpy过程，待会会谈到。\n\/\/...省略编写visitor过程，语法跟编写插件略有一点点不同。\nconst result = babel.transform(code, {\n    parserOpts: {\/\/babel的解析器，babylon的配置。记得加入classProperties，否则会无法解析app.wpy的类语法\n        sourceType: \x27module\x27,\n        plugins: [\x27classProperties\x27]\n    },\n    plugins: [\n        [{\n            visitor: myVistor\/\/使用我们写的访问者\n        }, {\n            __ROUTES__: pages\/\/替换成我们的pages数组\n        }],\n    ],\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e babel = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27babel-core\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/...省略获取app.wpy过程，待会会谈到。\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/...省略编写visitor过程，语法跟编写插件略有一点点不同。\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e result = babel.transform(code, {\n    \x3cspan class=\x22hljs-attr\x22\x3eparserOpts\x3c\/span\x3e: {\x3cspan class=\x22hljs-comment\x22\x3e\/\/babel的解析器，babylon的配置。记得加入classProperties，否则会无法解析app.wpy的类语法\x3c\/span\x3e\n        sourceType: \x3cspan class=\x22hljs-string\x22\x3e\x27module\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3eplugins\x3c\/span\x3e: [\x3cspan class=\x22hljs-string\x22\x3e\x27classProperties\x27\x3c\/span\x3e]\n    },\n    \x3cspan class=\x22hljs-attr\x22\x3eplugins\x3c\/span\x3e: [\n        [{\n            \x3cspan class=\x22hljs-attr\x22\x3evisitor\x3c\/span\x3e: myVistor\x3cspan class=\x22hljs-comment\x22\x3e\/\/使用我们写的访问者\x3c\/span\x3e\n        }, {\n            \x3cspan class=\x22hljs-attr\x22\x3e__ROUTES__\x3c\/span\x3e: pages\x3cspan class=\x22hljs-comment\x22\x3e\/\/替换成我们的pages数组\x3c\/span\x3e\n        }],\n    ],\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当然最终我们是转换成功啦，这个插件也用上了生产环境。但是后来没有采用这方案替换pages字段。暂时只替换了\x3ccode\x3e__ENV__: process.env.NODE_ENV\x3c\/code\x3e与\x3ccode\x3e__VERSION__: version\x3c\/code\x3e两个常量。\x3cbr\x3e为什么呢？\x3cbr\x3e因为每次编译之后标识符\x3ccode\x3e__ROUTES__\x3c\/code\x3e都会被转换成我们的路由表，那么下次我想替换的时候难道要手动删掉然后再加上\x3ccode\x3e__ROUTES__\x3c\/code\x3e吗？我当然不会干跟我们自动化工程化的思想八字不合的事情啦。\x3cbr\x3e不过写完这个插件之后收获还是挺大的，基本了解该如何通过编译器寻找并替换我们的目标节点了。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3e编写babel脚本识别pages字段\x3c\/h3\x3e\n\x3ch4\x3e1.思路\x3c\/h4\x3e\n\x3col\x3e\n\x3cli\x3e首先获取到源代码：app.wpy是类vue单文件的语法。js都在script标签内，那么怎么获取这部分代码呢？又正则？不好吧，太捞了。通过阅读\x3ca href=\x22https:\/\/github.com\/Tencent\/wepy\/blob\/052ba8c0abf0247cf197e47677aec6b31b43b97c\/packages\/wepy-cli\/src\/compile-wpy.js\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ewepy-cli的源码\x3c\/a\x3e，使用\x3ccode\x3exmldom\x3c\/code\x3e这个库来解析，获取script标签内的代码。\x3c\/li\x3e\n\x3cli\x3e编写访问者遍历并替换节点：首先是找到继承自\x3ccode\x3ewepy.app\x3c\/code\x3e的类，再找到\x3ccode\x3econfig\x3c\/code\x3e字段，最后匹配key为\x3ccode\x3epages\x3c\/code\x3e的对象的值。最后替换目标节点\x3c\/li\x3e\n\x3cli\x3ebabel转换为代码后，通过读写文件替换目标代码。大业已成！done!\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch4\x3e2.成果\x3c\/h4\x3e\n\x3cp\x3e最终脚本：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/**\n * @author zhazheng\n * @description 在wepy编译前预编译。获取app.wpy内的pages字段，并替换成已生成的路由表。\n *\/\nconst babel = require(\x27babel-core\x27)\nconst t = require(\x27babel-types\x27)\n\n\/\/1.引入路由\nconst Strategies = require(\x27..\/src\/lib\/routes-model\x27)\nconst routes = Strategies.sortByWeight(require(\x27..\/src\/config\/routes\x27))\nconst pages = routes.map(item =\x3e item.page)\n\n\/\/2.解析script标签内的js，获取code\nconst xmldom = require(\x27xmldom\x27)\nconst fs = require(\x27fs\x27)\nconst path = require(\x27path\x27)\n\nconst appFile = path.join(__dirname, \x27..\/src\/app.wpy\x27)\nconst fileContent = fs.readFileSync(appFile, { encoding: \x27UTF-8\x27 })\nlet xml = new xmldom.DOMParser().parseFromString(fileContent)\n\nfunction getCodeFromScript(xml){\n    let code = \x27\x27\n    Array.prototype.slice.call(xml.childNodes || []).forEach(child =\x3e {\n        if(child.nodeName === \x27script\x27){\n            Array.prototype.slice.call(child.childNodes || []).forEach(c =\x3e {\n                code \x2b= c.toString()\n            })\n        }\n    })\n    return code\n}\nconst code = getCodeFromScript(xml)\n\n\/\/ 3.在遍历ast树的过程中，嵌套三层visitor去寻找节点\n\/\/3.1.找class，父类为wepy.app\nconst appClassVisitor = {\n    Class: {\n        enter(path, state) {\n            const classDeclaration = path.get(\x27superClass\x27)\n            if(classDeclaration.matchesPattern(\x27wepy.app\x27)){\n                path.traverse(configVisitor, state)\n            }\n        }\n    }\n}\n\/\/3.2.找config\nconst configVisitor = {\n    ObjectExpression: {\n        enter(path, state){\n            const expr = path.parentPath.node\n            if(expr.key \x26amp;\x26amp; expr.key.name === \x27config\x27){\n                path.traverse(pagesVisitor, state)\n            }\n        }\n    }\n}\n\/\/3.3.找pages，并替换\nconst pagesVisitor = {\n    ObjectProperty: {\n        enter(path, { opts }){\n            const isPages = path.node.key.name === \x27pages\x27\n            if(isPages){\n                path.node.value = t.valueToNode(opts.value)\n            }\n        }\n    }\n}\n\n\/\/ 4.转换并生成code\nconst result = babel.transform(code, {\n    parserOpts: {\n        sourceType: \x27module\x27,\n        plugins: [\x27classProperties\x27]\n    },\n    plugins: [\n        [{\n            visitor: appClassVisitor\n        }, {\n            value: pages\n        }],\n    ],\n})\n\n\/\/ 5.替换源代码\nfs.writeFileSync(appFile, fileContent.replace(code, result.code))\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * @author zhazheng\n * @description 在wepy编译前预编译。获取app.wpy内的pages字段，并替换成已生成的路由表。\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e babel = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27babel-core\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e t = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27babel-types\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/1.引入路由\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Strategies = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/src\/lib\/routes-model\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e routes = Strategies.sortByWeight(\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/src\/config\/routes\x27\x3c\/span\x3e))\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e pages = routes.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eitem\x3c\/span\x3e =\x26gt;\x3c\/span\x3e item.page)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/2.解析script标签内的js，获取code\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e xmldom = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27xmldom\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fs = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fs\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e appFile = path.join(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27..\/src\/app.wpy\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fileContent = fs.readFileSync(appFile, { \x3cspan class=\x22hljs-attr\x22\x3eencoding\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27UTF-8\x27\x3c\/span\x3e })\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e xml = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e xmldom.DOMParser().parseFromString(fileContent)\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetCodeFromScript\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3exml\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e code = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.prototype.slice.call(xml.childNodes || []).forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3echild\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(child.nodeName === \x3cspan class=\x22hljs-string\x22\x3e\x27script\x27\x3c\/span\x3e){\n            \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.prototype.slice.call(child.childNodes || []).forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ec\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n                code \x2b= c.toString()\n            })\n        }\n    })\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e code\n}\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e code = getCodeFromScript(xml)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 3.在遍历ast树的过程中，嵌套三层visitor去寻找节点\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/3.1.找class，父类为wepy.app\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e appClassVisitor = {\n    \x3cspan class=\x22hljs-attr\x22\x3eClass\x3c\/span\x3e: {\n        enter(path, state) {\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e classDeclaration = path.get(\x3cspan class=\x22hljs-string\x22\x3e\x27superClass\x27\x3c\/span\x3e)\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(classDeclaration.matchesPattern(\x3cspan class=\x22hljs-string\x22\x3e\x27wepy.app\x27\x3c\/span\x3e)){\n                path.traverse(configVisitor, state)\n            }\n        }\n    }\n}\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/3.2.找config\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e configVisitor = {\n    \x3cspan class=\x22hljs-attr\x22\x3eObjectExpression\x3c\/span\x3e: {\n        enter(path, state){\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e expr = path.parentPath.node\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(expr.key \x26amp;\x26amp; expr.key.name === \x3cspan class=\x22hljs-string\x22\x3e\x27config\x27\x3c\/span\x3e){\n                path.traverse(pagesVisitor, state)\n            }\n        }\n    }\n}\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/3.3.找pages，并替换\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e pagesVisitor = {\n    \x3cspan class=\x22hljs-attr\x22\x3eObjectProperty\x3c\/span\x3e: {\n        enter(path, { opts }){\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e isPages = path.node.key.name === \x3cspan class=\x22hljs-string\x22\x3e\x27pages\x27\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(isPages){\n                path.node.value = t.valueToNode(opts.value)\n            }\n        }\n    }\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 4.转换并生成code\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e result = babel.transform(code, {\n    \x3cspan class=\x22hljs-attr\x22\x3eparserOpts\x3c\/span\x3e: {\n        \x3cspan class=\x22hljs-attr\x22\x3esourceType\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27module\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3eplugins\x3c\/span\x3e: [\x3cspan class=\x22hljs-string\x22\x3e\x27classProperties\x27\x3c\/span\x3e]\n    },\n    \x3cspan class=\x22hljs-attr\x22\x3eplugins\x3c\/span\x3e: [\n        [{\n            \x3cspan class=\x22hljs-attr\x22\x3evisitor\x3c\/span\x3e: appClassVisitor\n        }, {\n            \x3cspan class=\x22hljs-attr\x22\x3evalue\x3c\/span\x3e: pages\n        }],\n    ],\n})\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 5.替换源代码\x3c\/span\x3e\nfs.writeFileSync(appFile, fileContent.replace(code, result.code))\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e3.使用方法\x3c\/h4\x3e\n\x3cp\x3e只需要在执行\x3ccode\x3ewepy build --watch\x3c\/code\x3e之前先执行这份脚本，就可自动替换路由表，自动化操作。监听文件变动，增加模块时自动重新跑脚本，更新路由表，开发体验一流~\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e结语\x3c\/h3\x3e\n\x3cp\x3e把代码往更自动化更工程化的方向写，这样的过程收获还是挺大的。但是确实这份脚本仍有不足之处，起码匹配节点这部分的代码是不大严谨的。\x3cbr\x3e\x3cstrong\x3e另外插播一份广告\x3c\/strong\x3e\x3cbr\x3e我司\x3cstrong\x3e风变科技\x3c\/strong\x3e正招聘前端开发：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e应届、一年经验，熟悉Vue的前端小鲜肉\x3c\/li\x3e\n\x3cli\x3e三年经验的前端大佬\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e我！们！都！想！要！\x3cbr\x3e我们开发团队不仅代码写的好，而且男程序员还拥有着100%的脱单率！！快来加入我们吧！\x3c\/p\x3e\n\x3cp\x3e邮箱：nicolas_refn@foxmail.com\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>【babel+小程序】记“编写babel插件”与“通过语法解析替换小程序路由表”的经历</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000013130489">https://segmentfault.com/a/1190000013130489</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/i9f8gg837si/" target="_blank">https://alili.tech/archive/i9f8gg837si/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>