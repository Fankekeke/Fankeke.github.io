<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="underscore 系列之字符实体与 _.escape"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>underscore 系列之字符实体与 _.escape | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/k5dxkv9wlt/",
				"appid": "1613049289050283", 
				"title": "underscore 系列之字符实体与 _.escape | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-08T02:30:30"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/z3skidqyiy/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/7zxx6cdr24t/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f&text=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f&text=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f&title=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f&is_video=false&description=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f&title=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f&title=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f&title=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fk5dxkv9wlt%2f&title=underscore%20%e7%b3%bb%e5%88%97%e4%b9%8b%e5%ad%97%e7%ac%a6%e5%ae%9e%e4%bd%93%e4%b8%8e%20_.escape"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">underscore 系列之字符实体与 _.escape</h1><div class="meta"><div class="postdate"><time datetime="2018-12-08" itemprop="datePublished">2018-12-08</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e前言\x3c\/h2\x3e\n\x3cp\x3eunderscore 提供了 \x3ccode\x3e_.escape\x3c\/code\x3e 函数，用于转义 HTML 字符串，替换 \x26amp;, \x26lt;, \x26gt;, \x22, \x27, 和 ` 字符为字符实体。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22_.escape(\x27Curly, Larry \x26amp; Moe\x27);\n=\x3e \x26quot;Curly, Larry \x26amp;amp; Moe\x26quot;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e_.escape(\x3cspan class=\x22hljs-string\x22\x3e\x27Curly, Larry \x26amp; Moe\x27\x3c\/span\x3e);\n=\x26gt; \x3cspan class=\x22hljs-string\x22\x3e\x22Curly, Larry \x26amp;amp; Moe\x22\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eunderscore 同样提供了 \x3ccode\x3e_.unescape\x3c\/code\x3e 函数，功能与 \x3ccode\x3e_.escape\x3c\/code\x3e 相反：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22_.unescape(\x27Curly, Larry \x26amp;amp; Moe\x27);\n=\x3e \x26quot;Curly, Larry \x26amp; Moe\x26quot;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e_.unescape(\x3cspan class=\x22hljs-string\x22\x3e\x27Curly, Larry \x26amp;amp; Moe\x27\x3c\/span\x3e);\n=\x26gt; \x3cspan class=\x22hljs-string\x22\x3e\x22Curly, Larry \x26amp; Moe\x22\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eXSS 攻击\x3c\/h2\x3e\n\x3cp\x3e可是我们为什么需要转义 HTML 呢？\x3c\/p\x3e\n\x3cp\x3e举个例子，一个个人中心页的地址为：\x3ccode\x3ewww.example.com\/user.html?name=kevin\x3c\/code\x3e，我们希望从网址中取出用户的名称，然后将其显示在页面中，使用 JavaScript，我们可以这样做：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/**\n * 该函数用于取出网址参数\n *\/\nfunction getQueryString(name) {\n    var reg = new RegExp(\x26quot;(^|\x26amp;)\x26quot; \x2b name \x2b \x26quot;=([^\x26amp;]*)(\x26amp;|$)\x26quot;);\n    var r = window.location.search.substr(1).match(reg);\n    if (r != null) return unescape(r[2]);\n    return null;\n}\n\nvar name = getQueryString(\x27name\x27);\ndocument.getElementById(\x26quot;username\x26quot;).innerHTML = name;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * 该函数用于取出网址参数\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetQueryString\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ename\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e reg = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eRegExp\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22(^|\x26amp;)\x22\x3c\/span\x3e \x2b name \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22=([^\x26amp;]*)(\x26amp;|$)\x22\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e r = \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.location.search.substr(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e).match(reg);\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (r != \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eunescape\x3c\/span\x3e(r[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e]);\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e name = getQueryString(\x3cspan class=\x22hljs-string\x22\x3e\x27name\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x22username\x22\x3c\/span\x3e).innerHTML = name;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果被一个同样懂技术的人发现的话，那么他可能会动点“坏心思”：\x3c\/p\x3e\n\x3cp\x3e比如我把这个页面的地址修改为：\x3ccode\x3ewww.example.com\/user.html?name=\x26lt;script\x26gt;alert(1)\x26lt;\/script\x26gt;\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e就相当于:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22document.getElementById(\x26quot;username\x26quot;).innerHTML = \x27\x3cscript\x3ealert(1)\x3c\/script\x3e\x27;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x22username\x22\x3c\/span\x3e).innerHTML = \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;script\x26gt;alert(1)\x26lt;\/script\x26gt;\x27\x3c\/span\x3e;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e会有什么效果呢？\x3c\/p\x3e\n\x3cp\x3e结果是什么也没有发生……\x3c\/p\x3e\n\x3cp\x3e这是因为:\x3c\/p\x3e\n\x3cblockquote\x3e根据 W3C 规范，script 标签中所指的脚本仅在浏览器第一次加载页面时对其进行解析并执行其中的脚本代码，所以通过 innerHTML 方法动态插入到页面中的 script 标签中的脚本代码在所有浏览器中默认情况下均不能被执行。\x3c\/blockquote\x3e\n\x3cp\x3e千万不要以为这样就安全了……\x3c\/p\x3e\n\x3cp\x3e你把地址改成 \x3ccode\x3ewww.example.com\/user.html?name=\x26lt;img src=@ onerror=alert(1)\x26gt;\x3c\/code\x3e 的话，就相当于：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22document.getElementById(\x26quot;d1\x26quot;).innerHTML=\x26quot;\x3cimg src=@ onerror=alert(1)\x3e\x26quot;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x22d1\x22\x3c\/span\x3e).innerHTML=\x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;img src=@ onerror=alert(1)\x26gt;\x22\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e此时立刻就弹窗了 1。\x3c\/p\x3e\n\x3cp\x3e也许你会想，不就是弹窗个 1 吗？还能怎么样？能写多少代码？\x3c\/p\x3e\n\x3cp\x3e那我把地址改成 \x3ccode\x3ewww.example.com\/user.html?name=\x26lt;img src=@ onerror=\x27var s=document.createElement(\x22script\x22);s.src=\x22https:\/\/mqyqingfeng.github.io\/demo\/js\/alert.js\x22;document.body.appendChild(s);\x27 \/\x26gt;\x3c\/code\x3e 呢？\x3c\/p\x3e\n\x3cp\x3e就相当于：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22document.getElementById(\x26quot;username\x26quot;).innerHTML = \x26quot;\x3cimg src=@ onerror=\x27var s=document.createElement(\\\x26quot;script\\\x26quot;);s.src=\\\x26quot;https:\/\/mqyqingfeng.github.io\/demo\/js\/alert.js\\\x26quot;;document.body.appendChild(s);\x27 \/\x3e\x26quot;;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x22username\x22\x3c\/span\x3e).innerHTML = \x3cspan class=\x22hljs-string\x22\x3e\x22\x26lt;img src=@ onerror=\x27var s=document.createElement(\\\x22script\\\x22);s.src=\\\x22https:\/\/mqyqingfeng.github.io\/demo\/js\/alert.js\\\x22;document.body.appendChild(s);\x27 \/\x26gt;\x22\x3c\/span\x3e;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e整理下其中 onerror 的代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var s = document.createElement(\x26quot;script\x26quot;);\ns.src = \x26quot;https:\/\/mqyqingfeng.github.io\/demo\/js\/alert.js\x26quot;;\ndocument.body.appendChild(s);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e s = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x22script\x22\x3c\/span\x3e);\ns.src = \x3cspan class=\x22hljs-string\x22\x3e\x22https:\/\/mqyqingfeng.github.io\/demo\/js\/alert.js\x22\x3c\/span\x3e;\n\x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.body.appendChild(s);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e代码中引入了一个第三方的脚本，这样做的事情就多了，从取你的 cookie，发送到黑客自己的服务器，到监听你的输入，到发起 CSRF 攻击，直接以你的身份调用网站的各种接口……\x3c\/p\x3e\n\x3cp\x3e总之，很危险。\x3c\/p\x3e\n\x3cp\x3e为了防止这种情况的发生，我们可以将网址上的值取到后，进行一个特殊处理，再赋值给 DOM 的 innerHTML。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e字符实体\x3c\/h2\x3e\n\x3cp\x3e问题是怎么进行转义呢？而这就要谈到字符实体的概念了。\x3c\/p\x3e\n\x3cp\x3e在 HTML 中，某些字符是预留的。比如说在 HTML 中不能使用小于号（\x26lt;）和大于号（\x26gt;），因为浏览器会误认为它们是标签。\x3c\/p\x3e\n\x3cp\x3e如果希望正确地显示预留字符，我们必须在 HTML 源代码中使用字符实体（character entities）。\x3c\/p\x3e\n\x3cp\x3e字符实体有两种形式：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3ccode\x3e\x26amp;entity_name;\x3c\/code\x3e\x3c\/li\x3e\n\x3cli\x3e\n\x3ccode\x3e\x26amp;#entity_number;\x3c\/code\x3e。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e比如说我们要显示小于号，我们可以这样写：\x3ccode\x3e\x26amp;lt;\x3c\/code\x3e 或 \x3ccode\x3e\x26amp;#60\x3c\/code\x3e;\x3c\/p\x3e\n\x3cp\x3e值得一提的是，使用实体名而不是数字的好处是，名称易于记忆。不过坏处是，浏览器也许并不支持所有实体名称（但是对实体数字的支持却很好）。\x3c\/p\x3e\n\x3cp\x3e也许你会好奇，为什么 \x3ccode\x3e\x26lt;\x3c\/code\x3e 的字符实体是 \x3ccode\x3e\x26amp;#60\x3c\/code\x3e 呢？这是怎么进行计算的呢？\x3c\/p\x3e\n\x3cp\x3e其实很简单，就是取字符的 unicode 值，以 \x3ccode\x3e\x26amp;#\x3c\/code\x3e 开头接十进制数字 或者以 \x3ccode\x3e\x26amp;#x\x3c\/code\x3e开头接十六进制数字。举个例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var num = \x27\x3c\x27.charCodeAt(0); \/\/ 60\nnum.toString(10) \/\/ \x2760\x27\nnum.toString(16) \/\/ \x273c\x27\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e num = \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\x27\x3c\/span\x3e.charCodeAt(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 60\x3c\/span\x3e\nnum.toString(\x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ \x2760\x27\x3c\/span\x3e\nnum.toString(\x3cspan class=\x22hljs-number\x22\x3e16\x3c\/span\x3e) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ \x273c\x27\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们可以以 \x3ccode\x3e\x26amp;#60;\x3c\/code\x3e 或者 \x3ccode\x3e\x26amp;#x3c;\x3c\/code\x3e 在 HTML 中表示出 \x3ccode\x3e\x26lt;\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e不信你可以写这样一段 HTML，显示的效果都是 \x3ccode\x3e\x26lt;\x3c\/code\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cdiv\x3e\x26amp;lt;\x3c\/div\x3e\n\x3cdiv\x3e\x26amp;#60;\x3c\/div\x3e\n\x3cdiv\x3e\x26amp;#x3c;\x3c\/div\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x26amp;lt;\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x26amp;#60;\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x26amp;#x3c;\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e再举个例子：以字符 \x27喵\x27 为例：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var num = \x27喵\x27.charCodeAt(0); \/\/ 21941\nnum.toString(10) \/\/ \x2721941\x27\nnum.toString(16) \/\/ \x2755b5\x27\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e num = \x3cspan class=\x22hljs-string\x22\x3e\x27喵\x27\x3c\/span\x3e.charCodeAt(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 21941\x3c\/span\x3e\nnum.toString(\x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ \x2721941\x27\x3c\/span\x3e\nnum.toString(\x3cspan class=\x22hljs-number\x22\x3e16\x3c\/span\x3e) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ \x2755b5\x27\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在 HTML 中，我们就可以用 \x3ccode\x3e\x26amp;#21941;\x3c\/code\x3e 或者 \x3ccode\x3e\x26amp;#x55b5\x3c\/code\x3e 表示\x3ccode\x3e喵\x3c\/code\x3e，不过“喵”并不具有实体名。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e转义\x3c\/h2\x3e\n\x3cp\x3e我们的应对方式就是将取得的值中的特殊字符转为字符实体。\x3c\/p\x3e\n\x3cp\x3e举个例子，当页面地址是 \x3ccode\x3ewww.example.com\/user.html?name=\x26lt;strong\x26gt;123\x26lt;\/strong\x26gt;\x3c\/code\x3e时，我们通过 getQueryString 取得 name 的值：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var name = getQueryString(\x27name\x27); \/\/ \x3cstrong\x3e123\x3c\/strong\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e name = getQueryString(\x3cspan class=\x22hljs-string\x22\x3e\x27name\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ \x26lt;strong\x26gt;123\x26lt;\/strong\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果我们直接：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22document.getElementById(\x26quot;username\x26quot;).innerHTML = name;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x22username\x22\x3c\/span\x3e).innerHTML = name;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如我们所知，使用 innerHTML 会解析内容字符串，并且改变元素的 HMTL 内容，最终，从样式上，我们会看到一个加粗的 123。\x3c\/p\x3e\n\x3cp\x3e如果我们转义，将 \x3ccode\x3e\x26lt;strong\x26gt;123\x26lt;\/strong\x26gt;\x3c\/code\x3e 中的 \x3ccode\x3e\x26lt;\x3c\/code\x3e 和 \x3ccode\x3e\x26gt;\x3c\/code\x3e 转为实体字符，即 \x3ccode\x3e\x26amp;lt;strong\x26amp;gt;123\x26amp;lt;\/strong\x26amp;gt;\x3c\/code\x3e，我们再设置 innerHTML，浏览器就不会将其解释为标签，而是一段字符，最终会直接显示 \x3ccode\x3e\x26lt;strong\x26gt;123\x26lt;\/strong\x26gt;\x3c\/code\x3e，这样就避免了潜在的危险。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e思考\x3c\/h2\x3e\n\x3cp\x3e那么问题来了，我们具体要转义哪些字符呢？\x3c\/p\x3e\n\x3cp\x3e想想我们之所以要转义 \x3ccode\x3e\x26lt;\x3c\/code\x3e 和 \x3ccode\x3e\x26gt;\x3c\/code\x3e ，是因为浏览器会将其认为是一个标签的开始或结束，所以要转义的字符一定是浏览器会特殊对待的字符，那还有什么字符会被特殊对待的呢？(O_o)??\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3e\x26amp;\x3c\/code\x3e 是一个，因为浏览器会认为 \x3ccode\x3e\x26amp;\x3c\/code\x3e 是一个字符实体的开始，如果你输入了 \x3ccode\x3e\x26amp;lt;\x3c\/code\x3e，浏览器会将其解释为 \x3ccode\x3e\x26lt;\x3c\/code\x3e，但是当 \x3ccode\x3e\x26amp;lt;\x3c\/code\x3e 是作为用户输入的值时，应该仅仅是显示用户输入的值，而不是将其解释为一个 \x3ccode\x3e\x26lt;\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3e\x27\x3c\/code\x3e 和 \x3ccode\x3e\x22\x3c\/code\x3e 也要注意，举个例子：\x3c\/p\x3e\n\x3cp\x3e服务器端渲染的代码为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function render (input) {\n  return \x27\x3cinput type=\x26quot;name\x26quot; value=\x26quot;\x27 \x2b input \x2b \x27\x26quot;\x3e\x27\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3erender\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3einput\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;input type=\x22name\x22 value=\x22\x27\x3c\/span\x3e \x2b input \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x26gt;\x27\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3einput 的值如果直接来自于用户的输入，用户可以输入 \x3ccode\x3e\x22\x26gt; \x26lt;script\x26gt;alert(1)\x26lt;\/script\x26gt;\x3c\/code\x3e，最终渲染的 HTML 代码就变成了：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cinput type=\x26quot;name\x26quot; value=\x26quot;\x26quot;\x3e \x3cscript\x3ealert(1)\x3c\/script\x3e\x26quot;\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3einput\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22name\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3evalue\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22undefined\x22\x3ealert(1)\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22\x26gt;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e结果又是一次 XSS 攻击……\x3c\/p\x3e\n\x3cp\x3e最后还有一个是反引号 `，在 IE 低版本中(≤ 8)，反引号可以用于关闭标签：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cimg src=\x26quot;x` `\x3cscript\x3ealert(1)\x3c\/script\x3e\x26quot;` `\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs autohotkey\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3e\x26lt;img src=\x3cspan class=\x22hljs-string\x22\x3e\x22x` `\x26lt;script\x26gt;alert(1)\x26lt;\/script\x26gt;\x22\x3c\/span\x3e` `\x26gt;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e所以我们最终确定的要转义的字符为：\x26amp;, \x26lt;, \x26gt;, \x22, \x27, 和 `。转义对应的值为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x26amp; --\x3e \x26amp;amp;\n\x3c --\x3e \x26amp;lt;\n\x3e --\x3e \x26amp;gt;\n\x26quot; --\x3e \x26amp;quot;\n\x27 --\x3e \x26amp;#x27;\n` --\x3e \x26amp;#60;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs brainfuck\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\x26amp;\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x26gt; \x3cspan class=\x22hljs-comment\x22\x3e\x26amp;amp;\x3c\/span\x3e\n\x26lt; \x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x26gt; \x3cspan class=\x22hljs-comment\x22\x3e\x26amp;lt;\x3c\/span\x3e\n\x26gt; \x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x26gt; \x3cspan class=\x22hljs-comment\x22\x3e\x26amp;gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\x22\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x26gt; \x3cspan class=\x22hljs-comment\x22\x3e\x26amp;quot;\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\x27\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x26gt; \x3cspan class=\x22hljs-comment\x22\x3e\x26amp;#x27;\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e`\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3e-\x3c\/span\x3e\x26gt; \x3cspan class=\x22hljs-comment\x22\x3e\x26amp;#60;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e值得注意的是：单引号和反引号使用是实体数字、而其他使用的是实体名称，这主要是从兼容性的角度考虑的，有的浏览器并不能很好的支持单引号和反引号的实体名称。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e_.escape\x3c\/h2\x3e\n\x3cp\x3e那么具体我们该如何实现转义呢？我们直接看一个简单的实现：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var _ = {};\n\nvar escapeMap = {\n    \x27\x26amp;\x27: \x27\x26amp;amp;\x27,\n    \x27\x3c\x27: \x27\x26amp;lt;\x27,\n    \x27\x3e\x27: \x27\x26amp;gt;\x27,\n    \x27\x26quot;\x27: \x27\x26amp;quot;\x27,\n    \x26quot;\x27\x26quot;: \x27\x26amp;#x27;\x27,\n    \x27`\x27: \x27\x26amp;#x60;\x27\n};\n\n_.escape = function(string) {\n    var escaper = function(match) {\n        return escapeMap[match];\n    };\n    \/\/ 使用非捕获性分组\n    var source = \x27(?:\x27 \x2b Object.keys(escapeMap).join(\x27|\x27) \x2b \x27)\x27;\n    console.log(source) \/\/ (?:\x26amp;|\x3c|\x3e|\x26quot;|\x27|`)\n    var testRegexp = RegExp(source);\n    var replaceRegexp = RegExp(source, \x27g\x27);\n\n    string = string == null ? \x27\x27 : \x27\x27 \x2b string;\n    return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e _ = {};\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e escapeMap = {\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;amp;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;lt;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26gt;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;gt;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;quot;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x22\x27\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;#x27;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27`\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;#x60;\x27\x3c\/span\x3e\n};\n\n_.escape = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3estring\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e escaper = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ematch\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e escapeMap[match];\n    };\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 使用非捕获性分组\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e source = \x3cspan class=\x22hljs-string\x22\x3e\x27(?:\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(escapeMap).join(\x3cspan class=\x22hljs-string\x22\x3e\x27|\x27\x3c\/span\x3e) \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27)\x27\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(source) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ (?:\x26amp;|\x26lt;|\x26gt;|\x22|\x27|`)\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e testRegexp = \x3cspan class=\x22hljs-built_in\x22\x3eRegExp\x3c\/span\x3e(source);\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e replaceRegexp = \x3cspan class=\x22hljs-built_in\x22\x3eRegExp\x3c\/span\x3e(source, \x3cspan class=\x22hljs-string\x22\x3e\x27g\x27\x3c\/span\x3e);\n\n    string = string == \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e ? \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e : \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e \x2b string;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e实现的思路很简单，构造一个正则表达式，先判断是否能匹配到，如果能匹配到，就执行 replace，根据 escapeMap 将特殊字符进行替换，如果不能匹配，说明不需要转义，直接返回原字符串。\x3c\/p\x3e\n\x3cp\x3e值得一提的是，我们在代码中打印了构造出的正则表达式为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22(?:\x26amp;|\x3c|\x3e|\x26quot;|\x27|`)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs elixir\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3e(?\x3cspan class=\x22hljs-symbol\x22\x3e:\x26amp;|\x26lt;|\x26gt;|\x3cspan class=\x22hljs-string\x22\x3e\x22|\x27|`)\x3c\/span\x3e\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其中的 \x3ccode\x3e?:\x3c\/code\x3e 是个什么意思？没有这个 \x3ccode\x3e?:\x3c\/code\x3e 就不可以匹配吗？我们接着往下看。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader6\x22\x3e非捕获分组\x3c\/h2\x3e\n\x3cp\x3e\x3ccode\x3e(?:pattern)\x3c\/code\x3e 表示非捕获分组，即会匹配 pattern 但不获取匹配结果，不进行存储供以后使用。\x3c\/p\x3e\n\x3cp\x3e我们来看个例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function replacer(match, p1, p2, p3) {\n    \/\/ match，表示匹配的子串 abc12345#$*%\n    \/\/ p1，第 1 个括号匹配的字符串 abc\n    \/\/ p2，第 2 个括号匹配的字符串 12345\n    \/\/ p3，第 3 个括号匹配的字符串 #$*%\n    return [p1, p2, p3].join(\x27 - \x27);\n}\nvar newString = \x27abc12345#$*%\x27.replace(\/([^\\d]*)(\\d*)([^\\w]*)\/, replacer); \/\/ abc - 12345 - #$*%\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereplacer\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ematch, p1, p2, p3\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ match，表示匹配的子串 abc12345#$*%\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ p1，第 1 个括号匹配的字符串 abc\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ p2，第 2 个括号匹配的字符串 12345\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ p3，第 3 个括号匹配的字符串 #$*%\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e [p1, p2, p3].join(\x3cspan class=\x22hljs-string\x22\x3e\x27 - \x27\x3c\/span\x3e);\n}\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e newString = \x3cspan class=\x22hljs-string\x22\x3e\x27abc12345#$*%\x27\x3c\/span\x3e.replace(\x3cspan class=\x22hljs-regexp\x22\x3e\/([^\\d]*)(\\d*)([^\\w]*)\/\x3c\/span\x3e, replacer); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ abc - 12345 - #$*%\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e现在我们给第一个括号中的表达式加上 \x3ccode\x3e?:\x3c\/code\x3e，表示第一个括号中的内容不需要储存结果：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function replacer(match, p1, p2) {\n    \/\/ match，表示匹配的子串 abc12345#$*%\n    \/\/ p1，现在匹配的是字符串 12345\n    \/\/ p1，现在匹配的是字符串 #$*%\n    return [p1, p2].join(\x27 - \x27);\n}\nvar newString = \x27abc12345#$*%\x27.replace(\/(?:[^\\d]*)(\\d*)([^\\w]*)\/, replacer); \/\/ 12345 - #$*%\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereplacer\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ematch, p1, p2\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ match，表示匹配的子串 abc12345#$*%\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ p1，现在匹配的是字符串 12345\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ p1，现在匹配的是字符串 #$*%\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e [p1, p2].join(\x3cspan class=\x22hljs-string\x22\x3e\x27 - \x27\x3c\/span\x3e);\n}\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e newString = \x3cspan class=\x22hljs-string\x22\x3e\x27abc12345#$*%\x27\x3c\/span\x3e.replace(\x3cspan class=\x22hljs-regexp\x22\x3e\/(?:[^\\d]*)(\\d*)([^\\w]*)\/\x3c\/span\x3e, replacer); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 12345 - #$*%\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在 \x3ccode\x3e_.escape\x3c\/code\x3e 函数中，即使不使用 \x3ccode\x3e?:\x3c\/code\x3e 也不会影响匹配结果，只是使用 \x3ccode\x3e?:\x3c\/code\x3e 性能会更高一点。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e反转义\x3c\/h2\x3e\n\x3cp\x3e我们使用了 \x3ccode\x3e_.escape\x3c\/code\x3e 将指定字符转为字符实体，我们还需要一个方法将字符实体转义回来。\x3c\/p\x3e\n\x3cp\x3e写法与 \x3ccode\x3e_.unescape\x3c\/code\x3e 类似：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var _ = {};\n\nvar unescapeMap = {\n    \x27\x26amp;amp;\x27: \x27\x26amp;\x27,\n    \x27\x26amp;lt;\x27: \x27\x3c\x27,\n    \x27\x26amp;gt;\x27: \x27\x3e\x27,\n    \x27\x26amp;quot;\x27: \x27\x26quot;\x27,\n    \x27\x26amp;#x27;\x27: \x26quot;\x27\x26quot;,\n    \x27\x26amp;#x60;\x27: \x27`\x27\n};\n\n_.unescape = function(string) {\n    var escaper = function(match) {\n        return unescapeMap[match];\n    };\n    \/\/ 使用非捕获性分组\n    var source = \x27(?:\x27 \x2b Object.keys(unescapeMap).join(\x27|\x27) \x2b \x27)\x27;\n    console.log(source) \/\/ (?:\x26amp;|\x3c|\x3e|\x26quot;|\x27|`)\n    var testRegexp = RegExp(source);\n    var replaceRegexp = RegExp(source, \x27g\x27);\n\n    string = string == null ? \x27\x27 : \x27\x27 \x2b string;\n    return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;\n}\n\nconsole.log(_.unescape(\x27Curly, Larry \x26amp;amp; Moe\x27)) \/\/ Curly, Larry \x26amp; Moe\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e _ = {};\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e unescapeMap = {\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;amp;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;lt;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;gt;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26gt;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;quot;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;#x27;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22\x27\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;#x60;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27`\x27\x3c\/span\x3e\n};\n\n_.unescape = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3estring\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e escaper = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ematch\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e unescapeMap[match];\n    };\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 使用非捕获性分组\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e source = \x3cspan class=\x22hljs-string\x22\x3e\x27(?:\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(unescapeMap).join(\x3cspan class=\x22hljs-string\x22\x3e\x27|\x27\x3c\/span\x3e) \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27)\x27\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(source) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ (?:\x26amp;|\x26lt;|\x26gt;|\x22|\x27|`)\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e testRegexp = \x3cspan class=\x22hljs-built_in\x22\x3eRegExp\x3c\/span\x3e(source);\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e replaceRegexp = \x3cspan class=\x22hljs-built_in\x22\x3eRegExp\x3c\/span\x3e(source, \x3cspan class=\x22hljs-string\x22\x3e\x27g\x27\x3c\/span\x3e);\n\n    string = string == \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e ? \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e : \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e \x2b string;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;\n}\n\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(_.unescape(\x3cspan class=\x22hljs-string\x22\x3e\x27Curly, Larry \x26amp;amp; Moe\x27\x3c\/span\x3e)) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Curly, Larry \x26amp; Moe\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader8\x22\x3e抽象\x3c\/h2\x3e\n\x3cp\x3e你会不会觉得 \x3ccode\x3e_.escape\x3c\/code\x3e 与 \x3ccode\x3e_.unescape\x3c\/code\x3e 的代码实在是太像了，以至于让人感觉很冗余呢？\x3c\/p\x3e\n\x3cp\x3e那么我们又该如何优化呢？\x3c\/p\x3e\n\x3cp\x3e我们可以先写一个 \x3ccode\x3e_.invert\x3c\/code\x3e 函数，将 escapeMap 传入的时候，可以得到 unescapeMap，然后我们再根据传入的 map (escapeMap 或者 unescapeMap) 不同，返回不同的函数。\x3c\/p\x3e\n\x3cp\x3e实现的方式很简单，直接看代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/**\n * 返回一个object副本，使其键（keys）和值（values）对换。\n * _.invert({a: \x26quot;b\x26quot;});\n * =\x3e {b: \x26quot;a\x26quot;};\n *\/\n_.invert = function(obj) {\n    var result = {};\n    var keys = Object.keys(obj);\n    for (var i = 0, length = keys.length; i \x3c length; i\x2b\x2b) {\n        result[obj[keys[i]]] = keys[i];\n    }\n    return result;\n};\n\nvar escapeMap = {\n    \x27\x26amp;\x27: \x27\x26amp;amp;\x27,\n    \x27\x3c\x27: \x27\x26amp;lt;\x27,\n    \x27\x3e\x27: \x27\x26amp;gt;\x27,\n    \x27\x26quot;\x27: \x27\x26amp;quot;\x27,\n    \x26quot;\x27\x26quot;: \x27\x26amp;#x27;\x27,\n    \x27`\x27: \x27\x26amp;#x60;\x27\n};\nvar unescapeMap = _.invert(escapeMap);\n\nvar createEscaper = function(map) {\n    var escaper = function(match) {\n        return map[match];\n    };\n    \/\/ 使用非捕获性分组\n    var source = \x27(?:\x27 \x2b _.keys(map).join(\x27|\x27) \x2b \x27)\x27;\n    var testRegexp = RegExp(source);\n    var replaceRegexp = RegExp(source, \x27g\x27);\n    return function(string) {\n        string = string == null ? \x27\x27 : \x27\x27 \x2b string;\n        return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;\n    };\n};\n\n_.escape = createEscaper(escapeMap);\n_.unescape = createEscaper(unescapeMap);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * 返回一个object副本，使其键（keys）和值（values）对换。\n * _.invert({a: \x22b\x22});\n * =\x26gt; {b: \x22a\x22};\n *\/\x3c\/span\x3e\n_.invert = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eobj\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = {};\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e keys = \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(obj);\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, length = keys.length; i \x26lt; length; i\x2b\x2b) {\n        result[obj[keys[i]]] = keys[i];\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e result;\n};\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e escapeMap = {\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;amp;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;lt;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x26gt;\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;gt;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27\x22\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;quot;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x22\x27\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;#x27;\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27`\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26amp;#x60;\x27\x3c\/span\x3e\n};\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e unescapeMap = _.invert(escapeMap);\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e createEscaper = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emap\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e escaper = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ematch\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e map[match];\n    };\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 使用非捕获性分组\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e source = \x3cspan class=\x22hljs-string\x22\x3e\x27(?:\x27\x3c\/span\x3e \x2b _.keys(map).join(\x3cspan class=\x22hljs-string\x22\x3e\x27|\x27\x3c\/span\x3e) \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27)\x27\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e testRegexp = \x3cspan class=\x22hljs-built_in\x22\x3eRegExp\x3c\/span\x3e(source);\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e replaceRegexp = \x3cspan class=\x22hljs-built_in\x22\x3eRegExp\x3c\/span\x3e(source, \x3cspan class=\x22hljs-string\x22\x3e\x27g\x27\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3estring\x3c\/span\x3e) \x3c\/span\x3e{\n        string = string == \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e ? \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e : \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e \x2b string;\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;\n    };\n};\n\n_.escape = createEscaper(escapeMap);\n_.unescape = createEscaper(unescapeMap);\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader9\x22\x3eunderscore 系列\x3c\/h2\x3e\n\x3cp\x3eunderscore 系列目录地址：\x3ca href=\x22https:\/\/github.com\/mqyqingfeng\/Blog\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/mqyqingfeng\/Blog\x3c\/a\x3e。\x3c\/p\x3e\n\x3cp\x3eunderscore 系列预计写八篇左右，重点介绍 underscore 中的代码架构、链式调用、内部函数、模板引擎等内容，旨在帮助大家阅读源码，以及写出自己的 undercore。\x3c\/p\x3e\n\x3cp\x3e如果有错误或者不严谨的地方，请务必给予指正，十分感谢。如果喜欢或者有所启发，欢迎 star，对作者也是一种鼓励。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>underscore 系列之字符实体与 _.escape</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000014056591">https://segmentfault.com/a/1190000014056591</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/k5dxkv9wlt/" target="_blank">https://alili.tech/archive/k5dxkv9wlt/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>