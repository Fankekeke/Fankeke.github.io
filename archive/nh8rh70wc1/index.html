<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="构建离线web应用（一）"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>构建离线web应用（一） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/nh8rh70wc1/",
				"appid": "1613049289050283", 
				"title": "构建离线web应用（一） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-26T02:30:14"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/42sao9od3ko/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/5g7gmqefr2c/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f&text=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f&text=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f&title=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f&is_video=false&description=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f&title=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f&title=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f&title=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fnh8rh70wc1%2f&title=%e6%9e%84%e5%bb%ba%e7%a6%bb%e7%ba%bfweb%e5%ba%94%e7%94%a8%ef%bc%88%e4%b8%80%ef%bc%89"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">构建离线web应用（一）</h1><div class="meta"><div class="postdate"><time datetime="2018-12-26" itemprop="datePublished">2018-12-26</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e我喜欢移动app，而且也是那些坚持使用Web技术构建移动应用程序的人之一。\x3c\/p\x3e\n\x3cp\x3e经过技术的不断迭代（可能还有一些其它的东西），移动体验设计愈来愈平易近人，给予用户更好的体验。\x3c\/p\x3e\n\x3cp\x3e而今天，我们就要介绍一个新技术--渐进式 web 应用程序。在理解这个概念并自己尝试了一下之后，我觉得没有必要再做 hybrid 应用了。\x3c\/p\x3e\n\x3cp\x3e我们准备做这样的一个demo：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcIn?w=3468\x26amp;h=1886\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcIn?w=3468\x26amp;h=1886\x22 alt=\x22demo预览\x22 title=\x22demo预览\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3eProgressive Web Apps\x3c\/h2\x3e\n\x3cp\x3e渐进式 Web 应用是典型的旨在提高用户离线体验的 Web 应用。它解决了这样的问题：怎么才能不显示类似下面的离线错误？\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcIr?w=2314\x26amp;h=1526\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcIr?w=2314\x26amp;h=1526\x22 alt=\x22离线error\x22 title=\x22离线error\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e事实上，PWA 不仅解决了离线错误，还在恢复连接的时候将用户与内容连接起来。移动设备是渐进式 web 应用的主要使用场景。让我来告诉你为什么？\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e桌面浏览器\x3c\/h3\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e用户打开电脑（在家、学校或者办公室）\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e检查是否连上网络，没有则手动连接\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e打开 web 应用\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e移动端浏览器\x3c\/h3\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e拿出手机\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e默认手机已经连接上网络\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e直接打开 app\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e如上，用户对待两种场景的处理方式是不一样的。移动端用户不一定有很好的网络连接，有的甚至没有。在这样的场景下，开发商需要做的就是保持用户对产品的好感，在其网络恢复时与其互动。如果信号很差，开发商需要通过一些手段保持用户的耐心，不至于在请求过程中用户直接关闭 web 应用。\x3c\/p\x3e\n\x3cp\x3e当我们开始构建 PWA 应用时，你就能理解上面的场景了。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3eService Workers\x3c\/h2\x3e\n\x3cp\x3ePWA 背后的原理是 service workers。如果想让用户在离线场景下依然保持打开 web 页面，你需要在用户打开 web 应用并且有网络连接时做一些“后台任务”，这个“后台任务”会搜集 web 页面最近一次运行需要的一些资源，以备离线时使用。\x3c\/p\x3e\n\x3cp\x3e这就好像每年秋收储备粮食，以备冬天不时之需一样，不断循环。\x3c\/p\x3e\n\x3cp\x3ePWA 中的 service worker，可以类比成春天的播种的农民。下面是 MDN 对 service workers 的描述：\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3eService worker 是一个注册在指定源和路径下的事件驱动 worker。它采用 JavaScript 控制关联的页面或者网站，拦截并修改访问和资源请求，细粒度地缓存资源。你可以完全控制应用在特定情形（最常见的情形是网络不可用）下的表现。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e简而言之，service worker 就是一些在后台运行逻辑的 worker。它没有权限操作 DOM，但是可以调用其它的 API （例如 IndexDB 以及 Fetch API）。\x3c\/p\x3e\n\x3cp\x3e开始之前请牢记：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eservice workers 只能在 HTTPS 协议下生效（或者 Localhost）。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eservice workers 被设计成异步的，不能使用 XHR （但你可以使用 Fetch）或者 LocalStorage。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eservice workers 的作用范围是针对相对路径的。因此，\x3ccode\x3edemo\/sw.js\x3c\/code\x3e 只能相对于 \x3ccode\x3edemo\x3c\/code\x3e 起作用，\x3ccode\x3edemo\/first\/sw.js\x3c\/code\x3e 相对于 \x3ccode\x3efirst\x3c\/code\x3e。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3eMobile 还是 PWA\x3c\/h2\x3e\n\x3cp\x3e如果你能利用 service workers 存储离线使用所需的文件，那你就没有必要开发移动 app 了。如果你的 web 应用对移动用户进行了优化，并且几乎不需要调用移动端的硬件功能，那么你应该尝试一下 PWA。\x3c\/p\x3e\n\x3cp\x3e我花了一些时间看飞行模式下一些移动 app 的表现。我将它们分成三类：\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e离线情况下不做任何操作\x3c\/h3\x3e\n\x3cp\x3e例子： Coinbase\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcIv?w=394\x26amp;h=700\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcIv?w=394\x26amp;h=700\x22 alt=\x22Coinbase\x22 title=\x22Coinbase\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3eCoinbase 就是一直停留在 loading 的这个页面。它甚至让我怀疑这样的 app 为啥要存在，因为这个页面简直跟 web 展示一模一样。Coinbase 不是财经类 app，无需实时展示信息，因此，PWA 可能只适用应用于其 App Shell。\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3eApp Shell 是指不包含动态内容的一部分应用程序。例如导航菜单、侧边栏、背景、logo 等等。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e离线情况下展示警告信息（未连接网络等等），展示 App Shell，但其它都不可用\x3c\/h3\x3e\n\x3cp\x3e例子：Uber\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcIz?w=394\x26amp;h=700\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcIz?w=394\x26amp;h=700\x22 alt=\x22Uber\x22 title=\x22Uber\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3eUber 给用户展示了一些信息（通过 App Shell 以及地图），并且告知用户不能操作是由于他网络中断了。Uber是一个很高频的 app，这样的交互展示对于他们的应用场景很有意义。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3e离线情况下展示缓存的数据\x3c\/h3\x3e\n\x3cp\x3e例子： Medium\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcIA?w=394\x26amp;h=700\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcIA?w=394\x26amp;h=700\x22 alt=\x22Medium\x22 title=\x22Medium\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3eMedium在离线状态下展示缓存的数据，一些离线展示在这个分类里面的 app（例如，Instagram）还会提示用户离线了，所以，就不要对这个分类里面的 app 期望再搞了。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader8\x22\x3e优化\x3c\/h2\x3e\n\x3cp\x3e我的想法是，如果 PWA（或者 service workers）技术成熟并且被大规模应用的话，为什么不节省掉：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e前往应用商店\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e下载并不常用的 app\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e呢？\x3c\/p\x3e\n\x3cp\x3e当我们接下来谈到 Web Manifest 时，你就意识到只要给你的 web 应用新增一个桌面 icon，web 应用就可以通过点击这个 icon 实现启动了。\x3c\/p\x3e\n\x3cp\x3e一些公司已经在 PWA 方面做的比较好了，你可以在这个网址上面找到这些公司：\x3ca href=\x22https:\/\/pwa.rocks\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3epwa.rocks\x3c\/a\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader9\x22\x3e开发准备\x3c\/h2\x3e\n\x3cp\x3e我们已经介绍了足够多的理论知识了。这是一个手把手的教程，来吧，让我们动起手来。首先，按照下面的结构来创建一个新的项目：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22|--pwa-demo\n|----css\n|----fonts\n|----images\n|----js\n|----index.html\n|----service-worker.js\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs 1c\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-string\x22\x3e|--pwa-demo\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e|----css\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e|----fonts\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e|----images\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e|----js\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e|----index.html\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3e|----service-worker.js\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e下载 \x3ca href=\x22http:\/\/materializecss.com\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMaterialize\x3c\/a\x3e 这个 UI 库，用里面 \x3ccode\x3eCSS\x3c\/code\x3e、\x3ccode\x3eFonts\x3c\/code\x3e、\x3ccode\x3ejs 文件\x3c\/code\x3e分别替换项目里面的文件夹。\x3c\/p\x3e\n\x3cp\x3e打开 \x3ccode\x3eindex.html\x3c\/code\x3e 文件，引入一些资源：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3c!-- .\/index.html --\x3e\n\x3c!DOCTYPE html\x3e\n  \x3chtml\x3e\n    \x3chead\x3e\n      \x3c!--Import Google Icon Font--\x3e\n      \x3clink href=\x26quot;https:\/\/fonts.googleapis.com\/icon?family=Material\x2bIcons\x26quot; rel=\x26quot;stylesheet\x26quot;\x3e\n      \x3c!--Import materialize.css--\x3e\n      \x3clink type=\x26quot;text\/css\x26quot; rel=\x26quot;stylesheet\x26quot; href=\x26quot;css\/materialize.min.css\x26quot; media=\x26quot;screen,projection\x26quot;\/\x3e\n      \x3clink type=\x26quot;text\/css\x26quot; rel=\x26quot;stylesheet\x26quot; href=\x26quot;css\/app.css\x26quot;\x3e\n\n      \x3c!--Let browser know website is optimized for mobile--\x3e\n      \x3cmeta name=\x26quot;viewport\x26quot; content=\x26quot;width=device-width, initial-scale=1.0\x26quot;\/\x3e\n    \x3c\/head\x3e\n\n    \x3cbody\x3e\n\n      Body coming soon\n\n      \x3c!-- Scripts --\x3e\n      \x3cscript type=\x26quot;text\/javascript\x26quot; src=\x26quot;js\/jquery-2.1.1.min.js\x26quot;\x3e\x3c\/script\x3e\n      \x3cscript type=\x26quot;text\/javascript\x26quot; src=\x26quot;js\/materialize.min.js\x26quot;\x3e\x3c\/script\x3e\n      \x3cscript type=\x26quot;text\/javascript\x26quot; src=\x26quot;js\/app.js\x26quot;\x3e\x3c\/script\x3e\n    \x3c\/body\x3e\n  \x3c\/html\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\x26lt;!-- .\/index.html --\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e\x26lt;!DOCTYPE html\x26gt;\x3c\/span\x3e\n  \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ehtml\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ehead\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\x26lt;!--Import Google Icon Font--\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3elink\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ehref\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22https:\/\/fonts.googleapis.com\/icon?family=Material\x2bIcons\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3erel\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22stylesheet\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\x26lt;!--Import materialize.css--\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3elink\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22text\/css\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3erel\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22stylesheet\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ehref\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22css\/materialize.min.css\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3emedia\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22screen,projection\x22\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3elink\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22text\/css\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3erel\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22stylesheet\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ehref\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22css\/app.css\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\n      \x3cspan class=\x22hljs-comment\x22\x3e\x26lt;!--Let browser know website is optimized for mobile--\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3emeta\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22viewport\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22width=device-width, initial-scale=1.0\x22\x3c\/span\x3e\/\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ehead\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebody\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\n      Body coming soon\n\n      \x3cspan class=\x22hljs-comment\x22\x3e\x26lt;!-- Scripts --\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22text\/javascript\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3esrc\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22js\/jquery-2.1.1.min.js\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22undefined\x22\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22text\/javascript\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3esrc\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22js\/materialize.min.js\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22undefined\x22\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22text\/javascript\x22\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3esrc\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22js\/app.js\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22undefined\x22\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ebody\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n  \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ehtml\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们已经引入了下载好的文件，还需要自己在相应的目录创建一下 \x3ccode\x3eapp.css\x3c\/code\x3e 以及 \x3ccode\x3eapp.js\x3c\/code\x3e 这两个文件。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader10\x22\x3e注册 Service Worker\x3c\/h2\x3e\n\x3cp\x3e越早在浏览器注册，Service Worker 就能越早的开始工作。最佳的做法是在应用的入口。在这个项目中，我们可以在 \x3ccode\x3eapp.js\x3c\/code\x3e 注册一个新的 worker：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22(function(){\n  if (\x27serviceWorker\x27 in navigator) {\n    navigator.serviceWorker\n     .register(\x27\/service-worker.js\x27)\n     .then(function() { \n        console.log(\x27Service Worker Registered\x27); \n      });\n  }    \n})()\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-string\x22\x3e\x27serviceWorker\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e navigator) {\n    navigator.serviceWorker\n     .register(\x3cspan class=\x22hljs-string\x22\x3e\x27\/service-worker.js\x27\x3c\/span\x3e)\n     .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{ \n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27Service Worker Registered\x27\x3c\/span\x3e); \n      });\n  }    \n})()\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在做其他操作之前，我们首先需要检测一下浏览器对于 Service Worker 的兼容性。如果支持，那我们就可以利用 \x3ccode\x3eregister\x3c\/code\x3e 这个方法来注册这个 worker，这个方法告知了 service worker 文件的路径。注册函数返回一个 promise ，你可以在这个 promise 里面判断注册是否成功。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader11\x22\x3eService Worker 周期\x3c\/h2\x3e\n\x3cp\x3e在开始构建 PWA 之前，你需要理解 Service Worker 的生命周期：\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader12\x22\x3eInstall\x3c\/h3\x3e\n\x3cp\x3e这一阶段主要是让 worker 在浏览器给定的作用域挂载。由于这是生命周期的第一步，最好在这一步缓存各种资源：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ .\/service-worker.js\n\nvar cacheName = \x27PWADemo-v1\x27;\nvar filesToCache = [\n  \x27\/index.html\x27,\n  \x27\/css\/app.css\x27,\n  \x27\/js\/app.js\x27,\n  \/* ...and other assets (jQuery, Materialize, fonts, etc) *\/\n];\n\nself.addEventListener(\x27install\x27, function(e) {\n  console.log(\x27[ServiceWorker] Install\x27);\n  e.waitUntil(\n    caches.open(cacheName).then(function(cache) {\n      console.log(\x27[ServiceWorker] Caching app shell\x27);\n      return cache.addAll(filesToCache);\n    })\n  );\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ .\/service-worker.js\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e cacheName = \x3cspan class=\x22hljs-string\x22\x3e\x27PWADemo-v1\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e filesToCache = [\n  \x3cspan class=\x22hljs-string\x22\x3e\x27\/index.html\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e\x27\/css\/app.css\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-string\x22\x3e\x27\/js\/app.js\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-comment\x22\x3e\/* ...and other assets (jQuery, Materialize, fonts, etc) *\/\x3c\/span\x3e\n];\n\nself.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27install\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ee\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27[ServiceWorker] Install\x27\x3c\/span\x3e);\n  e.waitUntil(\n    caches.open(cacheName).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ecache\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27[ServiceWorker] Caching app shell\x27\x3c\/span\x3e);\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e cache.addAll(filesToCache);\n    })\n  );\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3ecaches.open\x3c\/code\x3e 和 \x3ccode\x3ecache.addAll\x3c\/code\x3e 都是异步操作.service worker 在这些操作完成之前可能会中断,\x3ccode\x3ee.waitUntil\x3c\/code\x3e用来等待 promise 的状态变成 resolved 或者 rejected。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e当缓存开关被打开时，我们尝试利用 \x3ccode\x3eaddAll\x3c\/code\x3e 来新增缓存。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e请记住，只要有一个文件缓存失败，service worker 就无法被正确挂载。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader13\x22\x3eActivate\x3c\/h3\x3e\n\x3cp\x3e当 worker 挂载完成，其效果并不会立即展示出来，除非前一个 service worker 销毁并且该 web 应用被重新访问。假设我们挂载了另一个不同 cacheName 的 service worker:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ .\/service-worker.js\n\nvar cacheName = \x27PWADemo-v2\x27;\nvar filesToCache = [\n  \/\/...\n];\n\nself.addEventListener(\x27install\x27, function(e) {\n  console.log(\x27[ServiceWorker] Install\x27);\n  \/\/...\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ .\/service-worker.js\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e cacheName = \x3cspan class=\x22hljs-string\x22\x3e\x27PWADemo-v2\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e filesToCache = [\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n];\n\nself.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27install\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ee\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27[ServiceWorker] Install\x27\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当这个新的 service worker 创建之后，新的缓存 \x3ccode\x3ePWADemo-v2\x3c\/code\x3e 也被创建，这时候 \x3ccode\x3ePWADemo-v1\x3c\/code\x3e 仍然存在。当触发 Activate 时，我们可以删除 \x3ccode\x3ePWADemo-v1\x3c\/code\x3e，使其“让位”于 \x3ccode\x3ePWADemo-v2\x3c\/code\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ .\/service-worker.js\n\nself.addEventListener(\x27activate\x27, function(e) {\n  console.log(\x27[ServiceWorker] Activate\x27);\n  e.waitUntil(\n    caches.keys().then(function(keyList) {\n      return Promise.all(keyList.map(function(key) {\n        if (key !== cacheName) {\n          console.log(\x27[ServiceWorker] Removing old cache\x27, key);\n          return caches.delete(key);\n        }\n      }));\n    })\n  );\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ .\/service-worker.js\x3c\/span\x3e\n\nself.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27activate\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ee\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27[ServiceWorker] Activate\x27\x3c\/span\x3e);\n  e.waitUntil(\n    caches.keys().then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekeyList\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.all(keyList.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekey\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (key !== cacheName) {\n          \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27[ServiceWorker] Removing old cache\x27\x3c\/span\x3e, key);\n          \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e caches.delete(key);\n        }\n      }));\n    })\n  );\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们检查所有的 cache 名称，如果发现不是正在使用的 cache，那么将其直接删除。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader14\x22\x3eFetch\x3c\/h3\x3e\n\x3cp\x3eFetch 不是一个必需的生命周期，但它提供了拦截请求资源的方法。当发送请求时，首先会触发这样的事件：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ .\/service-worker.js\n\nself.addEventListener(\x27fetch\x27, function(e) {\n  console.log(\x27[ServiceWorker] Fetch\x27, e.request.url);\n  e.respondWith(\n    caches.match(e.request).then(function(response) {\n      return response || fetch(e.request);\n    })\n  );\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ .\/service-worker.js\x3c\/span\x3e\n\nself.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27fetch\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ee\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27[ServiceWorker] Fetch\x27\x3c\/span\x3e, e.request.url);\n  e.respondWith(\n    caches.match(e.request).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eresponse\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e response || fetch(e.request);\n    })\n  );\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果资源已经被缓存了，我们返回浏览器缓存的版本。如果没有，那么我们调用 fetch api 去发送 HTTP 请求该资源。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader15\x22\x3eDebuggering Service Workers\x3c\/h2\x3e\n\x3cp\x3e由于 service workers 的工作方式，特别是进行缓存时，不是很容易进行 debugger 调试。幸运的是，chrome 的 dev tools 提供了助力。跟着下面的步骤，调试我们刚注册的 service worker：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e打开 chrome dev tools\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e点击 Application 这一选项，打开 service worker 分区：\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcIN?w=1316\x26amp;h=780\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcIN?w=1316\x26amp;h=780\x22 alt=\x22Chrome dev tools\x22 title=\x22Chrome dev tools\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e你可以查看到 status 是绿色的，这就表明你的 service worker 成功了：\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcIY?w=746\x26amp;h=728\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcIY?w=746\x26amp;h=728\x22 alt=\x22status\x22 title=\x22status\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e你可以打开 \x22Update on reload\x22 去强制更新 service worker，不用关闭所有已存在的 session：\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcIZ?w=746\x26amp;h=728\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcIZ?w=746\x26amp;h=728\x22 alt=\x22update on reload\x22 title=\x22update on reload\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e右击 \x22Cache Storage\x22，然后点击刷新去查看缓存。根据名称点击你所设置的cache，然后你就会看到缓存里面的各个项：\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVYcI0?w=740\x26amp;h=612\x22 src=\x22https:\/\/static.alili.tech\/img\/bVYcI0?w=740\x26amp;h=612\x22 alt=\x22Cache storage\x22 title=\x22Cache storage\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader16\x22\x3e接下来\x3c\/h2\x3e\n\x3cp\x3e你已经了解了必备的知识点，PWA 的概念对你来说已经不陌生了。接下来，我们将要讨论 PWA 的缓存策略。我们将了解如何使用 IndexDB 来保存数据而不是 localStorage。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>构建离线web应用（一）</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000011926250">https://segmentfault.com/a/1190000011926250</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/nh8rh70wc1/" target="_blank">https://alili.tech/archive/nh8rh70wc1/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>