<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="Vue项目SSR改造实战"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>Vue项目SSR改造实战 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/rroq60qgvqg/",
				"appid": "1613049289050283", 
				"title": "Vue项目SSR改造实战 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-22T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/8m2wpuj0w7/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/35rum9clzqj/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f&text=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f&text=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f&title=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f&is_video=false&description=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f&title=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f&title=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f&title=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2frroq60qgvqg%2f&title=Vue%e9%a1%b9%e7%9b%aeSSR%e6%94%b9%e9%80%a0%e5%ae%9e%e6%88%98"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Vue项目SSR改造实战</h1><div class="meta"><div class="postdate"><time datetime="2018-12-22" itemprop="datePublished">2018-12-22</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cblockquote\x3e博客已全站升级到https，如果遇到无法访问，请手动加上\x3ca href=\x22https:\/\/%E5%89%8D%E7%BC%80\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/前缀\x3c\/a\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e我们先看“疗效”，你可以打开我的博客\x3ca\x3eu3xyz.com\x3c\/a\x3e，通过查看源代码来看SSR直出效果。我的博客已经快上线一年了，但不吹不黑，访问量非常地小，我也一直在想办法提升访问量（包括在sf写文章，哈哈）。当然，在PC端，搜索引擎一直都是一个重要的流量来源。这里就不得不提到SEO。下图是我的博客以前在百度的快照：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012440046?w=601\x26amp;h=94\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012440046?w=601\x26amp;h=94\x22 alt=\x22SSR前快照\x22 title=\x22SSR前快照\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e细心的朋友会发现，这个快照非常简单，简单到几乎什么都没有。这也是没办法的事，\x3cstrong\x3e博客是基于Vue的SPA页面\x3c\/strong\x3e，整个项目本来就是一个“空架子”，这个快照从博客2月份上线以来就一直是上面的样子，直到最近上线SSR。搜索引擎蜘蛛每次来抓取你的网站都是一个样子，慢慢得，它也就不会来了，相应的，网站的权重，排名肯定不会好。到目前为此，我的博客不用网址进行搜索都搜不到。在上线了SSR后，再加上一些SEO优化，百度快照终于更新了：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012440047?w=699\x26amp;h=231\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012440047?w=699\x26amp;h=231\x22 alt=\x22SSR后快照\x22 title=\x22SSR后快照\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e为什么要做SSR\x3c\/h2\x3e\n\x3cp\x3e文章开始基本已经回答了为什么要做SSR这个问题，当然，还有另一个原因是SSR概念现在在前端非常火，无奈在实际项目中没有机会，也只有拿博客来练手了。下面将详细介绍本博客项目SSR全过程。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eSSR改造实战\x3c\/h2\x3e\n\x3cp\x3e总的来说SSR改造还是相当容易的。推荐在动手之前，先了解\x3ca href=\x22https:\/\/ssr.vuejs.org\/zh\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e官方文档\x3c\/a\x3e和\x3ca href=\x22https:\/\/github.com\/vuejs\/vue-hackernews-2.0\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e官方Vue SSR Demo\x3c\/a\x3e，这会让我们事半功倍。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e1. 构建改造\x3c\/h3\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012440048?w=1946\x26amp;h=892\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012440048?w=1946\x26amp;h=892\x22 alt=\x22VueSSR原理\x22 title=\x22VueSSR原理\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e上图是Vue官方的SSR原理介绍图片。从这张图片，我们可以知道：我们需要通过Webpack打包生成两份bundle文件：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3eClient Bundle，给浏览器用。和纯Vue前端项目Bundle类似\x3c\/li\x3e\n\x3cli\x3eServer Bundle，供服务端SSR使用，一个json文件\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e不管你项目先前是什么样子，是否是使用vue-cli生成的。都会有这个构建改造过程。在构建改造这里会用到 vue-server-renderer 库，这里要注意的是 vue-server-renderer 版本要与Vue版本一样。下图是我的构建文件目录：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012440049?w=223\x26amp;h=122\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012440049?w=223\x26amp;h=122\x22 alt=\x22构建\x22 title=\x22构建\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3eutil.js 提供一些公共方法\x3c\/li\x3e\n\x3cli\x3ewebpack.base.js是公共的配置\x3c\/li\x3e\n\x3cli\x3ewebpack.client.js 是生成Client Bundle的配置。核心配置如下：\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const VueSSRClientPlugin = require(\x27vue-server-renderer\/client-plugin\x27)\n\n\/\/ ...\n\nconst config = merge(baseConfig, {\n  target: \x27web\x27,\n  entry: \x27.\/src\/entry.client.js\x27,\n  plugins: [\n    new webpack.DefinePlugin({\n      \x27process.env.NODE_ENV\x27: JSON.stringify(process.env.NODE_ENV || \x27development\x27),\n      \x27process.env.VUE_ENV\x27: \x27\x26quot;client\x26quot;\x27\n    }),\n    new webpack.optimize.CommonsChunkPlugin({\n      name: \x27vender\x27,\n      minChunks: 2\n    }),\n    \/\/ extract webpack runtime \x26amp; manifest to avoid vendor chunk hash changing\n    \/\/ on every build.\n    new webpack.optimize.CommonsChunkPlugin({\n      name: \x27manifest\x27\n    }),\n    new VueSSRClientPlugin()\n  ]\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e VueSSRClientPlugin = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27vue-server-renderer\/client-plugin\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e config = merge(baseConfig, {\n  \x3cspan class=\x22hljs-attr\x22\x3etarget\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27web\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eentry\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27.\/src\/entry.client.js\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eplugins\x3c\/span\x3e: [\n    \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e webpack.DefinePlugin({\n      \x3cspan class=\x22hljs-string\x22\x3e\x27process.env.NODE_ENV\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(process.env.NODE_ENV || \x3cspan class=\x22hljs-string\x22\x3e\x27development\x27\x3c\/span\x3e),\n      \x3cspan class=\x22hljs-string\x22\x3e\x27process.env.VUE_ENV\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x22client\x22\x27\x3c\/span\x3e\n    }),\n    \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e webpack.optimize.CommonsChunkPlugin({\n      \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27vender\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3eminChunks\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\n    }),\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ extract webpack runtime \x26amp; manifest to avoid vendor chunk hash changing\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ on every build.\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e webpack.optimize.CommonsChunkPlugin({\n      \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27manifest\x27\x3c\/span\x3e\n    }),\n    \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e VueSSRClientPlugin()\n  ]\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3ewebpack.server.js 是生成Server Bundle的配置，核心配置如下：\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const VueSSRServerPlugin = require(\x27vue-server-renderer\/server-plugin\x27)\n\n\/\/ ...\n\nconst config = merge(baseConfig, {\n  target: \x27node\x27,\n  devtool: \x27#source-map\x27,\n  entry: \x27.\/src\/entry.server.js\x27,\n  output: {\n    libraryTarget: \x27commonjs2\x27,\n    filename: \x27server-bundle.js\x27\n  },\n  externals: nodeExternals({\n    \/\/ do not externalize CSS files in case we need to import it from a dep\n    whitelist: \/\\.css$\/\n  }),\n  plugins: [\n    new webpack.DefinePlugin({\n      \x27process.env.NODE_ENV\x27: JSON.stringify(process.env.NODE_ENV || \x27development\x27),\n      \x27process.env.VUE_ENV\x27: \x27\x26quot;server\x26quot;\x27\n    }),\n    new VueSSRServerPlugin()\n  ]\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e VueSSRServerPlugin = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27vue-server-renderer\/server-plugin\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e config = merge(baseConfig, {\n  \x3cspan class=\x22hljs-attr\x22\x3etarget\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27node\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3edevtool\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27#source-map\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eentry\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27.\/src\/entry.server.js\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eoutput\x3c\/span\x3e: {\n    \x3cspan class=\x22hljs-attr\x22\x3elibraryTarget\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27commonjs2\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3efilename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27server-bundle.js\x27\x3c\/span\x3e\n  },\n  \x3cspan class=\x22hljs-attr\x22\x3eexternals\x3c\/span\x3e: nodeExternals({\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ do not externalize CSS files in case we need to import it from a dep\x3c\/span\x3e\n    whitelist: \x3cspan class=\x22hljs-regexp\x22\x3e\/\\.css$\/\x3c\/span\x3e\n  }),\n  \x3cspan class=\x22hljs-attr\x22\x3eplugins\x3c\/span\x3e: [\n    \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e webpack.DefinePlugin({\n      \x3cspan class=\x22hljs-string\x22\x3e\x27process.env.NODE_ENV\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(process.env.NODE_ENV || \x3cspan class=\x22hljs-string\x22\x3e\x27development\x27\x3c\/span\x3e),\n      \x3cspan class=\x22hljs-string\x22\x3e\x27process.env.VUE_ENV\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x22server\x22\x27\x3c\/span\x3e\n    }),\n    \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e VueSSRServerPlugin()\n  ]\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e2. 代码改造\x3c\/h3\x3e\n\x3ch4\x3e2.1 必须使用VueRouter, Vuex。ajax库建议使用axios\x3c\/h4\x3e\n\x3cp\x3e可能你的项目没有使用VueRouter或Vuex。但遗憾的是，Vue-SSR必须基于 Vue \x2b VueRouter \x2b Vuex。Vuex官方没有提，但其实文档和Demo都是基于Vuex。我的博客以前也没有用Vuex，但经过一翻折腾后，还是乖乖加上了Vuex。另外，因为代码要能同时在浏览器和Node.js环境中运行，所以ajax库建议使用axios这样的跨平台库。\x3c\/p\x3e\n\x3ch4\x3e2.2 两个打包入口（entry），重构app, store, router, 为每个对象增加工厂方法createXXX\x3c\/h4\x3e\n\x3cp\x3e\x3cstrong\x3e每个用户通过浏览器访问Vue页面时，都是一个全新的上下文，但在服务端，应用启动后就一直运行着，处理每个用户请求的都是在同一个应用上下文中。为了不串数据，需要为每次SSR请求，创建全新的app, store, router\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012440050?w=206\x26amp;h=299\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012440050?w=206\x26amp;h=299\x22 alt=\x22项目目录\x22 title=\x22项目目录\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e上图是我的项目文件目录。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3eapp.js， 通用的启动Vue应用代码\x3c\/li\x3e\n\x3cli\x3eApp.vue，Vue应用根组件\x3c\/li\x3e\n\x3cli\x3eentry.client.js，浏览器环境入口\x3c\/li\x3e\n\x3cli\x3eentry.server.js，服务器环境入口\x3c\/li\x3e\n\x3cli\x3eindex.html，html模板\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e再看一下具体实现的核心代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ app.js\n\nimport Vue from \x27vue\x27\nimport App from \x27.\/App.vue\x27 \/\/ 根组件\nimport {createRouter} from \x27.\/routers\/index\x27 \nimport {createStore} from \x27.\/vuex\/store\x27\nimport {sync} from \x27vuex-router-sync\x27 \/\/ 把当VueRouter状态同步到Vuex中\n\n\/\/ createApp工厂方法\nexport function createApp (ssrContext) {\n  let router = createRouter() \/\/ 创建全新router实例\n  let store = createStore() \/\/ 创建全新store实例\n\n  \/\/ 同步路由状态到store中\n  sync(store, router)\n  \n  \/\/ 创建Vue应用\n  const app = new Vue({\n    router,\n    store,\n    ssrContext,\n    render: h =\x3e h(App)\n  })\n  return {app, router, store}\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ app.js\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Vue \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27vue\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e App \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/App.vue\x27\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 根组件\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e {createRouter} \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/routers\/index\x27\x3c\/span\x3e \n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e {createStore} \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/vuex\/store\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e {sync} \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27vuex-router-sync\x27\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 把当VueRouter状态同步到Vuex中\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ createApp工厂方法\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecreateApp\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3essrContext\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e router = createRouter() \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 创建全新router实例\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e store = createStore() \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 创建全新store实例\x3c\/span\x3e\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 同步路由状态到store中\x3c\/span\x3e\n  sync(store, router)\n  \n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 创建Vue应用\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Vue({\n    router,\n    store,\n    ssrContext,\n    \x3cspan class=\x22hljs-attr\x22\x3erender\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eh\x3c\/span\x3e =\x26gt;\x3c\/span\x3e h(App)\n  })\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {app, router, store}\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ entry.client.js \n\nimport Vue from \x27vue\x27\nimport { createApp } from \x27.\/app\x27\n\nconst { app, router, store } = createApp()\n\n\/\/ 如果有__INITIAL_STATE__变量，则将store的状态用它替换\nif (window.__INITIAL_STATE__) {\n  store.replaceState(window.__INITIAL_STATE__)\n}\n\nrouter.onReady(() =\x3e {\n    \n  \/\/ 通过路由勾子，执行拉取数据逻辑\n  router.beforeResolve((to, from, next) =\x3e {\n    \/\/ 找到增量组件，拉取数据 \n    const matched = router.getMatchedComponents(to) \n    const prevMatched = router.getMatchedComponents(from) \n    let diffed = false\n    const activated = matched.filter((c, i) =\x3e {\n      return diffed || (diffed = (prevMatched[i] !== c))\n    })\n    \/\/ 组件数据通过执行asyncData方法获取\n    const asyncDataHooks = activated.map(c =\x3e c.asyncData).filter(_ =\x3e _)\n    if (!asyncDataHooks.length) {\n      return next()\n    }\n    \/\/ 要注意asyncData方法要返回promise，asyncData调用的vuex action也必须返回promise\n    Promise.all(asyncDataHooks.map(hook =\x3e hook({ store, route: to })))\n      .then(() =\x3e {\n        next()\n      })\n      .catch(next)\n  })\n\n  \/\/ 将Vue实例挂载到dom中，完成浏览器端应用启动\n  app.$mount(\x27#app\x27)\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ entry.client.js \x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Vue \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27vue\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { createApp } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/app\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { app, router, store } = createApp()\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 如果有__INITIAL_STATE__变量，则将store的状态用它替换\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.__INITIAL_STATE__) {\n  store.replaceState(\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.__INITIAL_STATE__)\n}\n\nrouter.onReady(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 通过路由勾子，执行拉取数据逻辑\x3c\/span\x3e\n  router.beforeResolve(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eto, \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e, next\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 找到增量组件，拉取数据 \x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e matched = router.getMatchedComponents(to) \n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e prevMatched = router.getMatchedComponents(\x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e) \n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e diffed = \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e activated = matched.filter(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ec, i\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e diffed || (diffed = (prevMatched[i] !== c))\n    })\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 组件数据通过执行asyncData方法获取\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e asyncDataHooks = activated.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ec\x3c\/span\x3e =\x26gt;\x3c\/span\x3e c.asyncData).filter(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e_\x3c\/span\x3e =\x26gt;\x3c\/span\x3e _)\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!asyncDataHooks.length) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next()\n    }\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 要注意asyncData方法要返回promise，asyncData调用的vuex action也必须返回promise\x3c\/span\x3e\n    \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.all(asyncDataHooks.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ehook\x3c\/span\x3e =\x26gt;\x3c\/span\x3e hook({ store, \x3cspan class=\x22hljs-attr\x22\x3eroute\x3c\/span\x3e: to })))\n      .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        next()\n      })\n      .catch(next)\n  })\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 将Vue实例挂载到dom中，完成浏览器端应用启动\x3c\/span\x3e\n  app.$mount(\x3cspan class=\x22hljs-string\x22\x3e\x27#app\x27\x3c\/span\x3e)\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ entry.server.js\nimport { createApp } from \x27.\/app\x27\n\nexport default context =\x3e {\n  return new Promise((resolve, reject) =\x3e {\n    const { app, router, store } = createApp(context)\n\n    \/\/ 设置路由\n    router.push(context.url)\n\n    router.onReady(() =\x3e {\n      const matchedComponents = router.getMatchedComponents()\n      if (!matchedComponents.length) {\n        return reject({ code: 404 })\n      }\n\n      \/\/ 执行asyncData方法，预拉取数据\n      Promise.all(matchedComponents.map(Component =\x3e {\n        if (Component.asyncData) {\n          return Component.asyncData({\n            store: store,\n            route: router.currentRoute\n          })\n        }\n      })).then(() =\x3e {\n        \/\/ 将store的快照挂到ssr上下文上\n        context.state = store.state\n        resolve(app)\n      }).catch(reject)\n    }, reject)\n  })\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ entry.server.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { createApp } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/app\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e context =\x26gt; {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { app, router, store } = createApp(context)\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 设置路由\x3c\/span\x3e\n    router.push(context.url)\n\n    router.onReady(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e matchedComponents = router.getMatchedComponents()\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!matchedComponents.length) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e reject({ \x3cspan class=\x22hljs-attr\x22\x3ecode\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e404\x3c\/span\x3e })\n      }\n\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 执行asyncData方法，预拉取数据\x3c\/span\x3e\n      \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.all(matchedComponents.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eComponent\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (Component.asyncData) {\n          \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e Component.asyncData({\n            \x3cspan class=\x22hljs-attr\x22\x3estore\x3c\/span\x3e: store,\n            \x3cspan class=\x22hljs-attr\x22\x3eroute\x3c\/span\x3e: router.currentRoute\n          })\n        }\n      })).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 将store的快照挂到ssr上下文上\x3c\/span\x3e\n        context.state = store.state\n        resolve(app)\n      }).catch(reject)\n    }, reject)\n  })\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ createStore\n\nimport Vue from \x27vue\x27\nimport Vuex from \x27vuex\x27\n\/\/ ...\n\nVue.use(Vuex)\n\n\/\/ createStore工厂方法\nexport function createStore () {\n  return new Vuex.Store({\n    \/\/ rootstate\n    state: {\n      appName: \x27appName\x27,\n      title: \x27home\x27\n    },\n\n    modules: {\n      \/\/ ...\n    },\n\n    strict: process.env.NODE_ENV !== \x27production\x27 \/\/ 线上环境关闭store检查\n  })\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ createStore\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Vue \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27vue\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Vuex \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27vuex\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n\nVue.use(Vuex)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ createStore工厂方法\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecreateStore\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Vuex.Store({\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ rootstate\x3c\/span\x3e\n    state: {\n      \x3cspan class=\x22hljs-attr\x22\x3eappName\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27appName\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27home\x27\x3c\/span\x3e\n    },\n\n    \x3cspan class=\x22hljs-attr\x22\x3emodules\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n    },\n\n    \x3cspan class=\x22hljs-attr\x22\x3estrict\x3c\/span\x3e: process.env.NODE_ENV !== \x3cspan class=\x22hljs-string\x22\x3e\x27production\x27\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 线上环境关闭store检查\x3c\/span\x3e\n  })\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ createRouter\n\nimport Vue from \x27vue\x27\nimport Router from \x27vue-router\x27\nVue.use(Router)\n\n\/\/ createRouter工厂方法\nexport function createRouter () {\n  return new Router({\n    mode: \x27history\x27, \/\/ 注意这里要使用history模式，因为hash不会发送到服务端\n    fallback: false,\n    routes: [\n      {\n        path: \x27\/index\x27,\n        name: \x27index\x27,\n        component: () =\x3e System.import(\x27.\/index\/index.vue\x27) \/\/ 代码分片\n      },\n      {\n        path: \x27\/detail\/:aid\x27,\n        name: \x27detail\x27,\n        component: () =\x3e System.import(\x27.\/detail\/detail.vue\x27)\n      },\n      \/\/ ...\n      {\n        path: \x27\/\x27,\n        redirect: \x27\/index\x27\n      }\n    ]\n  })\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ createRouter\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Vue \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27vue\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Router \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27vue-router\x27\x3c\/span\x3e\nVue.use(Router)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ createRouter工厂方法\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecreateRouter\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Router({\n    \x3cspan class=\x22hljs-attr\x22\x3emode\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27history\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 注意这里要使用history模式，因为hash不会发送到服务端\x3c\/span\x3e\n    fallback: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3eroutes\x3c\/span\x3e: [\n      {\n        \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/index\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27index\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3ecomponent\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e System.import(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/index\/index.vue\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 代码分片\x3c\/span\x3e\n      },\n      {\n        \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/detail\/:aid\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27detail\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3ecomponent\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e System.import(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/detail\/detail.vue\x27\x3c\/span\x3e)\n      },\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n      {\n        \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3eredirect\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/index\x27\x3c\/span\x3e\n      }\n    ]\n  })\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e3. 重构组件获取数据方式\x3c\/h3\x3e\n\x3cp\x3e关于状态管理，要严格遵守Redux思想。建议把应用所有状态都存于store中，组件使用时再mapState下来，状态更改严格使用action的方式。另一个要提一点的是，action要返回promise。这样我们就可以使用asyncData方法获取组件数据了\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const actions = {\n  getArticleList ({state, commit}, curPageNum) {\n    commit(FETCH_ARTICLE_LIST, curPageNum)\n\n    \/\/ action 要返回promise\n    return apis.getArticleList({\n      data: {\n        size: state.pagi.itemsPerPage,\n        page: curPageNum\n      }\n    }).then((res) =\x3e {\n      \/\/ ...\n    })\n  }\n}\n\n\/\/ 组件asyncData实现\nexport default {\n  asyncData ({ store }) {\n    return store.dispatch(\x27getArticleList\x27, 1)\n  }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e actions = {\n  getArticleList ({state, commit}, curPageNum) {\n    commit(FETCH_ARTICLE_LIST, curPageNum)\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ action 要返回promise\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e apis.getArticleList({\n      \x3cspan class=\x22hljs-attr\x22\x3edata\x3c\/span\x3e: {\n        \x3cspan class=\x22hljs-attr\x22\x3esize\x3c\/span\x3e: state.pagi.itemsPerPage,\n        \x3cspan class=\x22hljs-attr\x22\x3epage\x3c\/span\x3e: curPageNum\n      }\n    }).then(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n    })\n  }\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 组件asyncData实现\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e {\n  asyncData ({ store }) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e store.dispatch(\x3cspan class=\x22hljs-string\x22\x3e\x27getArticleList\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n  }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e3. SSR服务器实现\x3c\/h3\x3e\n\x3cp\x3e在完成构建和代码改造后，如果一切顺利。我们能得到下面的打包文件：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012440051?w=310\x26amp;h=257\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012440051?w=310\x26amp;h=257\x22 alt=\x22dist文件\x22 title=\x22dist文件\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这时，我们可以开始实现SSR服务端代码了。下面是我博客SSR实现（基于Koa）\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ server.js\nconst Koa = require(\x27koa\x27)\nconst path = require(\x27path\x27)\nconst logger = require(\x27.\/logger\x27)\nconst server = new Koa()\nconst { createBundleRenderer } = require(\x27vue-server-renderer\x27)\nconst templateHtml = require(\x27fs\x27).readFileSync(path.resolve(__dirname, \x27.\/index.template.html\x27), \x27utf-8\x27)\n\nlet distPath = \x27.\/dist\x27\n\nconst renderer = createBundleRenderer(require(`${distPath}\/vue-ssr-server-bundle.json`), { \n  runInNewContext: false,\n  template: templateHtml, \n  clientManifest: require(`${distPath}\/vue-ssr-client-manifest.json`) \n})\n\nserver.use(function * (next) {\n  let ctx = this\n  const context = { url: ctx.req.url, pageTitle: \x27default-title\x27 }\n\n  \/\/ cgi请求，前端资源请求不能转到这里来。这里可以通过nginx做\n  if (\/\\.\\w\x2b$\/.test(context.url)) {\n    return yield next\n  }\n\n  \/\/ 注意这里也必须返回promise  \n  return new Promise((resolve, reject) =\x3e {\n    renderer.renderToString(context, function (err, html) {\n      if (err) {\n        logger.error(`[error][ssr-error]: ` \x2b err.stack)\n        return reject(err)\n      }\n      ctx.status = 200\n      ctx.type = \x27text\/html; charset=utf-8\x27\n      ctx.body = html\n      resolve(html)\n    })\n  })\n})\n\n\/\/ 错误处理\nserver.on(\x27error\x27, function (err) {\n  logger.error(\x27[error][server-error]: \x27 \x2b err.stack)\n})\n\nlet port = 80\n\nserver.listen(port, () =\x3e {\n  logger.info(`[info]: server is deploy on port: ${port}`)\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ server.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Koa = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e logger = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/logger\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e server = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Koa()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { createBundleRenderer } = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27vue-server-renderer\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e templateHtml = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fs\x27\x3c\/span\x3e).readFileSync(path.resolve(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27.\/index.template.html\x27\x3c\/span\x3e), \x3cspan class=\x22hljs-string\x22\x3e\x27utf-8\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e distPath = \x3cspan class=\x22hljs-string\x22\x3e\x27.\/dist\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e renderer = createBundleRenderer(\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${distPath}\x3c\/span\x3e\/vue-ssr-server-bundle.json`\x3c\/span\x3e), { \n  \x3cspan class=\x22hljs-attr\x22\x3erunInNewContext\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3etemplate\x3c\/span\x3e: templateHtml, \n  \x3cspan class=\x22hljs-attr\x22\x3eclientManifest\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${distPath}\x3c\/span\x3e\/vue-ssr-client-manifest.json`\x3c\/span\x3e) \n})\n\nserver.use(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e * (\x3cspan class=\x22hljs-params\x22\x3enext\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e ctx = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e context = { \x3cspan class=\x22hljs-attr\x22\x3eurl\x3c\/span\x3e: ctx.req.url, \x3cspan class=\x22hljs-attr\x22\x3epageTitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27default-title\x27\x3c\/span\x3e }\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ cgi请求，前端资源请求不能转到这里来。这里可以通过nginx做\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-regexp\x22\x3e\/\\.\\w\x2b$\/\x3c\/span\x3e.test(context.url)) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e next\n  }\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 注意这里也必须返回promise  \x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    renderer.renderToString(context, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerr, html\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err) {\n        logger.error(\x3cspan class=\x22hljs-string\x22\x3e`[error][ssr-error]: `\x3c\/span\x3e \x2b err.stack)\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e reject(err)\n      }\n      ctx.status = \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e\n      ctx.type = \x3cspan class=\x22hljs-string\x22\x3e\x27text\/html; charset=utf-8\x27\x3c\/span\x3e\n      ctx.body = html\n      resolve(html)\n    })\n  })\n})\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 错误处理\x3c\/span\x3e\nserver.on(\x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e) \x3c\/span\x3e{\n  logger.error(\x3cspan class=\x22hljs-string\x22\x3e\x27[error][server-error]: \x27\x3c\/span\x3e \x2b err.stack)\n})\n\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e port = \x3cspan class=\x22hljs-number\x22\x3e80\x3c\/span\x3e\n\nserver.listen(port, () =\x26gt; {\n  logger.info(\x3cspan class=\x22hljs-string\x22\x3e`[info]: server is deploy on port: \x3cspan class=\x22hljs-subst\x22\x3e${port}\x3c\/span\x3e`\x3c\/span\x3e)\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e4. 服务器部署\x3c\/h3\x3e\n\x3cp\x3e服务器部署，跟你的项目架构有关。比如我的博客项目在服务端有2个后端服务，一个数据库服务，nginx用于请求转发：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000012440052?w=1181\x26amp;h=720\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000012440052?w=1181\x26amp;h=720\x22 alt=\x22u3xyz架构\x22 title=\x22u3xyz架构\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3e5. 遇到的问题及解决办法\x3c\/h3\x3e\n\x3cblockquote\x3e加载不到组件的JS文件\x3c\/blockquote\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22[vue-router] Failed to resolve async component default: Error: Cannot find module \x27js\\main1.js\x27\n[vue-router] uncaught error during route navigation:\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs vbnet\x22\x3e\x3ccode\x3e[vue-router] Failed \x3cspan class=\x22hljs-keyword\x22\x3eto\x3c\/span\x3e resolve async component \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e: \x3cspan class=\x22hljs-keyword\x22\x3eError\x3c\/span\x3e: Cannot find \x3cspan class=\x22hljs-keyword\x22\x3emodule\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\x27js\\main1.js\x27\x3c\/span\x3e\n[vue-router] uncaught \x3cspan class=\x22hljs-keyword\x22\x3eerror\x3c\/span\x3e during route navigation:\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e解决办法：\x3c\/p\x3e\n\x3cp\x3e去掉webpack配置中的output.chunkFilename: getFileName(\x27js\/main[name]-$hash.js\x27)\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22if you are using CommonsChunkPlugin, make sure to use it only in the client config because the server bundle requires a single entry chunk.\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs livecodeserver\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e you are \x3cspan class=\x22hljs-keyword\x22\x3eusing\x3c\/span\x3e CommonsChunkPlugin, make sure \x3cspan class=\x22hljs-built_in\x22\x3eto\x3c\/span\x3e use \x3cspan class=\x22hljs-keyword\x22\x3eit\x3c\/span\x3e only \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethe\x3c\/span\x3e client config because \x3cspan class=\x22hljs-keyword\x22\x3ethe\x3c\/span\x3e server bundle requires \x3cspan class=\x22hljs-keyword\x22\x3ea\x3c\/span\x3e single entry chunk.\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e所以对webpack.server.js不要对配置CommonsChunkPlugin,也不要设置output.chunkFilename\x3c\/p\x3e\n\x3cblockquote\x3e代码高亮codeMirror使用到navigator对象，只能在浏览器环境运行\x3c\/blockquote\x3e\n\x3cp\x3e把执行逻辑放到mounted回调中。实现不行，就封装一个异步组件，把组件的初始化放到mounted中：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22mounted () {\n  let paragraph = require(\x27.\/paragraph.vue\x27)\n  Vue.component(\x27paragraph\x27, paragraph)\n  new Vue().$mount(\x27#paragraph\x27)\n},\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3emounted () {\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e paragraph = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/paragraph.vue\x27\x3c\/span\x3e)\n  Vue.component(\x3cspan class=\x22hljs-string\x22\x3e\x27paragraph\x27\x3c\/span\x3e, paragraph)\n  \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Vue().$mount(\x3cspan class=\x22hljs-string\x22\x3e\x27#paragraph\x27\x3c\/span\x3e)\n},\x3c\/code\x3e\x3c\/pre\x3e\n\x3cblockquote\x3e串数据\x3c\/blockquote\x3e\n\x3cp\x3edispatch的action没有返回promise，保证返回promise即可\x3c\/p\x3e\n\x3cblockquote\x3e路由跳转\x3c\/blockquote\x3e\n\x3cp\x3e路由跳转使用router方法或\x26lt;router-link \/\x26gt;标签，这两种方式能自适应浏览器端和服务端，不要使用a标签\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader8\x22\x3e小结\x3c\/h2\x3e\n\x3cp\x3e本文主要记录了我的博客\x3ca\x3eu3xyz.com\x3c\/a\x3eSSR过程：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e构建webpack改造\x3c\/li\x3e\n\x3cli\x3e代码改造\x3c\/li\x3e\n\x3cli\x3eserver端SSR实现\x3c\/li\x3e\n\x3cli\x3e上线部署\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e最后希望文章能对大家有些许帮助！\x3c\/p\x3e\n\x3cp\x3e愿文地址：\x3ca href=\x22http:\/\/u3xyz.com\/detail\/29\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eVue项目SSR改造实战\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>Vue项目SSR改造实战</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000012440041">https://segmentfault.com/a/1190000012440041</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/rroq60qgvqg/" target="_blank">https://alili.tech/archive/rroq60qgvqg/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>