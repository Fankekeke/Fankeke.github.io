<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="一步步去阅读koa源码，整体架构分析"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>一步步去阅读koa源码，整体架构分析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/rwotjbpp45/",
				"appid": "1613049289050283", 
				"title": "一步步去阅读koa源码，整体架构分析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-11-30T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/8zn5nalnoe/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/9pogqadt08q/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f&text=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f&text=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f&title=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f&is_video=false&description=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f&title=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f&title=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f&title=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2frwotjbpp45%2f&title=%e4%b8%80%e6%ad%a5%e6%ad%a5%e5%8e%bb%e9%98%85%e8%af%bbkoa%e6%ba%90%e7%a0%81%ef%bc%8c%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%88%86%e6%9e%90"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">一步步去阅读koa源码，整体架构分析</h1><div class="meta"><div class="postdate"><time datetime="2018-11-30" itemprop="datePublished">2018-11-30</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cblockquote\x3e阅读好的框架的源码有很多好处，从大神的视角去理解整个框架的设计思想。大到架构设计，小到可取的命名风格，还有设计模式、实现某类功能使用到的数据结构和算法等等。\x3c\/blockquote\x3e\n\x3ch3 id=\x22articleHeader0\x22\x3e使用koa\x3c\/h3\x3e\n\x3cp\x3e其实某个框架阅读源码的时候，首先我们要会去用这个框架，因为用了我们才知道，某个API是怎么用，哪里有坑，哪里设计的精妙。\x3c\/p\x3e\n\x3cp\x3e下面我们就简单用一下\x3ccode\x3ekoa\x3c\/code\x3e这个框架，如下代码\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\nconst Koa = require(\x27koa\x27)\nconst app = new Koa()\napp.use(async (ctx, next) =\x3e {\n  ctx.body = \x27Hello World\x27\n})\napp.listen(4002)\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Koa = \x3cspan class=\x22hljs-keyword\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Koa()\napp.\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e(async (ctx, next) =\x26gt; {\n  ctx.body = \x3cspan class=\x22hljs-string\x22\x3e\x27Hello World\x27\x3c\/span\x3e\n})\napp.listen(\x3cspan class=\x22hljs-number\x22\x3e4002\x3c\/span\x3e)\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e运行结果\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000014894689?w=1188\x26amp;h=452\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000014894689?w=1188\x26amp;h=452\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e瓦特？？这个服务会涉及到从请求到响应返回数据，就这几行代码？？ 是的，你没有看错，就是单单这几行代码就可以搭建了一个服务器。\x3c\/p\x3e\n\x3cp\x3e下面我们看看一探究竟。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e阅读源码\x3c\/h3\x3e\n\x3cp\x3e去到\x3ccode\x3enode_modules\x3c\/code\x3e文件夹下找到\x3ccode\x3ekoa\x3c\/code\x3e模块，先喵几眼\x3ccode\x3eREADME.md\x3c\/code\x3e文件，里面介绍了\x3ccode\x3ekoa\x3c\/code\x3e的一些安装、用法、插件等等，这里我们跳过，然后转到\x3ccode\x3epackage.json\x3c\/code\x3e如下图\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000014894690?w=1590\x26amp;h=736\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000014894690?w=1590\x26amp;h=736\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e看到\x3ccode\x3epackage.json\x3c\/code\x3e里面的\x3ccode\x3e\x22main\x22: \x22lib\/application.js\x22\x3c\/code\x3e没错，这就是我们的入口，在lib文件夹下面，我们看到里面有\x3ccode\x3eapplication.js\x3c\/code\x3e、\x3ccode\x3econtext.js\x3c\/code\x3e、\x3ccode\x3erequrest.js\x3c\/code\x3e和\x3ccode\x3eresponse.js\x3c\/code\x3e。下面经过我修改简化去掉注释\x3ccode\x3eapplication.js\x3c\/code\x3e就只有68行代码。阅读起来可以说是非常简单了。如下图：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000014894691?w=1296\x26amp;h=750\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000014894691?w=1296\x26amp;h=750\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e第一步是我们引入各种主要依赖\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 引入有很多 我只挑我阅读主要框架的代码模块\n\nconst response = require(\x27.\/response\x27); \/\/ 处理response对象\nconst compose = require(\x27koa-compose\x27); \/\/ 合并处理中间件函数\nconst context = require(\x27.\/context\x27); \/\/ 整合处理context对象\nconst request = require(\x27.\/request\x27); \/\/ 整合处理request对象\nconst http = require(\x27http\x27); \/\/ node的 http原生模块\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 引入有很多 我只挑我阅读主要框架的代码模块\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e response = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/response\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 处理response对象\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compose = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-compose\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 合并处理中间件函数\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e context = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/context\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 整合处理context对象\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e request = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/request\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 整合处理request对象\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e http = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27http\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ node的 http原生模块\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e以上就是我们的主要依赖\x3c\/p\x3e\n\x3cp\x3e在\x3ccode\x3eApplication\x3c\/code\x3e的对象中，有\x3ccode\x3econstructor\x3c\/code\x3e函数，这个主要是\x3ccode\x3e初始化Application对象，生成context对象、request对象、response对象\x3c\/code\x3e，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22module.exports = class Application extends Emitter {\n  \/\/ 初始化 Application\n  constructor() {\n    super(); \/\/ 继承Emitter\n    this.middleware = []; \/\/ 初始化middleware为空数组\n    this.context = Object.create(context); \/\/ 生成context对象\n    this.request = Object.create(request); \/\/ 生成request对象\n    this.response = Object.create(response); \/\/ 生成response对象\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scala\x22\x3e\x3ccode\x3emodule.exports = \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eApplication\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eEmitter\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始化 Application\x3c\/span\x3e\n  constructor() {\n    \x3cspan class=\x22hljs-keyword\x22\x3esuper\x3c\/span\x3e(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 继承Emitter\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.middleware = []; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始化middleware为空数组\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.context = \x3cspan class=\x22hljs-type\x22\x3eObject\x3c\/span\x3e.create(context); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 生成context对象\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.request = \x3cspan class=\x22hljs-type\x22\x3eObject\x3c\/span\x3e.create(request); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 生成request对象\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.response = \x3cspan class=\x22hljs-type\x22\x3eObject\x3c\/span\x3e.create(response); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 生成response对象\x3c\/span\x3e\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e阅读源码，我们先不要去扣细节，比如说\x3ccode\x3eObject.create(context)\x3c\/code\x3e生产的对象是什么？\x3ccode\x3ethis.request\x3c\/code\x3e对象下面又有什么东西？？？，我们现在主要知道的是、\x3ccode\x3ethis.context\x3c\/code\x3e是能获取或者设置请求和响应的信息的一个对象，。\x3ccode\x3ethis.request\x3c\/code\x3e是请求的对象、里面可以设置或者获取请求信息的一个对象、\x3ccode\x3ethis.response\x3c\/code\x3e是响应请求对象、里面可以设置或者获取响应参数和值的一个对象。大概先了解就可以了。继续往下看。\x3c\/p\x3e\n\x3cp\x3e在上面运用的时候，用到了\x3ccode\x3eapp.use(fn)\x3c\/code\x3e和\x3ccode\x3eapp.listen(4002)\x3c\/code\x3e 我们看看，源码里面试这样子的\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\nmodule.exports = class Application extends Emitter {\n  \/\/ 初始化 Application\n  constructor() {\n    ...\n  }\n  listen(...args) {\n    const server = http.createServer(this.callback());\n    return server.listen(...args);\n  }\n  use(fn) {\n    this.middleware.push(fn);\n    return this;\n  }\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scala\x22\x3e\x3ccode\x3e\nmodule.exports = \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eApplication\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eEmitter\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始化 Application\x3c\/span\x3e\n  constructor() {\n    ...\n  }\n  listen(...args) {\n    const server = http.createServer(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.callback());\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e server.listen(...args);\n  }\n  use(fn) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.middleware.push(fn);\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n  }\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面的代码很简单 \x3ccode\x3euse\x3c\/code\x3e函数就是把传入的\x3ccode\x3efn\x3c\/code\x3e 推入到\x3ccode\x3ethis.middleware\x3c\/code\x3e的数组中，然后返回\x3ccode\x3ethis\x3c\/code\x3e，方便链式调用。\x3c\/p\x3e\n\x3cp\x3e然后在\x3ccode\x3elisten\x3c\/code\x3e里面用\x3ccode\x3enode\x3c\/code\x3e原生的\x3ccode\x3ehttp\x3c\/code\x3e模块创建一个\x3ccode\x3eserver\x3c\/code\x3e，在这里顺便说一下，原生 http创建一个服务是这样子滴\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const http = http.createServer((req, res) =\x3e {\n  res.writeHead(200, { \x27Content-Type\x27: \x27text\/plain\x27 });\n  res.end(\x27okay\x27);\n});\nhttp.listen(8000)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs arduino\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e http = http.createServer((req, res) =\x26gt; {\n  res.writeHead(\x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e, { \x3cspan class=\x22hljs-string\x22\x3e\x27Content-Type\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27text\/plain\x27\x3c\/span\x3e });\n  res.\x3cspan class=\x22hljs-built_in\x22\x3eend\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27okay\x27\x3c\/span\x3e);\n});\nhttp.\x3cspan class=\x22hljs-built_in\x22\x3elisten\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e8000\x3c\/span\x3e)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e继续看代码 ，在创建服务的时候，参数里面调用了一个\x3ccode\x3ethis.callback()\x3c\/code\x3e函数，下面我们看看这个函数究竟是怎么样子的。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\nmodule.exports = class Application extends Emitter {\n  \/\/ 初始化 Application\n  constructor() {\n    ...\n  }\n  listen(...args) {\n    ...\n  }\n  use(fn) {\n    ...\n  }\n\n  callback() {\n    const fn = compose(this.middleware); \/\/ 集中处理中间件数组\n    const handleRequest = (req, res) =\x3e {\n      const ctx = this.createContext(req, res); \/\/ 整合req、res、context、request、response\n      return this.handleRequest(ctx, fn); \/\/ 返回handleRequest\n    };\n    return handleRequest;\n  }\n    \n  handleRequest(ctx, fnMiddleware) {\n    const handleResponse = () =\x3e respond(ctx); \/\/ 最终响应函数\n    return fnMiddleware(ctx).then(handleResponse) \/\/ 处理完中间件，然后传到下一响应函数\n  }\n  \/\/ 创建整合新的 context.\n  createContext(req, res) {\n    const context = Object.create(this.context);\n    const request = context.request = Object.create(this.request);\n    const response = context.response = Object.create(this.response);\n    context.app = request.app = response.app = this;\n    context.req = request.req = response.req = req;\n    context.res = request.res = response.res = res;\n    request.ctx = response.ctx = context;\n    request.response = response;\n    response.request = request;\n    context.originalUrl = request.originalUrl = req.url;\n    context.cookies = new Cookies(req, res, {\n      keys: this.keys,\n      secure: request.secure\n    });\n    request.ip = request.ips[0] || req.socket.remoteAddress || \x27\x27;\n    context.accept = request.accept = accepts(req);\n    context.state = {};\n    return context;\n  }\n};\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs verilog\x22\x3e\x3ccode\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3emodule\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.exports\x3c\/span\x3e = \x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e Application \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e Emitter {\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始化 Application\x3c\/span\x3e\n  constructor() {\n    ...\n  }\n  listen(..\x3cspan class=\x22hljs-variable\x22\x3e.args\x3c\/span\x3e) {\n    ...\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e(fn) {\n    ...\n  }\n\n  callback() {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fn = compose(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.middleware\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 集中处理中间件数组\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e handleRequest = (req, res) =\x26gt; {\n      \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e ctx = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.createContext\x3c\/span\x3e(req, res); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 整合req、res、context、request、response\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.handleRequest\x3c\/span\x3e(ctx, fn); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回handleRequest\x3c\/span\x3e\n    };\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e handleRequest;\n  }\n    \n  handleRequest(ctx, fnMiddleware) {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e handleResponse = () =\x26gt; respond(ctx); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 最终响应函数\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e fnMiddleware(ctx)\x3cspan class=\x22hljs-variable\x22\x3e.then\x3c\/span\x3e(handleResponse) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 处理完中间件，然后传到下一响应函数\x3c\/span\x3e\n  }\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 创建整合新的 context.\x3c\/span\x3e\n  createContext(req, res) {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e = Object\x3cspan class=\x22hljs-variable\x22\x3e.create\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.context\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e request = \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.request\x3c\/span\x3e = Object\x3cspan class=\x22hljs-variable\x22\x3e.create\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.request\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e response = \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.response\x3c\/span\x3e = Object\x3cspan class=\x22hljs-variable\x22\x3e.create\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.response\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.app\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.app\x3c\/span\x3e = response\x3cspan class=\x22hljs-variable\x22\x3e.app\x3c\/span\x3e = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.req\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.req\x3c\/span\x3e = response\x3cspan class=\x22hljs-variable\x22\x3e.req\x3c\/span\x3e = req;\n    \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.res\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.res\x3c\/span\x3e = response\x3cspan class=\x22hljs-variable\x22\x3e.res\x3c\/span\x3e = res;\n    request\x3cspan class=\x22hljs-variable\x22\x3e.ctx\x3c\/span\x3e = response\x3cspan class=\x22hljs-variable\x22\x3e.ctx\x3c\/span\x3e = \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e;\n    request\x3cspan class=\x22hljs-variable\x22\x3e.response\x3c\/span\x3e = response;\n    response\x3cspan class=\x22hljs-variable\x22\x3e.request\x3c\/span\x3e = request;\n    \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.originalUrl\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.originalUrl\x3c\/span\x3e = req\x3cspan class=\x22hljs-variable\x22\x3e.url\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.cookies\x3c\/span\x3e = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Cookies(req, res, {\n      keys: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.keys\x3c\/span\x3e,\n      secure: request\x3cspan class=\x22hljs-variable\x22\x3e.secure\x3c\/span\x3e\n    });\n    request\x3cspan class=\x22hljs-variable\x22\x3e.ip\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.ips\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] || req\x3cspan class=\x22hljs-variable\x22\x3e.socket\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.remoteAddress\x3c\/span\x3e || \x27\x27;\n    \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.accept\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.accept\x3c\/span\x3e = accepts(req);\n    \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.state\x3c\/span\x3e = {};\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e;\n  }\n};\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面我们可以看出在\x3ccode\x3ecallback\x3c\/code\x3e函数里面有一个\x3ccode\x3econst fn = compose(this.middleware);\x3c\/code\x3e 这个函数就是把\x3ccode\x3ethis.middleware\x3c\/code\x3e数组传进去，然后集中处理中间件，然后会返回处理完中间件的fn。\x3c\/p\x3e\n\x3cp\x3e继续下一行\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const handleRequest = (req, res) =\x3e {\n  const ctx = this.createContext(req, res);\n  return this.handleRequest(ctx, fn);\n};\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e handleRequest = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e ctx = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.createContext(req, res);\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handleRequest(ctx, fn);\n};\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e继续进入到\x3ccode\x3ehandleRequest\x3c\/code\x3e函数里面的\x3ccode\x3econst ctx = this.createContext(req, res);\x3c\/code\x3e这个把原生的http的\x3ccode\x3e请求对象req\x3c\/code\x3e和\x3ccode\x3e响应对象res\x3c\/code\x3e作为参数传进去，然后在\x3ccode\x3ecreateContext\x3c\/code\x3e函数（看上面最大那坨代码）在里面，把\x3ccode\x3ethis.request\x3c\/code\x3e、\x3ccode\x3ethis.response\x3c\/code\x3e、\x3ccode\x3ethis.context\x3c\/code\x3e、\x3ccode\x3e请求对象req\x3c\/code\x3e、\x3ccode\x3e响应对象res\x3c\/code\x3e都整，做各种整合、处理得到新的\x3ccode\x3econtext\x3c\/code\x3e对象返回出去。\x3c\/p\x3e\n\x3cp\x3e也就是强大的\x3ccode\x3ectx\x3c\/code\x3e，得到\x3ccode\x3ectx\x3c\/code\x3e之后，下一行返回\x3ccode\x3ereturn this.handleRequest(ctx, fn);\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3ethis.handleRequest(ctx, fn)\x3c\/code\x3e代码如下\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\nhandleRequest(ctx, fnMiddleware) {\n    const handleResponse = () =\x3e respond(ctx);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs coffeescript\x22\x3e\x3ccode\x3e\nhandleRequest(ctx, fnMiddleware) {\n    const handleResponse = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e respond(ctx);\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e fnMiddleware(ctx).\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(handleResponse).\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(onerror);\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个函数 就是处理完中间件处理之后的返回的函数把\x3ccode\x3ectx\x3c\/code\x3e传下去，最后流通到\x3ccode\x3erespond(ctx);\x3c\/code\x3e这个函数，\x3c\/p\x3e\n\x3cp\x3e那么我们看看这个函数被我简化后是怎么样子的，如下\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 一些容错判断或者提示我全部删了\nfunction respond(ctx) {\n  const res = ctx.res;\n  let body = ctx.body;\n  res.end(body);\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs d\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 一些容错判断或者提示我全部删了\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3efunction\x3c\/span\x3e respond(ctx) {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e res = ctx.res;\n  let \x3cspan class=\x22hljs-keyword\x22\x3ebody\x3c\/span\x3e = ctx.\x3cspan class=\x22hljs-keyword\x22\x3ebody\x3c\/span\x3e;\n  res.end(\x3cspan class=\x22hljs-keyword\x22\x3ebody\x3c\/span\x3e);\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e通过\x3ccode\x3ectx\x3c\/code\x3e拿到响应对象，和响应值、通过\x3ccode\x3eend\x3c\/code\x3e方法会通知服务器，所有响应头和响应主体都已被发送，即服务器将其视为已完成。看上面原生的http的服务方法。\x3c\/p\x3e\n\x3cp\x3e最后附上一个流程图\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000014894692?w=2330\x26amp;h=1022\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000014894692?w=2330\x26amp;h=1022\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这个只是介绍\x3ccode\x3eapplication\x3c\/code\x3e整个流程，还有很多细节都没有一一介绍到，比如、创建\x3ccode\x3econtext\x3c\/code\x3e、\x3ccode\x3erequest\x3c\/code\x3e、\x3ccode\x3eresponse\x3c\/code\x3e对象是怎么样子的呀？中间件是如何集中层层深入处理然后返回的呀？等等这些细节都会在下一篇会讲到（最近公司业务非常忙，不知道到猴年马月）。\x3c\/p\x3e\n\x3cblockquote\x3e写的不好的地方，让大家贱笑了。\x3c\/blockquote\x3e\n\x3cp\x3e然后最后安利一波博客，喜欢的小哥哥小姐姐可以star 哟\x3c\/p\x3e\n\x3cp\x3ewebsit: \x3ca href=\x22https:\/\/github.com\/naihe138\/naice-blog\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/naihe138\/naice-blog\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>一步步去阅读koa源码，整体架构分析</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000014894684">https://segmentfault.com/a/1190000014894684</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/rwotjbpp45/" target="_blank">https://alili.tech/archive/rwotjbpp45/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>