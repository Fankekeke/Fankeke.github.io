<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="译文：JS事件循环机制（event loop）之宏任务、微任务"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>译文：JS事件循环机制（event loop）之宏任务、微任务 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/s6twl73qqce/",
				"appid": "1613049289050283", 
				"title": "译文：JS事件循环机制（event loop）之宏任务、微任务 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-11-29T09:34:56"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/s6wuxbip1mn/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/l5048bn11w/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f&text=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f&text=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f&title=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f&is_video=false&description=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f&title=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f&title=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f&title=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fs6twl73qqce%2f&title=%e8%af%91%e6%96%87%ef%bc%9aJS%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6%ef%bc%88event%20loop%ef%bc%89%e4%b9%8b%e5%ae%8f%e4%bb%bb%e5%8a%a1%e3%80%81%e5%be%ae%e4%bb%bb%e5%8a%a1"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">译文：JS事件循环机制（event loop）之宏任务、微任务</h1><div class="meta"><div class="postdate"><time datetime="2018-11-29" itemprop="datePublished">2018-11-29</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch1 id=\x22articleHeader0\x22\x3e译文：JS事件循环机制（event loop）之宏任务、微任务\x3c\/h1\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e原文标题：《Tasks, microtasks, queues and schedules》\x3c\/h3\x3e\n\x3cp\x3e\x3cem\x3e这是一篇谷歌大神文章，写得非常精彩。译者想借这次翻译深入学习一下，由于水平有限，英文好的同学建议直接阅读原文。\x3c\/em\x3e\x3cbr\x3e\x3ca href=\x22https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/?utm_source=html5weekly\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e原文地址：Tasks, microtasks, queues and schedules\x3c\/a\x3e\x3cbr\x3e下面正文开始：\x3c\/p\x3e\n\x3ch4\x3eTasks, microtasks, queues and schedules\x3c\/h4\x3e\n\x3cp\x3e首先看一段代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22console.log(\x27script start\x27);\n\nsetTimeout(function() {\n  console.log(\x27setTimeout\x27);\n}, 0);\n\nPromise.resolve().then(function() {\n  console.log(\x27promise1\x27);\n}).then(function() {\n  console.log(\x27promise2\x27);\n});\n\nconsole.log(\x27script end\x27);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scilab\x22\x3e\x3ccode\x3econsole.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27script start\x27\x3c\/span\x3e);\n\nsetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e {\x3c\/span\x3e\n  console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27setTimeout\x27\x3c\/span\x3e);\n}, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n\nPromise.resolve().\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e {\x3c\/span\x3e\n  console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27promise1\x27\x3c\/span\x3e);\n}).\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e {\x3c\/span\x3e\n  console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27promise2\x27\x3c\/span\x3e);\n});\n\nconsole.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27script end\x27\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e打印顺序是什么？\x3cbr\x3e正确答案是\x3cbr\x3escript start, script end, promise1, promise2, setTimeout\x3cbr\x3e但是在不同浏览器上的结果却是让人懵逼的。\x3c\/p\x3e\n\x3cp\x3eMicrosoft Edge, Firefox 40, iOS Safari 和 desktop Safari 8.0.8在promise1，promise2之前打印了setTimeout，--虽然看起来像竞态条件。\x3cbr\x3e但让人懵逼的是Firefox 39 ， Safari 8.0.7会打印出正确顺序。\x3cbr\x3e\x3cem\x3e译者注：译者的Microsoft Edge 38.14393.2068.0，Firefox 59.0.2 版本会打印出正确顺序，应该已经支持了吧，其他浏览器未验证。\x3c\/em\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e为什么会出现这样打印顺序呢？\x3c\/h3\x3e\n\x3cp\x3e要理解这些你首先需要对事件循环机制处理宏任务和微任务的方式有了解。\x3cbr\x3e如果是第一次接触信息量会有点大。深呼吸……\x3c\/p\x3e\n\x3cp\x3e每个线程都会有它自己的event loop(事件循环)，所以都能独立运行。然而所有同源窗口会共享一个event loop以同步通信。event loop会一直运行，来执行进入队列的宏任务。一个event loop有多种的宏任务源（译者注：event等等），这些宏任务源保证了在本任务源内的顺序。但是浏览器每次都会选择一个源中的一个宏任务去执行。这保证了浏览器给与一些宏任务（如用户输入）以更高的优先级。好的，跟着我继续……\x3c\/p\x3e\n\x3ch4\x3e宏任务（task）\x3c\/h4\x3e\n\x3cp\x3e浏览器为了能够使得JS内部task与DOM任务能够有序的执行，会在一个task执行结束后，在下一个 task 执行开始前，对页面进行重新渲染 （task-\x26gt;渲染-\x26gt;task-\x26gt;...）\x3cbr\x3e鼠标点击会触发一个事件回调，需要执行一个宏任务，然后解析HTMl。还有下面这个例子，setTimeout\x3c\/p\x3e\n\x3cp\x3esetTimeout的作用是等待给定的时间后为它的回调产生一个新的宏任务。这就是为什么打印‘setTimeout’在‘script end’之后。因为打印‘script end’是第一个宏任务里面的事情，而‘setTimeout’是另一个独立的任务里面打印的。\x3c\/p\x3e\n\x3ch4\x3e微任务（Microtasks ）\x3c\/h4\x3e\n\x3cp\x3e微任务通常来说就是需要在当前 task 执行结束后立即执行的任务，比如对一系列动作做出反馈，或或者是需要异步的执行任务而又不需要分配一个新的 task，这样便可以减小一点性能的开销。只要执行栈中没有其他的js代码正在执行且每个宏任务执行完，微任务队列会立即执行。如果在微任务执行期间微任务队列加入了新的微任务，会将新的微任务加入队列尾部，之后也会被执行。微任务包括了mutation observe的回调还有接下来的例子promise的回调。\x3c\/p\x3e\n\x3cp\x3e一旦一个pormise有了结果，或者早已有了结果（有了结果是指这个promise到了fulfilled或rejected状态），他就会为它的回调产生一个微任务，这就保证了回调异步的执行即使这个promise早已有了结果。所以对一个已经有了结果的promise调用.then(yey, nay)会立即产生一个微任务。这就是为什么‘promise1’,\x27promise2\x27会打印在‘script end’之后，因为所有微任务执行的时候，当前执行栈的代码必须已经执行完毕。‘promise1’,\x27promise2\x27会打印在‘setTimeout’之前是因为所有微任务总会在下一个宏任务之前全部执行完毕。\x3c\/p\x3e\n\x3cp\x3e逐步执行demo:\x3cem\x3e译者注，这里作者实现了一个类似于debug，逐步执行的demo，其中还加入了执行栈的动画还有讲解，建议大家去原文观看\x3c\/em\x3e\x3cbr\x3e\x3ca href=\x22https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/?utm_source=html5weekly\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e原文\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e是的，我弄了一个逐步的图标。你怎么度过你的周六？和你的朋友出去享受阳光？emmmm,如果对我惊艳的ui交互设计看不懂，点击左右箭头试试吧。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e那为什么那些浏览器打印顺序不一样咧？\x3c\/h3\x3e\n\x3cp\x3e有些浏览会会打印出：\x3cbr\x3escript start, script end, setTimeout, promise1, promise2。\x3cbr\x3e他们会在setTimeout之后执行promise的回调，就好像这些浏览器会把promise的回调视作一个新的宏任务而不是微任务。\x3c\/p\x3e\n\x3cp\x3e其实无可厚非，因为promises 来自于ECMAScript 的标准而不是HTML标准。\x3cbr\x3eECMAScript 有个关于jobs的概念和微任务挺类似的，但是否明确具有关联关系却尚未定论\x3ca href=\x22https:\/\/esdiscuss.org\/topic\/the-initialization-steps-for-web-browsers#content-16\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e（相关讨论）\x3c\/a\x3e。然而，普遍的观点是promise应该属于微任务。\x3c\/p\x3e\n\x3cp\x3e如果说把 promise 当做一个新的 task 来执行的话，这将会造成一些性能上的问题，因为 promise 的回调函数可能会被延迟执行，因为在每一个 task 执行结束后浏览器可能会进行一些渲染工作。由于作为一个 task 将会和其他任务来源（task source）相互影响，这也会造成一些不确定性，同时这也将打破一些与其他 API 的交互，这样一来便会造成一系列的问题。\x3c\/p\x3e\n\x3cp\x3e这里有一个关于让Edge把promise加入微任务的提议，其实WebKit 早已悄悄正确实现。所以我猜Safari最终会修复，Firefox 43好像已修复。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e如何分辨宏任务和微任务？\x3c\/h3\x3e\n\x3cp\x3e实际测试是一种方法，观察日志打印顺序与promise和setTimeout的关系，但是首先浏览器对这两者的实现要正确。\x3cbr\x3e还有一个稳妥方法就是看文档，比如\x3ca href=\x22https:\/\/html.spec.whatwg.org\/multipage\/webappapis.html#timer-initialisation-steps\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3esetTimeout\x3c\/a\x3e是宏任务，\x3ca href=\x22https:\/\/dom.spec.whatwg.org\/#queue-a-mutation-record\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3emutation\x3c\/a\x3e是微任务。\x3cbr\x3e正如上文提到的，ECMAScript 中把微任务叫做jobs，\x3ca href=\x22http:\/\/www.ecma-international.org\/ecma-262\/6.0\/#sec-performpromisethen\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eEnqueueJob\x3c\/a\x3e\x3cbr\x3e是微任务。\x3cbr\x3e接下来，让我们看一些复杂的例子吧\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e一级boss战\x3c\/h3\x3e\n\x3cp\x3e写这篇文章前我就犯了这个错。来看代码\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cdiv class=\x26quot;outer\x26quot;\x3e\n  \x3cdiv class=\x26quot;inner\x26quot;\x3e\x3c\/div\x3e\n\x3c\/div\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs applescript\x22\x3e\x3ccode\x3e\x26lt;\x3cspan class=\x22hljs-keyword\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22outer\x22\x3c\/span\x3e\x26gt;\n  \x26lt;\x3cspan class=\x22hljs-keyword\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22inner\x22\x3c\/span\x3e\x26gt;\x26lt;\/\x3cspan class=\x22hljs-keyword\x22\x3ediv\x3c\/span\x3e\x26gt;\n\x26lt;\/\x3cspan class=\x22hljs-keyword\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在看接下来的js代码，如果我点击div.inner会打印什么？\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ Let\x27s get hold of those elements\nvar outer = document.querySelector(\x27.outer\x27);\nvar inner = document.querySelector(\x27.inner\x27);\n\n\/\/ Let\x27s listen for attribute changes on the\n\/\/ outer element\n\/\/监听element属性变化\nnew MutationObserver(function() {\n  console.log(\x27mutate\x27);\n}).observe(outer, {\n  attributes: true\n});\n\n\/\/ Here\x27s a click listener…\nfunction onClick() {\n  console.log(\x27click\x27);\n\n  setTimeout(function() {\n    console.log(\x27timeout\x27);\n  }, 0);\n\n  Promise.resolve().then(function() {\n    console.log(\x27promise\x27);\n  });\n\n  outer.setAttribute(\x27data-random\x27, Math.random());\n}\n\n\/\/ …which we\x27ll attach to both elements\ninner.addEventListener(\x27click\x27, onClick);\nouter.addEventListener(\x27click\x27, onClick);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Let\x27s get hold of those elements\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e outer = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.querySelector(\x3cspan class=\x22hljs-string\x22\x3e\x27.outer\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e inner = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.querySelector(\x3cspan class=\x22hljs-string\x22\x3e\x27.inner\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Let\x27s listen for attribute changes on the\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ outer element\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/监听element属性变化\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e MutationObserver(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27mutate\x27\x3c\/span\x3e);\n}).observe(outer, {\n  \x3cspan class=\x22hljs-attr\x22\x3eattributes\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n});\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Here\x27s a click listener…\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonClick\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e);\n\n  setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27timeout\x27\x3c\/span\x3e);\n  }, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n\n  \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve().then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27promise\x27\x3c\/span\x3e);\n  });\n\n  outer.setAttribute(\x3cspan class=\x22hljs-string\x22\x3e\x27data-random\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.random());\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ …which we\x27ll attach to both elements\x3c\/span\x3e\ninner.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, onClick);\nouter.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, onClick);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e偷看答案前先试一试啊，tips:日志可能出现多次哦。\x3cbr\x3e结果如下：\x3cbr\x3eclick\x3cbr\x3epromise\x3cbr\x3emutate\x3cbr\x3eclick\x3cbr\x3epromise\x3cbr\x3emutate\x3cbr\x3etimeout\x3cbr\x3etimeout\x3cbr\x3e你猜对了吗。你可能猜对了，但是许多浏览器却不这样觉得。\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbaQYd?w=610\x26amp;h=340\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbaQYd?w=610\x26amp;h=340\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cem\x3e译者注：译者本机测试\x3c\/em\x3e\x3cbr\x3eChrome( 64.0.3282.167（正式版本） （64 位）)相同，\x3cbr\x3eEdge(Edge 38.14393.2068.0)不同（与Chrome顺序相同）\x3cbr\x3eFirefox 32位 59.0.2\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3eclick\x3c\/li\x3e\n\x3cli\x3emutate\x3c\/li\x3e\n\x3cli\x3eclick\x3c\/li\x3e\n\x3cli\x3emutate\x3c\/li\x3e\n\x3cli\x3epromise\x3c\/li\x3e\n\x3cli\x3epromise\x3c\/li\x3e\n\x3cli\x3etimeout\x3c\/li\x3e\n\x3cli\x3etimeout\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e哪个是对的？\x3c\/h3\x3e\n\x3cp\x3e分发click event是一个宏任务，Mutation observer和promise都会进入微任务队列，setTimeout回调是一个宏任务，所以来看demo\x3cbr\x3e\x3cem\x3e作者演示demo，建议原文观看\x3c\/em\x3e\x3ca href=\x22https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/?utm_source=html5weekly\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3edemo\x3c\/a\x3e\x3cbr\x3e所以chrome是对的，我之前也不知道只要执行栈中没有js代码在执行，微任务会在回调后立即执行，我之前认为它只会在宏任务结束后执行（Although we are mid-task,microtasks are processed after callbacks if the stack is empty）.这个规则来自于HTML标准中关于回调调用的部分\x3c\/p\x3e\n\x3cblockquote\x3eIf the stack of script settings objects is now empty, perform a microtask checkpoint\x3cbr\x3e— HTML: Cleaning up after a callback step 3\x3c\/blockquote\x3e\n\x3cp\x3e如果\x3ca href=\x22https:\/\/html.spec.whatwg.org\/multipage\/webappapis.html#stack-of-script-settings-objects\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ejs执行栈\x3c\/a\x3e空了,立即执行\x3ca href=\x22https:\/\/html.spec.whatwg.org\/multipage\/webappapis.html#perform-a-microtask-checkpoint\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3emicrotask checkpoint \x3c\/a\x3e\x3cbr\x3e—— \x3ca href=\x22https:\/\/html.spec.whatwg.org\/multipage\/webappapis.html#clean-up-after-running-a-callback\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eHTML: Cleaning up after a callback\x3c\/a\x3e\x3cbr\x3emicrotask checkpoint 会检查整个微任务队列，除非正在执行这个检查动作。ECMAScript 标准中说到\x3c\/p\x3e\n\x3cblockquote\x3eExecution of a Job can be initiated only when there is no running execution context and the execution context stack is empty…\x3cbr\x3e— ECMAScript: Jobs and Job Queues\x3c\/blockquote\x3e\n\x3cp\x3eHTML环境下，必须执行。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3e浏览器哪里出错了？\x3c\/h3\x3e\n\x3cp\x3eFirefox和Safari在click监听器回调之间正确执行了mutation 回调的微任务，但promise打印结果却出现在了错误的位置。\x3cbr\x3e无可厚非的是jobs和微任务的关系太含糊不清，不过我仍认为应该在click监听器回调之间执行。\x3cbr\x3eEdge我们早就知道会把promise回调放进错误的队列，但他也也没在click监听器回调之间执行微任务队列，而是在所有监听器回调后执行，这打印click之后只打印了一次muteta，为此我给它提了个bug。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e一级boss愤怒的大哥来了\x3c\/h3\x3e\n\x3cp\x3e用刚才的代码，如果我们这样执行会发生什么。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22inner.click();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs abnf\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3einner.click()\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这依旧会开始分发事件，但这次是使用脚本而不是交互点击。\x3cbr\x3eclick\x3cbr\x3eclick\x3cbr\x3epromise\x3cbr\x3emutate\x3cbr\x3epromise\x3cbr\x3etimeout\x3cbr\x3etimeout\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVbaQYt?w=670\x26amp;h=320\x22 src=\x22https:\/\/static.alili.tech\/img\/bVbaQYt?w=670\x26amp;h=320\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e我发誓我从chrome得到的答案一直不一样- -。我已经更新了这个表许许多次了。我觉得我是错误地测试了Canary。假如你在 Chrome 中得到了不同的结果，请在评论中告诉我是哪个版本。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e为什么不一样呢？\x3c\/h3\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/?utm_source=html5weekly\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e来看demo发生了什么,原作者的演示demo\x3c\/a\x3e\x3cbr\x3e所以正确的顺序是click, click, promise, mutate, promise, timeout, timeout,看来chrome是对的。\x3cbr\x3e在每个监听器回调调用之后\x3c\/p\x3e\n\x3cblockquote\x3eIf the stack of script settings objects is now empty, perform a microtask checkpoint\x3cbr\x3e— HTML: Cleaning up after a callback step 3\x3c\/blockquote\x3e\n\x3cp\x3e之前的例子，微任务会在监听器回调之间执行。但这里的例子，click()会导致事件同步分发，所以在监听器回调之间Js执行栈不为空，而上述的这个规则保证了微任务不会打断正在执行的js.这意味着我们不能在监听器回调之间执行微任务，微任务会在监听器之后执行。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader10\x22\x3e这能影响到什么？\x3c\/h3\x3e\n\x3cp\x3e\x3cem\x3e译者注：对IndexedDB 理解不深入，这段就不翻译了- -\x3c\/em\x3e\x3cbr\x3eYeah, it\x27ll bite you in obscure places (ouch). I encountered this while trying to create a simple wrapper library for IndexedDB that uses promises rather than weird IDBRequest objects. It almost makes IDB fun to use.\x3c\/p\x3e\n\x3cp\x3eWhen IDB fires a success event, the related transaction object becomes inactive after dispatching (step 4). If I create a promise that resolves when this event fires, the callbacks should run before step 4 while the transaction is still active, but that doesn\x27t happen in browsers other than Chrome, rendering the library kinda useless.\x3c\/p\x3e\n\x3cp\x3eYou can actually work around this problem in Firefox, because promise polyfills such as es6-promise use mutation observers for callbacks, which correctly use microtasks. Safari seems to suffer from race conditions with that fix, but that could just be their broken implementation of IDB. Unfortunately, things consistently fail in IE\/Edge, as mutation events aren\x27t handled after callbacks.\x3c\/p\x3e\n\x3cp\x3eHopefully we\x27ll start to see some interoperability here soon.\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader11\x22\x3e干得不错！\x3c\/h3\x3e\n\x3cp\x3e总结一下：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e宏任务按顺序执行，且浏览器在每个宏任务之间渲染页面\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e所有微任务也按顺序执行，且在以下场景会立即执行所有微任务\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e每个回调之后且js执行栈中为空。\x3c\/li\x3e\n\x3cli\x3e每个宏任务结束后。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e希望你已经熟悉了eventloop.\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>译文：JS事件循环机制（event loop）之宏任务、微任务</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000014940904">https://segmentfault.com/a/1190000014940904</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/s6twl73qqce/" target="_blank">https://alili.tech/archive/s6twl73qqce/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>