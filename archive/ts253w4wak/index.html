<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="由setTimeout和setImmediate执行顺序的随机性窥探Node的事件循环机制"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>由setTimeout和setImmediate执行顺序的随机性窥探Node的事件循环机制 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/ts253w4wak/",
				"appid": "1613049289050283", 
				"title": "由setTimeout和setImmediate执行顺序的随机性窥探Node的事件循环机制 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-15T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/3fayzkah3wh/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/bel95p0kmfi/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f&text=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f&text=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f&title=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f&is_video=false&description=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f&title=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f&title=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f&title=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fts253w4wak%2f&title=%e7%94%b1setTimeout%e5%92%8csetImmediate%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e7%9a%84%e9%9a%8f%e6%9c%ba%e6%80%a7%e7%aa%a5%e6%8e%a2Node%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e6%9c%ba%e5%88%b6"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">由setTimeout和setImmediate执行顺序的随机性窥探Node的事件循环机制</h1><div class="meta"><div class="postdate"><time datetime="2018-12-15" itemprop="datePublished">2018-12-15</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e问题引入\x3c\/h2\x3e\n\x3cp\x3e接触过事件循环的同学大都会纠结一个点，就是在Node中\x3ccode\x3esetTimeout\x3c\/code\x3e和\x3ccode\x3esetImmediate\x3c\/code\x3e执行顺序的随机性。\x3c\/p\x3e\n\x3cp\x3e比如说下面这段代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22setTimeout(() =\x3e {\n    console.log(\x27setTimeout\x27);\n}, 0);\nsetImmediate(() =\x3e {\n    console.log(\x27setImmediate\x27);\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3esetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27setTimeout\x27\x3c\/span\x3e);\n}, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\nsetImmediate(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27setImmediate\x27\x3c\/span\x3e);\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e执行的结果是这样子的：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013102061?w=521\x26amp;h=287\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013102061?w=521\x26amp;h=287\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e为什么会出现这种情况呢？别急，我们先往下看。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e浏览器中事件循环模型\x3c\/h2\x3e\n\x3cp\x3e我们都知道，JavaScript是单线程的语言，对\x3ccode\x3eI\/O\x3c\/code\x3e的控制是通过异步来实现的，具体是通过“事件循环”机制来实现。\x3c\/p\x3e\n\x3cp\x3e对于JavaScript中的单线程，指的是JavaScript执行在单线程中，而内部\x3ccode\x3eI\/O\x3c\/code\x3e任务其实是另有线程池来完成的。\x3c\/p\x3e\n\x3cp\x3e在浏览器中，我们讨论事件循环，是以“从宏任务队列中取一个任务执行，再取出微任务队列中的所有任务”来分析执行代码的。但是在Node环境中并不适用。具体的浏览器事件循环解析：\x3ca href=\x22http:\/\/www.yangzicong.com\/article\/3\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e传送门\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e在Node中，事件循环的模型和浏览器相比大致相同，而最大的不同点在于Node中事件循环分不同的阶段。具体我们下面会讨论到。本文核心也在这里。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3eNode中事件循环阶段解析\x3c\/h2\x3e\n\x3cp\x3e下面是事件循环不同阶段的示意图：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013681765?w=804\x26amp;h=388\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013681765?w=804\x26amp;h=388\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e每个阶段都有一个先进先出的回调队列要执行。而每个阶段都有自己的特殊之处。简单来说，就是当事件循环进入某个阶段后，会执行该阶段特定的任意操作，然后才会执行这个阶段里的回调。当队列被执行完，或者执行的回调数量达到上限后，事件循环才会进入下一个阶段。\x3c\/p\x3e\n\x3cp\x3e以下是各个阶段详情。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3etimers\x3c\/h3\x3e\n\x3cp\x3e一个\x3ccode\x3etimer\x3c\/code\x3e指定一个下限时间而不是准确时间，在达到这个下限时间后执行回调。在指定的时间过后，\x3ccode\x3etimers\x3c\/code\x3e会尽早的执行回调，但是系统调度或者其他回调的执行可能会延迟它们。\x3c\/p\x3e\n\x3cblockquote\x3e从技术上来说，\x3ccode\x3epoll\x3c\/code\x3e阶段控制\x3ccode\x3etimers\x3c\/code\x3e什么时候执行，而执行的具体位置在\x3ccode\x3etimers\x3c\/code\x3e。\x3c\/blockquote\x3e\n\x3cp\x3e下限的时间有一个范围：\x3ccode\x3e[1, 2147483647]\x3c\/code\x3e，如果设定的时间不在这个范围，将被设置为1。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3eI\/O callbacks\x3c\/h3\x3e\n\x3cp\x3e这个阶段执行一些系统操作的回调，比如说TCP连接发生错误。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3eidle, prepare\x3c\/h3\x3e\n\x3cp\x3e系统内部的一些调用。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3epoll\x3c\/h3\x3e\n\x3cp\x3e这是最复杂的一个阶段。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3epoll\x3c\/code\x3e阶段有两个主要的功能：一是执行下限时间已经达到的\x3ccode\x3etimers\x3c\/code\x3e的回调，一是处理\x3ccode\x3epoll\x3c\/code\x3e队列里的\x3cstrong\x3e事件\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e注：Node很多API都是基于事件订阅完成的，这些API的回调应该都在\x3ccode\x3epoll\x3c\/code\x3e阶段完成。\x3c\/p\x3e\n\x3cp\x3e以下是Node官网的介绍：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013102062?w=998\x26amp;h=628\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013102062?w=998\x26amp;h=628\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e笔者把官网陈述的情况以不同的条件分解，更加的清楚。（如果有误，师请改正。）\x3c\/p\x3e\n\x3cp\x3e当事件循环进入\x3ccode\x3epoll\x3c\/code\x3e阶段：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3ccode\x3epoll\x3c\/code\x3e队列不为空的时候，事件循环肯定是先遍历队列并同步执行回调，直到队列清空或执行回调数达到系统上限。\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e\x3ccode\x3epoll\x3c\/code\x3e队列为空的时候，这里有两种情况。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e如果代码已经被\x3ccode\x3esetImmediate()\x3c\/code\x3e设定了回调，那么事件循环直接结束\x3ccode\x3epoll\x3c\/code\x3e阶段进入\x3ccode\x3echeck\x3c\/code\x3e阶段来执行\x3ccode\x3echeck\x3c\/code\x3e队列里的回调。\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e如果代码没有被设定\x3ccode\x3esetImmediate()\x3c\/code\x3e设定回调：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e如果有被设定的\x3ccode\x3etimers\x3c\/code\x3e，那么此时事件循环会检查\x3ccode\x3etimers\x3c\/code\x3e，如果有一个或多个\x3ccode\x3etimers\x3c\/code\x3e下限时间已经到达，那么事件循环将绕回\x3ccode\x3etimers\x3c\/code\x3e阶段，并执行\x3ccode\x3etimers\x3c\/code\x3e的有效回调队列。\x3c\/li\x3e\n\x3cli\x3e如果没有被设定\x3ccode\x3etimers\x3c\/code\x3e，这个时候事件循环是阻塞在\x3ccode\x3epoll\x3c\/code\x3e阶段等待回调被加入\x3ccode\x3epoll\x3c\/code\x3e队列。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3echeck\x3c\/h3\x3e\n\x3cp\x3e这个阶段允许在\x3ccode\x3epoll\x3c\/code\x3e阶段结束后立即执行回调。如果\x3ccode\x3epoll\x3c\/code\x3e阶段空闲，并且有被\x3ccode\x3esetImmediate()\x3c\/code\x3e设定的回调，那么事件循环直接跳到\x3ccode\x3echeck\x3c\/code\x3e执行而不是阻塞在\x3ccode\x3epoll\x3c\/code\x3e阶段等待回调被加入。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3esetImmediate()\x3c\/code\x3e实际上是一个特殊的\x3ccode\x3etimer\x3c\/code\x3e，跑在事件循环中的一个独立的阶段。它使用\x3ccode\x3elibuv\x3c\/code\x3e的\x3ccode\x3eAPI\x3c\/code\x3e来设定在\x3ccode\x3epoll\x3c\/code\x3e阶段结束后立即执行回调。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e注：\x3ccode\x3esetImmediate()\x3c\/code\x3e具有最高优先级，只要\x3ccode\x3epoll\x3c\/code\x3e队列为空，代码被\x3ccode\x3esetImmediate()\x3c\/code\x3e，无论是否有\x3ccode\x3etimers\x3c\/code\x3e达到下限时间，\x3ccode\x3esetImmediate()\x3c\/code\x3e的代码都先执行。\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3eclose callbacks\x3c\/h3\x3e\n\x3cp\x3e如果一个\x3ccode\x3esocket\x3c\/code\x3e或\x3ccode\x3ehandle\x3c\/code\x3e被突然关掉（比如\x3ccode\x3esocket.destroy()\x3c\/code\x3e），\x3ccode\x3eclose\x3c\/code\x3e事件将在这个阶段被触发，否则将通过\x3ccode\x3eprocess.nextTick()\x3c\/code\x3e触发。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader9\x22\x3e关于setTimeout和setImmediate\x3c\/h2\x3e\n\x3cp\x3e代码重现，我们会发现\x3ccode\x3esetTimeout\x3c\/code\x3e和\x3ccode\x3esetImmediate\x3c\/code\x3e在Node环境下执行是靠“随缘法则”的。\x3c\/p\x3e\n\x3cp\x3e比如说下面这段代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22setTimeout(() =\x3e {\n    console.log(\x27setTimeout\x27);\n}, 0);\nsetImmediate(() =\x3e {\n    console.log(\x27setImmediate\x27);\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3esetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27setTimeout\x27\x3c\/span\x3e);\n}, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\nsetImmediate(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27setImmediate\x27\x3c\/span\x3e);\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e执行的结果是这样子的：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013102061?w=521\x26amp;h=287\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013102061?w=521\x26amp;h=287\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e为什么会这样子呢？\x3c\/p\x3e\n\x3cp\x3e这里我们要根据前面的那个事件循环不同阶段的图解来说明一下：\x3c\/p\x3e\n\x3cp\x3e首先进入的是\x3ccode\x3etimers\x3c\/code\x3e阶段，如果我们的机器性能一般，那么进入\x3ccode\x3etimers\x3c\/code\x3e阶段，一毫秒已经过去了（\x3ccode\x3esetTimeout(fn, 0)\x3c\/code\x3e等价于\x3ccode\x3esetTimeout(fn, 1)\x3c\/code\x3e），那么\x3ccode\x3esetTimeout\x3c\/code\x3e的回调会首先执行。\x3c\/p\x3e\n\x3cp\x3e如果没有到一毫秒，那么在\x3ccode\x3etimers\x3c\/code\x3e阶段的时候，下限时间没到，\x3ccode\x3esetTimeout\x3c\/code\x3e回调不执行，事件循环来到了\x3ccode\x3epoll\x3c\/code\x3e阶段，这个时候队列为空，此时有代码被\x3ccode\x3esetImmediate()\x3c\/code\x3e，于是先执行了\x3ccode\x3esetImmediate()\x3c\/code\x3e的回调函数，之后在下一个事件循环再执行\x3ccode\x3esetTimemout\x3c\/code\x3e的回调函数。\x3c\/p\x3e\n\x3cp\x3e而我们在执行代码的时候，进入\x3ccode\x3etimers\x3c\/code\x3e的时间延迟其实是随机的，并不是确定的，所以会出现两个函数执行顺序随机的情况。\x3c\/p\x3e\n\x3cp\x3e那我们再来看一段代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var fs = require(\x27fs\x27)\n\nfs.readFile(__filename, () =\x3e {\n    setTimeout(() =\x3e {\n        console.log(\x27timeout\x27);\n    }, 0);\n    setImmediate(() =\x3e {\n        console.log(\x27immediate\x27);\n    });\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fs = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fs\x27\x3c\/span\x3e)\n\nfs.readFile(__filename, () =\x26gt; {\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27timeout\x27\x3c\/span\x3e);\n    }, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n    setImmediate(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27immediate\x27\x3c\/span\x3e);\n    });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里我们就会发现，\x3ccode\x3esetImmediate\x3c\/code\x3e永远先于\x3ccode\x3esetTimeout\x3c\/code\x3e执行。\x3c\/p\x3e\n\x3cp\x3e原因如下：\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3efs.readFile\x3c\/code\x3e的回调是在\x3ccode\x3epoll\x3c\/code\x3e阶段执行的，当其回调执行完毕之后，\x3ccode\x3epoll\x3c\/code\x3e队列为空，而\x3ccode\x3esetTimeout\x3c\/code\x3e入了\x3ccode\x3etimers\x3c\/code\x3e的队列，此时有代码被\x3ccode\x3esetImmediate()\x3c\/code\x3e，于是事件循环先进入\x3ccode\x3echeck\x3c\/code\x3e阶段执行回调，之后在下一个事件循环再在\x3ccode\x3etimers\x3c\/code\x3e阶段中执行有效回调。\x3c\/p\x3e\n\x3cp\x3e同样的，这段代码也是一样的道理：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22setTimeout(() =\x3e {\n    setImmediate(() =\x3e {\n        console.log(\x27setImmediate\x27);\n    });\n    setTimeout(() =\x3e {\n        console.log(\x27setTimeout\x27);\n    }, 0);\n}, 0);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3esetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    setImmediate(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27setImmediate\x27\x3c\/span\x3e);\n    });\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27setTimeout\x27\x3c\/span\x3e);\n    }, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n}, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e以上的代码在\x3ccode\x3etimers\x3c\/code\x3e阶段执行外部的\x3ccode\x3esetTimeout\x3c\/code\x3e回调后，内层的\x3ccode\x3esetTimeout\x3c\/code\x3e和\x3ccode\x3esetImmediate\x3c\/code\x3e入队，之后事件循环继续往后面的阶段走，走到\x3ccode\x3epoll\x3c\/code\x3e阶段的时候发现队列为空，此时有代码被\x3ccode\x3esetImmedate()\x3c\/code\x3e，所以直接进入\x3ccode\x3echeck\x3c\/code\x3e阶段执行响应回调（注意这里没有去检测\x3ccode\x3etimers\x3c\/code\x3e队列中是否有成员到达下限事件，因为\x3ccode\x3esetImmediate()\x3c\/code\x3e优先）。之后在第二个事件循环的\x3ccode\x3etimers\x3c\/code\x3e阶段中再去执行相应的回调。\x3c\/p\x3e\n\x3cp\x3e综上，我们可以总结：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e如果两者都在主模块中调用，那么执行先后取决于进程性能，也就是随机。\x3c\/li\x3e\n\x3cli\x3e如果两者都不在主模块调用（被一个异步操作包裹），那么\x3ccode\x3esetImmediate\x3c\/code\x3e的回调永远先执行。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader10\x22\x3eprocess.nextTick() and Promise\x3c\/h3\x3e\n\x3cp\x3e对于这两个，我们可以把它们理解成一个微任务。也就是说，它其实不属于事件循环的一部分。\x3c\/p\x3e\n\x3cp\x3e那么他们是在什么时候执行呢？\x3c\/p\x3e\n\x3cp\x3e不管在什么地方调用，他们都会在其所处的事件循环最后，事件循环进入下一个循环的阶段前执行。\x3c\/p\x3e\n\x3cp\x3e举个?：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22setTimeout(() =\x3e {\n    console.log(\x27timeout0\x27);\n    process.nextTick(() =\x3e {\n        console.log(\x27nextTick1\x27);\n        process.nextTick(() =\x3e {\n            console.log(\x27nextTick2\x27);\n        });\n    });\n    process.nextTick(() =\x3e {\n        console.log(\x27nextTick3\x27);\n    });\n    console.log(\x27sync\x27);\n    setTimeout(() =\x3e {\n        console.log(\x27timeout2\x27);\n    }, 0);\n}, 0);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3esetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27timeout0\x27\x3c\/span\x3e);\n    process.nextTick(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27nextTick1\x27\x3c\/span\x3e);\n        process.nextTick(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27nextTick2\x27\x3c\/span\x3e);\n        });\n    });\n    process.nextTick(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27nextTick3\x27\x3c\/span\x3e);\n    });\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27sync\x27\x3c\/span\x3e);\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27timeout2\x27\x3c\/span\x3e);\n    }, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n}, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e结果是：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000013102063?w=462\x26amp;h=261\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000013102063?w=462\x26amp;h=261\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e再解释一下：\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3etimers\x3c\/code\x3e阶段执行外层\x3ccode\x3esetTimeout\x3c\/code\x3e的回调，遇到同步代码先执行，也就有\x3ccode\x3etimeout0\x3c\/code\x3e、\x3ccode\x3esync\x3c\/code\x3e的输出。遇到\x3ccode\x3eprocess.nextTick\x3c\/code\x3e后入微任务队列，依次\x3ccode\x3enextTick1\x3c\/code\x3e、\x3ccode\x3enextTick3\x3c\/code\x3e、\x3ccode\x3enextTick2\x3c\/code\x3e入队后出队输出。之后，在下一个事件循环的\x3ccode\x3etimers\x3c\/code\x3e阶段，执行\x3ccode\x3esetTimeout\x3c\/code\x3e回调输出\x3ccode\x3etimeout2\x3c\/code\x3e。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader11\x22\x3e最后\x3c\/h3\x3e\n\x3cp\x3e下面给出两段代码，如果能够理解其执行顺序说明你已经理解透彻。\x3c\/p\x3e\n\x3cp\x3e代码1：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22setImmediate(function(){\n  console.log(\x26quot;setImmediate\x26quot;);\n  setImmediate(function(){\n    console.log(\x26quot;嵌套setImmediate\x26quot;);\n  });\n  process.nextTick(function(){\n    console.log(\x26quot;nextTick\x26quot;);\n  })\n});\n\n\/\/ setImmediate\n\/\/ nextTick\n\/\/ 嵌套setImmediate\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3esetImmediate(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22setImmediate\x22\x3c\/span\x3e);\n  setImmediate(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22嵌套setImmediate\x22\x3c\/span\x3e);\n  });\n  process.nextTick(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22nextTick\x22\x3c\/span\x3e);\n  })\n});\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ setImmediate\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ nextTick\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 嵌套setImmediate\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e解析：事件循环\x3ccode\x3echeck\x3c\/code\x3e阶段执行回调函数输出\x3ccode\x3esetImmediate\x3c\/code\x3e，之后输出\x3ccode\x3enextTick\x3c\/code\x3e。嵌套的\x3ccode\x3esetImmediate\x3c\/code\x3e在下一个事件循环的\x3ccode\x3echeck\x3c\/code\x3e阶段执行回调输出嵌套的\x3ccode\x3esetImmediate\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e代码2：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var fs = require(\x27fs\x27);\n\nfunction someAsyncOperation (callback) {\n  \/\/ 假设这个任务要消耗 95ms\n  fs.readFile(\x27\/path\/to\/file\x27, callback);\n}\n\nvar timeoutScheduled = Date.now();\n\nsetTimeout(function () {\n\n  var delay = Date.now() - timeoutScheduled;\n\n  console.log(delay \x2b \x26quot;ms have passed since I was scheduled\x26quot;);\n}, 100);\n\n\n\/\/ someAsyncOperation要消耗 95 ms 才能完成\nsomeAsyncOperation(function () {\n\n  var startCallback = Date.now();\n\n  \/\/ 消耗 10ms...\n  while (Date.now() - startCallback \x3c 10) {\n    ; \/\/ do nothing\n  }\n\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fs = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fs\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esomeAsyncOperation\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3ecallback\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 假设这个任务要消耗 95ms\x3c\/span\x3e\n  fs.readFile(\x3cspan class=\x22hljs-string\x22\x3e\x27\/path\/to\/file\x27\x3c\/span\x3e, callback);\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e timeoutScheduled = \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now();\n\nsetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e delay = \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now() - timeoutScheduled;\n\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(delay \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22ms have passed since I was scheduled\x22\x3c\/span\x3e);\n}, \x3cspan class=\x22hljs-number\x22\x3e100\x3c\/span\x3e);\n\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ someAsyncOperation要消耗 95 ms 才能完成\x3c\/span\x3e\nsomeAsyncOperation(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e startCallback = \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now();\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 消耗 10ms...\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (\x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now() - startCallback \x26lt; \x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e) {\n    ; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ do nothing\x3c\/span\x3e\n  }\n\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e解析：事件循环进入\x3ccode\x3epoll\x3c\/code\x3e阶段发现队列为空，并且没有代码被\x3ccode\x3esetImmediate()\x3c\/code\x3e。于是在\x3ccode\x3epoll\x3c\/code\x3e阶段等待\x3ccode\x3etimers\x3c\/code\x3e下限时间到达。当等到\x3ccode\x3e95ms\x3c\/code\x3e时，\x3ccode\x3efs.readFile\x3c\/code\x3e首先执行了，它的回调被添加进\x3ccode\x3epoll\x3c\/code\x3e队列并同步执行，耗时\x3ccode\x3e10ms\x3c\/code\x3e。此时总共时间累积\x3ccode\x3e105ms\x3c\/code\x3e。等到\x3ccode\x3epoll\x3c\/code\x3e队列为空的时候，事件循环会查看最近到达的\x3ccode\x3etimer\x3c\/code\x3e的下限时间，发现已经到达，再回到\x3ccode\x3etimers\x3c\/code\x3e阶段，执行\x3ccode\x3etimer\x3c\/code\x3e的回调。\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3e如果有什么问题，欢迎留言交流探讨。\x3c\/p\x3e\n\x3cp\x3e参考链接：\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/nodejs.org\/en\/docs\/guides\/event-loop-timers-and-nexttick\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/nodejs.org\/en\/docs\/gu...\x3c\/a\x3e  \x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/creeperyang\/blog\/issues\/26\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/creeperyan...\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>由setTimeout和setImmediate执行顺序的随机性窥探Node的事件循环机制</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000013102056">https://segmentfault.com/a/1190000013102056</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/ts253w4wak/" target="_blank">https://alili.tech/archive/ts253w4wak/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>