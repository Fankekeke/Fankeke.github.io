<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="提高代码质量——使用Jest和Sinon给已有的代码添加单元测试"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>提高代码质量——使用Jest和Sinon给已有的代码添加单元测试 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/vnnhg4z0lab/",
				"appid": "1613049289050283", 
				"title": "提高代码质量——使用Jest和Sinon给已有的代码添加单元测试 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-12-04T02:30:05"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/ial5xhhsyhn/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/q83fj2l9t8/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f&text=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f&text=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f&title=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f&is_video=false&description=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f&title=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f&title=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f&title=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fvnnhg4z0lab%2f&title=%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e2%80%94%e2%80%94%e4%bd%bf%e7%94%a8Jest%e5%92%8cSinon%e7%bb%99%e5%b7%b2%e6%9c%89%e7%9a%84%e4%bb%a3%e7%a0%81%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">提高代码质量——使用Jest和Sinon给已有的代码添加单元测试</h1><div class="meta"><div class="postdate"><time datetime="2018-12-04" itemprop="datePublished">2018-12-04</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch1\x3e概述\x3c\/h1\x3e\n\x3cp\x3e在日常的功能开发中，我们的代码测试都依赖于自己或者QA进行测试。这些操作不仅费时费力，而且还依赖开发者自身的驱动。在开发一些第三方依赖的库时，我们也没有办法给第三方提供完整的代码质量报告。\x3c\/p\x3e\n\x3cp\x3e现在，我们可以使用单元测试来提高自己的代码质量。下面，我将自己在使用Jest和Sinon.js配置和编写单元测试中的收获的经验和踩到的坑进行总结，根据从零开始配置和编写单元测试这一条线来进行分享。\x3c\/p\x3e\n\x3cp\x3e通过本文，你可以解决以下问题：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3eJest与Sinon.js是什么？\x3c\/li\x3e\n\x3cli\x3e如何配置Jest与Sinon.js，从而编写单元测试？\x3c\/li\x3e\n\x3cli\x3e如何解决进行单元测试中遇到的常见问题？\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch1\x3eJest与Sinon.js是什么\x3c\/h1\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/facebook.github.io\/jest\/\x22 rel=\x22nofollow noreferrer\x22\x3eJest\x3c\/a\x3e是FaceBook推出的一个针对JavaScript进行单元测试的库，它提供了断言、函数模拟等API来对你自己编写的业务逻辑代码进行测试后。\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22http:\/\/sinonjs.org\/\x22 rel=\x22nofollow noreferrer\x22\x3eSinon.js\x3c\/a\x3e是一个用来做独立测试和模拟的JavaScript库。它在单元测试的编写中通常用来模拟HTTP等相关请求。\x3c\/p\x3e\n\x3ch2\x3e为什么没有用其他的单元测试框架\x3c\/h2\x3e\n\x3cp\x3e在最开始的框架选择中，我先尝试了能够并行测试，大大提高单元测试速度的\x3ca href=\x22https:\/\/github.com\/avajs\/ava\x22 rel=\x22nofollow noreferrer\x22\x3eava\x3c\/a\x3e框架。它能满足日常的普通需求如utils工具集的测试，也能够配置Sinon.js来进行HTTP模拟测试。\x3c\/p\x3e\n\x3cp\x3e但是，在处理webpack alias的问题时，通过官方\x3ca href=\x22https:\/\/github.com\/avajs\/ava\/issues\/1011\x22 rel=\x22nofollow noreferrer\x22\x3eissue\x3c\/a\x3e中的极其复杂的配置也没有能够解决出现\x3ccode\x3eCannot find module\x3c\/code\x3e的问题（其中一个解决此问题的插件\x3ca href=\x22https:\/\/github.com\/istarkov\/babel-plugin-webpack-loaders\x22 rel=\x22nofollow noreferrer\x22\x3ebabel-plugin-webpack-loaders\x3c\/a\x3e中竟然是推荐直接使用Jest，囧）。\x3c\/p\x3e\n\x3cp\x3e而在Jest中，可以很方便的通过一些简单配置，就能够识别在文件中使用的webpack alias，相关的具体方法将会在后面章节进行具体描述。\x3c\/p\x3e\n\x3cp\x3e而对于其他的测试框架如：\x3ca href=\x22https:\/\/mochajs.org\/\x22 rel=\x22nofollow noreferrer\x22\x3eMocha\x3c\/a\x3e或者\x3ca href=\x22http:\/\/www.chaijs.com\/\x22 rel=\x22nofollow noreferrer\x22\x3eChai\x3c\/a\x3e等，没有进行具体的了解，因此在这里不多做评价。\x3c\/p\x3e\n\x3ch1\x3e如何配置Jest与Sinon.js，从而编写单元测试？\x3c\/h1\x3e\n\x3ch2\x3eJest配置\x3c\/h2\x3e\n\x3ch3\x3e安装依赖包\x3c\/h3\x3e\n\x3cp\x3e需要使用Jest，首先你需要进行安装，执行以下命令:\x3c\/p\x3e\n\x3cpre\x3e\x3ccode\x3enpm install jest -D\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果你的项目中存在\x3ccode\x3e.babelrc\x3c\/code\x3e文件（使用了babel 6）时，不论你测试的代码是否通过babel进行编译，你都需要安装额外的几个包：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode\x3enpm install babel-jest babel-core regenerator-runtime -D\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果你使用的是babel 7，则需要安装下面几个包：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode\x3enpm install babel-jest \x27babel-core@^7.0.0-0\x27 @babel\/core regenerator-runtime -D\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3\x3epackage.json文件配置\x3c\/h3\x3e\n\x3cp\x3e在安装完成依赖包以后，如果你有相关的jest配置项需要设置，你还可以在\x3ccode\x3epackage.json\x3c\/code\x3e文件中配置如下字段：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22json\x22\x3e{\n  \x22jest\x22: {\n    \n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3e.babelrc\x3c\/code\x3e文件只需要保存之前的配置，不需要做任何修改即可生效。\x3c\/p\x3e\n\x3ch2\x3eSinon.js配置\x3c\/h2\x3e\n\x3ch3\x3e依赖包安装\x3c\/h3\x3e\n\x3cp\x3e安装配置完了Jest，让我们来看下Sinon.js。需要使用Sinon.js，我们首先需要进行安装：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode\x3enpm install sinon -D\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e配置完成后，需要在使用的地方进行引入，如下所示：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3econst sinon = require(\x27sinon\x27);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在我的项目中，主要是使用Sinon.js来模拟HTTP请求。在Sinon.js的文档中，有专门关于\x3ca href=\x22http:\/\/sinonjs.org\/releases\/v4.5.0\/fake-xhr-and-server\/\x22 rel=\x22nofollow noreferrer\x22\x3eXMLHttpRequest对象的模拟\x3c\/a\x3e的章节，在下一章中，我们将会针对项目中sinon.js的使用进行简单的介绍。\x3c\/p\x3e\n\x3ch2\x3e编写单元测试\x3c\/h2\x3e\n\x3cp\x3e在本章中，我们会针对如何编写单元测试文件进行一个具体的讲解，其中包含：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e同步函数测试\x3c\/li\x3e\n\x3cli\x3e异步函数测试\x3c\/li\x3e\n\x3cli\x3eHTTP测试\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e同时，我们会对当中使用到的Jest和Sinon.js的API会进行简单介绍，如果需要使用其他的API，可以自行阅读\x3ca href=\x22https:\/\/facebook.github.io\/jest\/\x22 rel=\x22nofollow noreferrer\x22\x3eJest\x3c\/a\x3e和\x3ca href=\x22http:\/\/sinonjs.org\/\x22 rel=\x22nofollow noreferrer\x22\x3eSinon.js\x3c\/a\x3e的文档。\x3c\/p\x3e\n\x3cp\x3e通过上面三类测试，我们基本能够覆盖现有项目中的所有代码。\x3c\/p\x3e\n\x3ch3\x3e同步函数测试\x3c\/h3\x3e\n\x3cp\x3e同步函数的测试过程是这几个中最简单的一部分，我们可以测试函数返回值，也能够\x3ca href=\x22https:\/\/facebook.github.io\/jest\/docs\/en\/mock-functions.html\x22 rel=\x22nofollow noreferrer\x22\x3e测试传入的高阶函数\x3c\/a\x3e。下面我们通过一个具体的例子来看下。\x3c\/p\x3e\n\x3cp\x3e源代码文件，一个纯函数：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ user.js\nexport default function(obj) {\n    return \x27hjava\x27;\n}\n\nexport function handleUserData(callback) {\n    callback(\x27hjava\x27);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e针对上面的源代码文件编写的一个单元测试文件：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ user.test.js\nimport userFunc, {handleUserData} from \x27.\/user\x27;\n\n\/\/ test是一个注册的全局方法\ntest(\x27user\x27, () =\x26gt; {\n    expect(userFunc()).toBe(\x27hjava\x27); \/\/ 判断userFunc的执行结果等于\x27hjava\x27\n    \n    let callback = jest.fn(); \/\/ jest是一个注册的全局变量\n    handleUserData(callback);\n\n    expect(callback.mock.calls.length).toBe(1); \/\/ 判断callback函数被调用了一次\n    expect(callback.mock.calls[0][0]).toBe(\x27hjava\x27); \/\/ 判断了callback函数的第一次被调用的第一个参数为\x27hjava\x27\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e从上面的示例中我们可以看到，针对同步的纯函数，我们可以通过很简单的单元测试模型来验证它的功能。\x3c\/p\x3e\n\x3ch3\x3e异步函数测试\x3c\/h3\x3e\n\x3cp\x3e异步函数主要分为两种——Callback方式和Promise方式。这两种方式都很简单，下面我们对两种方式进行具体的介绍。详细内容可以见Jest文档中的\x3ca href=\x22https:\/\/facebook.github.io\/jest\/docs\/en\/asynchronous.html\x22 rel=\x22nofollow noreferrer\x22\x3e测试异步代码\x3c\/a\x3e。\x3c\/p\x3e\n\x3ch4\x3eCallback方式\x3c\/h4\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ user.js\nexport default function(callback) {\n    setTimeout(()=\x26gt;{\n        callback({username: \x27hjava\x27});\n    }, 1000);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ user.test.js\nimport userFunc from \x27.\/user\x27;\n\ntest(\x27user\x27, () =\x26gt; {\n    userFunc((data) =\x26gt; {\n        expect(data).toEqual({username: \x27hjava\x27}); \/\/ 对象比较用beEqual()\n    });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3ePromise方式\x3c\/h4\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ user.js\nexport default function(callback) {\n    return Promise.resolve({username: \x27hjava\x27});\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ user.test.js\nimport userFunc from \x27.\/user\x27;\n\ntest(\x27user\x27, () =\x26gt; {\n    userFunc().then((data) =\x26gt; {\n        expect(data).toEqual({username: \x27hjava\x27});\n    });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3\x3eHTTP测试\x3c\/h3\x3e\n\x3cp\x3e在测试HTTP请求相关参数的过程中，我们需要模拟XMLHttpRequest对象，从而拦截相关的HTTP请求，获取请求数据。正好Sinon.js能够做到这一点。下面我们通过一个示例来看下相关的逻辑：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ user.js\nexport default function(callback) {\n    this.sendRequest(\x27\/user\/get\x27, callback); \/\/ 发送请求来获取用户数据，成功后执行callback回调函数\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ user.test.js\nimport Sinon from \x27sinon\x27;\nimport userFunc from \x27user\x27;\n\nlet XHR;\nlet requests = [];\n\/\/ beforeEach是Jest提供的函数，在每个测试执行前都会执行一次\nbeforeEach(() =\x26gt; {\n    XHR = sinon.useFakeXMLHttpRequest(); \/\/创建一个模拟的XMLHttpRequest对象\n\n    XHR.onCreate = function (xhr) {\n        requests.push(xhr);\n    };\n});\n\n\/\/ afterEach是Jest提供的函数，在每个测试执行后都会执行一次\nafterEach(() =\x26gt; {\n    XHR.restore();\n});\n\ntest(\x27user\x27, () =\x26gt; {\n    let callback = jest.fn();\n\n    HTTPCommon.deleteRemoteSession({\n        data: {},\n        success: callback\n    });\n\n    expect(requests.length).toBe(1);\n\n    requests[0].respond(200, {\x22Content-Type\x22: \x27application\/json\x27}, \x27hjava\x27); \/\/ 模拟返回值\n\n    expect(callback.mock.calls[0][0]).toBe(\x27hjava\x27);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch1\x3e如何解决进行单元测试中遇到的常见问题？\x3c\/h1\x3e\n\x3cp\x3e在本章中，我们总结了如下问题来进行介绍，希望大家再遇到相同问题时能够快速解决：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e如何统计Jest单元测试覆盖率\x3c\/li\x3e\n\x3cli\x3e如何设置单元测试文件不使用本地的babel配置\x3c\/li\x3e\n\x3cli\x3e如何设置单元测试文件使用本地的babel配置\x3c\/li\x3e\n\x3cli\x3e如何处理代码中引用的webpack alias问题\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2\x3e如何统计单元测试覆盖率？\x3c\/h2\x3e\n\x3cp\x3e不像ava一样，需要使用syc来进行计算，Jest内置了统计单元测试覆盖率的工具，只需要简单配置即可达到相关的要求。具体配置如下：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22json\x22\x3e\/\/ package.json\n{\n  \x22jest\x22: {\n    \x22collectCoverage\x22: true, \/\/ 是否开启统计单元测试覆盖率\n    \x22collectCoverageFrom\x22: [ \/\/ 指定统计单元测试覆盖率文件\n      \x22**\/src\/**.js\x22\n    ],\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2\x3e如何设置单元测试文件不使用ES2015配置\x3c\/h2\x3e\n\x3cp\x3e如果你的项目中有\x3ccode\x3e.babelrc\x3c\/code\x3e文件，而你不希望单元测试文件受到babel文件的影响，你可以在jest的配置项中增加\x3ccode\x3etransform\x3c\/code\x3e字段，具体配置如下:\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22json\x22\x3e\/\/ package.json\n{\n  \x22jest\x22: {\n    \x22transform\x22: {}\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2\x3e如何设置单元测试使用ES2015配置\x3c\/h2\x3e\n\x3cp\x3e如果你的单元测试文件中需要使用ES2015后通过babel来进行编译，那么需要对\x3ccode\x3e.babelrc\x3c\/code\x3e文件的配置进行部分修改。\x3c\/p\x3e\n\x3cp\x3e如果你之前在\x3ccode\x3e.babelrc\x3c\/code\x3e文件中，把\x3ccode\x3emodules\x3c\/code\x3e字段设置为false，那么你需要在\x3ccode\x3etest\x3c\/code\x3e环境下重新开启，具体代码如下：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22json\x22\x3e\/\/ .babelrc\n{\n  \x22presets\x22: [[\x22env\x22, {\x22modules\x22: false}]],\n  \x22env\x22: {\n    \x22test\x22: {\n      \x22presets\x22: [[\x22env\x22]]\n    }\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果你使用的是babel 7的话（安装时多安装过相关依赖包），你需要设置的\x3ccode\x3epresets\x3c\/code\x3e字段的值应该为\x3ccode\x3e@babel\/env\x3c\/code\x3e，具体代码如下：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22json\x22\x3e\/\/ .babelrc\n{\n  \x22presets\x22: [[\x22env\x22, {\x22modules\x22: false}]],\n  \x22env\x22: {\n    \x22test\x22: {\n      \x22presets\x22: [[\x22@babel\/env\x22]]\n    }\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2\x3e如何处理代码中引用的webpack alias问题\x3c\/h2\x3e\n\x3cp\x3e如果我们在项目中使用了webpack，那么我们很大概率会使用到alias相关属性来定义路径。但是，在单元测试框架中，它并不能够识别这种路径，就会出现\x3ccode\x3eCannot find module \x27xxx\x27 from \x27yyy\x27\x3c\/code\x3e的报错。\x3c\/p\x3e\n\x3cp\x3e不像ava框架需要安装插件和进行复杂的配置，我们只需要在Jest中配置\x3ccode\x3emoduleNameMapper\x3c\/code\x3e属性即可满足需求。具体示例如下：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22json\x22\x3e\/\/ webpack.config.js\n{\n    alias: {\n        \x27@__dir\x27:process.cwd()\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cpre\x3e\x3ccode class=\x22json\x22\x3e\/\/package.json\n{\n    \x22jest\x22: {\n        \x22moduleNameMapper\x22: {\n        \x22@__dir(.*)$\x22: \x22\x26lt;rootDir\x26gt;$1\x22 \/\/正则匹配方式，对应webpack alias\n        }\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch1\x3e总结\x3c\/h1\x3e\n\x3cp\x3e编写测试是一个很好的习惯。\x3c\/p\x3e\n\x3cp\x3e很多人经常都说要对自己的代码进行质量监控，但是又不知道该如何下手。通过这篇文章，你应该学会了如何针对已有代码从零开始编写一套完整的单元测试用例。\x3c\/p\x3e\n\x3cp\x3e如果有任何疑问，欢迎留言或者私信进行沟通与交流。\x3c\/p\x3e\n\x3cp\x3e关于Jest是如何测试JavaScript代码以及Sinon是如何模拟XMLHttpRequest请求的，我们将会在后面几篇博客中给大家带来相关的源码解析，有兴趣的同学可以关注我，留意后续的文章。\x3c\/p\x3e\n\x3ch1\x3e附录\x3c\/h1\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/facebook.github.io\/jest\/\x22 rel=\x22nofollow noreferrer\x22\x3eJest\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/sinonjs.org\/\x22 rel=\x22nofollow noreferrer\x22\x3eSinon.js\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/github.com\/avajs\/ava\x22 rel=\x22nofollow noreferrer\x22\x3eava\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/github.com\/avajs\/ava\/issues\/1011\x22 rel=\x22nofollow noreferrer\x22\x3eava关于配置解决webpack alias的issue\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/mochajs.org\/\x22 rel=\x22nofollow noreferrer\x22\x3eMocha\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.chaijs.com\/\x22 rel=\x22nofollow noreferrer\x22\x3eChai\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>提高代码质量——使用Jest和Sinon给已有的代码添加单元测试</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000014465282">https://segmentfault.com/a/1190000014465282</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/vnnhg4z0lab/" target="_blank">https://alili.tech/archive/vnnhg4z0lab/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/hvvo3rmt3dj/">JS打包工具rollup——完全入门指南<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/semhn25oasq/">Spring Boot [基于Spring Boot 与 Vue的后台脚手架] SanJi Boot Security<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/t1iml4tjj7r/">WebGL入门demo<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/8gbs1y0r0ns/">[面试专题]一线互联网大厂面试总结<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/4os59l0zeel/">react&#43;react-router4&#43;redux最新版构建分享<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/dznv6a9ewcj/">react虚拟dom机制与diff算法<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/myiqarfowok/">一套Vue的单页模板：N3-admin<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/2eeweuxgjbk/">使用 json-server 搭建 api mock 服务 (一)<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/h7cszygcoqq/">使用Ionic3框架开始第一个混合开发APP<aside class="dates">2019-01-04</aside></a></li><li><a href="/archive/g8by6kv9q8t/">如何只用 CSS 完成漂亮的加载<aside class="dates">2019-01-04</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>